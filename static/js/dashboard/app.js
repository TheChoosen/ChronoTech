// Point d'entr√©e principal pour ChronoTech Dashboard
import { kanbanManager } from './modules/kanban_module.js';
import { techniciansManager } from './modules/technicians.js';
import { ganttManager } from './modules/gantt.js';
import { notificationManager } from './utils/notifications.js';
import { apiClient } from './utils/api.js';

// Dashboard principal ChronoTech
class ChronoTechDashboard {
    constructor() {
        this.initialized = false;
        this.modules = {
            kanban: kanbanManager,
            technicians: techniciansManager,
            gantt: ganttManager,
            notifications: notificationManager,
            api: apiClient
        };
    }

    // Initialisation centralis√©e
    async init() {
        if (this.initialized) return;

        console.log('üöÄ Initialisation ChronoTech Dashboard v2.0...');

        // Attendre que toutes les librairies soient charg√©es
        if (!this.checkDependencies()) {
            console.log('‚è≥ Attente des d√©pendances...');
            setTimeout(() => this.init(), 100);
            return;
        }

        try {
            // Initialiser les modules
            await this.initializeModules();
            
            // Exposer les fonctions pour compatibilit√© avec l'ancien code
            this.exposeGlobalFunctions();
            
            // Configurer les √©v√©nements globaux
            this.setupGlobalEvents();

            this.initialized = true;
            console.log('‚úÖ ChronoTech Dashboard initialis√© avec succ√®s');

            // Charger les donn√©es initiales
            await this.loadInitialData();

        } catch (error) {
            console.error('‚ùå Erreur lors de l\'initialisation:', error);
            notificationManager.showToast('Erreur lors de l\'initialisation du dashboard', 'error');
        }
    }

    // V√©rifier les d√©pendances
    checkDependencies() {
        const dependencies = [
            { name: 'FullCalendar', check: () => typeof FullCalendar !== 'undefined' },
            { name: 'Bootstrap', check: () => typeof bootstrap !== 'undefined' },
            { name: 'DOM', check: () => document.readyState === 'complete' || document.readyState === 'interactive' }
        ];

        return dependencies.every(dep => {
            const available = dep.check();
            if (!available) {
                console.log(`‚è≥ En attente de ${dep.name}...`);
            }
            return available;
        });
    }

    // Initialiser les modules
    async initializeModules() {
        console.log('üîß Initialisation des modules...');

        // Demander permission pour les notifications
        await notificationManager.requestNotificationPermission();

        // Initialiser les gestionnaires de composants
        this.initializeComponents();

        console.log('‚úÖ Modules initialis√©s');
    }

    // Initialiser les composants
    initializeComponents() {
        // Initialiser les panels s'ils existent
        if (document.getElementById('kanbanPanel')) {
            window.KanbanSystem?.init?.();
        }

        if (document.getElementById('calendarPanel')) {
            window.CalendarSystem?.init?.();
        }

        if (document.getElementById('analyticsPanel')) {
            window.AnalyticsSystem?.init?.();
        }

        // Initialiser le syst√®me de notifications global
        if (document.getElementById('notificationSystem')) {
            window.NotificationSystem = notificationManager;
        }
    }

    // Exposer les fonctions pour compatibilit√©
    exposeGlobalFunctions() {
        // Fonctions Kanban
        window.loadKanbanDataFix = () => this.modules.kanban.loadKanbanDataFix();
        window.updateKanbanColumnsDirect = (data) => this.modules.kanban.updateKanbanColumnsDirect(data);
        window.createKanbanCardDirect = (workOrder) => this.modules.kanban.createKanbanCardDirect(workOrder);
        window.filterKanban = () => this.modules.kanban.filterKanban();

        // Fonctions Techniciens
        window.loadTechniciansData = () => this.modules.technicians.loadTechniciansData();
        window.updateTechnicianModal = (data) => this.modules.technicians.updateTechnicianModal(data);
        window.addTechnician = () => this.modules.technicians.addTechnician?.() || console.log('Ajouter technicien');

        // Fonctions Gantt
        window.loadGanttData = () => this.modules.gantt.loadGanttData();
        window.refreshGantt = () => this.modules.gantt.refresh();
        window.exportGantt = () => this.modules.gantt.export();

        // Fonctions utilitaires
        window.createWorkOrder = () => this.createWorkOrder();
        window.viewWorkOrderDetails = (id) => this.viewWorkOrderDetails(id);
        window.editWorkOrder = (id) => this.editWorkOrder(id);

        console.log('‚úÖ Fonctions globales expos√©es');
    }

    // Configurer les √©v√©nements globaux
    setupGlobalEvents() {
        // Gestionnaire d'erreurs global
        window.addEventListener('error', (event) => {
            console.error('Erreur globale:', event.error);
            notificationManager.showToast('Une erreur inattendue s\'est produite', 'error');
        });

        // Gestionnaire de promesses rejet√©es
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Promesse rejet√©e:', event.reason);
            event.preventDefault();
        });

        // Rechargement p√©riodique des donn√©es (toutes les 5 minutes)
        setInterval(() => {
            if (this.initialized) {
                this.refreshData();
            }
        }, 5 * 60 * 1000);

        console.log('‚úÖ √âv√©nements globaux configur√©s');
    }

    // Charger les donn√©es initiales
    async loadInitialData() {
        console.log('üìä Chargement des donn√©es initiales...');

        const loadPromises = [];

        // Charger les donn√©es avec d√©lais pour √©viter les races conditions
        setTimeout(() => {
            loadPromises.push(this.modules.kanban.loadKanbanDataFix());
        }, 100);

        setTimeout(() => {
            loadPromises.push(this.modules.technicians.loadTechniciansData());
        }, 200);

        setTimeout(() => {
            loadPromises.push(this.modules.gantt.loadGanttData());
        }, 300);

        try {
            await Promise.allSettled(loadPromises);
            console.log('‚úÖ Donn√©es initiales charg√©es');
            notificationManager.showToast('Dashboard charg√© avec succ√®s', 'success');
        } catch (error) {
            console.error('Erreur lors du chargement des donn√©es:', error);
            notificationManager.showToast('Certaines donn√©es n\'ont pas pu √™tre charg√©es', 'warning');
        }
    }

    // Actualiser les donn√©es
    async refreshData() {
        console.log('üîÑ Actualisation des donn√©es...');
        
        try {
            await Promise.allSettled([
                this.modules.kanban.loadKanbanDataFix(),
                this.modules.technicians.loadTechniciansData(),
                this.modules.gantt.loadGanttData()
            ]);
            
            console.log('‚úÖ Donn√©es actualis√©es');
        } catch (error) {
            console.error('Erreur lors de l\'actualisation:', error);
        }
    }

    // Cr√©er un nouvel ordre de travail
    createWorkOrder() {
        console.log('‚ûï Cr√©ation d\'un nouvel ordre de travail');
        
        // V√©rifier si une modal sp√©cifique existe
        const createModal = document.getElementById('createWorkOrderModal');
        if (createModal) {
            const modal = new bootstrap.Modal(createModal);
            modal.show();
        } else {
            notificationManager.showToast('Modal de cr√©ation √† impl√©menter', 'info');
        }
    }

    // Voir les d√©tails d'un ordre de travail
    viewWorkOrderDetails(id) {
        console.log('üëÅÔ∏è Affichage d√©tails ordre de travail:', id);
        
        const detailsModal = document.getElementById('workOrderDetailsModal');
        if (detailsModal) {
            // Charger les donn√©es de l'ordre de travail
            this.loadWorkOrderDetails(id);
            const modal = new bootstrap.Modal(detailsModal);
            modal.show();
        } else {
            notificationManager.showToast(`D√©tails ordre de travail #${id}`, 'info');
        }
    }

    // Modifier un ordre de travail
    editWorkOrder(id) {
        console.log('‚úèÔ∏è Modification ordre de travail:', id);
        notificationManager.showToast(`Modification ordre de travail #${id}`, 'info');
    }

    // Charger les d√©tails d'un ordre de travail
    async loadWorkOrderDetails(id) {
        try {
            const workOrder = await apiClient.request(`/work_orders/${id}`);
            this.populateWorkOrderModal(workOrder);
        } catch (error) {
            console.error('Erreur chargement d√©tails:', error);
            notificationManager.showToast('Impossible de charger les d√©tails', 'error');
        }
    }

    // Remplir la modal avec les d√©tails
    populateWorkOrderModal(workOrder) {
        // Remplir les champs de la modal avec les donn√©es
        const fields = {
            'modal-wo-number': workOrder.claim_number,
            'modal-wo-customer': workOrder.customer_name,
            'modal-wo-description': workOrder.description,
            'modal-wo-technician': workOrder.technician_name,
            'modal-wo-status': workOrder.status,
            'modal-wo-priority': workOrder.priority
        };

        Object.entries(fields).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value || 'N/A';
            }
        });
    }

    // Obtenir le statut du dashboard
    getStatus() {
        return {
            initialized: this.initialized,
            modules: Object.keys(this.modules),
            version: '2.0'
        };
    }
}

// Cr√©er l'instance globale
const dashboard = new ChronoTechDashboard();

// Exposer l'instance globalement pour compatibilit√©
window.ChronoTechDashboard = dashboard;

// Initialisation automatique
document.addEventListener('DOMContentLoaded', () => {
    console.log('üéØ DOM Ready - D√©marrage ChronoTech Dashboard');
    
    // D√©lai pour que tous les scripts se chargent
    setTimeout(() => {
        dashboard.init();
    }, 500);
});

// Fallback si DOMContentLoaded est d√©j√† pass√©
if (document.readyState !== 'loading') {
    setTimeout(() => {
        dashboard.init();
    }, 100);
}

// Export pour utilisation comme module
export default dashboard;
