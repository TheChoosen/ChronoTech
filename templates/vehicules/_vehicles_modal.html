<div class="modal fade" id="vehiclesModal" tabindex="-1" aria-labelledby="vehiclesModalLabel" aria-hidden="true"
  data-customer-id="{{ customer.id if customer is defined and customer else '' }}"
  data-wo-url="{{ url_for('work_orders.create_work_order') }}"
  data-appt-url="{{ url_for('appointments.create') }}">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
  <h5 class="modal-title" id="vehiclesModalLabel">Véhicules de {{ customer.name if customer is defined and customer else 'client' }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="vehicles-list">
          {% if vehicles %}
          <ul class="list-group mb-3" id="vehicles-list-group">
            {% for v in vehicles %}
            <li class="list-group-item d-flex justify-content-between align-items-center" data-vehicle-id="{{ v.id }}">
              <div>
                <strong class="vehicle-title">{{ v.make or '' }} {{ v.model or '' }}</strong>
                <div class="small text-muted vehicle-sub">{{ v.year or '' }} - {{ v.license_plate or '' }}</div>
                {% if v.notes %}<div class="mt-1 vehicle-notes">{{ v.notes }}</div>{% endif %}
              </div>
              <div>
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-vehicle" data-id="{{ v.id }}">Modifier</button>
                  <button type="button" class="btn btn-sm btn-outline-primary btn-create-wo" data-url="{{ url_for('work_orders.create_work_order', customer_id=customer.id, vehicle_id=v.id) if customer is defined and customer else url_for('work_orders.create_work_order', vehicle_id=v.id) }}" title="Créer un bon de travail pour ce véhicule">Bon</button>
                  <button type="button" class="btn btn-sm btn-outline-success btn-create-appt" data-url="{{ url_for('appointments.create', customer_id=customer.id, vehicle_id=v.id) if customer is defined and customer else url_for('appointments.create', vehicle_id=v.id) }}" title="Créer un rendez-vous pour ce véhicule">RDV</button>
                  <form method="POST" action="{{ url_for('vehicles.delete', id=v.id) }}" style="display:inline; margin:0;">
                    <button type="submit" class="btn btn-sm btn-outline-danger">Supprimer</button>
                  </form>
                </div>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="alert alert-info">Aucun véhicule enregistré pour ce client.</div>
          {% endif %}

          <hr>

          <h6>Ajouter un véhicule</h6>
          <form id="add-vehicle-form">
            <input type="hidden" name="customer_id" value="{{ customer.id if customer is defined and customer else '' }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Marque</label>
                  <input name="make" class="form-control">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Modèle</label>
                  <input name="model" class="form-control">
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">Année</label>
                  <input name="year" class="form-control" type="number">
                </div>
              </div>
              <div class="col-md-2">
                <div class="mb-3">
                  <label class="form-label">Immat.</label>
                  <input name="license_plate" class="form-control">
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">VIN</label>
              <input name="vin" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Notes</label>
              <textarea name="notes" class="form-control"></textarea>
            </div>
            <div class="d-flex justify-content-end">
              <button type="button" id="add-vehicle-btn" class="btn btn-primary">Ajouter</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

  <script>
// Helper to get CSRF token value from the add form
function getAddFormCsrf(){
  var form = document.getElementById('add-vehicle-form');
  if(!form) return null;
  var el = form.querySelector('input[name="csrf_token"]');
  return el ? el.value : null;
}

document.getElementById('add-vehicle-btn').addEventListener('click', function(){
  var form = document.getElementById('add-vehicle-form');
  var data = new FormData(form);
  var csrf = getAddFormCsrf();
  var headers = {'X-Requested-With': 'XMLHttpRequest'};
  if(csrf) headers['X-CSRF-Token'] = csrf;

  fetch("{{ url_for('vehicles.create') }}", {
    method: 'POST',
    body: data,
    headers: headers
  }).then(r => r.json()).then(res => {
    if(res.success){
      // append the new vehicle into the list without reloading
      var v = res.vehicle;
      if(v){
        var ul = document.getElementById('vehicles-list-group');
        if(!ul){
          // create list container
          ul = document.createElement('ul'); ul.className = 'list-group mb-3'; ul.id = 'vehicles-list-group';
          var placeholder = document.querySelector('#vehicles-list .alert'); if(placeholder) placeholder.remove();
          document.getElementById('vehicles-list').insertBefore(ul, document.querySelector('#vehicles-list hr'));
        }
        var modal = document.getElementById('vehiclesModal');
        var customerId = modal ? modal.getAttribute('data-customer-id') : '';
        var woBase = modal ? modal.getAttribute('data-wo-url') : '/work_orders/create';
        var apptBase = modal ? modal.getAttribute('data-appt-url') : '/appointments/create';
        var li = document.createElement('li'); li.className = 'list-group-item d-flex justify-content-between align-items-center'; li.setAttribute('data-vehicle-id', v.id);
        li.innerHTML = `
          <div>
            <strong class="vehicle-title">${v.make || ''} ${v.model || ''}</strong>
            <div class="small text-muted vehicle-sub">${v.year || ''} - ${v.license_plate || ''}</div>
            ${v.notes ? `<div class="mt-1 vehicle-notes">${v.notes}</div>` : ''}
          </div>
          <div>
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-sm btn-outline-secondary btn-edit-vehicle" data-id="${v.id}">Modifier</button>
              <button type="button" class="btn btn-sm btn-outline-primary btn-create-wo" data-url="${woBase}?customer_id=${customerId}&vehicle_id=${v.id}" title="Créer un bon de travail pour ce véhicule">Bon</button>
              <button type="button" class="btn btn-sm btn-outline-success btn-create-appt" data-url="${apptBase}?customer_id=${customerId}&vehicle_id=${v.id}" title="Créer un rendez-vous pour ce véhicule">RDV</button>
              <form method="POST" action="/vehicles/${v.id}/delete" style="display:inline; margin:0;">
                <button type="submit" class="btn btn-sm btn-outline-danger">Supprimer</button>
              </form>
            </div>
          </div>`;
        ul.insertBefore(li, ul.firstChild);
      }
      // clear form
      form.reset();
    } else {
      alert(res.message || 'Erreur ajout véhicule');
    }
  }).catch(err => { alert('Erreur réseau'); });
});
</script>

<!-- Inline modal used to load the edit form -->
<div class="modal fade" id="vehicleEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Modifier le véhicule</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="vehicleEditModalBody">
        <!-- edit form will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script>
// Delegate edit button clicks
document.addEventListener('click', function(e){
  if(e.target && e.target.classList.contains('btn-edit-vehicle')){
    var id = e.target.getAttribute('data-id');
    var modalEl = document.getElementById('vehicleEditModal');
    var modalBody = document.getElementById('vehicleEditModalBody');
    // Fetch the edit page HTML
    fetch(`/vehicles/${id}/edit`).then(r => r.text()).then(html => {
      modalBody.innerHTML = html;
      var modal = new bootstrap.Modal(modalEl);
      modal.show();

      // Attach AJAX submit handler to the loaded form
      var form = modalBody.querySelector('form');
      if(form){
        form.addEventListener('submit', function(ev){
          ev.preventDefault();
          var fd = new FormData(form);
          var headers = {'X-Requested-With': 'XMLHttpRequest'};
          if(window.CT && window.CT.getCsrfToken){
            var t = window.CT.getCsrfToken(); if(t) headers['X-CSRF-Token'] = t;
          }
          fetch(form.action || `/vehicles/${id}/edit`, { method: 'POST', body: fd, headers: headers })
            .then(r => r.json()).then(resp => {
              if(resp.success){
                // update the list item DOM with new values
                var li = document.querySelector(`li[data-vehicle-id="${id}"]`);
                if(li && resp.vehicle){
                  li.querySelector('.vehicle-title').textContent = (resp.vehicle.make || '') + ' ' + (resp.vehicle.model || '');
                  li.querySelector('.vehicle-sub').textContent = (resp.vehicle.year || '') + ' - ' + (resp.vehicle.license_plate || '');
                  var notesEl = li.querySelector('.vehicle-notes');
                  if(notesEl){ notesEl.textContent = resp.vehicle.notes || ''; }
                  else if(resp.vehicle.notes){
                    var d = document.createElement('div'); d.className = 'mt-1 vehicle-notes'; d.textContent = resp.vehicle.notes; li.querySelector('div').appendChild(d);
                  }
                }
                modal.hide();
              } else {
                alert(resp.message || 'Erreur mise à jour');
              }
            }).catch(() => alert('Erreur réseau'));
        });
      }
    }).catch(()=> alert('Impossible de charger le formulaire'));
  }
  // Create work order from vehicle row: open dedicated create page in new tab
  if(e.target && e.target.classList.contains('btn-create-wo')){
    var url = e.target.getAttribute('data-url');
    if(url) window.open(url, '_blank');
  }
  // Create appointment from vehicle row: open dedicated create page in new tab
  if(e.target && e.target.classList.contains('btn-create-appt')){
    var url = e.target.getAttribute('data-url');
    if(url) window.open(url, '_blank');
  }
});

function openCreateModal(url, kind){
  // reuse the vehicleEditModal to display the create form
  var modalEl = document.getElementById('vehicleEditModal');
  var modalBody = document.getElementById('vehicleEditModalBody');
  fetch(url).then(r => r.text()).then(html => {
    modalBody.innerHTML = html;
    var modal = new bootstrap.Modal(modalEl);
    modal.show();
    var form = modalBody.querySelector('form');
    if(!form) return;
    form.addEventListener('submit', function(ev){
      ev.preventDefault();
      var fd = new FormData(form);
      var headers = {'X-Requested-With': 'XMLHttpRequest'};
      if(window.CT && window.CT.getCsrfToken){ var t = window.CT.getCsrfToken(); if(t) headers['X-CSRF-Token'] = t; }
      fetch(form.action || url, { method: 'POST', body: fd, headers: headers })
        .then(r => r.json()).then(resp => {
          if(resp && resp.success){
            // open created resource in a new tab if url provided
            if(resp.url){ window.open(resp.url, '_blank'); }
            modal.hide();
            if(window.CT && window.CT.showToast) window.CT.showToast('Créé avec succès', 'success');
          } else {
            alert(resp && resp.message ? resp.message : 'Erreur création');
          }
        }).catch(()=> alert('Erreur réseau'));
    });
  }).catch(()=> alert('Impossible de charger le formulaire'));
}
