{% extends "base.html" %}

{% block title %}Tableau de Bord Analytique - ChronoTech{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-chart-pie me-2"></i>Tableau de Bord Analytique
        </h1>
        <div class="d-flex gap-2">
            <div class="dropdown">
                <button class="btn btn-outline-primary clay-button dropdown-toggle" type="button" 
                        data-bs-toggle="dropdown">
                    <i class="fas fa-calendar me-2"></i>{{ current_period_label }}
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="?period=today">Aujourd'hui</a></li>
                    <li><a class="dropdown-item" href="?period=week">Cette semaine</a></li>
                    <li><a class="dropdown-item" href="?period=month">Ce mois</a></li>
                    <li><a class="dropdown-item" href="?period=quarter">Ce trimestre</a></li>
                    <li><a class="dropdown-item" href="?period=year">Cette année</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#customPeriodModal">Période personnalisée</a></li>
                </ul>
            </div>
            <button class="btn btn-outline-secondary clay-button" onclick="refreshDashboard()">
                <i class="fas fa-sync me-2"></i>Actualiser
            </button>
            <button class="btn btn-outline-success clay-button" onclick="exportDashboard()">
                <i class="fas fa-download me-2"></i>Exporter
            </button>
        </div>
    </div>

    <!-- Métriques principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="clay-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-shape bg-primary text-white rounded-circle me-3">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div>
                            <h3 class="mb-0">{{ metrics.total_work_orders }}</h3>
                            <p class="text-muted mb-0">Ordres de Travail</p>
                            <small class="text-{{ 'success' if metrics.work_orders_change >= 0 else 'danger' }}">
                                <i class="fas fa-arrow-{{ 'up' if metrics.work_orders_change >= 0 else 'down' }}"></i>
                                {{ metrics.work_orders_change }}% vs période précédente
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="clay-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-shape bg-success text-white rounded-circle me-3">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <h3 class="mb-0">{{ metrics.completed_orders }}</h3>
                            <p class="text-muted mb-0">Terminés</p>
                            <small class="text-{{ 'success' if metrics.completion_rate >= 80 else 'warning' if metrics.completion_rate >= 60 else 'danger' }}">
                                {{ metrics.completion_rate }}% de réussite
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="clay-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-shape bg-warning text-white rounded-circle me-3">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div>
                            <h3 class="mb-0">{{ metrics.avg_resolution_time }}h</h3>
                            <p class="text-muted mb-0">Temps Moyen</p>
                            <small class="text-{{ 'success' if metrics.time_change <= 0 else 'danger' }}">
                                <i class="fas fa-arrow-{{ 'down' if metrics.time_change <= 0 else 'up' }}"></i>
                                {{ metrics.time_change|abs }}% vs objectif
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="clay-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-shape bg-info text-white rounded-circle me-3">
                            <i class="fas fa-euro-sign"></i>
                        </div>
                        <div>
                            <h3 class="mb-0">{{ metrics.total_revenue|round }}€</h3>
                            <p class="text-muted mb-0">Chiffre d'Affaires</p>
                            <small class="text-{{ 'success' if metrics.revenue_change >= 0 else 'danger' }}">
                                <i class="fas fa-arrow-{{ 'up' if metrics.revenue_change >= 0 else 'down' }}"></i>
                                {{ metrics.revenue_change }}% vs période précédente
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Graphique des tendances -->
            <div class="clay-card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Évolution des Interventions</h5>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="trendType" id="trend-daily" autocomplete="off" checked>
                        <label class="btn btn-outline-secondary btn-sm" for="trend-daily">Jour</label>
                        <input type="radio" class="btn-check" name="trendType" id="trend-weekly" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="trend-weekly">Semaine</label>
                        <input type="radio" class="btn-check" name="trendType" id="trend-monthly" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="trend-monthly">Mois</label>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="trendsChart" height="300"></canvas>
                </div>
            </div>

            <!-- Analyse de performance -->
            <div class="clay-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Performance par Zone</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Zone</th>
                                    <th>Interventions</th>
                                    <th>Taux de Réussite</th>
                                    <th>Temps Moyen</th>
                                    <th>Techniciens</th>
                                    <th>Charge</th>
                                    <th>Tendance</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for zone in zone_performance %}
                                <tr>
                                    <td>
                                        <div class="fw-bold">{{ zone.name }}</div>
                                        <small class="text-muted">{{ zone.coverage_area }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ zone.total_interventions }}</span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress me-2" style="width: 60px; height: 6px;">
                                                <div class="progress-bar bg-{{ 'success' if zone.success_rate >= 80 else 'warning' if zone.success_rate >= 60 else 'danger' }}" 
                                                     style="width: {{ zone.success_rate }}%"></div>
                                            </div>
                                            <span class="small">{{ zone.success_rate }}%</span>
                                        </div>
                                    </td>
                                    <td>{{ zone.avg_time }}h</td>
                                    <td>
                                        <span class="badge bg-info">{{ zone.technician_count }}</span>
                                    </td>
                                    <td>
                                        <div class="progress" style="width: 50px; height: 6px;">
                                            <div class="progress-bar bg-{{ 'success' if zone.workload < 60 else 'warning' if zone.workload < 80 else 'danger' }}" 
                                                 style="width: {{ zone.workload }}%"></div>
                                        </div>
                                        <small>{{ zone.workload }}%</small>
                                    </td>
                                    <td>
                                        <i class="fas fa-arrow-{{ 'up text-success' if zone.trend > 0 else 'down text-danger' if zone.trend < 0 else 'right text-muted' }}"></i>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Répartition par statut -->
            <div class="clay-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Répartition par Statut</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" height="250"></canvas>
                    <div class="mt-3">
                        {% for status in status_distribution %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <div class="status-color me-2" style="background-color: {{ status.color }};"></div>
                                <span>{{ status.label }}</span>
                            </div>
                            <span class="fw-bold">{{ status.count }} ({{ status.percentage }}%)</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Top techniciens -->
            <div class="clay-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-star me-2"></i>Top Techniciens</h5>
                </div>
                <div class="card-body">
                    {% for tech in top_technicians %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="position-relative me-3">
                            {% if tech.photo %}
                            <img src="{{ url_for('static', filename='uploads/photos/' + tech.photo) }}" 
                                 alt="{{ tech.name }}" class="rounded-circle" width="40" height="40">
                            {% else %}
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 40px; height: 40px; font-size: 14px;">
                                {{ tech.name[0].upper() }}
                            </div>
                            {% endif %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning">
                                {{ loop.index }}
                            </span>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">{{ tech.name }}</div>
                            <small class="text-muted">{{ tech.specialization }}</small>
                            <div class="mt-1">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-success" style="width: {{ tech.performance_score }}%"></div>
                                </div>
                                <small class="text-success">{{ tech.performance_score }}% performance</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">{{ tech.completed_interventions }}</div>
                            <small class="text-muted">interventions</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Alertes et notifications -->
            <div class="clay-card">
                <div class="card-header">
                    <h5 class="mb-0 text-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>Alertes
                    </h5>
                </div>
                <div class="card-body">
                    {% if alerts %}
                    {% for alert in alerts %}
                    <div class="alert alert-{{ alert.type }} p-2 mb-2">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-{{ alert.icon }} me-2 mt-1"></i>
                            <div class="flex-grow-1">
                                <div class="fw-bold">{{ alert.title }}</div>
                                <small>{{ alert.message }}</small>
                            </div>
                            {% if alert.action_url %}
                            <a href="{{ alert.action_url }}" class="btn btn-sm btn-outline-{{ alert.type }}">
                                Action
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <p>Aucune alerte active</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Analyse détaillée -->
    <div class="row mt-4">
        <div class="col-lg-6">
            <div class="clay-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Types d'Intervention</h5>
                </div>
                <div class="card-body">
                    <canvas id="interventionTypesChart" height="250"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="clay-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Temps de Résolution</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="mb-2">
                                <h4 class="mb-0 text-success">{{ time_metrics.under_4h }}%</h4>
                                <small class="text-muted">< 4h</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="mb-2">
                                <h4 class="mb-0 text-warning">{{ time_metrics.under_24h }}%</h4>
                                <small class="text-muted">< 24h</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="mb-2">
                                <h4 class="mb-0 text-danger">{{ time_metrics.over_24h }}%</h4>
                                <small class="text-muted">> 24h</small>
                            </div>
                        </div>
                    </div>
                    <canvas id="resolutionTimeChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal période personnalisée -->
<div class="modal fade" id="customPeriodModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sélectionner une Période</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="GET">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Date de début</label>
                                <input type="date" class="form-control clay-input" name="start_date" 
                                       value="{{ request.args.get('start_date', '') }}">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Date de fin</label>
                                <input type="date" class="form-control clay-input" name="end_date" 
                                       value="{{ request.args.get('end_date', '') }}">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary clay-button-primary">Appliquer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Actualisation du tableau de bord
function refreshDashboard() {
    location.reload();
}

// Export du tableau de bord
function exportDashboard() {
    const params = new URLSearchParams(window.location.search);
    params.append('export', 'pdf');
    window.location.href = '{{ url_for("analytics.dashboard") }}?' + params.toString();
}

// Initialisation des graphiques
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Chart !== 'undefined') {
        initTrendsChart();
        initStatusChart();
        initInterventionTypesChart();
        initResolutionTimeChart();
    }
    
    // Mise à jour automatique toutes les 5 minutes
    setInterval(refreshDashboard, 5 * 60 * 1000);
});

function initTrendsChart() {
    const ctx = document.getElementById('trendsChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ trend_data.labels|tojson }},
            datasets: [{
                label: 'Interventions',
                data: {{ trend_data.data|tojson }},
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function initStatusChart() {
    const ctx = document.getElementById('statusChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ status_chart.labels|tojson }},
            datasets: [{
                data: {{ status_chart.data|tojson }},
                backgroundColor: {{ status_chart.colors|tojson }}
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function initInterventionTypesChart() {
    const ctx = document.getElementById('interventionTypesChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ intervention_types.labels|tojson }},
            datasets: [{
                label: 'Nombre',
                data: {{ intervention_types.data|tojson }},
                backgroundColor: '#28a745'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function initResolutionTimeChart() {
    const ctx = document.getElementById('resolutionTimeChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['< 4h', '4-24h', '> 24h'],
            datasets: [{
                data: [{{ time_metrics.under_4h }}, {{ time_metrics.under_24h }}, {{ time_metrics.over_24h }}],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// Gestion du type de tendance
document.querySelectorAll('input[name="trendType"]').forEach(radio => {
    radio.addEventListener('change', function() {
        updateTrendsChart(this.value);
    });
});

function updateTrendsChart(type) {
    // Mettre à jour le graphique selon le type sélectionné
    fetch(`{{ url_for('api.get_trend_data') }}?type=${type}`)
        .then(response => response.json())
        .then(data => {
            // Mettre à jour les données du graphique
            console.log('Mise à jour du graphique:', type, data);
        });
}
</script>

<style>
.icon-shape {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.status-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

.progress {
    background-color: #e9ecef;
}

.alert {
    border: none;
    border-radius: 8px;
}

.badge {
    font-size: 0.75em;
}

.clay-card {
    transition: transform 0.2s ease;
}

.clay-card:hover {
    transform: translateY(-2px);
}

canvas {
    max-height: 300px;
}
</style>
{% endblock %}
