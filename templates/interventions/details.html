<!-- details.html -->

{% extends "base.html" %}

{% block title %}Intervention {{ work_order.claim_number }} - ChronoTech{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/intervention-details.css') }}">
{% endblock %}

{% block content %}
<div class="intervention-details-container">
    <div class="intervention-header clay-card">
        <div class="header-main">
            <div class="title-section">
                <h1>{{ work_order.claim_number }}</h1>
                <div class="subline">{{ work_order.customer_name }} · {{ work_order.vehicle_registration or work_order.vehicle_vin or '' }}</div>
            </div>
            <div class="header-actions">
                <button class="clay-btn clay-btn-primary" onclick="openAiAssistant()">Assistant IA</button>
                <button class="clay-btn clay-btn-primary" onclick="openPhotoCapture()">Photo</button>
                <button class="clay-btn clay-btn-primary" onclick="startVoiceNote()">Enregistrer</button>
            </div>
        </div>
        <div class="ai-summary small">
            <span class="ai-icon">IA</span>
            <span class="label">IA: {{ notes | length }} notes · {{ media | length }} médias</span>
        </div>
    </div>

    <div class="intervention-layout">
        <!-- Left: Vehicle info and AI summary -->
        <div class="main-column">
            <div class="vehicle-info clay-card">
                <h3>Véhicule</h3>
                <div class="vehicle-grid">
                    <div><strong>Marque:</strong> {{ work_order.vehicle_make or '—' }}</div>
                    <div><strong>Modèle:</strong> {{ work_order.vehicle_model or '—' }}</div>
                    <div><strong>Année:</strong> {{ work_order.vehicle_year or '—' }}</div>
                    <div><strong>Immatriculation / VIN:</strong> {{ work_order.vehicle_registration or work_order.vehicle_vin or '—' }}</div>
                    <div><strong>Kilométrage:</strong> {{ work_order.vehicle_mileage or '—' }}</div>
                </div>
            </div>

            <div class="ai-summary-panel clay-card">
                <h3>AI-Assisted Summary</h3>
                <p class="muted">L'IA lit les notes, médias et enregistrements liés et propose un résumé des pièces, actions et temps estimé.</p>
                <div>
                    <textarea id="ai-input" class="clay-textarea" rows="6" placeholder="Ajoutez des instructions supplémentaires pour l'IA (optionnel)"></textarea>
                    <div class="form-actions mt-2">
                        <button class="clay-btn clay-btn-primary" id="generateSummaryBtn">Générer le résumé IA</button>
                        <button class="clay-btn clay-btn-ghost" id="clearSummaryBtn">Effacer</button>
                    </div>
                </div>

                <div id="ai-summary-result" style="margin-top:1rem; display:none;">
                    <h4>Résumé IA</h4>
                    <div id="ai-summary-text" class="ai-output clay-card-nested"></div>
                    <div class="mt-2">
                        <button class="clay-btn clay-btn-success" id="acceptAiSummary">Accepter et ajouter aux notes</button>
                    </div>
                </div>
            </div>

            <div class="notes-interface clay-card">
                <h3>Notes</h3>
                <textarea id="note-content" class="clay-textarea" rows="4" placeholder="Ajouter une note..."></textarea>
                <div class="form-actions mt-2">
                    <button class="clay-btn clay-btn-primary" onclick="addNote()">Ajouter la note</button>
                </div>

                <div class="notes-list mt-3">
                    {% for note in notes %}
                    <div class="note-item clay-card-nested">
                        <div class="note-header"><strong>{{ note.technician_name }}</strong> · <span class="muted">{{ moment(note.created_at).fromNow() }}</span></div>
                        <div class="note-content">{{ note.content }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Right: Photo upload, audio, and media gallery -->
        <div class="sidebar-column">
            <div class="photo-uploader clay-card">
                <h3>Photos</h3>
                <div class="uploader-area">
                    <input type="file" id="photoInput" accept="image/*" multiple style="display:none;" onchange="handlePhotoFiles(this.files)">
                    <div class="uploader-dropzone" id="photoDropzone" onclick="document.getElementById('photoInput').click()">
                        <div class="dz-text">Cliquez ou déposez des photos ici</div>
                        <div class="dz-sub">JPG, PNG — Plusieurs sélection possibles</div>
                    </div>
                    <div id="photoPreview" class="photo-preview-grid mt-2"></div>
                    <div class="form-actions mt-2">
                        <button class="clay-btn clay-btn-primary" onclick="uploadSelectedPhotos()">Téléverser photos</button>
                    </div>
                </div>
            </div>

            <div class="voice-uploader clay-card">
                <h3>Audio / Enregistrement</h3>

                <div class="mb-3">
                    <label class="form-label">Source</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="source" id="sourceFile" value="file" checked>
                            <label class="form-check-label" for="sourceFile">Upload file</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="source" id="sourceMic" value="mic">
                            <label class="form-check-label" for="sourceMic">Use microphone</label>
                        </div>
                    </div>
                </div>

                <div class="mb-3" id="fileRow">
                    <label for="fileInput" class="form-label">Audio file</label>
                    <input class="form-control" type="file" id="fileInput" accept="audio/*">
                </div>

                <div class="mb-3" id="micRow" style="display:none;">
                    <label class="form-label">Microphone</label>
                    <div>
                        <button type="button" id="startRec" class="btn btn-outline-primary btn-sm">Start Recording</button>
                        <button type="button" id="stopRec" class="btn btn-outline-danger btn-sm" disabled>Stop</button>
                        <button type="button" id="playRec" class="btn btn-outline-secondary btn-sm" disabled>Play</button>
                        <span id="recStatus" class="ms-2 text-muted">Not recording</span>
                    </div>
                    <div class="mt-2">
                        <audio id="audioPreview" controls style="width:100%; display:none;"></audio>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="mode" class="form-label">Mode</label>
                    <select id="mode" class="form-select">
                        <option value="transcribe">Transcribe</option>
                        <option value="translate">Translate</option>
                    </select>
                </div>

                <div class="mb-3" id="langRow" style="display:none;">
                    <label for="target_lang" class="form-label">Target language (e.g. French, Spanish, de)</label>
                    <input type="text" id="target_lang" class="form-control">
                </div>

                <button class="btn btn-primary" type="submit" id="submitBtn">Upload</button>

                <hr />
                <h4>Result</h4>
                <pre id="result" style="white-space:pre-wrap;">No results yet.</pre>
            </div>

            <div class="media-gallery clay-card mt-2">
                <h3>Galerie</h3>
                <div class="media-grid">
                    {% for item in media %}
                    <div class="media-item {{ item.media_type }}">
                        {% if item.media_type == 'photo' %}
                        <img src="{{ url_for('static', filename=item.file_path) }}" alt="photo" onclick="openMediaViewer('{{ item.file_path }}')">
                        {% elif item.media_type == 'audio' %}
                        <div class="audio-row">Audio <button class="clay-btn clay-btn-ghost" onclick="playMedia('{{ item.file_path }}')">Play</button></div>
                        {% else %}
                        <div class="media-row">{{ item.file_path }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Simple media viewer modal -->
<div id="media-viewer-modal" class="clay-modal" style="display:none;">
    <div class="clay-modal-content">
        <div class="clay-modal-header">
            <h3>Visualiseur média</h3>
            <button class="clay-modal-close" onclick="closeMediaViewer()">&times;</button>
        </div>
        <div class="clay-modal-body" id="media-viewer-body"></div>
    </div>
</div>
    <div class="clay-modal-content large">
        <div class="clay-modal-header">
            <h3>Visualisation média</h3>
            <button class="clay-modal-close" onclick="closeMediaViewer()">&times;</button>
        </div>
        <div class="clay-modal-body">
            <div id="media-viewer-content">
                <!-- Contenu chargé dynamiquement -->
            </div>
        </div>
    </div>
</div>

<!-- Interface de capture photo -->
<div id="photo-capture-modal" class="clay-modal" style="display:none;">
    <div class="clay-modal-content">
        <div class="clay-modal-header">
            <h3>Capture photo</h3>
            <button class="clay-modal-close" onclick="closePhotoCapture()">&times;</button>
        </div>
        <div class="clay-modal-body">
            <div class="camera-interface">
                <video id="camera-feed" autoplay playsinline></video>
                <canvas id="photo-canvas" style="display:none;"></canvas>
                <div class="camera-controls">
                    <button id="capture-btn" class="clay-btn clay-btn-primary">Capturer</button>
                    <button id="retake-btn" class="clay-btn clay-btn-ghost" style="display:none;">Reprendre</button>
                    <button id="save-photo-btn" class="clay-btn clay-btn-success" style="display:none;">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const workOrderId = {{ work_order.id }};

// --- Photo upload handling ---
let selectedPhotos = [];
function handlePhotoFiles(files) {
    selectedPhotos = Array.from(files);
    const preview = document.getElementById('photoPreview');
    preview.innerHTML = '';
    selectedPhotos.forEach((f, i) => {
        const url = URL.createObjectURL(f);
        const img = document.createElement('img');
        img.src = url;
        img.style.maxWidth = '120px';
        img.style.margin = '4px';
        preview.appendChild(img);
    });
}

async function uploadSelectedPhotos() {
    if (!selectedPhotos.length) return alert('Aucune photo sélectionnée');
    const fd = new FormData();
    selectedPhotos.forEach((f, i) => fd.append('photos', f, f.name));
    const resp = await fetch(`/interventions/${workOrderId}/upload_photos`, { method: 'POST', body: fd });
    const json = await resp.json();
    if (json.success) location.reload(); else alert('Upload failed');
}

// --- Audio / recording handling (new implementation) ---

// Initialize audio interface after DOM is loaded
function initAudioInterface() {
    // UI toggles
    const sourceFile = document.getElementById('sourceFile');
    const sourceMic = document.getElementById('sourceMic');
    const fileRow = document.getElementById('fileRow');
    const micRow = document.getElementById('micRow');
    const modeEl = document.getElementById('mode');
    const langRow = document.getElementById('langRow');

    if (sourceFile && sourceMic && fileRow && micRow) {
        sourceFile.addEventListener('change', () => { 
            fileRow.style.display = 'block'; 
            micRow.style.display = 'none'; 
        });
        
        sourceMic.addEventListener('change', () => { 
            fileRow.style.display = 'none'; 
            micRow.style.display = 'block'; 
        });
    }

    if (modeEl && langRow) {
        modeEl.addEventListener('change', function(e) {
            langRow.style.display = e.target.value === 'translate' ? 'block' : 'none';
        });
    }

    // Initialize recording functionality
    initRecording();
}

function initRecording() {

function initRecording() {
    // Microphone recording logic
    let mediaRecorder = null;
    let audioChunks = [];
    let recordedBlob = null;

    const startBtn = document.getElementById('startRec');
    const stopBtn = document.getElementById('stopRec');
    const playBtn = document.getElementById('playRec');
    const recStatus = document.getElementById('recStatus');
    const audioPreview = document.getElementById('audioPreview');

    if (!startBtn || !stopBtn || !playBtn || !recStatus || !audioPreview) {
        console.warn('Audio recording elements not found');
        return;
    }

    startBtn.addEventListener('click', async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioChunks = [];
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.addEventListener('dataavailable', e => {
                if (e.data && e.data.size > 0) audioChunks.push(e.data);
            });
            mediaRecorder.addEventListener('start', () => {
                recordedBlob = null;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                playBtn.disabled = true;
                recStatus.textContent = 'Recording...';
                // Show live preview while recording
                try {
                    audioPreview.style.display = 'block';
                    audioPreview.src = '';
                    audioPreview.autoplay = true;
                    audioPreview.srcObject = stream;
                } catch (err) {
                    console.warn('Live preview not available for this browser/codec.', err);
                }
            });
            mediaRecorder.addEventListener('stop', () => {
                recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(recordedBlob);
                // Stop live preview and show recorded blob
                try {
                    audioPreview.srcObject = null;
                    audioPreview.autoplay = false;
                } catch (err) {
                    // ignore
                }
                audioPreview.src = url;
                audioPreview.style.display = 'block';
                playBtn.disabled = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                recStatus.textContent = 'Recording stopped';
            });
            mediaRecorder.start();
        } catch (err) {
            recStatus.textContent = 'Microphone access denied or unavailable';
            console.error(err);
        }
    });

    stopBtn.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
    });

    playBtn.addEventListener('click', () => {
        if (audioPreview.src) {
            audioPreview.play();
        }
    });

    // Form submit handler
    const uploadBtn = document.getElementById('uploadAudioBtn');
    if (uploadBtn) {
        uploadBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            const resultEl = document.getElementById('result');
            if (!resultEl) return;
            
            resultEl.textContent = 'Preparing upload...';

            const formData = new FormData();
            const sourceRadio = document.querySelector('input[name="source"]:checked');
            const modeSelect = document.getElementById('mode');
            const targetLangInput = document.getElementById('target_lang');
            
            if (!sourceRadio || !modeSelect) {
                resultEl.textContent = 'Interface elements not found';
                return;
            }
            
            const source = sourceRadio.value;
            const mode = modeSelect.value;
            const target_lang = targetLangInput ? targetLangInput.value : '';

            formData.append('mode', mode);
            // Attach selected company and bon_id if present
            const urlParams = new URLSearchParams(window.location.search);
            const qCompany = urlParams.get('company');
            const qBon = urlParams.get('bon_id');
            if (qCompany) formData.append('company', qCompany);
            if (qBon) formData.append('bon_id', qBon);
            if (target_lang) formData.append('target_lang', target_lang);

            if (source === 'mic') {
                if (!recordedBlob) {
                    resultEl.textContent = 'No recording available. Please record audio first.';
                    return;
                }
                // Provide a filename and ensure a compatible MIME (webm/ogg) - OpenAI accepts many formats
                formData.append('file', recordedBlob, 'microphone.webm');
            } else {
                const fileInput = document.getElementById('fileInput');
                if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                    resultEl.textContent = 'No file selected.';
                    return;
                }
                formData.append('file', fileInput.files[0]);
            }

            resultEl.textContent = 'Uploading...';
            try {
                const resp = await fetch('/api/openai/audio', { method: 'POST', body: formData });
                const json = await resp.json();
                if (!resp.ok) {
                    resultEl.textContent = 'Error: ' + JSON.stringify(json, null, 2);
                    return;
                }
                resultEl.textContent = JSON.stringify(json, null, 2);
            } catch (err) {
                resultEl.textContent = 'Network error: ' + err.message;
            }
        });
    }
}

// --- AI Summary interaction ---
const generateSummaryBtn = document.getElementById('generateSummaryBtn');
const clearSummaryBtn = document.getElementById('clearSummaryBtn');
const acceptAiSummary = document.getElementById('acceptAiSummary');

if (generateSummaryBtn) {
    generateSummaryBtn.addEventListener('click', generateAiSummary);
}

if (clearSummaryBtn) {
    clearSummaryBtn.addEventListener('click', () => {
        document.getElementById('ai-input').value = '';
        document.getElementById('ai-summary-result').style.display = 'none';
    });
}

if (acceptAiSummary) {
    acceptAiSummary.addEventListener('click', acceptAiSummaryHandler);
}

async function generateAiSummary() {
    const extra = document.getElementById('ai-input').value.trim();
    document.getElementById('ai-summary-text').textContent = 'Generating...';
    document.getElementById('ai-summary-result').style.display = 'block';
    try {
        const resp = await fetch(`/interventions/ai/generate_summary/${workOrderId}`, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ extra }) 
        });
        const j = await resp.json();
        if (j.success) document.getElementById('ai-summary-text').textContent = j.summary;
        else document.getElementById('ai-summary-text').textContent = 'AI generation failed';
    } catch (err) { 
        document.getElementById('ai-summary-text').textContent = 'Network error'; 
    }
}

async function acceptAiSummaryHandler() {
    const summary = document.getElementById('ai-summary-text').textContent || '';
    if (!summary) return alert('No summary to accept');
    const fd = new FormData(); 
    fd.append('content', summary); 
    fd.append('note_type', 'internal');
    const resp = await fetch(`/interventions/${workOrderId}/add_note`, { method: 'POST', body: fd });
    const j = await resp.json(); 
    if (j.success) location.reload(); 
    else alert('Failed to save note');
}

// --- Media viewer helpers ---
function openMediaViewer(path) { 
    document.getElementById('media-viewer-body').innerHTML = `<img src='${path}' style='max-width:100%'>`; 
    document.getElementById('media-viewer-modal').style.display = 'block'; 
}

function closeMediaViewer() { 
    document.getElementById('media-viewer-modal').style.display = 'none'; 
}

function playMedia(path) { 
    const a = new Audio(path); 
    a.play(); 
}

// --- Notes ---
async function addNote() {
    const content = document.getElementById('note-content').value.trim();
    if (!content) return alert('Veuillez saisir une note');
    const fd = new FormData(); 
    fd.append('content', content); 
    fd.append('note_type', 'internal');
    const resp = await fetch(`/interventions/${workOrderId}/add_note`, { method: 'POST', body: fd });
    const j = await resp.json(); 
    if (j.success) location.reload(); 
    else alert('Failed to add note');
}

// --- Placeholder functions for buttons that might not have implementations yet ---
function openAiAssistant() {
    alert('AI Assistant functionality to be implemented');
}

function openPhotoCapture() {
    alert('Photo capture functionality to be implemented');
}

function startVoiceNote() {
    alert('Voice note functionality to be implemented');
}
</script>
{% endblock %}