{% extends "base.html" %}

{% block title %}Intervention {{ work_order.claim_number }} - ChronoTech{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/claymorphism.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/interventions-claymorphism.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/intervention-details.css') }}">
<style>
    .ai-tools-container {
        background: linear-gradient(145deg, var(--secondary-color), rgba(255,255,255,0.05)) !important;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .tool-card {
        background: linear-gradient(145deg, var(--clay-bg-light), var(--clay-bg-dark));
        box-shadow: var(--shadow-light);
        border: 1px solid rgba(255,255,255,0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .tool-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transition: left 0.5s;
    }
    
    .tool-card:hover::before {
        left: 100%;
    }
    
    .tool-card:active {
        transform: translateY(-2px) scale(0.98) !important;
    }
    
    .tool-badge {
        background: linear-gradient(45deg, var(--primary-color), var(--accent-color)) !important;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .tool-icon {
        transition: all 0.3s ease;
    }
    
    .tool-card:hover .tool-icon {
        transform: scale(1.1);
        filter: brightness(1.2);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .ai-tools-container .row {
            margin: 0;
        }
        .tool-card {
            height: 100px !important;
            padding: 1rem !important;
        }
        .tool-icon {
            font-size: 2rem !important;
        }
    }
    
    @media (max-width: 992px) {
        .ai-tools-container .col-lg-3 {
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Script pour définir les variables globales -->
<script>
    const workOrderId = {% if work_order and work_order.id %}{{ work_order.id | tojson }}{% else %}null{% endif %};
    const userRole = {{ session.get('role', 'user') | tojson }};
</script>

<div class="container-fluid" style="background: var(--bg-color); min-height: 100vh; padding: 2rem;">
    <div class="row">
        <div class="col-md-8">
            {% include 'interventions/_vehicle_info.html' %}
            
            <!-- Outils IA et Notes - Interface Unifiée (5 outils) -->
            <div class="ai-tools-container clay-card" style="margin-bottom: 2rem; padding: 2rem; background: linear-gradient(145deg, var(--secondary-color), rgba(255,255,255,0.1));">
                <div class="row g-3">
                    <!-- Informations Client -->
                    <div class="col-xl-2 col-lg-3 col-md-6">
                        <div class="tool-card clay-element" style="position: relative; padding: 1.5rem; text-align: center; height: 120px; display: flex; flex-direction: column; justify-content: center; cursor: pointer; transition: all 0.3s ease; border-radius: var(--border-radius);"
                             data-bs-toggle="modal" data-bs-target="#customerModal"
                             data-bs-toggle="tooltip" data-bs-placement="top"
                             title="Consultez les informations détaillées du client"
                             onmouseover="this.style.transform='translateY(-5px) scale(1.02)'; this.style.boxShadow='var(--shadow-hover)'"
                             onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='var(--shadow-light)'">
                            <div class="tool-icon" style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 0.5rem;">
                                <i class="fas fa-user"></i>
                            </div>
                            <h6 style="margin: 0; color: var(--text-color); font-weight: 600; font-size: 0.95rem;">Informations Client</h6>
                            <div class="tool-badge" style="position: absolute; top: 8px; right: 8px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                                CLIENT
                            </div>
                        </div>
                    </div>
                    
                    <!-- Suggestions Intelligentes IA -->
                    <div class="col-xl-2 col-lg-3 col-md-6">
                        <div class="tool-card clay-element" style="position: relative; padding: 1.5rem; text-align: center; height: 120px; display: flex; flex-direction: column; justify-content: center; cursor: pointer; transition: all 0.3s ease; border-radius: var(--border-radius);"
                             data-bs-toggle="modal" data-bs-target="#suggestionsModal"
                             data-bs-toggle="tooltip" data-bs-placement="top" 
                             title="Accédez aux analyses IA, recherche rapide et suggestions contextuelles"
                             onmouseover="this.style.transform='translateY(-5px) scale(1.02)'; this.style.boxShadow='var(--shadow-hover)'"
                             onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='var(--shadow-light)'">
                            <div class="tool-icon" style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 0.5rem;">
                                <i class="fas fa-brain"></i>
                            </div>
                            <h6 style="margin: 0; color: var(--text-color); font-weight: 600; font-size: 0.95rem;">Suggestions IA</h6>
                            <div class="tool-badge" style="position: absolute; top: 8px; right: 8px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                                SMART
                            </div>
                        </div>
                    </div>
                    
                    <!-- Assistant IA Chat -->
                    <div class="col-xl-2 col-lg-3 col-md-6">
                        <div class="tool-card clay-element" style="position: relative; padding: 1.5rem; text-align: center; height: 120px; display: flex; flex-direction: column; justify-content: center; cursor: pointer; transition: all 0.3s ease; border-radius: var(--border-radius);"
                             data-bs-toggle="modal" data-bs-target="#aiChatModal"
                             data-bs-toggle="tooltip" data-bs-placement="top"
                             title="Générez des résumés techniques, rapports clients et analyses avec l'IA"
                             onmouseover="this.style.transform='translateY(-5px) scale(1.02)'; this.style.boxShadow='var(--shadow-hover)'"
                             onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='var(--shadow-light)'">
                            <div class="tool-icon" style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 0.5rem;">
                                <i class="fas fa-robot"></i>
                            </div>
                            <h6 style="margin: 0; color: var(--text-color); font-weight: 600; font-size: 0.95rem;">Assistant IA</h6>
                            <div class="tool-badge" style="position: absolute; top: 8px; right: 8px; background: linear-gradient(45deg, #f093fb, #f5576c); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                                CHAT
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enregistrement Audio -->
                    <div class="col-xl-2 col-lg-3 col-md-6">
                        <div class="tool-card clay-element" style="position: relative; padding: 1.5rem; text-align: center; height: 120px; display: flex; flex-direction: column; justify-content: center; cursor: pointer; transition: all 0.3s ease; border-radius: var(--border-radius);"
                             data-bs-toggle="modal" data-bs-target="#audioModal"
                             data-bs-toggle="tooltip" data-bs-placement="top"
                             title="Enregistrez et transcrivez des notes audio avec IA"
                             onmouseover="this.style.transform='translateY(-5px) scale(1.02)'; this.style.boxShadow='var(--shadow-hover)'"
                             onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='var(--shadow-light)'">
                            <div class="tool-icon" style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 0.5rem;">
                                <i class="fas fa-microphone"></i>
                            </div>
                            <h6 style="margin: 0; color: var(--text-color); font-weight: 600; font-size: 0.95rem;">Enregistrement Audio</h6>
                            <div class="tool-badge" style="position: absolute; top: 8px; right: 8px; background: linear-gradient(45deg, #43e97b, #38f9d7); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                                AUDIO
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes et Commentaires -->
                    <div class="col-xl-2 col-lg-3 col-md-6">
                        <div class="tool-card clay-element" style="position: relative; padding: 1.5rem; text-align: center; height: 120px; display: flex; flex-direction: column; justify-content: center; cursor: pointer; transition: all 0.3s ease; border-radius: var(--border-radius);"
                             data-bs-toggle="modal" data-bs-target="#notesCommentsModal"
                             data-bs-toggle="tooltip" data-bs-placement="top"
                             title="Gérez les notes d'intervention et commentaires internes"
                             onmouseover="this.style.transform='translateY(-5px) scale(1.02)'; this.style.boxShadow='var(--shadow-hover)'"
                             onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='var(--shadow-light)'">
                            <div class="tool-icon" style="font-size: 2.5rem; color: var(--primary-color); margin-bottom: 0.5rem;">
                                <i class="fas fa-sticky-note"></i>
                            </div>
                            <h6 style="margin: 0; color: var(--text-color); font-weight: 600; font-size: 0.95rem;">Notes & Commentaires</h6>
                            <div class="tool-badge" style="position: absolute; top: 8px; right: 8px; background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                                DOCS
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Indicateur d'état -->
                <div class="tools-status" style="margin-top: 1rem; text-align: center;">
                    <small style="color: var(--text-color); opacity: 0.7; font-size: 0.8rem;">
                        <i class="fas fa-info-circle me-1"></i>Cliquez sur un outil pour l'ouvrir en mode plein écran
                    </small>
                </div>
            </div>
            
        </div>
        <div class="col-md-4">
            {% include 'interventions/_right_column.html' %}
        </div>
    </div>
</div>

<!-- Modal Enregistrement Audio -->
<div class="modal fade" id="audioModal" tabindex="-1" aria-labelledby="audioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content clay-card" style="background: var(--secondary-color); border: none; border-radius: var(--border-radius);">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), #4c51bf); color: white; border: none; border-radius: var(--border-radius) var(--border-radius) 0 0;">
                <h5 class="modal-title" id="audioModalLabel" style="font-weight: 600;">
                    <i class="fas fa-microphone me-2"></i>Enregistrement et Transcription Audio
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 0;">
                {% include 'interventions/_audio_panel.html' %}
            </div>
        </div>
    </div>
</div>

<!-- Modal des Suggestions Intelligentes -->
<div class="modal fade" id="suggestionsModal" tabindex="-1" aria-labelledby="suggestionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content clay-card" style="background: var(--secondary-color); border: none; border-radius: var(--border-radius);">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), #4c51bf); color: white; border: none; border-radius: var(--border-radius) var(--border-radius) 0 0;">
                <h5 class="modal-title" id="suggestionsModalLabel" style="font-weight: 600;">
                    <i class="fas fa-brain me-2"></i>Suggestions Intelligentes IA
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 0;">
                {% include 'interventions/_suggestions_panel.html' %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Notes et Commentaires -->
<div class="modal fade" id="notesCommentsModal" tabindex="-1" aria-labelledby="notesCommentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content clay-card" style="background: var(--secondary-color); border: none; border-radius: var(--border-radius);">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), #4c51bf); color: white; border: none; border-radius: var(--border-radius) var(--border-radius) 0 0;">
                <h5 class="modal-title" id="notesCommentsModalLabel" style="font-weight: 600;">
                    <i class="fas fa-sticky-note me-2"></i>Notes et Commentaires d'intervention
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 0;">
                {% include 'interventions/_notes_comments_tabs.html' %}
            </div>
        </div>
    </div>
</div>

<!-- Modal de l'Assistant IA -->
<div class="modal fade" id="aiChatModal" tabindex="-1" aria-labelledby="aiChatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content clay-card" style="background: var(--secondary-color); border: none; border-radius: var(--border-radius);">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), #4c51bf); color: white; border: none; border-radius: var(--border-radius) var(--border-radius) 0 0;">
                <h5 class="modal-title" id="aiChatModalLabel" style="font-weight: 600;">
                    <i class="fas fa-robot me-2"></i>Assistant IA - Résumé d'intervention
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 0;">
                {% include 'interventions/_ai_chat_panel.html' %}
            </div>
        </div>
    </div>
</div>

<!-- Modal - Informations Client -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content clay-element" style="border: none; box-shadow: var(--shadow-strong); background: var(--bg-color);">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom: none; padding: 1.5rem 2rem;">
                <h4 class="modal-title" id="customerModalLabel" style="margin: 0; font-weight: 600; display: flex; align-items: center;">
                    <i class="fas fa-user me-3" style="font-size: 1.5rem;"></i>
                    Informations Client
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="margin: 0;"></button>
            </div>
            <div class="modal-body" style="padding: 2rem; background: var(--bg-color);">
                <div class="row g-4">
                    <!-- Informations de base du client -->
                    <div class="col-lg-6">
                        <div class="clay-card" style="padding: 1.5rem; height: 100%;">
                            <h5 style="color: var(--primary-color); margin-bottom: 1.5rem; display: flex; align-items: center;">
                                <i class="fas fa-user-circle me-2"></i>
                                Informations Personnelles
                            </h5>
                            <div class="info-grid">
                                <div class="info-item" style="margin-bottom: 1rem; padding: 1rem; background: var(--secondary-color); border-radius: var(--border-radius);">
                                    <label style="font-weight: 600; color: var(--text-color); display: flex; align-items: center; margin-bottom: 0.5rem;">
                                        <i class="fas fa-signature me-2" style="color: var(--primary-color);"></i>
                                        Nom complet
                                    </label>
                                    <div style="font-size: 1.1rem; color: var(--text-color);">
                                        {{ work_order.customer_name }}
                                    </div>
                                </div>
                                
                                <div class="info-item" style="margin-bottom: 1rem; padding: 1rem; background: var(--secondary-color); border-radius: var(--border-radius);">
                                    <label style="font-weight: 600; color: var(--text-color); display: flex; align-items: center; margin-bottom: 0.5rem;">
                                        <i class="fas fa-phone me-2" style="color: var(--primary-color);"></i>
                                        Téléphone
                                    </label>
                                    <div style="font-size: 1.1rem; color: var(--text-color);">
                                        {% if work_order.customer_phone %}
                                            <a href="tel:{{ work_order.customer_phone }}" style="color: var(--primary-color); text-decoration: none;">
                                                {{ work_order.customer_phone }}
                                            </a>
                                        {% else %}
                                            <span style="color: #888; font-style: italic;">Non renseigné</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="info-item" style="margin-bottom: 1rem; padding: 1rem; background: var(--secondary-color); border-radius: var(--border-radius);">
                                    <label style="font-weight: 600; color: var(--text-color); display: flex; align-items: center; margin-bottom: 0.5rem;">
                                        <i class="fas fa-envelope me-2" style="color: var(--primary-color);"></i>
                                        Email
                                    </label>
                                    <div style="font-size: 1.1rem; color: var(--text-color);">
                                        {% if work_order.customer_email %}
                                            <a href="mailto:{{ work_order.customer_email }}" style="color: var(--primary-color); text-decoration: none;">
                                                {{ work_order.customer_email }}
                                            </a>
                                        {% else %}
                                            <span style="color: #888; font-style: italic;">Non renseigné</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Adresse et localisation -->
                    <div class="col-lg-6">
                        <div class="clay-card" style="padding: 1.5rem; height: 100%;">
                            <h5 style="color: var(--primary-color); margin-bottom: 1.5rem; display: flex; align-items: center;">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                Adresse & Localisation
                            </h5>
                            <div class="address-info" style="padding: 1rem; background: var(--secondary-color); border-radius: var(--border-radius);">
                                {% if work_order.customer_address %}
                                    <div style="font-size: 1.1rem; color: var(--text-color); line-height: 1.6;">
                                        {{ work_order.customer_address }}
                                    </div>
                                    <div style="margin-top: 1rem;">
                                        <a href="https://maps.google.com/?q={{ work_order.customer_address|urlencode }}" 
                                           target="_blank" 
                                           class="btn btn-primary btn-sm" 
                                           style="background: linear-gradient(45deg, var(--primary-color), #667eea); border: none;">
                                            <i class="fas fa-map me-1"></i>
                                            Voir sur Google Maps
                                        </a>
                                    </div>
                                {% else %}
                                    <div style="color: #888; font-style: italic; text-align: center; padding: 2rem;">
                                        <i class="fas fa-map-marker-alt" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                        <br>Adresse non renseignée
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Historique et actions rapides -->
                    <div class="col-12">
                        <div class="clay-card" style="padding: 1.5rem;">
                            <h5 style="color: var(--primary-color); margin-bottom: 1.5rem; display: flex; align-items: center;">
                                <i class="fas fa-history me-2"></i>
                                Actions Rapides
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <button class="btn btn-outline-primary w-100" style="border: 2px solid var(--primary-color); background: transparent; color: var(--primary-color); transition: all 0.3s;">
                                        <i class="fas fa-edit me-2"></i>
                                        Modifier Client
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-success w-100" style="border: 2px solid #28a745; background: transparent; color: #28a745; transition: all 0.3s;">
                                        <i class="fas fa-file-invoice me-2"></i>
                                        Nouvelle Facture
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-info w-100" style="border: 2px solid #17a2b8; background: transparent; color: #17a2b8; transition: all 0.3s;">
                                        <i class="fas fa-clock me-2"></i>
                                        Historique
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-warning w-100" style="border: 2px solid #ffc107; background: transparent; color: #ffc107; transition: all 0.3s;">
                                        <i class="fas fa-star me-2"></i>
                                        Marquer Favori
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background: var(--secondary-color); border-top: 1px solid rgba(255,255,255,0.1); padding: 1rem 2rem;">
                <small style="color: var(--text-color); opacity: 0.7;">
                    <i class="fas fa-info-circle me-1"></i>
                    Dernière mise à jour: {{ work_order.updated_at.strftime('%d/%m/%Y à %H:%M') if work_order.updated_at else 'Non disponible' }}
                </small>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background: var(--clay-bg); border: 1px solid var(--clay-border); color: var(--text-color);">
                    <i class="fas fa-times me-1"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modale d'historique des temps -->
{% include 'interventions/_time_history_modal.html' %}

{% endblock %}

{% block scripts %}
{% include 'interventions/_details_scripts.html' %}
{% endblock %}
