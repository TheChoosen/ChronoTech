<div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
        <i class="fas fa-list me-2"></i>Liste des Clients
        <span class="badge bg-secondary">{{ pagination.total }} résultat(s)</span>
    </h5>
    <div class="d-flex gap-2">
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="view" id="view-grid" autocomplete="off" checked>
            <label class="btn btn-outline-secondary btn-sm clay-button" for="view-grid" onclick="switchView('grid')">
                <i class="fas fa-th"></i>
            </label>
            <input type="radio" class="btn-check" name="view" id="view-list" autocomplete="off">
            <label class="btn btn-outline-secondary btn-sm clay-button" for="view-list" onclick="switchView('list')">
                <i class="fas fa-list"></i>
            </label>
        </div>
    </div>
</div>

<!-- Vue grille (par défaut) -->
<div class="card-body" id="gridView">
    {% if customers %}
    <div class="row">
    {% for customer in customers %}
    {% set _status_l = (customer.status or '')|string|lower %}
    {% set is_active_flag = ((customer.is_active is defined) and (customer.is_active == 1 or customer.is_active == '1' or customer.is_active is sameas true)) or (_status_l in ['active', 'actif']) %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 customer-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex align-items-center">
                            <div class="avatar-circle me-3">
                                {% if customer.avatar %}
                                <img src="{{ url_for('static', filename='uploads/avatars/' + customer.avatar) }}" alt="{{ customer.name }}" class="rounded-circle" width="48" height="48">
                                {% else %}
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                    {{ customer.name[0].upper() }}
                                </div>
                                {% endif %}
                            </div>
                            <div>
                                <h6 class="mb-1">{{ customer.name }}
                                    {% if (customer.vehicles_count or 0) == 0 %}
                                    <i class="fa-solid fa-car text-danger"></i>
                                    {% endif %}
                                    {% if not is_active_flag %}
                                    <span class="badge bg-secondary ms-2" title="Client inactif">Inactif</span>
                                    {% else %}
                                    <span class="badge bg-success ms-2" title="Client actif">Actif</span>
                                    {% endif %}
                                </h6>
                                <span class="badge {{ customer.customer_type|customer_type_badge }} mb-1">
                                    {% if customer.customer_type == 'individual' %}Particulier
                                    {% elif customer.customer_type == 'company' %}Entreprise
                                    {% elif customer.customer_type == 'government' %}Administration
                                    {% else %}{{ customer.customer_type }}{% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('customers.view_customer', customer_id=customer.id) }}">
                                        <i class="fas fa-eye me-2"></i>Voir
                                    </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('customers.edit_customer', customer_id=customer.id) }}">
                                        <i class="fas fa-edit me-2"></i>Modifier
                                    </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('work_orders.create_work_order', customer_id=customer.id) }}">
                                        <i class="fas fa-plus me-2"></i>Créer un bon de travail
                                    </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('vehicles.new') }}?customer_id={{ customer.id }}">
                                        <i class="fas fa-car me-2"></i>Créer un véhicule
                                    </a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                {% if current_user.role in ['admin', 'supervisor'] %}
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteCustomer({{ customer.id }})">
                                        <i class="fas fa-trash me-2"></i>Supprimer
                                    </a></li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>

                    <div class="customer-info">
                        {% if customer.email %}
                        <p class="mb-1"><i class="fas fa-envelope text-muted me-2"></i><a href="mailto:{{ customer.email }}">{{ customer.email }}</a></p>
                        {% endif %}
                        {% if customer.phone %}
                        <p class="mb-1"><i class="fas fa-phone text-muted me-2"></i><a href="tel:{{ customer.phone }}">{{ customer.phone }}</a></p>
                        {% endif %}
                        {% if customer.city %}
                        <p class="mb-1"><i class="fas fa-map-marker-alt text-muted me-2"></i>{{ customer.city }}</p>
                        {% endif %}
                        {% if customer.company %}
                        <p class="mb-1"><i class="fas fa-building text-muted me-2"></i>{{ customer.company }}</p>
                        {% endif %}
                    </div>

                    <hr>

                    <!-- Statistiques client -->
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="stat-item">
                                <h6 class="mb-0">{{ customer.work_orders_count or 0 }}</h6>
                                <small class="text-muted">Interventions</small>
                                <small class="text-muted d-block">Véhicules: {{ customer.vehicles_count or 0 }}</small>
                                {% if (customer.vehicles_count or 0) == 0 %}
                                <div class="mt-1"><small class="text-danger">Aucun véhicule associé</small></div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item">
                                <h6 class="mb-0">{{ customer.total_spent|currency if customer.total_spent else '0 €' }}</h6>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item">
                                <h6 class="mb-0">
                                    {% if customer.last_order_date %}
                                    {{ customer.last_order_date|days_ago }}j
                                    {% else %}
                                    -
                                    {% endif %}
                                </h6>
                                <small class="text-muted">Dernier</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="customer-status-flag" title="{{ (customer.status or 'Statut inconnu')|capitalize }}">
                            {% if _status_l in ['active', 'actif'] %}
                                <i class="fas fa-check-circle text-success" aria-hidden="true"></i>
                            {% elif _status_l in ['inactive', 'inactif'] %}
                                <i class="fas fa-times-circle text-secondary" aria-hidden="true"></i>
                            {% elif _status_l == 'prospect' %}
                                <i class="fas fa-exclamation-circle text-warning" aria-hidden="true"></i>
                            {% else %}
                                <i class="fas fa-question-circle text-muted" aria-hidden="true"></i>
                            {% endif %}
                            <span class="visually-hidden">{{ customer.status if customer.status else 'statut inconnu' }}</span>
                        </span>
                        <small class="text-muted">Créé {{ customer.created_at|datetime_format('short') }}</small>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-4">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h5>Aucun client trouvé</h5>
        <p class="text-muted">Commencez par ajouter votre premier client</p>
        <a href="{{ url_for('customers.add_customer') }}" class="btn btn-primary clay-button-primary">
            <i class="fas fa-plus me-2"></i>Ajouter un client
        </a>
    </div>
    {% endif %}
</div>

<!-- Vue liste (cachée par défaut) -->
<div class="table-responsive" id="listView" style="display: none;">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Client</th>
                <th>Type</th>
                <th>Contact</th>
                <th>Localisation</th>
                <th>Interventions</th>
                <th>Total</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for customer in customers %}
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        {% if customer.avatar %}
                        <img src="{{ url_for('static', filename='uploads/avatars/' + customer.avatar) }}" alt="{{ customer.name }}" class="rounded-circle me-2" width="32" height="32">
                        {% else %}
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 14px;">{{ customer.name[0].upper() }}</div>
                        {% endif %}
                        <div>
                            <div class="fw-bold">{{ customer.name }}</div>
                            {% if customer.company %}
                            <small class="text-muted">{{ customer.company }}</small>
                            {% endif %}
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge {{ customer.customer_type|customer_type_badge }}">
                        {% if customer.customer_type == 'individual' %}Particulier
                        {% elif customer.customer_type == 'company' %}Entreprise
                        {% elif customer.customer_type == 'government' %}Administration
                        {% else %}{{ customer.customer_type }}{% endif %}
                    </span>
                </td>
                <td>
                    {% if customer.email %}<div><a href="mailto:{{ customer.email }}">{{ customer.email }}</a></div>{% endif %}
                    {% if customer.phone %}<div><a href="tel:{{ customer.phone }}">{{ customer.phone }}</a></div>{% endif %}
                </td>
                <td>{{ customer.city or '-' }}</td>
                <td>{{ customer.work_orders_count or 0 }}</td>
                <td>{{ customer.total_spent|currency if customer.total_spent else '0 €' }}</td>
                <td>
                    <span class="customer-status-flag" title="{{ (customer.status or 'Statut inconnu')|capitalize }}">
                        {% if _status_l in ['active', 'actif'] %}
                            <i class="fas fa-check-circle text-success" aria-hidden="true"></i>
                        {% elif _status_l in ['inactive', 'inactif'] %}
                            <i class="fas fa-times-circle text-secondary" aria-hidden="true"></i>
                        {% elif _status_l == 'prospect' %}
                            <i class="fas fa-exclamation-circle text-warning" aria-hidden="true"></i>
                        {% else %}
                            <i class="fas fa-question-circle text-muted" aria-hidden="true"></i>
                        {% endif %}
                        <span class="visually-hidden">{{ customer.status if customer.status else 'statut inconnu' }}</span>
                    </span>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('customers.view_customer', customer_id=customer.id) }}" class="btn btn-sm btn-outline-primary clay-button"><i class="fas fa-eye"></i></a>
                        <a href="{{ url_for('customers.edit_customer', customer_id=customer.id) }}" class="btn btn-sm btn-outline-secondary clay-button"><i class="fas fa-edit"></i></a>
                        {% if current_user.role in ['admin', 'supervisor'] %}
                        <button class="btn btn-sm btn-outline-danger clay-button" onclick="deleteCustomer({{ customer.id }})"><i class="fas fa-trash"></i></button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if pagination.pages > 1 %}
<div class="card-footer">
    <nav aria-label="Pagination clients">
        <ul class="pagination justify-content-center mb-0">
            {% if pagination.has_prev %}
            <li class="page-item"><a class="page-link" href="{{ url_for('customers.index', page=pagination.prev_num, **request.args) }}"><i class="fas fa-chevron-left"></i></a></li>
            {% endif %}

            {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
            {% if page_num != pagination.page %}
            <li class="page-item"><a class="page-link" href="{{ url_for('customers.index', page=page_num, **request.args) }}">{{ page_num }}</a></li>
            {% else %}
            <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
            {% endif %}
            {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
            {% endfor %}

            {% if pagination.has_next %}
            <li class="page-item"><a class="page-link" href="{{ url_for('customers.index', page=pagination.next_num, **request.args) }}"><i class="fas fa-chevron-right"></i></a></li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}
