{# Section documents client (fichiers, contrats, devis) #}

{%- from 'customers/_components/macros.html' import document_card, loading_skeleton -%}
     
{# FIX dropdown masqués + overflow visible + z-index #}
<style>
    .customer360-toolbar.card-fix,
    .customer360-toolbar.card-fix .card-body,
    .customer360-toolbar.card-fix .card-header { overflow: visible !important; }
    .customer360-toolbar { position: relative; z-index: 20; }
    .customer360-toolbar .dropdown-menu { z-index: 10000; }
    .clay-card.dropdown-context,
    .clay-card.dropdown-context > .card-body,
    .clay-card.dropdown-context > .card-header { overflow: visible !important; }
    /* Portal dropdown (detached into body) */
    .dropdown-menu.dropdown-portal { position: absolute !important; top: 0; left: 0; margin:0; z-index: 11000; }
</style>

{# Barre d'outils documents #}
<div class="clay-card mb-4 customer360-toolbar card-fix dropdown-context">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control clay-input" 
                               placeholder="Rechercher un document..." 
                               id="documents-search" onkeyup="filterDocuments()">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select clay-select" id="documents-type-filter" onchange="filterDocuments()">
                        <option value="">Tous les types</option>
                        <option value="contract">Contrats</option>
                        <option value="quote">Devis</option>
                        <option value="invoice">Factures</option>
                        <option value="warranty">Garanties</option>
                        <option value="manual">Manuels</option>
                        <option value="photo">Photos</option>
                        <option value="other">Autres</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select clay-select" id="documents-status-filter" onchange="filterDocuments()">
                        <option value="">Tous les statuts</option>
                        <option value="draft">Brouillon</option>
                        <option value="pending">En attente</option>
                        <option value="signed">Signé</option>
                        <option value="archived">Archivé</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="dropdown">
                        <button class="clay-button w-100" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                            <i class="fas fa-plus me-2"></i>Ajouter
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="uploadDocument()">
                                <i class="fas fa-upload me-2"></i>Télécharger fichier
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="createDocument('quote')">
                                <i class="fas fa-file-invoice me-2"></i>Créer devis
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="createDocument('contract')">
                                <i class="fas fa-file-contract me-2"></i>Créer contrat
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="scanDocument()">
                                <i class="fas fa-camera me-2"></i>Scanner document
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {# Statistiques documents #}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="clay-element p-3 text-center">
                <h3 class="mb-1" style="color: var(--primary-color);" id="totalDocuments">
                    {{ document_stats.total if document_stats else 0 }}
                </h3>
                <small class="text-muted">Total documents</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="clay-element p-3 text-center">
                <h3 class="mb-1" style="color: var(--success-color);" id="signedDocuments">
                    {{ document_stats.signed if document_stats else 0 }}
                </h3>
                <small class="text-muted">Signés</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="clay-element p-3 text-center">
                <h3 class="mb-1" style="color: var(--warning-color);" id="pendingDocuments">
                    {{ document_stats.pending if document_stats else 0 }}
                </h3>
                <small class="text-muted">En attente</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="clay-element p-3 text-center">
                <h3 class="mb-1" style="color: var(--info-color);" id="storageUsed">
                    {{ (document_stats.storage_mb|round(1)) if document_stats else 0 }} MB
                </h3>
                <small class="text-muted">Stockage utilisé</small>
            </div>
        </div>
    </div>
    
    {# Vue en grille des documents #}
    <div class="clay-card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-folder me-2"></i>Documents
                    <span class="badge bg-secondary ms-2" id="documentsCount">{{ documents|length if documents }}</span>
                </h5>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="documentsView" id="gridView" value="grid" checked>
                    <label class="btn btn-outline-primary btn-sm" for="gridView">
                        <i class="fas fa-th"></i>
                    </label>
                    
                    <input type="radio" class="btn-check" name="documentsView" id="listView" value="list">
                    <label class="btn btn-outline-primary btn-sm" for="listView">
                        <i class="fas fa-list"></i>
                    </label>
                </div>
            </div>
        </div>
        <div class="card-body">
            {# Zone de chargement #}
            <div id="documentsLoading" style="display: none;">
                <div class="row">
                    <div class="col-md-4">{{ loading_skeleton(type="card") }}</div>
                    <div class="col-md-4">{{ loading_skeleton(type="card") }}</div>
                    <div class="col-md-4">{{ loading_skeleton(type="card") }}</div>
                </div>
            </div>
            
            {# Vue en grille #}
            <div id="documentsGrid" class="row">
                {% if documents %}
                    {% for document in documents %}
                        {{ document_card(document) }}
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Aucun document trouvé</h5>
                            <p class="text-muted">Commencez par télécharger ou créer un document.</p>
                            <button class="clay-button" onclick="uploadDocument()">
                                <i class="fas fa-plus me-2"></i>Ajouter un document
                            </button>
                        </div>
                    </div>
                {% endif %}
            </div>
            
            {# Vue en liste #}
            <div id="documentsList" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Document</th>
                                <th>Type</th>
                                <th>Taille</th>
                                <th>Modifié</th>
                                <th>Statut</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="documentsListBody">
                            {# Le contenu sera généré par JavaScript #}
                        </tbody>
                    </table>
                </div>
            </div>
            
            {# Bouton charger plus #}
            <div id="loadMoreDocuments" class="text-center mt-4" style="display: none;">
                <button class="clay-button" onclick="loadMoreDocuments()">
                    <i class="fas fa-plus me-2"></i>Charger plus de documents
                </button>
            </div>
        </div>
    </div>
    
    {# Zone de glisser-déposer #}
    <div id="dropZone" class="clay-element p-5 text-center mt-4" 
         style="border: 2px dashed var(--border-color); display: none;">
        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">Glissez vos fichiers ici</h5>
        <p class="text-muted">ou cliquez pour sélectionner</p>
        <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif" style="display: none;">
    </div>
</div>

{# Modal de prévisualisation de document #}
<div class="modal fade" id="documentPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prévisualisation du document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="documentPreviewContent" style="height: 70vh;">
                    {# Le contenu sera chargé dynamiquement #}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="clay-button" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="clay-button" id="downloadPreviewDocument">
                    <i class="fas fa-download me-2"></i>Télécharger
                </button>
            </div>
        </div>
    </div>
</div>

{# Modal de signature électronique #}
<div class="modal fade" id="signatureModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Signature électronique</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <p class="text-muted">Dessinez votre signature dans la zone ci-dessous</p>
                </div>
                <div class="text-center">
                    <canvas id="signatureCanvas" width="600" height="200" 
                            style="border: 2px solid var(--border-color); border-radius: 8px;"></canvas>
                </div>
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-outline-secondary" onclick="clearSignature()">
                        <i class="fas fa-eraser me-2"></i>Effacer
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="clay-button" onclick="saveSignature()">
                    <i class="fas fa-signature me-2"></i>Signer le document
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables pour la gestion des documents
let documentsPage = 1;
let documentsLoading = false;
let documentsHasMore = true;
let currentSigningDocument = null;

// Variables pour les filtres
let documentFilters = {
    search: '',
    type: '',
    status: ''
};

// Variables pour la signature
let isDrawing = false;
let signatureCanvas = null;
let signatureCtx = null;

// Fonction pour filtrer les documents
function filterDocuments() {
    const searchEl = document.getElementById('documents-search');
    const typeEl = document.getElementById('documents-type-filter');
    const statusEl = document.getElementById('documents-status-filter');
    documentFilters.search = (searchEl?.value || '').toLowerCase();
    documentFilters.type = typeEl?.value || '';
    documentFilters.status = statusEl?.value || '';
    
    // Reset pagination
    documentsPage = 1;
    documentsHasMore = true;
    
    // Afficher le loading
    document.getElementById('documentsLoading').style.display = 'block';
    document.getElementById('documentsGrid').style.display = 'none';
    
    // Charger les documents filtrés
    loadDocuments(true);
}

// Fonction pour charger les documents
function loadDocuments(reset = false) {
    if (documentsLoading || (!documentsHasMore && !reset)) return;
    
    documentsLoading = true;
    
    if (reset) {
        documentsPage = 1;
        documentsHasMore = true;
    }
    
    const params = new URLSearchParams({
        page: documentsPage,
        search: documentFilters.search,
        type: documentFilters.type,
        status: documentFilters.status
    });
    
    fetch(`/api/customers/${customerId}/documents?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const grid = document.getElementById('documentsGrid');
                
                if (reset) {
                    grid.innerHTML = '';
                }
                
                if (data.documents.length === 0 && reset) {
                    grid.innerHTML = `
                        <div class="col-12">
                            <div class="text-center py-5">
                                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Aucun document trouvé</h5>
                                <p class="text-muted">Essayez de modifier vos critères de recherche.</p>
                            </div>
                        </div>
                    `;
                } else {
                    data.documents.forEach(document => {
                        grid.insertAdjacentHTML('beforeend', renderDocumentCard(document));
                    });
                }
                
                // Mettre à jour les contrôles de pagination
                documentsHasMore = data.has_more;
                document.getElementById('loadMoreDocuments').style.display = 
                    documentsHasMore ? 'block' : 'none';
                
                // Mettre à jour le compteur
                document.getElementById('documentsCount').textContent = data.total_count;
                
                documentsPage++;
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des documents:', error);
            showToast('Erreur lors du chargement des documents', 'error');
        })
        .finally(() => {
            documentsLoading = false;
            document.getElementById('documentsLoading').style.display = 'none';
            document.getElementById('documentsGrid').style.display = 'flex';
        });
}

// Fonction pour charger plus de documents
function loadMoreDocuments() {
    loadDocuments(false);
}

// Changer la vue (grille/liste)
function changeDocumentsView(view) {
    if (view === 'grid') {
        document.getElementById('documentsGrid').style.display = 'flex';
        document.getElementById('documentsList').style.display = 'none';
    } else {
        document.getElementById('documentsGrid').style.display = 'none';
        document.getElementById('documentsList').style.display = 'block';
        renderDocumentsList();
    }
}

// Rendre la liste des documents
function renderDocumentsList() {
    const tbody = document.getElementById('documentsListBody');
    const gridItems = document.querySelectorAll('#documentsGrid .col-md-4');
    
    tbody.innerHTML = '';
    
    gridItems.forEach(item => {
        const documentData = JSON.parse(item.dataset.document || '{}');
        tbody.insertAdjacentHTML('beforeend', renderDocumentRow(documentData));
    });
}

// Actions sur les documents
function uploadDocument() {
    document.getElementById('fileInput').click();
}

function createDocument(type) {
    window.location.href = `/documents/new?type=${type}&customer_id=${customerId}`;
}

function scanDocument() {
    // Logique pour scanner un document (webcam/mobile)
    showToast('Fonctionnalité de scan en cours de développement', 'info');
}

function previewDocument(documentId) {
    fetch(`/api/documents/${documentId}/preview`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const modal = new bootstrap.Modal(document.getElementById('documentPreviewModal'));
                const content = document.getElementById('documentPreviewContent');
                
                if (data.content_type === 'application/pdf') {
                    content.innerHTML = `
                        <iframe src="${data.preview_url}" 
                                width="100%" height="100%" 
                                style="border: none;"></iframe>
                    `;
                } else if (data.content_type.startsWith('image/')) {
                    content.innerHTML = `
                        <div class="text-center p-4">
                            <img src="${data.preview_url}" 
                                 class="img-fluid" 
                                 style="max-height: 60vh;">
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="text-center p-5">
                            <i class="fas fa-file fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Prévisualisation non disponible</h5>
                            <p class="text-muted">Ce type de fichier ne peut pas être prévisualisé.</p>
                        </div>
                    `;
                }
                
                // Configurer le bouton de téléchargement
                document.getElementById('downloadPreviewDocument').onclick = () => {
                    window.open(data.download_url, '_blank');
                };
                
                modal.show();
            }
        })
        .catch(error => {
            console.error('Erreur lors de la prévisualisation:', error);
            showToast('Erreur lors de la prévisualisation', 'error');
        });
}

function signDocument(documentId) {
    currentSigningDocument = documentId;
    
    // Initialiser le canvas de signature
    initSignatureCanvas();
    
    const modal = new bootstrap.Modal(document.getElementById('signatureModal'));
    modal.show();
}

// Initialiser le canvas de signature
function initSignatureCanvas() {
    signatureCanvas = document.getElementById('signatureCanvas');
    signatureCtx = signatureCanvas.getContext('2d');
    
    // Configuration du canvas
    signatureCtx.strokeStyle = '#000';
    signatureCtx.lineWidth = 2;
    signatureCtx.lineCap = 'round';
    
    // Événements de dessin
    signatureCanvas.addEventListener('mousedown', startDrawing);
    signatureCanvas.addEventListener('mousemove', draw);
    signatureCanvas.addEventListener('mouseup', stopDrawing);
    signatureCanvas.addEventListener('mouseout', stopDrawing);
    
    // Support tactile
    signatureCanvas.addEventListener('touchstart', handleTouch);
    signatureCanvas.addEventListener('touchmove', handleTouch);
    signatureCanvas.addEventListener('touchend', stopDrawing);
}

function startDrawing(e) {
    isDrawing = true;
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.beginPath();
    signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function draw(e) {
    if (!isDrawing) return;
    
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    signatureCtx.stroke();
}

function stopDrawing() {
    isDrawing = false;
}

function handleTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                     e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    signatureCanvas.dispatchEvent(mouseEvent);
}

function clearSignature() {
    signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
}

function saveSignature() {
    if (!currentSigningDocument) return;
    
    // Convertir le canvas en blob
    signatureCanvas.toBlob(blob => {
        const formData = new FormData();
        formData.append('signature', blob, 'signature.png');
        formData.append('document_id', currentSigningDocument);
        
        fetch(`/api/documents/${currentSigningDocument}/sign`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Document signé avec succès', 'success');
                
                // Fermer la modal
                bootstrap.Modal.getInstance(document.getElementById('signatureModal')).hide();
                
                // Recharger les documents
                filterDocuments();
            } else {
                showToast('Erreur lors de la signature', 'error');
            }
        })
        .catch(error => {
            console.error('Erreur lors de la signature:', error);
            showToast('Erreur lors de la signature', 'error');
        });
    });
}

// Gestion du glisser-déposer
function initDragAndDrop() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    // Afficher la zone de glisser-déposer lors du drag
    document.addEventListener('dragenter', (e) => {
        e.preventDefault();
        dropZone.style.display = 'block';
    });
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.background = 'var(--bg-light)';
    });
    
    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.style.background = '';
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.display = 'none';
        
        const files = e.dataTransfer.files;
        handleFileUpload(files);
    });
    
    // Clic sur la zone de glisser-déposer
    dropZone.addEventListener('click', () => {
        fileInput.click();
    });
    
    // Changement de fichier
    fileInput.addEventListener('change', (e) => {
        handleFileUpload(e.target.files);
    });
}

// Gérer l'upload de fichiers
function handleFileUpload(files) {
    const formData = new FormData();
    
    Array.from(files).forEach(file => {
        formData.append('files', file);
    });
    
    formData.append('customer_id', customerId);
    
    // Afficher une barre de progression
    showUploadProgress();
    
    fetch('/api/documents/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`${data.uploaded_count} document(s) téléchargé(s)`, 'success');
            
            // Recharger les documents
            filterDocuments();
        } else {
            showToast('Erreur lors du téléchargement', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur lors de l\'upload:', error);
        showToast('Erreur lors du téléchargement', 'error');
    })
    .finally(() => {
        hideUploadProgress();
    });
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser le glisser-déposer
    initDragAndDrop();
    
    // Écouter les changements de vue
    document.querySelectorAll('input[name="documentsView"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                changeDocumentsView(this.value);
            }
        });
    });
    
    // Écouter l'activation de l'onglet
    document.getElementById('documents-tab').addEventListener('shown.bs.tab', function() {
        if (document.getElementById('documentsGrid').children.length === 0) {
            loadDocuments(true);
        }
    });

    /* Amélioration dropdown: si clipping détecté, on 'portalise' le menu dans body */
    document.querySelectorAll('.customer360-toolbar .dropdown').forEach(dd => {
        dd.addEventListener('show.bs.dropdown', function(e){
            const menu = this.querySelector('.dropdown-menu');
            if(!menu) return;
            // Temporarily show to measure
            menu.style.visibility = 'hidden';
            menu.classList.add('show');
            const rect = menu.getBoundingClientRect();
            menu.classList.remove('show');
            menu.style.visibility = '';
            const clipped = rect.top < 0 || rect.left < 0 || rect.right > window.innerWidth || rect.bottom > window.innerHeight;
            if (clipped) {
                // Portalize
                const trigger = this.querySelector('[data-bs-toggle="dropdown"]');
                const tRect = trigger.getBoundingClientRect();
                menu.dataset.portalOriginalParent = this.querySelector('.dropdown-menu').parentElement === this ? '1' : '';
                document.body.appendChild(menu);
                menu.classList.add('dropdown-portal');
                positionPortalMenu(menu, tRect);
                window.addEventListener('scroll', portalScrollHandler, true);
                window.addEventListener('resize', portalResizeHandler, true);
                function portalScrollHandler(){ positionPortalMenu(menu, trigger.getBoundingClientRect()); }
                function portalResizeHandler(){ positionPortalMenu(menu, trigger.getBoundingClientRect()); }
                menu._portalCleanup = () => {
                    window.removeEventListener('scroll', portalScrollHandler, true);
                    window.removeEventListener('resize', portalResizeHandler, true);
                };
            }
        });
        dd.addEventListener('hidden.bs.dropdown', function(){
            const menu = document.querySelector('.dropdown-menu.dropdown-portal');
            if(menu){
                menu._portalCleanup && menu._portalCleanup();
                // Return to original dropdown
                dd.appendChild(menu);
                menu.classList.remove('dropdown-portal');
                menu.style.top='';
                menu.style.left='';
            }
        });
    });

    function positionPortalMenu(menu, triggerRect){
        const top = triggerRect.bottom + window.scrollY;
        const left = triggerRect.left + window.scrollX;
        menu.style.top = top + 'px';
        menu.style.left = left + 'px';
    }
});
</script>
