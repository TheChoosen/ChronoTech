{% extends "base.html" %}

{% block title %}Modifier {{ customer.name }} - ChronoTech{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
                <i class="fa-solid fa-user-edit me-2"></i>Modifier {{ customer.name }}
        </h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('customers.view_customer', customer_id=customer.id) }}" class="btn btn-outline-primary clay-button">
                    <i class="fa-solid fa-eye me-2"></i>Voir le profil
            </a>
            <a href="{{ url_for('customers.index') }}" class="btn btn-outline-secondary clay-button">
                    <i class="fa-solid fa-arrow-left me-2"></i>Retour à la liste
            </a>
        </div>
    </div>

    <form id="customerForm" method="POST" enctype="multipart/form-data">
        <!-- CSRF protection -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="row">
            <!-- Contenu principal -->
            <div class="col-lg-8">
                <!-- Informations de base -->
                <div class="clay-card mb-4">
                    <div class="card-header">
                            <h5 class="mb-0"><i class="fa-solid fa-user me-2"></i>Informations de Base</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Nom *</label>
                                    <input type="text" id="name" name="name" 
                                           class="form-control clay-input" 
                                           placeholder="Nom complet ou raison sociale"
                                           value="{{ customer.name or '' }}" required>
                                    {% if errors and 'name' in errors %}
                                    <div class="text-danger small">{{ errors['name'] }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="customer_type" class="form-label">Type de client</label>
                                    <select id="customer_type" name="customer_type" 
                                            class="form-select clay-input" onchange="updateFormFields()">
                                        <option value="particulier" {% if customer.customer_type == 'particulier' %}selected{% endif %}>Particulier</option>
                                        <option value="entreprise" {% if customer.customer_type == 'entreprise' %}selected{% endif %}>Entreprise</option>
                                        <option value="administration" {% if customer.customer_type == 'administration' %}selected{% endif %}>Administration</option>
                                    </select>
                                    {% if errors and 'customer_type' in errors %}
                                    <div class="text-danger small">{{ errors['customer_type'] }}</div>
                                    {% endif %}
                                </div>

                                <div class="mb-3" id="companyField">
                                    <label for="company" class="form-label">Raison sociale</label>
                                    <input type="text" id="company" name="company" 
                                           class="form-control clay-input" 
                                           placeholder="Nom de l'entreprise"
                                           value="{{ customer.company or '' }}">
                                    {% if errors and 'company' in errors %}
                                    <div class="text-danger small">{{ errors['company'] }}</div>
                                    {% endif %}
                                </div>

                                <div class="mb-3" id="siretField">
                                    <label for="siret" class="form-label">SIRET</label>
                                    <input type="text" id="siret" name="siret" 
                                           class="form-control clay-input" 
                                           placeholder="14 chiffres"
                                           value="{{ customer.siret or '' }}"
                                           pattern="[0-9]{14}" maxlength="14">
                                    {% if errors and 'siret' in errors %}
                                    <div class="text-danger small">{{ errors['siret'] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" id="email" name="email" 
                                           class="form-control clay-input" 
                                           placeholder="exemple@email.com"
                                           value="{{ customer.email or '' }}">
                                    {% if errors and 'email' in errors %}
                                    <div class="text-danger small">{{ errors['email'] }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Téléphone</label>
                                    <input type="tel" id="phone" name="phone" 
                                           class="form-control clay-input" 
                                           placeholder="0123456789"
                                           value="{{ customer.phone or '' }}">
                                    {% if errors and 'phone' in errors %}
                                    <div class="text-danger small">{{ errors['phone'] }}</div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="is_active" class="form-label">Statut</label>
                                    <select id="is_active" name="is_active" class="form-select clay-input">
                                        <option value="1" {% if customer.is_active %}selected{% endif %}>Actif</option>
                                        <option value="0" {% if not customer.is_active %}selected{% endif %}>Inactif</option>
                                    </select>
                                    {% if errors and 'is_active' in errors %}
                                    <div class="text-danger small">{{ errors['is_active'] }}</div>
                                    {% endif %}
                                </div>

                                <!-- Photo/Avatar -->
                                <div class="mb-3">
                                    <label class="form-label">Photo/Avatar</label>
                                    {% if customer.avatar %}
                                    <div class="mb-2">
                                        <img src="{{ url_for('static', filename='uploads/avatars/' + customer.avatar) }}" 
                                             alt="{{ customer.name }}" class="rounded-circle" 
                                             width="80" height="80" style="object-fit: cover;">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="remove_avatar" 
                                                   name="remove_avatar" value="1">
                                            <label class="form-check-label" for="remove_avatar">
                                                Supprimer la photo actuelle
                                            </label>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <input type="file" class="form-control clay-input" id="avatar" 
                                           name="avatar" accept="image/*">
                                    <div class="form-text">
                                        Formats supportés : JPG, PNG, GIF. Taille max : 2MB.
                                    </div>
                                    <div id="avatarPreview" class="mt-2" style="display: none;">
                                        <img id="avatarImg" class="rounded-circle" width="80" height="80" 
                                             style="object-fit: cover; border: 3px solid #dee2e6;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Adresse -->
                <div class="clay-card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fa-solid fa-map-marker-alt me-2"></i>Adresse</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary clay-button" onclick="searchAddress()">
                                <i class="fa-solid fa-search me-2"></i>Rechercher
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="address" class="form-label">Adresse</label>
                            <textarea id="address" name="address" 
                                      class="form-control clay-input" rows="2" 
                                      placeholder="Numéro, rue, avenue...">{{ customer.address or '' }}</textarea>
                            {% if errors and 'address' in errors %}
                            <div class="text-danger small">{{ errors['address'] }}</div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="postal_code" class="form-label">Code postal</label>
                                    <input type="text" id="postal_code" name="postal_code" 
                                           class="form-control clay-input" 
                                           placeholder="Code postal"
                                           value="{{ customer.postal_code or '' }}"
                                           maxlength="10">
                                    {% if errors and 'postal_code' in errors %}
                                    <div class="text-danger small">{{ errors['postal_code'] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="city" class="form-label">Ville</label>
                                    <input type="text" id="city" name="city" 
                                           class="form-control clay-input" 
                                           placeholder="Paris"
                                           value="{{ customer.city or '' }}">
                                    {% if errors and 'city' in errors %}
                                    <div class="text-danger small">{{ errors['city'] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="country" class="form-label">Pays</label>
                                    <select id="country" name="country" class="form-control clay-input">
                                        <option value="FR" {% if customer.country == 'FR' or not customer.country %}selected{% endif %}>France</option>
                                        <option value="BE" {% if customer.country == 'BE' %}selected{% endif %}>Belgique</option>
                                        <option value="CH" {% if customer.country == 'CH' %}selected{% endif %}>Suisse</option>
                                        <option value="LU" {% if customer.country == 'LU' %}selected{% endif %}>Luxembourg</option>
                                        <option value="CA" {% if customer.country == 'CA' %}selected{% endif %}>Canada</option>
                                    </select>
                                    {% if errors and 'country' in errors %}
                                    <div class="text-danger small">{{ errors['country'] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informations additionnelles -->
                <div class="clay-card mb-4">
                    <div class="card-header">
                            <h5 class="mb-0"><i class="fa-solid fa-info-circle me-2"></i>Informations Additionnelles</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="notes" class="form-label">Notes</label>
                                    <textarea id="notes" name="notes" 
                                              class="form-control clay-input" rows="3" 
                                              placeholder="Notes internes sur le client...">{{ customer.notes or '' }}</textarea>
                                    <div class="form-text">Ces notes sont visibles uniquement par l'équipe</div>
                                    {% if errors and 'notes' in errors %}
                                    <div class="text-danger small">{{ errors['notes'] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="mobile" class="form-label">Mobile</label>
                                    <input type="tel" id="mobile" name="mobile" 
                                           class="form-control clay-input" 
                                           placeholder="0612345678"
                                           value="{{ customer.mobile or '' }}">
                                    {% if errors and 'mobile' in errors %}
                                    <div class="text-danger small">{{ errors['mobile'] }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="tax_number" class="form-label">Numéro de TVA</label>
                                    <input type="text" id="tax_number" name="tax_number" 
                                           class="form-control clay-input" 
                                           placeholder="FR12345678901"
                                           value="{{ customer.tax_number or '' }}">
                                    {% if errors and 'tax_number' in errors %}
                                    <div class="text-danger small">{{ errors['tax_number'] }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="preferred_contact" class="form-label">Contact préféré</label>
                                    <select id="preferred_contact" name="preferred_contact" class="form-select clay-input">
                                        <option value="email" {% if customer.preferred_contact == 'email' or not customer.preferred_contact %}selected{% endif %}>Email</option>
                                        <option value="phone" {% if customer.preferred_contact == 'phone' %}selected{% endif %}>Téléphone</option>
                                        <option value="mobile" {% if customer.preferred_contact == 'mobile' %}selected{% endif %}>Mobile</option>
                                        <option value="mail" {% if customer.preferred_contact == 'mail' %}selected{% endif %}>Courrier</option>
                                    </select>
                                    {% if errors and 'preferred_contact' in errors %}
                                    <div class="text-danger small">{{ errors['preferred_contact'] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Historique des modifications -->
                <div class="clay-card mb-4">
                    <div class="card-header">
                            <h5 class="mb-0"><i class="fa-solid fa-history me-2"></i>Historique des Modifications</h5>
                    </div>
                    <div class="card-body">
                        {% if modification_history %}
                        <div class="timeline">
                            {% for modification in modification_history %}
                            <div class="timeline-item">
                                <div class="timeline-marker">
                                        <i class="fa-solid fa-circle"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">{{ modification.action }}</h6>
                                    <p class="mb-1 text-muted">{{ modification.created_at|datetime_format }}</p>
                                    {% if modification.changes %}
                                    <p class="mb-0 small">{{ modification.changes }}</p>
                                    {% endif %}
                                    <small class="text-muted">Par {{ modification.user_name }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">Aucune modification antérieure enregistrée.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Actions -->
                <div class="clay-card mb-4">
                    <div class="card-header">
                            <h5 class="mb-0"><i class="fa-solid fa-save me-2"></i>Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary clay-button-primary">
                                    <i class="fa-solid fa-save me-2"></i>Enregistrer les modifications
                            </button>
                            <button type="submit" name="save_and_add_order" value="1" 
                                    class="btn btn-success clay-button">
                                        <i class="fa-solid fa-plus me-2"></i>Enregistrer et créer un bon de travail
                            </button>
                            <a href="{{ url_for('customers.view_customer', customer_id=customer.id) }}" 
                               class="btn btn-outline-secondary clay-button">
                                    <i class="fa-solid fa-times me-2"></i>Annuler
                            </a>
                            {% if current_user.role in ['admin', 'supervisor'] %}
                            <hr>
                            <button type="button" class="btn btn-outline-danger clay-button" 
                                    onclick="deleteCustomer()">
                                    <i class="fa-solid fa-trash me-2"></i>Supprimer le client
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Informations système -->
                <div class="clay-card mb-4">
                    <div class="card-header">
                            <h5 class="mb-0"><i class="fa-solid fa-info me-2"></i>Informations Système</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless table-sm">
                            <tr>
                                <td><strong>ID Client :</strong></td>
                                <td>{{ customer.id }}</td>
                            </tr>
                            <tr>
                                <td><strong>Créé le :</strong></td>
                                <td>{{ customer.created_at|datetime_format }}</td>
                            </tr>
                            <tr>
                                <td><strong>Créé par :</strong></td>
                                <td>{{ customer.created_by_name or 'Système' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Modifié le :</strong></td>
                                <td>{{ customer.updated_at|datetime_format }}</td>
                            </tr>
                            <tr>
                                <td><strong>Dernière modification :</strong></td>
                                <td>{{ customer.last_modified_by_name or 'Système' }}</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Statistiques rapides -->
                <div class="clay-card mb-4">
                    <div class="card-header">
                            <h5 class="mb-0"><i class="fa-solid fa-chart-bar me-2"></i>Statistiques</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="stat-item">
                                    <h5 class="mb-0">{{ customer.work_orders_count or 0 }}</h5>
                                    <small class="text-muted">Interventions</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-item">
                                    <h5 class="mb-0">{{ customer.total_spent|currency if customer.total_spent else '0 €' }}</h5>
                                    <small class="text-muted">Total dépensé</small>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="stat-item">
                                    <h5 class="mb-0">
                                        {% if customer.last_order_date %}
                                        {{ customer.last_order_date|days_ago }}j
                                        {% else %}
                                        -
                                        {% endif %}
                                    </h5>
                                    <small class="text-muted">Dernière commande</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-item">
                                    <h5 class="mb-0">{{ customer.satisfaction_score or '-' }}</h5>
                                    <small class="text-muted">Satisfaction</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Changements détectés -->
                <div class="clay-card" id="changesCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0 text-warning">
                                <i class="fa-solid fa-exclamation-triangle me-2"></i>Changements Détectés
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="changesList">
                            <!-- Liste des changements détectés -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Variables pour détecter les changements
let originalFormData = {};

// Mise à jour des champs selon le type de client
function updateFormFields() {
    const customerType = document.getElementById('customer_type').value;
    const companyField = document.getElementById('companyField');
    const siretField = document.getElementById('siretField');
    
    if (customerType === 'company' || customerType === 'government') {
        companyField.style.display = 'block';
        siretField.style.display = 'block';
        document.getElementById('company').required = true;
    } else {
        companyField.style.display = 'none';
        siretField.style.display = 'none';
        document.getElementById('company').required = false;
    }
}

// Validation du code postal selon le pays
function validatePostalCode() {
    const postalCodeField = document.getElementById('postal_code');
    const countryField = document.getElementById('country');
    
    if (!postalCodeField || !countryField) return;
    
    const postalCode = postalCodeField.value.trim();
    const country = countryField.value || 'FR';
    
    if (!postalCode) return; // Optionnel
    
    let isValid = false;
    let expectedFormat = '';
    
    switch(country.toUpperCase()) {
        case 'CA':
            isValid = /^[A-Z]\d[A-Z] \d[A-Z]\d$/i.test(postalCode);
            expectedFormat = 'K1A 0A6';
            break;
        case 'US':
            isValid = /^\d{5}(-\d{4})?$/.test(postalCode);
            expectedFormat = '12345 ou 12345-6789';
            break;
        case 'GB':
            isValid = /^[A-Z]{1,2}\d[R\dA-Z]? \d[A-Z]{2}$/i.test(postalCode);
            expectedFormat = 'SW1A 1AA';
            break;
        case 'FR':
        default:
            isValid = /^\d{5}$/.test(postalCode);
            expectedFormat = '12345';
            break;
    }
    
    // Supprimer les messages d'erreur précédents
    const existingError = postalCodeField.parentNode.querySelector('.postal-code-error');
    if (existingError) {
        existingError.remove();
    }
    
    // Mettre à jour l'apparence du champ
    if (isValid) {
        postalCodeField.classList.remove('is-invalid');
        postalCodeField.classList.add('is-valid');
    } else {
        postalCodeField.classList.remove('is-valid');
        postalCodeField.classList.add('is-invalid');
        
        // Ajouter un message d'erreur
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-danger small postal-code-error';
        errorDiv.textContent = `Format attendu pour ${country}: ${expectedFormat}`;
        postalCodeField.parentNode.appendChild(errorDiv);
    }
}

// Aperçu de l'avatar
document.getElementById('avatar').addEventListener('change', function() {
    const file = this.files[0];
    const preview = document.getElementById('avatarPreview');
    const img = document.getElementById('avatarImg');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            img.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
});

// Recherche d'adresse
function searchAddress() {
    const address = document.getElementById('address').value;
    const postalCode = document.getElementById('postal_code').value;
    const city = document.getElementById('city').value;
    
    if (!address && !postalCode && !city) {
        alert('Veuillez saisir au moins une partie de l\'adresse');
        return;
    }
    
    alert('Fonction de recherche d\'adresse à implémenter avec une API de géocodage');
}

// Suppression du client
function deleteCustomer() {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce client ? Cette action supprimera également tous ses bons de travail associés.')) {
        return;
    }

    const url = `{{ url_for('customers.delete_customer', customer_id=customer.id) }}`;
    const formData = new FormData();
    formData.append('customer_id', '{{ customer.id }}');

    fetch(url, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
    }).then(response => {
        if (response.ok) {
            // Redirect to the list (AJAX refresh could be used if present)
            window.location.href = `{{ url_for('customers.index') }}`;
        } else {
            alert('Erreur lors de la suppression du client');
        }
    }).catch(err => {
        console.error('Delete failed', err);
        alert('Erreur lors de la suppression du client');
    });
}

// Détection des changements
function detectChanges() {
    const currentFormData = new FormData(document.getElementById('customerForm'));
    const changes = [];
    
    // Comparer les valeurs actuelles avec les originales
    for (let [key, value] of currentFormData.entries()) {
        if (originalFormData[key] !== value) {
            changes.push(key);
        }
    }
    
    const changesCard = document.getElementById('changesCard');
    const changesList = document.getElementById('changesList');
    
    if (changes.length > 0) {
        changesList.innerHTML = '<ul class="list-unstyled mb-0">' + 
            changes.map(field => `<li><i class="fas fa-circle fa-xs text-warning me-2"></i>${field}</li>`).join('') +
            '</ul>';
        changesCard.style.display = 'block';
    } else {
        changesCard.style.display = 'none';
    }
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    updateFormFields();
    
    // Capturer les données initiales du formulaire
    const formData = new FormData(document.getElementById('customerForm'));
    for (let [key, value] of formData.entries()) {
        originalFormData[key] = value;
    }
    
    // Écouter les changements
    document.getElementById('customerForm').addEventListener('input', detectChanges);
    document.getElementById('customerForm').addEventListener('change', detectChanges);
    
    // Auto-complétion de la ville basée sur le code postal
    document.getElementById('postal_code').addEventListener('blur', function() {
        const postalCode = this.value;
        if (postalCode.length === 5) {
            const cities = {
                '75001': 'Paris',
                '69001': 'Lyon',
                '13001': 'Marseille',
                '31000': 'Toulouse',
                '59000': 'Lille'
            };
            
            if (cities[postalCode] && !document.getElementById('city').value) {
                document.getElementById('city').value = cities[postalCode];
            }
        }
    });
});

// Validation avant soumission
document.getElementById('customerForm').addEventListener('submit', function(e) {
    const requiredFields = ['name', 'email'];
    let isValid = true;
    
    requiredFields.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        e.preventDefault();
        alert('Veuillez remplir tous les champs obligatoires');
    }
});

// Timeline CSS
const style = document.createElement('style');
style.textContent = `
.timeline {
    position: relative;
    padding-left: 30px;
    max-height: 300px;
    overflow-y: auto;
}
.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}
.timeline-item {
    position: relative;
    margin-bottom: 20px;
}
.timeline-marker {
    position: absolute;
    left: -22px;
    top: 5px;
    width: 14px;
    height: 14px;
    background: #fff;
    border: 2px solid #007bff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}
.timeline-marker i {
    font-size: 6px;
    color: #007bff;
}
.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}
.stat-item {
    padding: 0.5rem;
}
`;
document.head.appendChild(style);

// Initialisation des écouteurs d'événements
document.addEventListener('DOMContentLoaded', function() {
    // Validation du code postal en temps réel
    const postalCodeField = document.getElementById('postal_code');
    const countryField = document.getElementById('country');
    
    if (postalCodeField) {
        postalCodeField.addEventListener('input', validatePostalCode);
        postalCodeField.addEventListener('blur', validatePostalCode);
    }
    
    if (countryField) {
        countryField.addEventListener('change', validatePostalCode);
    }
    
    // Validation initiale du formulaire si des données existent
    updateFormFields();
    validatePostalCode();
});
</script>
{% endblock %}
