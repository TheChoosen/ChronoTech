{% extends "base.html" %}

{% block title %}Gestion des Clients - ChronoTech{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête avec style claymorphism -->
    <div class="clay-element p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0 d-flex align-items-center">
                <div class="stat-icon bg-primary me-3" style="width: 50px; height: 50px;">
                    <i class="fas fa-users"></i>
                </div>
                <span style="color: var(--text-color);">Gestion des Clients</span>
            </h1>
            <div class="d-flex gap-3">
                <!-- Menu Outils Avancés -->
                <div class="dropdown">
                    <button class="clay-button dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-tools me-2"></i>Outils avancés
                    </button>
                    <ul class="dropdown-menu">
                        <li><h6 class="dropdown-header">Analytics</h6></li>
                        <li><a class="dropdown-item" href="{{ url_for('customers.get_rfm_segments') }}">
                            <i class="fas fa-chart-pie me-2"></i>Segments RFM
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Gestion</h6></li>
                        <li><a class="dropdown-item" href="{{ url_for('customers.list_customer_duplicates') }}">
                            <i class="fas fa-clone me-2"></i>Gestion des doublons
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('customers.delivery_routes') }}">
                            <i class="fas fa-route me-2"></i>Planification des routes
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Outils</h6></li>
                        <li><a class="dropdown-item" href="#" onclick="detectAllDuplicates()">
                            <i class="fas fa-search me-2"></i>Détecter doublons
                        </a></li>
                    </ul>
                </div>
                
                <a href="{{ url_for('customers.add_customer') }}" class="clay-button-primary">
                    <i class="fas fa-plus me-2"></i>Nouveau Client
                </a>
                <button class="clay-button" onclick="exportCustomers()">
                    <i class="fas fa-download me-2"></i>Exporter
                </button>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div id="customersStats">
        {% include 'customers/_stats.html' %}
    </div>

    <!-- Filtres et recherche avec style claymorphism -->
    <div class="clay-card mb-4">
        <div class="card-body p-4">
            <form method="GET" id="filterForm" action="{{ url_for('customers.index') }}">
                <div class="row g-3">
                    <!-- Recherche -->
                    <div class="col-md-6 col-lg-3">
                        <label class="form-label fw-semibold" style="color: var(--text-color);">Recherche</label>
                        <div class="position-relative">
                            <input type="text" class="clay-input form-control" name="search" 
                                value="{{ request.args.get('search', '') }}" 
                                placeholder="Nom, email, téléphone...">
                            <i class="fas fa-search position-absolute" style="right: 15px; top: 50%; transform: translateY(-50%); opacity: 0.5;"></i>
                        </div>
                    </div>

                    <!-- Type de client -->
                    <div class="col-md-6 col-lg-3">
                        <label class="form-label fw-semibold" style="color: var(--text-color);">Type</label>
                        <select class="clay-input form-select" name="customer_type">
                            <option value="">Tous les types</option>
                            <option value="individual" {% if request.args.get('customer_type') == 'individual' %}selected{% endif %}>Particulier</option>
                            <option value="company" {% if request.args.get('customer_type') == 'company' %}selected{% endif %}>Entreprise</option>
                            <option value="government" {% if request.args.get('customer_type') == 'government' %}selected{% endif %}>Administration</option>
                        </select>
                    </div>

                    <!-- Statut -->
                    <div class="col-md-6 col-lg-3">
                        <label class="form-label fw-semibold" style="color: var(--text-color);">Statut</label>
                        <select class="clay-input form-select" name="status">
                            <option value="">Tous les statuts</option>
                            <option value="active" {% if request.args.get('status') == 'active' %}selected{% endif %}>Actif</option>
                            <option value="inactive" {% if request.args.get('status') == 'inactive' %}selected{% endif %}>Inactif</option>
                        </select>
                    </div>

                    <!-- Ville -->
                    <div class="col-md-6 col-lg-3">
                        <label class="form-label fw-semibold" style="color: var(--text-color);">Ville</label>
                        <input type="text" class="clay-input form-control" name="city" 
                            value="{{ request.args.get('city', '') }}" 
                            placeholder="Filtrer par ville">
                    </div>

                    <!-- Boutons -->
                    <div class="col-12">
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('customers.index') }}" class="clay-button">
                                <i class="fas fa-times me-2"></i>Réinitialiser
                            </a>
                            <button type="submit" class="clay-button-primary">
                                <i class="fas fa-filter me-2"></i>Filtrer
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des clients -->
    <div class="clay-card" id="customersCard">
        {% include 'customers/_list.html' %}
    </div>
</div>

    <script>
    function submitFilter() {
        const form = document.getElementById('filterForm');
        const params = new URLSearchParams(new FormData(form));

        // remove empty values
        for (const [k, v] of Array.from(params.entries())) {
            if (!v || v === '') params.delete(k);
        }

        // always reset pagination when filtering
        params.delete('page');

    const query = params.toString();
    // Build absolute URL to avoid issues with trailing slashes or relative paths
    const actionAttr = form.getAttribute('action') || window.location.pathname;
    const actionUrl = new URL(actionAttr, window.location.origin);
    actionUrl.search = query; // sets empty string if no params
    const url = actionUrl.toString();
    console.debug('[customers] params=', query);

        // Show loading state
        const card = document.getElementById('customersCard');
        if (!card) {
            // fallback to full navigation
            window.location.href = url;
            return;
        }

        const previous = card.innerHTML;
        // insert a lightweight spinner overlay
        card.style.opacity = '0.6';
        const spinner = document.createElement('div');
        spinner.className = 'customers-loading-overlay d-flex justify-content-center align-items-center';
        spinner.innerHTML = `<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Chargement...</span></div>`;
        spinner.style.position = 'absolute';
        spinner.style.left = 0;
        spinner.style.top = 0;
        spinner.style.width = '100%';
        spinner.style.height = '100%';
        spinner.style.background = 'rgba(255,255,255,0.6)';
        spinner.style.zIndex = 2000;
        spinner.style.pointerEvents = 'none';
        card.style.position = 'relative';
        card.appendChild(spinner);

        console.debug('[customers] fetch url=', url);
    fetch(url, { method: 'GET', credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json, text/html' } })
            .then(resp => {
                console.debug('[customers] response status=', resp.status, 'content-type=', resp.headers.get('content-type'));
                if (!resp.ok) throw new Error('Fetch failed');
                // Try to parse JSON first (our server returns {html: '...'} for AJAX)
                const contentType = resp.headers.get('content-type') || '';
                if (contentType.includes('application/json')) return resp.json();
                return resp.text().then(t => ({ html: t }));
            })
            .then(data => {
                if (!data) throw new Error('Empty response');
                if (data.html && typeof data.html === 'string') {
                    // If server returned only the fragment as JSON.html, insert it into the card
                    // The fragment may be a partial (no outer #customersCard wrapper)
                    const frag = document.createElement('div');
                    frag.innerHTML = data.html;
                    // If fragment contains the wrapper, extract inner, otherwise use fragment directly
                    const newCard = frag.querySelector('#customersCard') || frag;
                    if (!newCard) {
                        window.location.href = url; // fallback
                        return;
                    }
                    card.innerHTML = newCard.innerHTML;
                } else if (data.html) {
                    // fallback to text/html string
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data.html, 'text/html');
                    const newCard = doc.getElementById('customersCard');
                    if (!newCard) {
                        window.location.href = url;
                        return;
                    }
                    card.innerHTML = newCard.innerHTML;
                } else {
                    window.location.href = url;
                    return;
                }

                // Update browser URL without reloading
                try { history.pushState({}, '', url); } catch (e) {}

                // Replace stats panel if provided by the server
                if (data.stats_html && typeof data.stats_html === 'string') {
                    const statsFrag = document.createElement('div');
                    statsFrag.innerHTML = data.stats_html;
                    const newStats = statsFrag.querySelector('#customersStats') || statsFrag;
                    const statsContainer = document.getElementById('customersStats');
                    if (statsContainer && newStats) statsContainer.innerHTML = newStats.innerHTML;
                }

                // Reattach handlers for forms/controls inside the replaced fragment
                attachFilterHandlers();
                attachPaginationHandlers();
            })
            .catch(err => {
                console.error('Filter fetch failed', err);
                // fallback to full navigation
                window.location.href = url;
            })
            .finally(() => {
                // remove spinner and restore opacity
                const ov = card.querySelector('.customers-loading-overlay');
                if (ov) ov.remove();
                card.style.opacity = '';
                card.style.position = '';
            });
    }

    // Attach submit handlers; works whether this script runs before or after DOMContentLoaded
    function attachFilterHandlers() {
        const form = document.getElementById('filterForm');
        if (!form) return;
        if (form._filterHandlersAttached) return; // idempotent
        form._filterHandlersAttached = true;

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            submitFilter();
        });

        // Handle Enter key inside the search input explicitly and add debounce for live search
        const searchInput = form.querySelector('input[name="search"]');
        if (searchInput) {
            let debounceTimer = null;
            searchInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitFilter();
                }
            });
            // debounce on input for 400ms
            searchInput.addEventListener('input', function () {
                if (debounceTimer) clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    submitFilter();
                }, 400);
            });
        }

        // Also attach click handler to the submit button to avoid issues where click doesn't trigger form submit
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.addEventListener('click', function (e) {
                e.preventDefault();
                submitFilter();
            });
        }

        // Attach change handlers to select controls to trigger AJAX filtering
        form.querySelectorAll('select').forEach(sel => {
            sel.addEventListener('change', function () {
                console.debug('[customers] select change', sel.name, sel.value);
                submitFilter();
            });
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() { attachFilterHandlers(); attachPaginationHandlers(); });
    } else {
        attachFilterHandlers();
        attachPaginationHandlers();
    }

        // Intercept pagination links inside the customersCard to use AJAX
        function attachPaginationHandlers() {
            const card = document.getElementById('customersCard');
            if (!card) return;
            card.querySelectorAll('.pagination a.page-link').forEach(a => {
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    const href = a.getAttribute('href');
                    if (!href) return;
                    // parse query params and set them into the filter form then submit
                    const url = new URL(href, window.location.origin);
                    const params = new URLSearchParams(url.search);
                    // copy params into the filter form
                    const form = document.getElementById('filterForm');
                    for (const [k, v] of params.entries()) {
                        const field = form.querySelector(`[name="${k}"]`);
                        if (field) {
                            field.value = v;
                        } else {
                            // create hidden input for page param
                            if (k === 'page') {
                                let existing = form.querySelector('input[name="page"]');
                                if (!existing) {
                                    existing = document.createElement('input');
                                    existing.type = 'hidden';
                                    existing.name = 'page';
                                    form.appendChild(existing);
                                }
                                existing.value = v;
                            }
                        }
                    }
                    submitFilter();
                });
            });
        }

        // ensure pagination handlers are attached after fragment replacement
        window.addEventListener('popstate', function () { attachFilterHandlers(); attachPaginationHandlers(); });

    function switchView(viewType) {
        const gridView = document.getElementById('gridView');
        const listView = document.getElementById('listView');
        const gridBtn = document.getElementById('view-grid-btn');
        const listBtn = document.getElementById('view-list-btn');

        if (viewType === 'grid') {
            gridView.style.display = 'block';
            listView.style.display = 'none';
            gridBtn.classList.add('active');
            listBtn.classList.remove('active');
        } else {
            gridView.style.display = 'none';
            listView.style.display = 'block';
            gridBtn.classList.remove('active');
            listBtn.classList.add('active');
        }
    }

    function deleteCustomer(customerId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce client ? Cette action supprimera également tous ses bons de travail associés.')) {
            const url = `/customers/${customerId}/delete`;
            const formData = new FormData();
            formData.append('customer_id', customerId);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            }).then(response => {
                if (response.ok) {
                    // If JSON returned, we could handle it; simplest is to reload the list fragment
                    // Try to refresh via AJAX if on customers page
                    if (document.getElementById('customersCard')) {
                        submitFilter();
                    } else {
                        location.reload();
                    }
                } else {
                    alert('Erreur lors de la suppression du client');
                }
            }).catch(err => {
                console.error('Delete failed', err);
                alert('Erreur lors de la suppression du client');
            });
        }
    }

    function exportCustomers() {
        const params = new URLSearchParams(window.location.search);
        window.location.href = `/customers/export?${params.toString()}`;
    }

    function detectAllDuplicates() {
        if (!confirm('Lancer la détection de doublons sur tous les clients ? Cette opération peut prendre du temps.')) return;
        
        fetch('/customers/duplicates/detect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                if (data.duplicates_found > 0) {
                    if (confirm('Voulez-vous voir les doublons détectés ?')) {
                        window.location.href = '/customers/duplicates';
                    }
                }
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la détection des doublons');
        });
    }

    // Style CSS pour les cartes clients - style claymorphism
    const style = document.createElement('style');
    style.textContent = `
/* Cartes clients avec effet claymorphism */
.customer-card {
    background: var(--secondary-color, #e0e5ec);
    box-shadow: var(--shadow-level-1, 8px 8px 16px #a3b1c6, -8px -8px 16px #ffffff);
    border: none;
    border-radius: var(--border-radius, 15px);
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
    overflow: visible;
}

.customer-card:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-level-3, 20px 20px 40px #a3b1c6, -20px -20px 40px #ffffff);
    z-index: 50;
}

/* Icônes de statut avec style claymorphism */
.stat-icon {
    border-radius: 50%;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-level-1, 8px 8px 16px #a3b1c6, -8px -8px 16px #ffffff);
}

/* Styles pour les avatars */
.avatar-clay {
    box-shadow: var(--shadow-level-1, 8px 8px 16px #a3b1c6, -8px -8px 16px #ffffff);
    transition: all 0.3s ease;
}

.avatar-clay:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-level-2, 12px 12px 24px #a3b1c6, -12px -12px 24px #ffffff);
}

/* Assurer que les dropdowns apparaissent au-dessus des cartes */
.dropdown-menu {
    z-index: 2050 !important;
    background: var(--secondary-color, #e0e5ec);
    box-shadow: var(--shadow-level-3, 20px 20px 40px #a3b1c6, -20px -20px 40px #ffffff);
    border: none;
    border-radius: var(--border-radius, 15px);
}

/* Styles pour les badges */
.clay-badge {
    padding: 0.4rem 0.8rem;
    border-radius: var(--border-radius-sm, 10px);
    font-weight: 500;
    font-size: 0.85rem;
}

/* Pagination style claymorphism */
.pagination .page-link {
    border: none;
    background: transparent;
    margin: 0 0.25rem;
    border-radius: var(--border-radius, 15px);
}

/* Petits éléments avec effet clay */
.small-clay-element {
    background: var(--secondary-color, #e0e5ec);
    box-shadow: var(--shadow-level-1, 4px 4px 8px #a3b1c6, -4px -4px 8px #ffffff);
    border-radius: var(--border-radius-sm, 10px);
    transition: all 0.2s ease;
}

.small-clay-element:hover {
    box-shadow: var(--shadow-level-2, 6px 6px 12px #a3b1c6, -6px -6px 12px #ffffff);
}

/* Améliorer les states de focus */
.clay-input:focus,
.clay-button:focus,
.clay-button-primary:focus {
    outline: 2px solid var(--primary-color, #5a67ff);
    outline-offset: 2px;
}

/* Animation de loading pour les états AJAX */
.customers-loading-overlay {
    background: rgba(224, 229, 236, 0.8) !important;
    backdrop-filter: blur(2px);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .customer-card:hover {
        transform: translateY(-3px);
    }
    
    .stat-icon {
        width: 48px !important;
        height: 48px !important;
    }
    
    .avatar-clay {
        width: 40px !important;
        height: 40px !important;
    }
}
`;
    document.head.appendChild(style);
</script>
{% endblock %}