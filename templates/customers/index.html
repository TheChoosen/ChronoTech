{% extends "base.html" %}

{% block title %}Gestion des Clients - ChronoTech{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-users me-2"></i>Gestion des Clients
        </h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('customers.add_customer') }}" class="btn btn-primary clay-button-primary">
                <i class="fas fa-plus me-2"></i>Nouveau Client
            </a>
            <button class="btn btn-outline-secondary clay-button" onclick="exportCustomers()">
                <i class="fas fa-download me-2"></i>Exporter
            </button>
        </div>
    </div>

    <!-- Statistiques -->
    <div id="customersStats">
        {% include 'customers/_stats.html' %}
    </div>

    <!-- Filtres et recherche -->
    <div class="clay-card mb-4">
        <div class="card-body">
            <form method="GET" id="filterForm" action="{{ url_for('customers.index') }}">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Recherche</label>
                        <div class="input-group">
                            <input type="text" class="form-control clay-input" name="search"
                                value="{{ request.args.get('search', '') }}" placeholder="Nom, email, téléphone...">
                            <button class="btn btn-outline-secondary" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Type</label>
                        <select class="form-select clay-input" name="customer_type">
                            <option value="">Tous les types</option>
                            <option value="individual" {{ 'selected' if request.args.get('customer_type')=='individual'
                                }}>
                                Particulier
                            </option>
                            <option value="company" {{ 'selected' if request.args.get('customer_type')=='company' }}>
                                Entreprise
                            </option>
                            <option value="government" {{ 'selected' if request.args.get('customer_type')=='government'
                                }}>
                                Administration
                            </option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Zone</label>
                        <select class="form-select clay-input" name="zone">
                            <option value="">Toutes zones</option>
                            {% for zone in zones %}
                            <option value="{{ zone }}" {{ 'selected' if request.args.get('zone')==zone }}>
                                {{ zone }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Statut</label>
                        <select class="form-select clay-input" name="status">
                            <option value="">Tous statuts</option>
                            <option value="active" {{ 'selected' if request.args.get('status')=='active' }}>
                                Actif
                            </option>
                            <option value="inactive" {{ 'selected' if request.args.get('status')=='inactive' }}>
                                Inactif
                            </option>
                            <option value="prospect" {{ 'selected' if request.args.get('status')=='prospect' }}>
                                Prospect
                            </option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Tri</label>
                        <select class="form-select clay-input" name="sort">
                            <option value="name" {{ 'selected' if request.args.get('sort')=='name' }}>
                                Nom A-Z
                            </option>
                            <option value="name_desc" {{ 'selected' if request.args.get('sort')=='name_desc' }}>
                                Nom Z-A
                            </option>
                            <option value="created_date" {{ 'selected' if request.args.get('sort')=='created_date' }}>
                                Plus récents
                            </option>
                            <option value="last_order" {{ 'selected' if request.args.get('sort')=='last_order' }}>
                                Dernière commande
                            </option>
                        </select>
                    </div>
                </div>

                {% if request.args.get('search') or request.args.get('customer_type') or request.args.get('zone') or
                request.args.get('status') %}
                <div class="mt-3">
                    <a href="{{ url_for('customers.index') }}" class="btn btn-sm btn-outline-secondary clay-button">
                        <i class="fas fa-times me-1"></i>Effacer les filtres
                    </a>
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Liste des clients -->
    <div class="clay-card" id="customersCard">
        {% include 'customers/_list.html' %}
    </div>
</div>

    <script>
    function submitFilter() {
        const form = document.getElementById('filterForm');
        const params = new URLSearchParams(new FormData(form));

        // remove empty values
        for (const [k, v] of Array.from(params.entries())) {
            if (!v || v === '') params.delete(k);
        }

        // always reset pagination when filtering
        params.delete('page');

    const query = params.toString();
    // Build absolute URL to avoid issues with trailing slashes or relative paths
    const actionAttr = form.getAttribute('action') || window.location.pathname;
    const actionUrl = new URL(actionAttr, window.location.origin);
    actionUrl.search = query; // sets empty string if no params
    const url = actionUrl.toString();
    console.debug('[customers] params=', query);

        // Show loading state
        const card = document.getElementById('customersCard');
        if (!card) {
            // fallback to full navigation
            window.location.href = url;
            return;
        }

        const previous = card.innerHTML;
        // insert a lightweight spinner overlay
        card.style.opacity = '0.6';
        const spinner = document.createElement('div');
        spinner.className = 'customers-loading-overlay d-flex justify-content-center align-items-center';
        spinner.innerHTML = `<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Chargement...</span></div>`;
        spinner.style.position = 'absolute';
        spinner.style.left = 0;
        spinner.style.top = 0;
        spinner.style.width = '100%';
        spinner.style.height = '100%';
        spinner.style.background = 'rgba(255,255,255,0.6)';
        spinner.style.zIndex = 2000;
        spinner.style.pointerEvents = 'none';
        card.style.position = 'relative';
        card.appendChild(spinner);

        console.debug('[customers] fetch url=', url);
    fetch(url, { method: 'GET', credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json, text/html' } })
            .then(resp => {
                console.debug('[customers] response status=', resp.status, 'content-type=', resp.headers.get('content-type'));
                if (!resp.ok) throw new Error('Fetch failed');
                // Try to parse JSON first (our server returns {html: '...'} for AJAX)
                const contentType = resp.headers.get('content-type') || '';
                if (contentType.includes('application/json')) return resp.json();
                return resp.text().then(t => ({ html: t }));
            })
            .then(data => {
                if (!data) throw new Error('Empty response');
                if (data.html && typeof data.html === 'string') {
                    // If server returned only the fragment as JSON.html, insert it into the card
                    // The fragment may be a partial (no outer #customersCard wrapper)
                    const frag = document.createElement('div');
                    frag.innerHTML = data.html;
                    // If fragment contains the wrapper, extract inner, otherwise use fragment directly
                    const newCard = frag.querySelector('#customersCard') || frag;
                    if (!newCard) {
                        window.location.href = url; // fallback
                        return;
                    }
                    card.innerHTML = newCard.innerHTML;
                } else if (data.html) {
                    // fallback to text/html string
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data.html, 'text/html');
                    const newCard = doc.getElementById('customersCard');
                    if (!newCard) {
                        window.location.href = url;
                        return;
                    }
                    card.innerHTML = newCard.innerHTML;
                } else {
                    window.location.href = url;
                    return;
                }

                // Update browser URL without reloading
                try { history.pushState({}, '', url); } catch (e) {}

                // Replace stats panel if provided by the server
                if (data.stats_html && typeof data.stats_html === 'string') {
                    const statsFrag = document.createElement('div');
                    statsFrag.innerHTML = data.stats_html;
                    const newStats = statsFrag.querySelector('#customersStats') || statsFrag;
                    const statsContainer = document.getElementById('customersStats');
                    if (statsContainer && newStats) statsContainer.innerHTML = newStats.innerHTML;
                }

                // Reattach handlers for forms/controls inside the replaced fragment
                attachFilterHandlers();
                attachPaginationHandlers();
            })
            .catch(err => {
                console.error('Filter fetch failed', err);
                // fallback to full navigation
                window.location.href = url;
            })
            .finally(() => {
                // remove spinner and restore opacity
                const ov = card.querySelector('.customers-loading-overlay');
                if (ov) ov.remove();
                card.style.opacity = '';
                card.style.position = '';
            });
    }

    // Attach submit handlers; works whether this script runs before or after DOMContentLoaded
    function attachFilterHandlers() {
        const form = document.getElementById('filterForm');
        if (!form) return;
        if (form._filterHandlersAttached) return; // idempotent
        form._filterHandlersAttached = true;

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            submitFilter();
        });

        // Handle Enter key inside the search input explicitly and add debounce for live search
        const searchInput = form.querySelector('input[name="search"]');
        if (searchInput) {
            let debounceTimer = null;
            searchInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitFilter();
                }
            });
            // debounce on input for 400ms
            searchInput.addEventListener('input', function () {
                if (debounceTimer) clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    submitFilter();
                }, 400);
            });
        }

        // Also attach click handler to the submit button to avoid issues where click doesn't trigger form submit
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.addEventListener('click', function (e) {
                e.preventDefault();
                submitFilter();
            });
        }

        // Attach change handlers to select controls to trigger AJAX filtering
        form.querySelectorAll('select').forEach(sel => {
            sel.addEventListener('change', function () {
                console.debug('[customers] select change', sel.name, sel.value);
                submitFilter();
            });
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() { attachFilterHandlers(); attachPaginationHandlers(); });
    } else {
        attachFilterHandlers();
        attachPaginationHandlers();
    }

        // Intercept pagination links inside the customersCard to use AJAX
        function attachPaginationHandlers() {
            const card = document.getElementById('customersCard');
            if (!card) return;
            card.querySelectorAll('.pagination a.page-link').forEach(a => {
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    const href = a.getAttribute('href');
                    if (!href) return;
                    // parse query params and set them into the filter form then submit
                    const url = new URL(href, window.location.origin);
                    const params = new URLSearchParams(url.search);
                    // copy params into the filter form
                    const form = document.getElementById('filterForm');
                    for (const [k, v] of params.entries()) {
                        const field = form.querySelector(`[name="${k}"]`);
                        if (field) {
                            field.value = v;
                        } else {
                            // create hidden input for page param
                            if (k === 'page') {
                                let existing = form.querySelector('input[name="page"]');
                                if (!existing) {
                                    existing = document.createElement('input');
                                    existing.type = 'hidden';
                                    existing.name = 'page';
                                    form.appendChild(existing);
                                }
                                existing.value = v;
                            }
                        }
                    }
                    submitFilter();
                });
            });
        }

        // ensure pagination handlers are attached after fragment replacement
        window.addEventListener('popstate', function () { attachFilterHandlers(); attachPaginationHandlers(); });

    function switchView(viewType) {
        const gridView = document.getElementById('gridView');
        const listView = document.getElementById('listView');

        if (viewType === 'grid') {
            gridView.style.display = 'block';
            listView.style.display = 'none';
        } else {
            gridView.style.display = 'none';
            listView.style.display = 'block';
        }
    }

    function deleteCustomer(customerId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce client ? Cette action supprimera également tous ses bons de travail associés.')) {
            const url = `/customers/${customerId}/delete`;
            const formData = new FormData();
            formData.append('customer_id', customerId);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            }).then(response => {
                if (response.ok) {
                    // If JSON returned, we could handle it; simplest is to reload the list fragment
                    // Try to refresh via AJAX if on customers page
                    if (document.getElementById('customersCard')) {
                        submitFilter();
                    } else {
                        location.reload();
                    }
                } else {
                    alert('Erreur lors de la suppression du client');
                }
            }).catch(err => {
                console.error('Delete failed', err);
                alert('Erreur lors de la suppression du client');
            });
        }
    }

    function exportCustomers() {
        // window.location.href = `/customers/export?{{ request.query_string.decode() }}`;
    }

    // Style CSS pour les cartes clients (prévenir chevauchement et gérer z-index)
    const style = document.createElement('style');
    style.textContent = `
.customer-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    border: 1px solid rgba(0,0,0,0.08);
    position: relative; /* create stacking context */
    z-index: 1;
}
.customer-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.18);
    z-index: 50; /* bring hovered card above neighbors */
}
/* Ensure dropdown menus and popovers appear above cards */
.dropdown-menu {
    z-index: 1050; /* above typical Bootstrap modals */
}
.icon-shape {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.stat-item h6 {
    color: #495057;
    font-weight: 600;
}
.avatar-circle {
    min-width: 48px;
}
/* Small flag style for status icons */
.customer-status-flag {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 1rem;
}
.customer-status-flag i {
    font-size: 1.1rem;
}
`;
    document.head.appendChild(style);
</script>
{% endblock %}