{% extends "base.html" %}

{% block title %}Modifier Bon de Travail {{ work_order.claim_number }} - ChronoTech{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-edit me-2"></i>Modifier Bon de Travail {{ work_order.claim_number }}
        </h1>
        <a href="{{ url_for('work_orders.view_work_order', id=work_order.id) }}" class="btn btn-outline-secondary clay-button">
            <i class="fas fa-arrow-left me-2"></i>Retour
        </a>
    </div>

    <form id="workOrderForm" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}"/>
        
        <div class="row">
            <!-- Contenu principal -->
            <div class="col-lg-8">
                <!-- Informations principales -->
                <div class="clay-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations Principales</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="claim_number" class="form-label">Numéro de réclamation</label>
                                    <input type="text" class="form-control clay-input" name="claim_number" 
                                           value="{{ work_order.claim_number or '' }}" readonly>
                                    <div class="form-text">Le numéro de réclamation ne peut pas être modifié</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="customer_id" class="form-label">Client</label>
                                    <select class="form-select clay-input" name="customer_id" id="customer_id">
                                        <option value="">Sélectionner un client</option>
                                        {% for customer in customers %}
                                        <option value="{{ customer.id }}" 
                                                {% if customer.id == work_order.customer_id %}selected{% endif %}
                                                data-email="{{ customer.email or '' }}" 
                                                data-phone="{{ customer.phone or '' }}"
                                                data-address="{{ customer.address or '' }}">
                                            {{ customer.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="priority" class="form-label">Priorité</label>
                                    <select class="form-select clay-input" name="priority" id="priority">
                                        <option value="low" {% if work_order.priority == 'low' %}selected{% endif %}>Faible</option>
                                        <option value="medium" {% if work_order.priority == 'medium' %}selected{% endif %}>Moyenne</option>
                                        <option value="high" {% if work_order.priority == 'high' %}selected{% endif %}>Élevée</option>
                                        <option value="urgent" {% if work_order.priority == 'urgent' %}selected{% endif %}>Urgente</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="status" class="form-label">Statut</label>
                                    <select class="form-select clay-input" name="status" id="status">
                                        <option value="pending" {% if work_order.status == 'pending' %}selected{% endif %}>En attente</option>
                                        <option value="assigned" {% if work_order.status == 'assigned' %}selected{% endif %}>Assigné</option>
                                        <option value="in_progress" {% if work_order.status == 'in_progress' %}selected{% endif %}>En cours</option>
                                        <option value="completed" {% if work_order.status == 'completed' %}selected{% endif %}>Terminé</option>
                                        <option value="cancelled" {% if work_order.status == 'cancelled' %}selected{% endif %}>Annulé</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="assigned_technician_id" class="form-label">Technicien assigné</label>
                                    <select class="form-select clay-input" name="assigned_technician_id" id="assigned_technician_id">
                                        <option value="">Non assigné</option>
                                        {% for technician in technicians %}
                                        <option value="{{ technician.id }}" 
                                                {% if technician.id == work_order.assigned_technician_id %}selected{% endif %}>
                                            {{ technician.name }} ({{ technician.specialization }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="scheduled_date" class="form-label">Date prévue</label>
                                    <input type="datetime-local" class="form-control clay-input" name="scheduled_date" 
                                           id="scheduled_date" value="{{ work_order.scheduled_date.strftime('%Y-%m-%dT%H:%M') if work_order.scheduled_date else '' }}">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control clay-input" name="description" id="description" rows="4" 
                                      placeholder="Description détaillée du problème ou de l'intervention à effectuer...">{{ work_order.description or '' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes (visibles client)</label>
                            <textarea class="form-control clay-input" name="notes" id="notes" rows="3" 
                                      placeholder="Notes visibles par le client...">{{ work_order.notes or '' }}</textarea>
                            <div class="form-text">Ces notes seront visibles par le client</div>
                        </div>

                        <div class="mb-3">
                            <label for="internal_notes" class="form-label">Notes internes</label>
                            <textarea class="form-control clay-input" name="internal_notes" id="internal_notes" rows="3" 
                                      placeholder="Notes internes, non visibles par le client...">{{ work_order.internal_notes or '' }}</textarea>
                            <div class="form-text">Ces notes ne sont visibles que par l'équipe interne</div>
                        </div>
                    </div>
                </div>

                <!-- Localisation -->
                <div class="clay-card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Localisation</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary clay-button" data-action="location">
                            <i class="fas fa-crosshairs me-2"></i>Position actuelle
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="location_address" class="form-label">Adresse</label>
                            <textarea class="form-control clay-input" name="location_address" id="location_address" rows="3" 
                                      placeholder="Adresse complète de l'intervention...">{{ work_order.location_address or '' }}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="location_latitude" class="form-label">Latitude</label>
                                    <input type="number" class="form-control clay-input" name="location_latitude" 
                                           id="location_latitude" step="any" placeholder="Latitude"
                                           value="{{ work_order.location_latitude or '' }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="location_longitude" class="form-label">Longitude</label>
                                    <input type="number" class="form-control clay-input" name="location_longitude" 
                                           id="location_longitude" step="any" placeholder="Longitude"
                                           value="{{ work_order.location_longitude or '' }}">
                                </div>
                            </div>
                        </div>

                        <!-- Mini carte si coordonnées disponibles -->
                        <div id="editMapContainer" style="display: none;">
                            <div id="editMap" style="height: 250px; border-radius: 8px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Médias et documents -->
                <div class="clay-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-paperclip me-2"></i>Documents et Médias</h5>
                    </div>
                    <div class="card-body">
                        <!-- Documents existants -->
                        {% if media_files %}
                        <h6>Fichiers existants :</h6>
                        <div class="row mb-3">
                            {% for media in media_files %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card">
                                    {% if media.file_type.startswith('image') %}
                                    <img src="{{ url_for('static', filename='uploads/' + media.filename) }}" 
                                         class="card-img-top" style="height: 120px; object-fit: cover;">
                                    {% else %}
                                    <div class="card-img-top d-flex align-items-center justify-content-center" 
                                         style="height: 120px; background-color: #f8f9fa;">
                                        <i class="fas fa-file fa-3x text-muted"></i>
                                    </div>
                                    {% endif %}
                                    <div class="card-body p-2">
                                        <h6 class="card-title small mb-1">{{ media.original_filename }}</h6>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">{{ media.created_at|datetime_format }}</small>
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    data-action="remove-media" data-media-id="{{ media.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <hr>
                        {% endif %}

                        <!-- Upload de nouveaux fichiers -->
                        <div class="mb-3">
                            <label for="new_files" class="form-label">Ajouter de nouveaux fichiers</label>
                            <input type="file" class="form-control clay-input" id="new_files" 
                                   name="new_files" multiple accept="image/*,.pdf,.doc,.docx,.txt">
                            <div class="form-text">
                                Types supportés : Images, PDF, Documents Word, Texte. Taille max : 10MB par fichier.
                            </div>
                        </div>

                        <!-- Aperçu des nouveaux fichiers -->
                        <div id="newFilesPreview" class="row" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Actions -->
                <div class="clay-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-save me-2"></i>Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary clay-button-primary">
                                <i class="fas fa-save me-2"></i>Enregistrer les modifications
                            </button>
                            <a href="{{ url_for('work_orders.view_work_order', id=work_order.id) }}" 
                               class="btn btn-outline-secondary clay-button">
                                <i class="fas fa-times me-2"></i>Annuler
                            </a>
                            {% if current_user.role in ['admin', 'supervisor'] %}
                            <hr>
                            <button type="button" class="btn btn-outline-danger clay-button" 
                                    data-action="delete">
                                <i class="fas fa-trash me-2"></i>Supprimer
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Informations système -->
                <div class="clay-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info me-2"></i>Informations</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless table-sm">
                            <tr>
                                <td><strong>Créé le :</strong></td>
                                <td>{{ work_order.created_at|datetime_format }}</td>
                            </tr>
                            <tr>
                                <td><strong>Créé par :</strong></td>
                                <td>{{ work_order.created_by_name or 'Système' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Modifié le :</strong></td>
                                <td>{{ work_order.updated_at|datetime_format }}</td>
                            </tr>
                            <tr>
                                <td><strong>ID :</strong></td>
                                <td>{{ work_order.id }}</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Estimations -->
                <div class="clay-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Estimations</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="estimated_duration" class="form-label">Durée estimée</label>
                            <div class="input-group">
                                <input type="number" class="form-control clay-input" name="estimated_duration" 
                                       id="estimated_duration" placeholder="0" step="0.1" min="0"
                                       value="{{ work_order.estimated_duration or '' }}">
                                <span class="input-group-text">heures</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="estimated_cost" class="form-label">Coût estimé</label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="number" class="form-control clay-input" name="estimated_cost" 
                                       id="estimated_cost" placeholder="0.00" step="0.01" min="0"
                                       value="{{ work_order.estimated_cost or '' }}">
                            </div>
                        </div>

                        <!-- Calcul automatique -->
                        <div class="mt-3">
                            <button type="button" class="btn btn-sm btn-outline-info clay-button" 
                                    data-action="calculate">
                                <i class="fas fa-calculator me-2"></i>Calculer automatiquement
                            </button>
                            <div class="form-text">
                                Basé sur la complexité et les tarifs standard
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informations client -->
                <div class="clay-card" id="customerInfo" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-user me-2"></i>Informations Client</h5>
                    </div>
                    <div class="card-body">
                        <div id="customerDetails">
                            <!-- Contenu dynamique -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Gestion du changement de client
document.getElementById('customer_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const customerInfo = document.getElementById('customerInfo');
    const customerDetails = document.getElementById('customerDetails');
    
    if (selectedOption.value) {
        const email = selectedOption.dataset.email;
        const phone = selectedOption.dataset.phone;
        const address = selectedOption.dataset.address;
        
        let html = `<p><strong>${selectedOption.text}</strong></p>`;
        if (email) html += `<p><i class="fas fa-envelope me-2"></i>${email}</p>`;
        if (phone) html += `<p><i class="fas fa-phone me-2"></i>${phone}</p>`;
        if (address) html += `<p><i class="fas fa-map-marker-alt me-2"></i>${address}</p>`;
        
        customerDetails.innerHTML = html;
        customerInfo.style.display = 'block';
    } else {
        customerInfo.style.display = 'none';
    }
});

// Géolocalisation
function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            document.getElementById('location_latitude').value = position.coords.latitude.toFixed(6);
            document.getElementById('location_longitude').value = position.coords.longitude.toFixed(6);
            updateMap();
        }, function() {
            alert('Impossible d\'obtenir votre position actuelle.');
        });
    } else {
        alert('La géolocalisation n\'est pas supportée par ce navigateur.');
    }
}

// Mise à jour de la carte
function updateMap() {
    const lat = document.getElementById('location_latitude').value;
    const lng = document.getElementById('location_longitude').value;
    
    if (lat && lng) {
        const mapContainer = document.getElementById('editMapContainer');
        if (mapContainer) {
            mapContainer.style.display = 'block';
            console.log('Afficher carte aux coordonnées:', lat, lng);
        }
    }
}

// Aperçu des fichiers
const fileInput = document.getElementById('new_files');
if (fileInput) {
    fileInput.addEventListener('change', function() {
        const preview = document.getElementById('newFilesPreview');
        if (!preview) return;
        
        preview.innerHTML = '';
        
        if (this.files.length > 0) {
            preview.style.display = 'flex';
            
            Array.from(this.files).forEach((file) => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-3';
                
                const isImage = file.type.startsWith('image/');
                
                if (isImage) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        col.innerHTML = `
                            <div class="card">
                                <img src="${e.target.result}" class="card-img-top" style="height: 120px; object-fit: cover;">
                                <div class="card-body p-2">
                                    <h6 class="card-title small mb-1">${file.name}</h6>
                                    <small class="text-muted">${(file.size / 1024).toFixed(1)} KB</small>
                                </div>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                } else {
                    col.innerHTML = `
                        <div class="card">
                            <div class="card-img-top d-flex align-items-center justify-content-center" 
                                 style="height: 120px; background-color: #f8f9fa;">
                                <i class="fas fa-file fa-3x text-muted"></i>
                            </div>
                            <div class="card-body p-2">
                                <h6 class="card-title small mb-1">${file.name}</h6>
                                <small class="text-muted">${(file.size / 1024).toFixed(1)} KB</small>
                            </div>
                        </div>
                    `;
                }
                
                preview.appendChild(col);
            });
        } else {
            preview.style.display = 'none';
        }
    });
}

// Calcul automatique des estimations
function calculateEstimate() {
    const priority = document.getElementById('priority').value;
    const description = document.getElementById('description').value;
    
    let baseDuration = 2; // heures
    let baseRate = 80; // €/heure
    
    switch(priority) {
        case 'urgent':
            baseDuration *= 1.5;
            baseRate *= 1.3;
            break;
        case 'high':
            baseDuration *= 1.2;
            baseRate *= 1.1;
            break;
    }
    
    if (description.length > 200) {
        baseDuration *= 1.3;
    }
    
    const durationField = document.getElementById('estimated_duration');
    const costField = document.getElementById('estimated_cost');
    if (durationField) durationField.value = baseDuration.toFixed(1);
    if (costField) costField.value = (baseDuration * baseRate).toFixed(2);
}

// Event listeners pour les boutons avec data-action
document.addEventListener('click', function(e) {
    const action = e.target.closest('[data-action]')?.dataset.action;
    
    switch(action) {
        case 'location':
            getCurrentLocation();
            break;
            
        case 'calculate':
            calculateEstimate();
            break;
            
        case 'remove-media':
            const mediaId = e.target.closest('[data-media-id]')?.dataset.mediaId;
            if (mediaId && confirm("Êtes-vous sûr de vouloir supprimer ce fichier ?")) {
                fetch(`{{ url_for('work_orders.delete_media') }}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({media_id: mediaId})
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Erreur lors de la suppression du fichier');
                    }
                }).catch(() => {
                    alert('Erreur de connexion');
                });
            }
            break;
            
        case 'delete':
            if (confirm("Êtes-vous sûr de vouloir supprimer ce bon de travail ? Cette action est irréversible.")) {
                alert('Fonctionnalité de suppression à implémenter');
            }
            break;
    }
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Déclencher l'affichage des infos client si un client est déjà sélectionné
    const customerSelect = document.getElementById('customer_id');
    if (customerSelect) {
        customerSelect.dispatchEvent(new Event('change'));
    }
    
    // Déclencher l'affichage de la carte si coordonnées présentes
    updateMap();
});
</script>
{% endblock %}
