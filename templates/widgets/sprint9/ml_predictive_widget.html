<!-- Widget Sprint 9.1 - Maintenance Prédictive ML 2.0 -->
<div class="clay-card dashboard-widget" id="ml-predictive-widget">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
            <i class="fa-solid fa-brain me-2 text-primary"></i>
            <span class="widget-title">Maintenance Prédictive ML 2.0</span>
            <span class="badge bg-info ms-2" id="ml-model-badge">IA</span>
        </h6>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="refreshMLPredictions()" title="Actualiser prédictions">
                <i class="fa-solid fa-sync-alt"></i>
            </button>
            <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#mlPredictiveModal" title="Vue détaillée">
                <i class="fa-solid fa-expand"></i>
            </button>
        </div>
    </div>
    
    <div class="card-body p-3">
        <!-- Indicateurs de risque rapides -->
        <div class="ml-risk-indicators mb-3">
            <div class="row text-center">
                <div class="col-3">
                    <div class="risk-indicator critical">
                        <i class="fa-solid fa-exclamation-triangle fa-2x mb-1"></i>
                        <div class="risk-count" id="ml-critical-count">0</div>
                        <small>Critique</small>
                    </div>
                </div>
                <div class="col-3">
                    <div class="risk-indicator high">
                        <i class="fa-solid fa-clock fa-2x mb-1"></i>
                        <div class="risk-count" id="ml-high-count">0</div>
                        <small>Élevé</small>
                    </div>
                </div>
                <div class="col-3">
                    <div class="risk-indicator medium">
                        <i class="fa-solid fa-info-circle fa-2x mb-1"></i>
                        <div class="risk-count" id="ml-medium-count">0</div>
                        <small>Moyen</small>
                    </div>
                </div>
                <div class="col-3">
                    <div class="risk-indicator low">
                        <i class="fa-solid fa-check-circle fa-2x mb-1"></i>
                        <div class="risk-count" id="ml-low-count">0</div>
                        <small>Faible</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Prédictions urgentes -->
        <div class="ml-urgent-predictions">
            <h6 class="mb-2">
                <i class="fa-solid fa-bell text-warning me-1"></i>
                Interventions Urgentes
            </h6>
            <div id="ml-urgent-list" class="urgent-predictions-list">
                <div class="text-center text-muted py-2">
                    <i class="fa-solid fa-spinner fa-spin me-2"></i>
                    Analyse des prédictions...
                </div>
            </div>
        </div>
        
        <!-- Actions rapides ML -->
        <div class="ml-quick-actions mt-3">
            <div class="row">
                <div class="col-6">
                    <button class="btn btn-primary btn-sm w-100" onclick="generatePreventiveWorkOrders()">
                        <i class="fa-solid fa-magic me-1"></i>
                        Bons Préventifs
                    </button>
                </div>
                <div class="col-6">
                    <button class="btn btn-info btn-sm w-100" onclick="showFleetAnalysis()">
                        <i class="fa-solid fa-chart-line me-1"></i>
                        Analyse Flotte
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Statistiques ML -->
        <div class="ml-stats mt-3">
            <div class="row text-center">
                <div class="col-6">
                    <div class="stat-item">
                        <div class="stat-value" style="color: black;" id="ml-accuracy">--</div>
                        <div class="stat-label" style="color: black;">Précision IA</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-item">
                        <div class="stat-value" style="color: black;" id="ml-vehicles-analyzed">--</div>
                        <div class="stat-label" style="color: black;">Véhicules</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Indicateur de statut modèle -->
        <div class="ml-model-status mt-2">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <i class="fa-solid fa-microchip me-1"></i>
                    Modèle: <span id="ml-model-type">Chargement...</span>
                </small>
                <small class="text-muted">
                    <i class="fa-solid fa-clock me-1"></i>
                    <span id="ml-last-update">--</span>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Modal détaillée Maintenance Prédictive -->
<div class="modal fade" id="mlPredictiveModal" tabindex="-1" aria-labelledby="mlPredictiveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mlPredictiveModalLabel">
                    <i class="fa-solid fa-brain me-2 text-primary"></i>
                    Maintenance Prédictive ML 2.0 - Analyse Complète
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            
            <div class="modal-body">
                <!-- Contrôles de la modal -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="runFleetAnalysis()">
                                <i class="fa-solid fa-play me-1"></i>
                                Analyser Flotte
                            </button>
                            <button class="btn btn-success" onclick="generateAllPredictions()">
                                <i class="fa-solid fa-magic me-1"></i>
                                Prédictions Auto
                            </button>
                            <button class="btn btn-warning" onclick="retrainMLModel()">
                                <i class="fa-solid fa-sync-alt me-1"></i>
                                Réentraîner IA
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex gap-2 justify-content-end">
                            <select class="form-select form-select-sm" id="ml-risk-filter" onchange="filterMLPredictions()">
                                <option value="">Tous les risques</option>
                                <option value="critical">Critique</option>
                                <option value="high">Élevé</option>
                                <option value="medium">Moyen</option>
                                <option value="low">Faible</option>
                            </select>
                            <button class="btn btn-outline-primary btn-sm" onclick="exportMLReport()">
                                <i class="fa-solid fa-download me-1"></i>
                                Export
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Tableau de bord ML -->
                <div class="row mb-4">
                    <div class="col-lg-8">
                        <!-- Liste des prédictions -->
                        <div class="clay-card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fa-solid fa-list me-2"></i>
                                    Prédictions par Véhicule
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 400px;">
                                    <table class="table table-hover mb-0" id="ml-predictions-table">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>Véhicule</th>
                                                <th>Risque</th>
                                                <th>Jours</th>
                                                <th>Confiance</th>
                                                <th>Anomalie</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ml-predictions-tbody">
                                            <tr>
                                                <td colspan="6" class="text-center py-4">
                                                    <i class="fa-solid fa-spinner fa-spin me-2"></i>
                                                    Chargement des prédictions...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <!-- Statistiques détaillées -->
                        <div class="clay-card h-100">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fa-solid fa-chart-pie me-2"></i>
                                    Statistiques IA
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="ml-detailed-stats">
                                    <div class="stat-row mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Modèle utilisé:</span>
                                            <span class="badge bg-info" id="ml-model-badge-modal">ML</span>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-row mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Précision moyenne:</span>
                                            <span class="fw-bold text-success" id="ml-avg-confidence">--</span>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-row mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Anomalies détectées:</span>
                                            <span class="fw-bold text-warning" id="ml-anomalies-count">--</span>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-row mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Délai moyen:</span>
                                            <span class="fw-bold" id="ml-avg-days">-- jours</span>
                                        </div>
                                    </div>
                                    
                                    <hr>
                                    
                                    <div class="risk-distribution">
                                        <h6 class="mb-2">Distribution des Risques</h6>
                                        <div class="progress mb-2" style="height: 20px;">
                                            <div class="progress-bar bg-danger" id="critical-bar" style="width: 0%">Critique</div>
                                            <div class="progress-bar bg-warning" id="high-bar" style="width: 0%">Élevé</div>
                                            <div class="progress-bar bg-info" id="medium-bar" style="width: 0%">Moyen</div>
                                            <div class="progress-bar bg-success" id="low-bar" style="width: 0%">Faible</div>
                                        </div>
                                        <div class="risk-legend">
                                            <div class="d-flex justify-content-between small">
                                                <span><span class="badge bg-danger">Critique</span> <span id="critical-percent">0%</span></span>
                                                <span><span class="badge bg-success">Faible</span> <span id="low-percent">0%</span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Graphique temporel des prédictions -->
                <div class="row">
                    <div class="col-12">
                        <div class="clay-card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fa-solid fa-chart-line me-2"></i>
                                    Évolution des Prédictions
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="ml-predictions-chart" style="height: 200px;">
                                    <div class="d-flex align-items-center justify-content-center h-100">
                                        <div class="text-muted">
                                            <i class="fa-solid fa-chart-line fa-3x mb-2 d-block"></i>
                                            Graphique des prédictions ML<br>
                                            <small>Évolution temporelle des risques</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div>
                        <small class="text-muted">
                            <i class="fa-solid fa-microchip me-1"></i>
                            Sprint 9.1 - IA Prédictive v2.0
                        </small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        <button type="button" class="btn btn-primary" onclick="generatePreventiveWorkOrders()">
                            <i class="fa-solid fa-magic me-1"></i>
                            Générer Bons Préventifs
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Styles Widget ML Prédictif Sprint 9.1 */
.widget-ml-predictive {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}

.widget-ml-predictive .card-header {
    background: rgba(255, 255, 255, 0.1);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.widget-ml-predictive .card-body {
    background: rgba(255, 255, 255, 0.05);
}

.ml-risk-indicators .risk-indicator {
    padding: 0.75rem;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.ml-risk-indicators .risk-indicator:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.ml-risk-indicators .risk-indicator.critical {
    background: rgba(220, 53, 69, 0.2);
    border: 1px solid rgba(220, 53, 69, 0.3);
}

.ml-risk-indicators .risk-indicator.high {
    background: rgba(255, 193, 7, 0.2);
    border: 1px solid rgba(255, 193, 7, 0.3);
}

.ml-risk-indicators .risk-indicator.medium {
    background: rgba(13, 202, 240, 0.2);
    border: 1px solid rgba(13, 202, 240, 0.3);
}

.ml-risk-indicators .risk-indicator.low {
    background: rgba(25, 135, 84, 0.2);
    border: 1px solid rgba(25, 135, 84, 0.3);
}

.risk-count {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0.25rem 0;
}

.urgent-predictions-list {
    max-height: 150px;
    overflow-y: auto;
}

.ml-urgent-item {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.2);
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.ml-urgent-item:hover {
    background: rgba(255, 193, 7, 0.2);
    transform: translateX(5px);
}

.ml-urgent-item .urgent-vehicle {
    font-weight: 600;
    color: #ffc107;
}

.ml-urgent-item .urgent-days {
    font-weight: bold;
    color: #dc3545;
}

.ml-stats .stat-item {
    padding: 0.5rem;
    text-align: center;
}

.ml-stats .stat-value {
    font-size: 1.25rem;
    font-weight: bold;
    color: #fff;
}

.ml-stats .stat-label {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.8);
}

.ml-model-status {
    padding-top: 0.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* Styles Modal ML */
#mlPredictiveModal .clay-card {
    border: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

#mlPredictiveModal .table-responsive {
    border-radius: 0.5rem;
}

#mlPredictiveModal .risk-distribution .progress {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

#mlPredictiveModal .risk-distribution .progress-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.75rem;
    min-width: 60px;
}

.ml-detailed-stats .stat-row {
    padding: 0.5rem 0;
    border-bottom: 1px solid #e9ecef;
}

.ml-detailed-stats .stat-row:last-child {
    border-bottom: none;
}

/* Animation des prédictions */
.ml-prediction-row {
    transition: all 0.3s ease;
}

.ml-prediction-row:hover {
    background: rgba(13, 110, 253, 0.05);
    transform: translateX(5px);
}

.ml-prediction-row.critical {
    border-left: 4px solid #dc3545;
}

.ml-prediction-row.high {
    border-left: 4px solid #fd7e14;
}

.ml-prediction-row.medium {
    border-left: 4px solid #0dcaf0;
}

.ml-prediction-row.low {
    border-left: 4px solid #198754;
}

/* Indicateurs de confiance */
.confidence-indicator {
    width: 100%;
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}

.confidence-bar {
    height: 100%;
    border-radius: 3px;
    transition: width 0.3s ease;
}

.confidence-bar.high {
    background: linear-gradient(90deg, #198754, #20c997);
}

.confidence-bar.medium {
    background: linear-gradient(90deg, #fd7e14, #ffc107);
}

.confidence-bar.low {
    background: linear-gradient(90deg, #dc3545, #fd5c5c);
}

/* Responsive */
@media (max-width: 768px) {
    .widget-ml-predictive .ml-risk-indicators .col-3 {
        margin-bottom: 0.5rem;
    }
    
    .widget-ml-predictive .ml-quick-actions .col-6 {
        margin-bottom: 0.5rem;
    }
    
    #mlPredictiveModal .modal-dialog {
        max-width: 95%;
        margin: 0.5rem auto;
    }
    
    #mlPredictiveModal .table-responsive {
        font-size: 0.875rem;
    }
}

/* Animations de chargement */
@keyframes mlPulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.ml-loading {
    animation: mlPulse 1.5s ease-in-out infinite;
}

/* Indicateurs de statut */
.ml-status-online {
    color: #198754;
}

.ml-status-training {
    color: #fd7e14;
}

.ml-status-error {
    color: #dc3545;
}
</style>

<script>
// Script Widget ML Prédictif Sprint 9.1
class MLPredictiveWidget {
    constructor() {
        this.predictions = [];
        this.isLoading = false;
        this.refreshInterval = null;
        this.init();
    }
    
    init() {
        console.log('🤖 Initialisation Widget ML Prédictif Sprint 9.1');
        this.loadInitialData();
        this.setupEventListeners();
        this.startAutoRefresh();
    }
    
    async loadInitialData() {
        this.setLoading(true);
        try {
            await this.refreshMLPredictions();
            await this.loadMLStats();
        } catch (error) {
            console.error('❌ Erreur chargement initial ML:', error);
            this.showError('Erreur chargement données ML');
        } finally {
            this.setLoading(false);
        }
    }
    
    setupEventListeners() {
        // Auto-actualisation au focus de la modal
        $('#mlPredictiveModal').on('shown.bs.modal', () => {
            this.refreshModalData();
        });
        
        // Gestion du filtre de risque
        document.getElementById('ml-risk-filter')?.addEventListener('change', (e) => {
            this.filterMLPredictions();
        });
    }
    
    startAutoRefresh() {
        // Actualisation automatique toutes les 5 minutes
        this.refreshInterval = setInterval(() => {
            if (!this.isLoading) {
                this.refreshMLPredictions();
            }
        }, 300000); // 5 minutes
    }
    
    setLoading(loading) {
        this.isLoading = loading;
        const loadingElements = document.querySelectorAll('.ml-loading');
        loadingElements.forEach(el => {
            if (loading) {
                el.classList.add('ml-loading');
            } else {
                el.classList.remove('ml-loading');
            }
        });
    }
    
    async refreshMLPredictions() {
        try {
            console.log('🔄 Actualisation prédictions ML...');
            
            const response = await fetch('/api/v1/ml/predict/fleet?limit=20');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            
            if (data.success) {
                this.predictions = data.predictions;
                this.updateWidgetDisplay(data);
                this.updateModalTable(data.predictions);
                console.log(`✅ ${data.predictions.length} prédictions chargées`);
            } else {
                throw new Error(data.error || 'Erreur API');
            }
            
        } catch (error) {
            console.error('❌ Erreur refresh ML:', error);
            this.showFallbackData();
        }
    }
    
    updateWidgetDisplay(data) {
        const stats = data.statistics;
        
        // Mettre à jour les compteurs de risque
        document.getElementById('ml-critical-count').textContent = stats.critical_count || 0;
        document.getElementById('ml-high-count').textContent = stats.high_count || 0;
        document.getElementById('ml-medium-count').textContent = stats.medium_count || 0;
        document.getElementById('ml-low-count').textContent = stats.low_count || 0;
        
        // Mettre à jour les stats générales
        document.getElementById('ml-vehicles-analyzed').textContent = stats.total_vehicles || 0;
        document.getElementById('ml-accuracy').textContent = '87%'; // Valeur exemple
        
        // Mettre à jour les prédictions urgentes
        this.updateUrgentPredictions(data.predictions);
        
        // Mettre à jour le statut du modèle
        document.getElementById('ml-model-type').textContent = 'ML Supervisé';
        document.getElementById('ml-last-update').textContent = new Date().toLocaleTimeString();
    }
    
    updateUrgentPredictions(predictions) {
        const urgentList = document.getElementById('ml-urgent-list');
        const urgentPredictions = predictions.filter(p => 
            p.risk_level.level === 'critical' || 
            p.prediction.days_to_maintenance <= 7
        ).slice(0, 3);
        
        if (urgentPredictions.length === 0) {
            urgentList.innerHTML = `
                <div class="text-center text-muted py-2">
                    <i class="fa-solid fa-check-circle me-2 text-success"></i>
                    Aucune intervention urgente
                </div>
            `;
            return;
        }
        
        urgentList.innerHTML = urgentPredictions.map(pred => `
            <div class="ml-urgent-item" onclick="showVehiclePrediction(${pred.vehicle_id})">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="urgent-vehicle">
                            ${pred.vehicle_info?.make || 'Véhicule'} ${pred.vehicle_info?.model || pred.vehicle_id}
                        </div>
                        <small class="text-muted">${pred.vehicle_info?.license_plate || ''}</small>
                    </div>
                    <div class="text-end">
                        <div class="urgent-days">${pred.prediction.days_to_maintenance}j</div>
                        <small class="badge bg-${pred.risk_level.level === 'critical' ? 'danger' : 'warning'}">
                            ${pred.risk_level.label}
                        </small>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    updateModalTable(predictions) {
        const tbody = document.getElementById('ml-predictions-tbody');
        
        if (predictions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="fa-solid fa-info-circle me-2"></i>
                        Aucune prédiction disponible
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = predictions.map(pred => `
            <tr class="ml-prediction-row ${pred.risk_level.level}" data-vehicle-id="${pred.vehicle_id}">
                <td>
                    <div class="fw-bold">${pred.vehicle_info?.make || ''} ${pred.vehicle_info?.model || ''}</div>
                    <small class="text-muted">${pred.vehicle_info?.license_plate || `ID: ${pred.vehicle_id}`}</small>
                </td>
                <td>
                    <span class="badge bg-${this.getRiskBadgeColor(pred.risk_level.level)}">
                        ${pred.risk_level.label}
                    </span>
                </td>
                <td>
                    <span class="fw-bold ${pred.prediction.days_to_maintenance <= 7 ? 'text-danger' : ''}">
                        ${pred.prediction.days_to_maintenance}
                    </span>
                    <small class="text-muted d-block">jours</small>
                </td>
                <td>
                    <div class="confidence-indicator mb-1">
                        <div class="confidence-bar ${this.getConfidenceLevel(pred.prediction.confidence_score)}" 
                             style="width: ${pred.prediction.confidence_score}%"></div>
                    </div>
                    <small>${pred.prediction.confidence_score}%</small>
                </td>
                <td>
                    ${pred.prediction.anomaly_detected ? 
                        '<i class="fa-solid fa-exclamation-triangle text-warning" title="Anomalie détectée"></i>' : 
                        '<i class="fa-solid fa-check text-success" title="Normal"></i>'
                    }
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="showVehiclePrediction(${pred.vehicle_id})" 
                                title="Voir détails">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="generatePreventiveWorkOrder(${pred.vehicle_id})" 
                                title="Bon préventif">
                            <i class="fa-solid fa-magic"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    getRiskBadgeColor(level) {
        const colors = {
            'critical': 'danger',
            'high': 'warning', 
            'medium': 'info',
            'low': 'success'
        };
        return colors[level] || 'secondary';
    }
    
    getConfidenceLevel(score) {
        if (score >= 80) return 'high';
        if (score >= 60) return 'medium';
        return 'low';
    }
    
    async refreshModalData() {
        await this.refreshMLPredictions();
        await this.loadMLStats();
        this.updateRiskDistribution();
    }
    
    async loadMLStats() {
        try {
            const response = await fetch('/api/v1/ml/stats/predictions');
            if (!response.ok) return;
            
            const data = await response.json();
            if (data.success) {
                this.updateModalStats(data);
            }
        } catch (error) {
            console.error('❌ Erreur stats ML:', error);
        }
    }
    
    updateModalStats(data) {
        const stats = data.prediction_stats;
        const modelInfo = data.model_info;
        
        document.getElementById('ml-model-badge-modal').textContent = 
            modelInfo.loaded ? 'ML Actif' : 'Heuristique';
        
        document.getElementById('ml-avg-confidence').textContent = 
            stats.avg_confidence ? `${Math.round(stats.avg_confidence)}%` : '--';
        
        document.getElementById('ml-anomalies-count').textContent = 
            stats.anomalies_detected || 0;
        
        document.getElementById('ml-avg-days').textContent = 
            stats.avg_days_predicted ? `${Math.round(stats.avg_days_predicted)} jours` : '--';
    }
    
    updateRiskDistribution() {
        const total = this.predictions.length;
        if (total === 0) return;
        
        const distribution = {
            critical: this.predictions.filter(p => p.risk_level.level === 'critical').length,
            high: this.predictions.filter(p => p.risk_level.level === 'high').length,
            medium: this.predictions.filter(p => p.risk_level.level === 'medium').length,
            low: this.predictions.filter(p => p.risk_level.level === 'low').length
        };
        
        // Mettre à jour les barres de progression
        Object.entries(distribution).forEach(([level, count]) => {
            const percentage = (count / total) * 100;
            const bar = document.getElementById(`${level}-bar`);
            const percentSpan = document.getElementById(`${level}-percent`);
            
            if (bar) bar.style.width = `${percentage}%`;
            if (percentSpan) percentSpan.textContent = `${Math.round(percentage)}%`;
        });
    }
    
    filterMLPredictions() {
        const filter = document.getElementById('ml-risk-filter')?.value;
        const rows = document.querySelectorAll('.ml-prediction-row');
        
        rows.forEach(row => {
            if (!filter || row.classList.contains(filter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    showFallbackData() {
        // Données de fallback pour démonstration
        const fallbackStats = {
            critical_count: 2,
            high_count: 5,
            medium_count: 8,
            low_count: 15,
            total_vehicles: 30
        };
        
        this.updateWidgetDisplay({ statistics: fallbackStats, predictions: [] });
        
        document.getElementById('ml-urgent-list').innerHTML = `
            <div class="ml-urgent-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="urgent-vehicle">Ford Transit #123</div>
                        <small class="text-muted">AB-123-CD</small>
                    </div>
                    <div class="text-end">
                        <div class="urgent-days">3j</div>
                        <small class="badge bg-danger">Critique</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    showError(message) {
        console.error('ML Widget Error:', message);
        // Toast notification
        if (window.showToast) {
            window.showToast('Erreur ML', message, 'error');
        }
    }
}

// Fonctions globales pour les actions
async function refreshMLPredictions() {
    if (window.mlPredictiveWidget) {
        await window.mlPredictiveWidget.refreshMLPredictions();
    }
}

async function generatePreventiveWorkOrders() {
    try {
        console.log('🔧 Génération bons préventifs en masse...');
        
        // Récupérer les véhicules critiques/élevés
        const criticalVehicles = window.mlPredictiveWidget?.predictions?.filter(p => 
            p.risk_level.level === 'critical' || p.risk_level.level === 'high'
        ) || [];
        
        if (criticalVehicles.length === 0) {
            alert('Aucun véhicule ne nécessite de maintenance préventive urgente.');
            return;
        }
        
        const confirm = window.confirm(
            `Générer ${criticalVehicles.length} bons de travail préventifs automatiquement ?`
        );
        
        if (!confirm) return;
        
        let generated = 0;
        for (const vehicle of criticalVehicles) {
            try {
                const response = await fetch('/api/v1/ml/generate/work-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vehicle_id: vehicle.vehicle_id })
                });
                
                if (response.ok) generated++;
            } catch (error) {
                console.error(`Erreur génération bon véhicule ${vehicle.vehicle_id}:`, error);
            }
        }
        
        if (window.showToast) {
            window.showToast(
                'Bons Préventifs', 
                `${generated} bons de travail générés automatiquement`, 
                'success'
            );
        }
        
        // Actualiser les données
        setTimeout(() => refreshMLPredictions(), 1000);
        
    } catch (error) {
        console.error('❌ Erreur génération bons préventifs:', error);
        alert('Erreur lors de la génération des bons préventifs');
    }
}

async function generatePreventiveWorkOrder(vehicleId) {
    try {
        const response = await fetch('/api/v1/ml/generate/work-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ vehicle_id: vehicleId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (window.showToast) {
                window.showToast(
                    'Bon Préventif Créé', 
                    `Bon #${data.work_order.work_order_id} généré automatiquement`, 
                    'success'
                );
            }
        } else {
            throw new Error(data.error);
        }
        
    } catch (error) {
        console.error('❌ Erreur génération bon préventif:', error);
        alert(`Erreur: ${error.message}`);
    }
}

function showFleetAnalysis() {
    $('#mlPredictiveModal').modal('show');
}

function showVehiclePrediction(vehicleId) {
    console.log(`🔍 Affichage détails prédiction véhicule ${vehicleId}`);
    // TODO: Implémenter modal détails véhicule
    alert(`Détails prédiction véhicule ${vehicleId} - À implémenter`);
}

async function runFleetAnalysis() {
    console.log('🚛 Analyse complète de la flotte...');
    await refreshMLPredictions();
}

async function generateAllPredictions() {
    console.log('🔮 Génération de toutes les prédictions...');
    await refreshMLPredictions();
}

async function retrainMLModel() {
    try {
        const confirm = window.confirm('Réentraîner le modèle ML ? Cette opération peut prendre quelques minutes.');
        if (!confirm) return;
        
        console.log('🔄 Réentraînement modèle ML...');
        
        const response = await fetch('/api/v1/ml/model/retrain', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (window.showToast) {
                window.showToast('Modèle ML', 'Réentraînement réussi', 'success');
            }
            await refreshMLPredictions();
        } else {
            throw new Error(data.error);
        }
        
    } catch (error) {
        console.error('❌ Erreur réentraînement:', error);
        alert(`Erreur réentraînement: ${error.message}`);
    }
}

function exportMLReport() {
    console.log('📊 Export rapport ML...');
    // TODO: Implémenter export
    alert('Export rapport ML - À implémenter');
}

// Initialisation automatique
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('ml-predictive-widget')) {
        window.mlPredictiveWidget = new MLPredictiveWidget();
    }
});
</script>
