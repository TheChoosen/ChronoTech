<!-- Widget Admin Center - Sprint 7.1 -->
<div class="col-lg-4 col-md-6 mb-4" data-widget="admin-center">
    <div class="card claymorphism-card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-shield-alt text-warning me-2"></i>
                Centre Admin
            </h6>
            <div class="admin-status-indicator">
                <div class="status-dot" id="adminStatusDot" title="Statut système"></div>
            </div>
        </div>
        
        <div class="card-body">
            <!-- Raccourcis rapides -->
            <div class="admin-shortcuts mb-3">
                <div class="row g-2">
                    <!-- RBAC Management -->
                    <div class="col-6">
                        <div class="shortcut-card" onclick="openRBAC()">
                            <div class="shortcut-icon">
                                <i class="fas fa-users-cog"></i>
                                <span class="notification-badge" id="rbacPendingBadge" style="display: none;">0</span>
                            </div>
                            <div class="shortcut-text">
                                <div class="fw-bold">RBAC</div>
                                <small class="text-muted">Permissions</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- API Documentation -->
                    <div class="col-6">
                        <div class="shortcut-card" onclick="openAPIDoc()">
                            <div class="shortcut-icon">
                                <i class="fas fa-code"></i>
                            </div>
                            <div class="shortcut-text">
                                <div class="fw-bold">API Docs</div>
                                <small class="text-muted">Documentation</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Audit Logs -->
                    <div class="col-6">
                        <div class="shortcut-card" onclick="openAuditLogs()">
                            <div class="shortcut-icon">
                                <i class="fas fa-history"></i>
                                <span class="notification-badge" id="auditNewBadge" style="display: none;">0</span>
                            </div>
                            <div class="shortcut-text">
                                <div class="fw-bold">Audit</div>
                                <small class="text-muted">Logs</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Health -->
                    <div class="col-6">
                        <div class="shortcut-card" onclick="openSystemHealth()">
                            <div class="shortcut-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="shortcut-text">
                                <div class="fw-bold">Santé</div>
                                <small class="text-muted">Système</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Indicateurs de validation en attente -->
            <div class="pending-validations" id="pendingValidations">
                <div class="section-title mb-2">
                    <small class="text-muted fw-bold">En attente de validation</small>
                </div>
                
                <div class="validation-list" id="validationList">
                    <!-- Items en attente chargés dynamiquement -->
                </div>
            </div>
            
            <!-- Actions rapides -->
            <div class="quick-actions mt-3">
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary flex-fill" onclick="exportLogs()">
                        <i class="fas fa-download me-1"></i>
                        Export
                    </button>
                    <button class="btn btn-sm btn-outline-success flex-fill" onclick="backupSystem()">
                        <i class="fas fa-save me-1"></i>
                        Backup
                    </button>
                    <button class="btn btn-sm btn-outline-info flex-fill" onclick="systemReport()">
                        <i class="fas fa-chart-line me-1"></i>
                        Rapport
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-footer">
            <div class="row text-center">
                <div class="col-4">
                    <small class="text-muted">Utilisateurs</small>
                    <div class="fw-bold" id="totalUsers">0</div>
                </div>
                <div class="col-4">
                    <small class="text-muted">Rôles</small>
                    <div class="fw-bold text-primary" id="totalRoles">0</div>
                </div>
                <div class="col-4">
                    <small class="text-muted">Uptime</small>
                    <div class="fw-bold text-success" id="systemUptime">99%</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.admin-status-indicator {
    position: relative;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #28a745;
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.6);
    animation: pulse-green 2s infinite;
}

.status-dot.warning {
    background: #ffc107;
    box-shadow: 0 0 10px rgba(255, 193, 7, 0.6);
    animation: pulse-yellow 2s infinite;
}

.status-dot.error {
    background: #dc3545;
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.6);
    animation: pulse-red 2s infinite;
}

@keyframes pulse-green {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes pulse-yellow {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@keyframes pulse-red {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

.shortcut-card {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}

.shortcut-card:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.shortcut-icon {
    position: relative;
    margin-bottom: 5px;
}

.shortcut-icon i {
    font-size: 1.5rem;
    color: var(--bs-primary);
}

.notification-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.shortcut-text {
    margin-top: 5px;
}

.validation-list {
    max-height: 120px;
    overflow-y: auto;
}

.validation-item {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 6px;
    padding: 8px 12px;
    margin-bottom: 6px;
    display: flex;
    justify-content: between;
    align-items: center;
}

.validation-item:last-child {
    margin-bottom: 0;
}

.validation-text {
    flex: 1;
    font-size: 0.875rem;
}

.validation-actions {
    display: flex;
    gap: 4px;
}

.validation-actions button {
    padding: 2px 6px;
    font-size: 0.75rem;
}

.section-title {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 5px;
}

.quick-actions .btn {
    font-size: 0.875rem;
}
</style>

<script>
// Variables globales pour Admin Center
let adminStats = {};
let pendingValidations = [];
let systemHealth = {};

// Initialisation du widget Admin Center
function initAdminCenter() {
    loadAdminStats();
    loadPendingValidations();
    checkSystemHealth();
    
    // Actualisation périodique
    setInterval(() => {
        loadAdminStats();
        checkSystemHealth();
    }, 30000); // Toutes les 30 secondes
    
    setInterval(() => {
        loadPendingValidations();
    }, 60000); // Toutes les minutes
}

// Chargement des statistiques admin
async function loadAdminStats() {
    try {
        const response = await fetch('/api/v1/admin/stats');
        if (response.ok) {
            adminStats = await response.json();
            updateAdminStats();
        }
    } catch (error) {
        console.error('❌ Erreur chargement stats admin:', error);
    }
}

// Mise à jour de l'affichage des statistiques
function updateAdminStats() {
    document.getElementById('totalUsers').textContent = adminStats.users || 0;
    document.getElementById('totalRoles').textContent = adminStats.roles || 0;
    document.getElementById('systemUptime').textContent = (adminStats.uptime || 99) + '%';
}

// Chargement des validations en attente
async function loadPendingValidations() {
    try {
        const response = await fetch('/api/v1/admin/pending-validations');
        if (response.ok) {
            pendingValidations = await response.json();
            updatePendingValidations();
            updateNotificationBadges();
        }
    } catch (error) {
        console.error('❌ Erreur chargement validations:', error);
    }
}

// Mise à jour de l'affichage des validations
function updatePendingValidations() {
    const validationList = document.getElementById('validationList');
    
    if (pendingValidations.length === 0) {
        validationList.innerHTML = `
            <div class="text-center text-muted py-2">
                <i class="fas fa-check-circle me-2"></i>
                Aucune validation en attente
            </div>
        `;
        return;
    }
    
    validationList.innerHTML = pendingValidations.map(validation => `
        <div class="validation-item">
            <div class="validation-text">
                <div class="fw-bold">${validation.type}</div>
                <small class="text-muted">${validation.description}</small>
            </div>
            <div class="validation-actions">
                <button class="btn btn-success btn-sm" onclick="approveValidation('${validation.id}')">
                    <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="rejectValidation('${validation.id}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// Mise à jour des badges de notification
function updateNotificationBadges() {
    const rbacPending = pendingValidations.filter(v => v.type === 'rbac').length;
    const auditNew = pendingValidations.filter(v => v.type === 'audit').length;
    
    const rbacBadge = document.getElementById('rbacPendingBadge');
    const auditBadge = document.getElementById('auditNewBadge');
    
    if (rbacPending > 0) {
        rbacBadge.textContent = rbacPending;
        rbacBadge.style.display = 'flex';
    } else {
        rbacBadge.style.display = 'none';
    }
    
    if (auditNew > 0) {
        auditBadge.textContent = auditNew;
        auditBadge.style.display = 'flex';
    } else {
        auditBadge.style.display = 'none';
    }
}

// Vérification de la santé du système
async function checkSystemHealth() {
    try {
        const response = await fetch('/api/v1/health');
        if (response.ok) {
            systemHealth = await response.json();
            updateSystemStatus();
        } else {
            updateSystemStatus('error');
        }
    } catch (error) {
        console.error('❌ Erreur vérification santé système:', error);
        updateSystemStatus('error');
    }
}

// Mise à jour du statut système
function updateSystemStatus(status = null) {
    const statusDot = document.getElementById('adminStatusDot');
    
    if (status) {
        statusDot.className = `status-dot ${status}`;
        return;
    }
    
    // Analyser la santé du système
    const healthScore = systemHealth.score || 100;
    
    if (healthScore >= 90) {
        statusDot.className = 'status-dot';
        statusDot.title = 'Système opérationnel';
    } else if (healthScore >= 70) {
        statusDot.className = 'status-dot warning';
        statusDot.title = 'Attention système';
    } else {
        statusDot.className = 'status-dot error';
        statusDot.title = 'Problème système';
    }
}

// Actions des raccourcis
function openRBAC() {
    window.open('/admin/rbac', '_blank');
}

function openAPIDoc() {
    window.open('/api/v1/docs', '_blank');
}

function openAuditLogs() {
    // Ouvrir modal ou page d'audit logs
    if (typeof showAuditLogsModal === 'function') {
        showAuditLogsModal();
    } else {
        window.open('/admin/audit-logs', '_blank');
    }
}

function openSystemHealth() {
    // Ouvrir modal de santé système
    showSystemHealthModal();
}

// Actions de validation
async function approveValidation(validationId) {
    try {
        const response = await fetch(`/api/v1/admin/validations/${validationId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        if (response.ok) {
            showNotification('Validation approuvée', 'success');
            loadPendingValidations();
        } else {
            throw new Error('Erreur approbation');
        }
    } catch (error) {
        console.error('❌ Erreur approbation validation:', error);
        showNotification('Erreur lors de l\'approbation', 'error');
    }
}

async function rejectValidation(validationId) {
    try {
        const response = await fetch(`/api/v1/admin/validations/${validationId}/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        if (response.ok) {
            showNotification('Validation rejetée', 'info');
            loadPendingValidations();
        } else {
            throw new Error('Erreur rejet');
        }
    } catch (error) {
        console.error('❌ Erreur rejet validation:', error);
        showNotification('Erreur lors du rejet', 'error');
    }
}

// Actions rapides
async function exportLogs() {
    try {
        const response = await fetch('/api/v1/admin/export-logs', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chronotech-logs-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Logs exportés avec succès', 'success');
        } else {
            throw new Error('Erreur export');
        }
    } catch (error) {
        console.error('❌ Erreur export logs:', error);
        showNotification('Erreur lors de l\'export', 'error');
    }
}

async function backupSystem() {
    try {
        showNotification('Backup en cours...', 'info');
        
        const response = await fetch('/api/v1/admin/backup', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            showNotification(`Backup créé: ${result.filename}`, 'success');
        } else {
            throw new Error('Erreur backup');
        }
    } catch (error) {
        console.error('❌ Erreur backup système:', error);
        showNotification('Erreur lors du backup', 'error');
    }
}

function systemReport() {
    // Générer et afficher rapport système
    showSystemReportModal();
}

// Modal de santé système
function showSystemHealthModal() {
    // Créer et afficher modal avec détails de santé
    const modalContent = `
        <div class="modal fade" id="systemHealthModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-heartbeat me-2"></i>
                            Santé du Système
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="health-metric">
                                    <h6>Score Global</h6>
                                    <div class="progress mb-3">
                                        <div class="progress-bar bg-success" style="width: ${systemHealth.score || 100}%">
                                            ${systemHealth.score || 100}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="health-metric">
                                    <h6>Uptime</h6>
                                    <div class="progress mb-3">
                                        <div class="progress-bar bg-info" style="width: ${adminStats.uptime || 99}%">
                                            ${adminStats.uptime || 99}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="system-details">
                            <h6>Détails du Système</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-database text-success me-2"></i> Base de données: Opérationnelle</li>
                                <li><i class="fas fa-server text-success me-2"></i> Serveur: En ligne</li>
                                <li><i class="fas fa-network-wired text-success me-2"></i> Réseau: Stable</li>
                                <li><i class="fas fa-memory text-warning me-2"></i> Mémoire: ${systemHealth.memory || 'N/A'}</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        <button type="button" class="btn btn-primary" onclick="refreshSystemHealth()">Actualiser</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Ajouter au DOM et afficher
    document.body.insertAdjacentHTML('beforeend', modalContent);
    const modal = new bootstrap.Modal(document.getElementById('systemHealthModal'));
    modal.show();
    
    // Nettoyer après fermeture
    document.getElementById('systemHealthModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function refreshSystemHealth() {
    checkSystemHealth();
    showNotification('Santé système actualisée', 'info');
}

// Modal rapport système
function showSystemReportModal() {
    showNotification('Génération du rapport système...', 'info');
    // À implémenter: modal avec rapport détaillé
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', function() {
    initAdminCenter();
});
</script>
