<!-- 
ChronoTech - Template Portail Client Sprint 3
Interface de suivi temps réel pour les clients
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChronoTech - Suivi de votre intervention</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Styles personnalisés -->
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 2rem auto;
            overflow: hidden;
        }
        
        .header-section {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .progress-section {
            padding: 2rem;
        }
        
        .progress-bar {
            height: 20px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 25%, rgba(255,255,255,0.2) 25%, rgba(255,255,255,0.2) 50%, transparent 50%, transparent 75%, rgba(255,255,255,0.2) 75%);
            background-size: 20px 20px;
            animation: progress-stripes 1s linear infinite;
        }
        
        @keyframes progress-stripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }
        
        .status-badge {
            font-size: 1.1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
        }
        
        .info-card {
            background: var(--light-bg);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
            padding-left: 2rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -0.5rem;
            top: 0.25rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: #6c757d;
        }
        
        .timeline-item.completed::before {
            background: var(--success-color);
        }
        
        .timeline-item.in-progress::before {
            background: var(--warning-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .refresh-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .last-update {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .main-container {
                margin: 1rem;
                border-radius: 15px;
            }
            
            .header-section {
                padding: 1.5rem;
            }
            
            .progress-section {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-6">
                <div class="main-container">
                    <!-- Header -->
                    <div class="header-section">
                        <div class="mb-3">
                            <i class="fas fa-tools fa-2x mb-3"></i>
                            <h2 class="mb-0">ChronoTech</h2>
                            <p class="mb-0 opacity-75">Suivi de votre intervention</p>
                        </div>
                        
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="h5 mb-0">#{{ work_order.claim_number or work_order.id }}</div>
                                <small class="opacity-75">Numéro</small>
                            </div>
                            <div class="col-6">
                                <div class="h5 mb-0">{{ work_order.priority|title }}</div>
                                <small class="opacity-75">Priorité</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Section -->
                    <div class="progress-section">
                        <!-- Status Badge -->
                        <div class="text-center mb-4">
                            <span id="status-badge" class="status-badge badge bg-primary">
                                <i class="fas fa-clock me-2"></i>
                                <span id="status-text">Chargement...</span>
                            </span>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="fw-bold">Progression</span>
                                <span id="progress-percent" class="fw-bold">0%</span>
                            </div>
                            <div class="progress progress-bar">
                                <div id="progress-fill" class="progress-bar bg-success" role="progressbar" 
                                     style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Vehicle Info -->
                        {% if work_order.make %}
                        <div class="info-card">
                            <h6 class="mb-3"><i class="fas fa-car me-2"></i>Véhicule</h6>
                            <div class="row">
                                <div class="col-8">
                                    <strong>{{ work_order.make }} {{ work_order.model }}</strong>
                                    {% if work_order.year %}({{ work_order.year }}){% endif %}
                                </div>
                                <div class="col-4 text-end">
                                    {% if work_order.license_plate %}
                                        <span class="badge bg-secondary">{{ work_order.license_plate }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Technician Info -->
                        <div class="info-card">
                            <h6 class="mb-3"><i class="fas fa-user-hard-hat me-2"></i>Votre technicien</h6>
                            <div class="row align-items-center">
                                <div class="col-8">
                                    <div id="technician-name" class="fw-bold">{{ work_order.technician_name or 'Non assigné' }}</div>
                                    <div id="technician-phone" class="text-muted small">
                                        {% if work_order.technician_phone %}
                                            <i class="fas fa-phone me-1"></i>{{ work_order.technician_phone }}
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-4 text-end">
                                    <span id="technician-status" class="badge bg-success">
                                        <i class="fas fa-circle me-1"></i>Actif
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ETA -->
                        <div class="info-card">
                            <h6 class="mb-3"><i class="fas fa-clock me-2"></i>Estimation</h6>
                            <div class="row">
                                <div class="col-6">
                                    <div class="small text-muted">Fin prévue</div>
                                    <div id="eta-time" class="fw-bold">Calcul en cours...</div>
                                </div>
                                <div class="col-6 text-end">
                                    <div class="small text-muted">Durée estimée</div>
                                    <div id="estimated-duration" class="fw-bold">
                                        {% if work_order.estimated_duration %}
                                            {{ work_order.estimated_duration }} min
                                        {% else %}
                                            À déterminer
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tasks Timeline -->
                        <div class="info-card">
                            <h6 class="mb-3"><i class="fas fa-list-check me-2"></i>Étapes</h6>
                            <div id="tasks-timeline" class="timeline">
                                <!-- Chargement dynamique -->
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Chargement des étapes...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div class="info-card">
                            <h6 class="mb-3"><i class="fas fa-comment-dots me-2"></i>Notes de progression</h6>
                            <div id="progress-notes">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Chargement des notes...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Refresh Info -->
                        <div class="text-center mt-4">
                            <p class="last-update mb-2">
                                <i class="fas fa-sync-alt me-1"></i>
                                Dernière mise à jour: <span id="last-update">Maintenant</span>
                            </p>
                            <button id="refresh-btn" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-refresh me-1"></i>Actualiser
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Auto-refresh badge -->
    <div class="refresh-badge">
        <span class="badge bg-success">
            <i class="fas fa-wifi me-1"></i>Temps réel
        </span>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Configuration
        const workOrderId = {{ work_order.id }};
        const token = "{{ token }}";
        let refreshInterval;
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadProgressData();
            startAutoRefresh();
            
            // Event listener pour le bouton refresh
            document.getElementById('refresh-btn').addEventListener('click', loadProgressData);
        });
        
        // Charger les données de progression
        async function loadProgressData() {
            try {
                const response = await fetch(`/client/api/progress/${workOrderId}?token=${token}`);
                const data = await response.json();
                
                if (data.success) {
                    updateUI(data);
                    updateLastRefresh();
                } else {
                    showError(data.error || 'Erreur lors du chargement');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion');
            }
        }
        
        // Mettre à jour l'interface
        function updateUI(data) {
            // Progress bar
            const progressFill = document.getElementById('progress-fill');
            const progressPercent = document.getElementById('progress-percent');
            
            progressFill.style.width = data.progress_percent + '%';
            progressFill.setAttribute('aria-valuenow', data.progress_percent);
            progressPercent.textContent = data.progress_percent + '%';
            
            // Status badge
            const statusBadge = document.getElementById('status-badge');
            const statusText = document.getElementById('status-text');
            
            statusText.textContent = data.status_label;
            statusBadge.className = 'status-badge badge ' + getStatusClass(data.status);
            
            // Technician info
            if (data.technician_name) {
                document.getElementById('technician-name').textContent = data.technician_name;
                if (data.technician_phone) {
                    document.getElementById('technician-phone').innerHTML = 
                        `<i class="fas fa-phone me-1"></i>${data.technician_phone}`;
                }
            }
            
            // ETA
            if (data.eta) {
                const etaDate = new Date(data.eta);
                document.getElementById('eta-time').textContent = formatDateTime(etaDate);
            }
            
            // Tasks timeline
            if (data.tasks) {
                updateTasksTimeline(data.tasks);
            }
            
            // Notes
            if (data.notes) {
                updateProgressNotes(data.notes);
            }
        }
        
        // Mettre à jour la timeline des tâches
        function updateTasksTimeline(tasks) {
            const timeline = document.getElementById('tasks-timeline');
            
            if (!tasks || tasks.length === 0) {
                timeline.innerHTML = '<div class="text-muted">Aucune étape définie</div>';
                return;
            }
            
            timeline.innerHTML = tasks.map(task => `
                <div class="timeline-item ${task.status}">
                    <div class="fw-bold">${task.task_name}</div>
                    <div class="text-muted small">${task.description || ''}</div>
                    ${task.completed_at ? `<div class="text-success small mt-1">
                        <i class="fas fa-check me-1"></i>Terminé le ${formatDateTime(new Date(task.completed_at))}
                    </div>` : ''}
                </div>
            `).join('');
        }
        
        // Mettre à jour les notes
        function updateProgressNotes(notes) {
            const notesContainer = document.getElementById('progress-notes');
            
            if (!notes || notes.length === 0) {
                notesContainer.innerHTML = '<div class="text-muted">Aucune note pour le moment</div>';
                return;
            }
            
            notesContainer.innerHTML = notes.map(note => `
                <div class="mb-3 p-3 bg-light rounded">
                    <div class="small text-muted mb-1">
                        ${formatDateTime(new Date(note.created_at))} - ${note.created_by_name}
                    </div>
                    <div>${note.content}</div>
                </div>
            `).join('');
        }
        
        // Obtenir la classe CSS pour le statut
        function getStatusClass(status) {
            const classes = {
                'draft': 'bg-secondary',
                'pending': 'bg-warning',
                'assigned': 'bg-info',
                'in_progress': 'bg-primary',
                'completed': 'bg-success',
                'cancelled': 'bg-danger'
            };
            return classes[status] || 'bg-secondary';
        }
        
        // Formater date et heure
        function formatDateTime(date) {
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Mettre à jour l'heure de dernière actualisation
        function updateLastRefresh() {
            document.getElementById('last-update').textContent = 
                new Date().toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
        }
        
        // Démarrer l'actualisation automatique
        function startAutoRefresh() {
            refreshInterval = setInterval(loadProgressData, 30000); // 30 secondes
        }
        
        // Arrêter l'actualisation automatique
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }
        
        // Afficher une erreur
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger alert-dismissible fade show';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.progress-section').prepend(errorDiv);
            
            // Auto-dismiss après 5 secondes
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }
        
        // Gérer la visibilité de la page
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
                loadProgressData(); // Refresh immédiat
            }
        });
    </script>
</body>
</html>
