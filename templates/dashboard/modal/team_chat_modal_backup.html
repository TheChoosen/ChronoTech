<!-- Modal Chat d'équipe -->
<!-- Styles CSS pour le chat -->
<style>
/* Styles pour le chat avec départements */
#chat-messages {
    max-height: 400px;
    overflow-y: auto;
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background-color: #f8f9fa;
}

#chat-online-users {
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
}

.user-item:hover {
    background-color: #f8f9fa !important;
    cursor: pointer;
}

.hover-bg:hover {
    background-color: #f8f9fa !important;
}

.department-color-badge {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
}

.avatar-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.75em;
    font-weight: bold;
}

.file-attachment {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
}

.file-attachment:hover {
    background-color: #e9ecef;
}

.voice-message audio {
    width: 100%;
    max-width: 300px;
    height: 40px;
}

#typing-indicator {
    min-height: 20px;
    font-style: italic;
    color: #6c757d;
    font-size: 0.85em;
    padding: 5px 10px;
}

.loading-message {
    opacity: 0.8;
}

/* Animation pour l'indicateur de connexion */
#connection-status .badge {
    transition: all 0.3s ease;
}

/* Styles pour les messages */
#chat-messages .mb-3 {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Styles pour le bouton d'enregistrement actif */
.btn-danger#voice-record-btn {
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
    }
}

/* Amélioration du scroll */
#chat-messages::-webkit-scrollbar {
    width: 6px;
}

#chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}

/* Styles pour les différents types de messages */
.message-text {
    background-color: #ffffff;
    border-left: 3px solid #007bff;
}

.message-file {
    background-color: #f8f9fa;
    border-left: 3px solid #28a745;
}

.message-voice {
    background-color: #fff3cd;
    border-left: 3px solid #ffc107;
}

.message-system {
    background-color: #d1ecf1;
    border-left: 3px solid #17a2b8;
    text-align: center;
    font-style: italic;
}

/* Responsive */
@media (max-width: 768px) {
    .modal-xl {
        max-width: 95%;
    }
    
    #chat-messages {
        max-height: 250px;
    }
    
    #chat-online-users {
        max-height: 200px;
    }
    
    .ms-md-4, .me-md-4 {
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
}
</style>

<div class="modal fade" id="teamChatModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fa-solid fa-comments me-2"></i>ChronoChat - Chat d'équipe
                </h5>
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button"
                            data-bs-toggle="dropdown" id="channelDropdownBtn">
                            <i class="fa-solid fa-hashtag me-1"></i><span id="current-channel">Global</span>
                        </button>
                        <ul class="dropdown-menu" id="channelDropdownMenu">
                            <li><h6 class="dropdown-header">Canaux généraux</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="switchChannel('global')">
                                    <i class="fa-solid fa-globe me-2"></i>Global
                                </a></li>
                            <li><a class="dropdown-item" href="#" onclick="switchChannel('general')">
                                    <i class="fa-solid fa-comments me-2"></i>Général
                                </a></li>
                            <li><a class="dropdown-item" href="#" onclick="switchChannel('technician')">
                                    <i class="fa-solid fa-wrench me-2"></i>Techniciens
                                </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Départements</h6></li>
                            <div id="department-channels">
                                <!-- Canaux départements dynamiques -->
                            </div>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-info" href="#" data-bs-toggle="modal" data-bs-target="#departmentsModal">
                                    <i class="fa-solid fa-cog me-2"></i>Gérer les départements
                                </a></li>
                        </ul>
                    </div>
                    <button class="btn btn-sm btn-outline-light" onclick="refreshChatChannels()" title="Actualiser les canaux">
                        <i class="fa-solid fa-sync"></i>
                    </button>
                    <div class="connection-status" id="connection-status">
                        <span class="badge bg-secondary">
                            <i class="fa-solid fa-circle"></i> Déconnecté
                        </span>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0" style="height: 70vh;">
                    <!-- Zone des messages -->
                    <div class="col-12 col-md-8 d-flex flex-column">
                        <div class="chat-messages flex-grow-1 p-3" id="chat-messages"
                            style="overflow-y: auto; max-height: 100%;">
                            <div class="text-center text-muted py-4">
                                <i class="fa-solid fa-comments fa-2x mb-2"></i>
                                <p>Bienvenue dans ChronoChat! Connectez-vous pour commencer...</p>
                            </div>
                        </div>
                        <div class="border-top p-3">
                            <div class="input-group">
                                <!-- Bouton microphone pour enregistrement vocal -->
                                <button class="btn btn-outline-secondary" type="button" id="voice-record-btn" title="Enregistrer un message vocal">
                                    <i class="fa-solid fa-microphone"></i>
                                </button>
                                <!-- Bouton pour fichiers -->
                                <button class="btn btn-outline-secondary" type="button" onclick="attachFile()" title="Joindre un fichier">
                                    <i class="fa-solid fa-paperclip"></i>
                                </button>
                                <input type="text" class="form-control" id="chat-input"
                                    placeholder="Tapez votre message..." maxlength="500"
                                    onkeypress="if(event.key==='Enter' && !event.shiftKey) {event.preventDefault(); sendMessage();}">
                                <button class="btn btn-primary" type="button" onclick="sendMessage()" id="send-btn">
                                    <i class="fa-solid fa-paper-plane"></i>
                                </button>
                            </div>
                            <small class="text-muted mt-1">
                                <span id="typing-indicator"></span>
                                <span class="float-end" id="char-count">0/500</span>
                            </small>
                        </div>
                    </div>
                    <!-- Sidebar utilisateurs en ligne -->
                    <div class="col-12 col-md-4 border-start bg-light">
                        <div class="p-3 border-bottom">
                            <h6 class="mb-0">
                                <i class="fa-solid fa-users me-2"></i>Membres en ligne
                                <span class="badge bg-success ms-2" id="chat-online-count">0</span>
                            </h6>
                        </div>
                        <div class="p-2" style="max-height: calc(70vh - 60px); overflow-y: auto;">
                            <div id="chat-online-users">
                                <!-- Liste des utilisateurs en ligne -->
                                <div class="text-center text-muted py-3">
                                    <i class="fa-solid fa-user-clock fa-2x mb-2"></i>
                                    <p class="small">Chargement des utilisateurs...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript intégration départements/chat avec WebSocket -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
// Variables globales pour le chat avec départements
let currentChatChannel = 'global';
let chatDepartments = [];
let socket = null;
let currentUser = {
    id: 1, // TODO: Récupérer depuis la session
    name: 'Utilisateur ChronoTech'
};

// Variables pour l'enregistrement vocal
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let recordingTimer;
let recordingDuration = 0;

// Initialisation WebSocket
function initWebSocketConnection() {
    console.log('🔌 Initialisation connexion WebSocket...');
    
    // Fermer la connexion existante si nécessaire
    if (socket) {
        socket.disconnect();
    }
    
    // Connexion WebSocket
    socket = io('http://localhost:5001', {
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 1000
    });
    
    // Événements de base
    socket.on('connect', () => {
        console.log('✅ WebSocket connecté!');
        updateConnectionStatus('connected');
        // Rejoindre le canal actuel
        joinChannel(currentChatChannel);
    });
    
    socket.on('connect_error', (error) => {
        console.error('❌ Erreur de connexion WebSocket:', error);
        updateConnectionStatus('error');
    });
    
    socket.on('disconnect', (reason) => {
        console.log('⚠️ WebSocket déconnecté:', reason);
        updateConnectionStatus('disconnected');
    });
    
    // Écouter les nouveaux messages
    socket.on('new_message', (data) => {
        displayMessage(data);
    });
    
    // Écouter les utilisateurs qui rejoignent
    socket.on('user_joined', (data) => {
        displaySystemMessage(`${data.username} a rejoint le canal`, 'info');
        updateOnlineUsers();
    });
    
    // Écouter les utilisateurs qui partent
    socket.on('user_left', (data) => {
        displaySystemMessage(`${data.username} a quitté le canal`, 'info');
        updateOnlineUsers();
    });
    
    // Écouter l'indicateur de frappe
    socket.on('user_typing', (data) => {
        showTypingIndicator(data.username);
    });
    
    // Confirmation de jointure
    socket.on('join_success', (data) => {
        console.log('✅ Canal rejoint:', data.channel);
    });
    
    // Erreurs
    socket.on('error', (data) => {
        console.error('❌ Erreur WebSocket:', data.message);
        displaySystemMessage(data.message, 'error');
    });
}

// Mettre à jour le statut de connexion
function updateConnectionStatus(status) {
    const statusElement = document.getElementById('connection-status');
    if (!statusElement) return;
    
    const statusSpan = statusElement.querySelector('span');
    
    switch(status) {
        case 'connected':
            statusSpan.className = 'badge bg-success';
            statusSpan.innerHTML = '<i class="fa-solid fa-circle"></i> Connecté';
            break;
        case 'disconnected':
            statusSpan.className = 'badge bg-warning';
            statusSpan.innerHTML = '<i class="fa-solid fa-circle"></i> Déconnecté';
            break;
        case 'error':
            statusSpan.className = 'badge bg-danger';
            statusSpan.innerHTML = '<i class="fa-solid fa-circle"></i> Erreur';
            break;
        default:
            statusSpan.className = 'badge bg-secondary';
            statusSpan.innerHTML = '<i class="fa-solid fa-circle"></i> En attente...';
    }
}

// Rejoindre un canal
function joinChannel(channel) {
    if (!socket || !socket.connected) {
        console.error('❌ WebSocket non connecté');
        return;
    }
    
    socket.emit('join', {
        user_id: currentUser.id,
        username: currentUser.name,
        channel: channel
    });
    
    currentChatChannel = channel;
}

// Charger les départements depuis l'API
function loadRealDepartments() {
    fetch('/api/chat/departments')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                chatDepartments = data.departments.filter(d => d.chat_enabled && d.active);
                updateDepartmentChannels();
                console.log('✅ Départements synchronisés:', chatDepartments.length);
            } else {
                console.error('❌ Erreur chargement départements:', data.error);
                loadChatDepartmentsFallback();
            }
        })
        .catch(error => {
            console.error('❌ Erreur chargement départements:', error);
            loadChatDepartmentsFallback();
        });
}

// Fallback départements
function loadChatDepartmentsFallback() {
    chatDepartments = [
        { id: 1, name: 'Technique', code: 'TECH', color: '#007bff', member_count: 8 },
        { id: 2, name: 'Commercial', code: 'COMM', color: '#28a745', member_count: 5 },
        { id: 3, name: 'Support Client', code: 'SUPP', color: '#17a2b8', member_count: 4 }
    ];
    updateDepartmentChannels();
}

// Mettre à jour les canaux de départements dans le dropdown
function updateDepartmentChannels() {
    const container = document.getElementById('department-channels');
    if (!container) return;

    container.innerHTML = '';

    if (chatDepartments.length === 0) {
        container.innerHTML = '<li><span class="dropdown-item-text text-muted small">Aucun département configuré</span></li>';
        return;
    }

    chatDepartments.forEach(dept => {
        const channelItem = document.createElement('li');
        channelItem.innerHTML = `
            <a class="dropdown-item" href="#" onclick="switchChannel('dept_${dept.id}')">
                <span class="department-color-badge me-2" style="background-color: ${dept.color}; width: 8px; height: 8px; border-radius: 50%; display: inline-block;"></span>
                <i class="fa-solid fa-hashtag me-1"></i>${dept.name.toLowerCase()}
                <small class="text-muted ms-auto">(${dept.member_count})</small>
            </a>
        `;
        container.appendChild(channelItem);
    });
}

// Fonction de changement de canal mise à jour
function switchChannel(channel) {
    currentChatChannel = channel;
    
    // Mettre à jour l'affichage du canal actuel
    const currentChannelSpan = document.getElementById('current-channel');
    if (currentChannelSpan) {
        if (channel === 'global') {
            currentChannelSpan.textContent = 'Global';
        } else if (channel === 'general') {
            currentChannelSpan.textContent = 'Général';
        } else if (channel === 'technician') {
            currentChannelSpan.textContent = 'Techniciens';
        } else if (channel.startsWith('dept_')) {
            const deptId = parseInt(channel.replace('dept_', ''));
            const dept = chatDepartments.find(d => d.id === deptId);
            if (dept) {
                currentChannelSpan.innerHTML = `<span class="department-color-badge me-1" style="background-color: ${dept.color}; width: 8px; height: 8px; border-radius: 50%; display: inline-block;"></span>${dept.name}`;
            }
        } else if (channel.startsWith('private_')) {
            currentChannelSpan.innerHTML = '<i class="fa-solid fa-user me-1"></i>Conversation privée';
        }
    }

    // Rejoindre le canal via WebSocket
    if (socket && socket.connected) {
        joinChannel(channel);
    }
    
    // Charger les messages du canal
    loadChannelMessages(channel);
    
    // Mettre à jour les utilisateurs en ligne pour ce canal
    updateOnlineUsers();

    console.log('📢 Canal changé vers:', channel);
}

// Charger les messages d'un canal
function loadChannelMessages(channel) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;

    // Afficher un loader
    messagesContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2 text-muted">Chargement des messages...</p>
        </div>
    `;
    
    // Récupérer l'historique depuis l'API
    fetch(`/api/chat/messages/${channel}`)
        .then(response => response.json())
        .then(data => {
            messagesContainer.innerHTML = '';
            
            if (!data.success) {
                messagesContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fa-solid fa-exclamation-triangle me-2"></i>
                        Erreur de chargement des messages: ${data.error}
                    </div>
                `;
                return;
            }
            
            if (data.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fa-solid fa-comments fa-2x mb-2"></i>
                        <p>Pas encore de messages dans ce canal.</p>
                        <p class="small">Soyez le premier à écrire!</p>
                    </div>
                `;
                return;
            }
            
            // Afficher les messages existants
            data.messages.forEach(message => {
                displayMessage(message);
            });
        })
        .catch(error => {
            console.error('Erreur chargement messages:', error);
            messagesContainer.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fa-solid fa-exclamation-triangle me-2"></i>
                    Erreur de chargement des messages. Veuillez réessayer.
                </div>
            `;
        });
}

// Afficher un message
function displayMessage(data) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    // Effacer le message de bienvenue s'il existe
    const welcomeMsg = messagesContainer.querySelector('.text-center.text-muted');
    if (welcomeMsg) {
        welcomeMsg.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-3 p-3 rounded';
    
    // Déterminer si c'est l'utilisateur actuel
    const isCurrentUser = data.user_id === currentUser.id;
    if (isCurrentUser) {
        messageDiv.classList.add('bg-light', 'ms-md-4');
    } else {
        messageDiv.classList.add('bg-white', 'me-md-4', 'border');
    }
    
    // En-tête du message
    let messageContent = `
        <div class="d-flex justify-content-between align-items-start mb-2">
            <strong class="${isCurrentUser ? 'text-primary' : 'text-dark'}">${isCurrentUser ? 'Vous' : data.username}</strong>
            <small class="text-muted">${data.timestamp || new Date().toLocaleTimeString()}</small>
        </div>`;
    
    // Contenu selon le type de message
    switch(data.type || data.message_type) {
        case 'file':
        case 'pdf':
            const fileIcon = data.type === 'pdf' ? 'fa-file-pdf text-danger' : 'fa-file text-primary';
            messageContent += `
                <div class="file-attachment p-2 border rounded mb-2">
                    <i class="fa-solid ${fileIcon} me-2"></i>
                    <span class="file-name">${data.message?.filename || data.file_info?.filename || 'Fichier'}</span>
                    ${data.file_info?.file_size ? `<span class="file-size text-muted ms-2">(${formatFileSize(data.file_info.file_size)})</span>` : ''}
                    <a href="${data.file_url || data.message?.url}" class="btn btn-sm btn-outline-primary ms-2" target="_blank" download>
                        <i class="fa-solid fa-download"></i>
                    </a>
                </div>`;
            break;
            
        case 'image':
            messageContent += `
                <div class="mb-2">
                    <a href="${data.file_url || data.message?.url}" target="_blank">
                        <img src="${data.file_url || data.message?.url}" class="img-fluid rounded" 
                             style="max-height: 200px;" alt="Image partagée">
                    </a>
                </div>`;
            break;
            
        case 'voice':
            messageContent += `
                <div class="voice-message mb-2">
                    <audio controls class="w-100">
                        <source src="${data.file_url || data.message?.url}" type="audio/webm">
                        Votre navigateur ne supporte pas l'élément audio.
                    </audio>
                </div>
                <small class="text-muted">${data.message?.duration ? formatAudioDuration(data.message.duration) : ''}</small>`;
            break;
            
        case 'text':
        default:
            // Message texte simple
            messageContent += `<p class="mb-1">${escapeHtml(data.message)}</p>`;
    }
    
    // Ajouter le canal
    messageContent += `<small class="text-muted d-block mt-1">Canal: #${getChannelDisplayName(data.channel)}</small>`;
    
    messageDiv.innerHTML = messageContent;
    
    // Ajouter au conteneur
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Afficher un message système
function displaySystemMessage(message, type = 'info') {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type === 'error' ? 'danger' : 'info'} mb-2 text-center small`;
    messageDiv.innerHTML = `
        <i class="fa-solid ${type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'} me-1"></i>
        ${message}
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Supprimer le message après 5 secondes
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.remove();
        }
    }, 5000);
}

// Envoyer un message
function sendMessage() {
    const input = document.getElementById('chat-input');
    if (!input || !input.value.trim()) return;
    
    if (!socket || !socket.connected) {
        displaySystemMessage('Connexion WebSocket nécessaire pour envoyer des messages', 'error');
        return;
    }

    const message = input.value.trim();
    
    // Envoyer via WebSocket
    socket.emit('message', {
        user_id: currentUser.id,
        username: currentUser.name,
        channel: currentChatChannel,
        type: 'text',
        message: message
    });

    input.value = '';
    updateCharCount();
    
    console.log(`📤 Message envoyé sur #${currentChatChannel}:`, message);
}

// Gestion des fichiers
function attachFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        uploadFile(file);
    };
    
    input.click();
}

// Upload de fichier
function uploadFile(file) {
    // Afficher un message de chargement
    const messagesContainer = document.getElementById('chat-messages');
    const loadingMsgDiv = document.createElement('div');
    loadingMsgDiv.className = 'mb-3 p-3 bg-light rounded ms-md-4 loading-message';
    loadingMsgDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-2">
            <strong class="text-primary">Vous</strong>
            <small class="text-muted">${new Date().toLocaleTimeString()}</small>
        </div>
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
            <span>Envoi du fichier ${file.name}...</span>
        </div>
    `;
    messagesContainer.appendChild(loadingMsgDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Préparer les données
    const formData = new FormData();
    formData.append('file', file);
    formData.append('channel', currentChatChannel);
    formData.append('user_id', currentUser.id);
    
    // Envoyer le fichier
    fetch('/api/chat/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Supprimer le message de chargement
        loadingMsgDiv.remove();
        
        if (!data.success) {
            displaySystemMessage('Erreur lors de l\'envoi du fichier: ' + data.error, 'error');
            return;
        }
        
        // Déterminer le type de fichier
        const fileType = file.type.startsWith('image/') ? 'image' : 
                        (file.name.endsWith('.pdf') ? 'pdf' : 'file');
        
        // Envoyer le message via WebSocket
        socket.emit('message', {
            user_id: currentUser.id,
            username: currentUser.name,
            channel: currentChatChannel,
            type: fileType,
            message: {
                filename: file.name,
                size: file.size,
                url: data.url,
                mimetype: file.type
            },
            file_id: data.file_id
        });
    })
    .catch(error => {
        console.error('Erreur upload fichier:', error);
        loadingMsgDiv.remove();
        displaySystemMessage('Erreur lors de l\'envoi du fichier. Veuillez réessayer.', 'error');
    });
}

// Gestion de l'enregistrement vocal
function toggleVoiceRecording() {
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
}

function startRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            const recordBtn = document.getElementById('voice-record-btn');
            
            // Mettre à jour l'apparence du bouton
            recordBtn.classList.add('btn-danger');
            recordBtn.innerHTML = '<i class="fa-solid fa-stop"></i>';
            
            // Initialiser l'enregistreur
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            isRecording = true;
            
            // Démarrer le compteur
            recordingDuration = 0;
            recordingTimer = setInterval(() => {
                recordingDuration += 1;
                const minutes = Math.floor(recordingDuration / 60);
                const seconds = recordingDuration % 60;
                
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.innerHTML = `
                        <i class="fa-solid fa-microphone text-danger me-1"></i>
                        Enregistrement: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}
                    `;
                }
                
                // Limiter à 2 minutes
                if (recordingDuration >= 120) {
                    stopRecording();
                }
            }, 1000);
            
            // Collecter les données
            mediaRecorder.addEventListener('dataavailable', event => {
                audioChunks.push(event.data);
            });
            
            // Quand l'enregistrement est terminé
            mediaRecorder.addEventListener('stop', () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                uploadVoiceMessage(audioBlob);
            });
            
            // Commencer l'enregistrement
            mediaRecorder.start();
            
        })
        .catch(error => {
            console.error('Erreur d\'accès au microphone:', error);
            displaySystemMessage('Impossible d\'accéder au microphone. Vérifiez les permissions.', 'error');
        });
}

function stopRecording() {
    if (!mediaRecorder || mediaRecorder.state === 'inactive') return;
    
    // Arrêter l'enregistrement
    mediaRecorder.stop();
    isRecording = false;
    
    // Arrêter le timer
    clearInterval(recordingTimer);
    
    // Remettre le bouton à l'état initial
    const recordBtn = document.getElementById('voice-record-btn');
    recordBtn.classList.remove('btn-danger');
    recordBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
    
    // Effacer l'indicateur
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.innerHTML = '';
    }
    
    // Arrêter tous les tracks du stream
    if (mediaRecorder.stream) {
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
    }
}

function uploadVoiceMessage(audioBlob) {
    // Créer FormData
    const formData = new FormData();
    formData.append('file', audioBlob, 'voice-message.webm');
    formData.append('channel', currentChatChannel);
    formData.append('user_id', currentUser.id);
    
    // Afficher un message de chargement
    const messagesContainer = document.getElementById('chat-messages');
    const loadingMsgDiv = document.createElement('div');
    loadingMsgDiv.className = 'mb-3 p-3 bg-light rounded ms-md-4 loading-message';
    loadingMsgDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-2">
            <strong class="text-primary">Vous</strong>
            <small class="text-muted">${new Date().toLocaleTimeString()}</small>
        </div>
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
            <span>Envoi du message vocal...</span>
        </div>
    `;
    messagesContainer.appendChild(loadingMsgDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Envoyer l'audio
    fetch('/api/chat/upload-voice', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Supprimer le message de chargement
        loadingMsgDiv.remove();
        
        if (!data.success) {
            displaySystemMessage('Erreur lors de l\'envoi du message vocal: ' + data.error, 'error');
            return;
        }
        
        // Envoyer le message via WebSocket
        socket.emit('message', {
            user_id: currentUser.id,
            username: currentUser.name,
            channel: currentChatChannel,
            type: 'voice',
            message: {
                url: data.url,
                duration: recordingDuration
            },
            file_id: data.file_id
        });
    })
    .catch(error => {
        console.error('Erreur upload message vocal:', error);
        loadingMsgDiv.remove();
        displaySystemMessage('Erreur lors de l\'envoi du message vocal. Veuillez réessayer.', 'error');
    });
}

// Mettre à jour les utilisateurs en ligne
function updateOnlineUsers() {
    fetch('/api/chat/online-users')
        .then(response => response.json())
        .then(data => {
            const usersContainer = document.getElementById('chat-online-users');
            const countBadge = document.getElementById('chat-online-count');
            
            if (!usersContainer || !countBadge) return;
            
            if (!data.success) {
                console.error('Erreur chargement utilisateurs:', data.error);
                return;
            }
            
            // Nombre d'utilisateurs en ligne
            countBadge.textContent = data.users.length;
            
            if (data.users.length === 0) {
                usersContainer.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fa-solid fa-user-slash fa-2x mb-2"></i>
                        <p class="small">Aucun utilisateur en ligne</p>
                    </div>
                `;
                return;
            }
            
            // Afficher les utilisateurs
            usersContainer.innerHTML = data.users.map(user => `
                <div class="d-flex align-items-center mb-2 p-2 rounded hover-bg user-item" 
                     data-user-id="${user.id}" onclick="startPrivateChat(${user.id}, '${user.name.replace(/'/g, "\\'")}')">
                    <div class="avatar-circle me-2 ${user.status === 'online' ? 'bg-success' : 'bg-warning'}" 
                         style="width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; 
                                justify-content: center; color: white; font-size: 0.75em; font-weight: bold;">
                        ${getInitials(user.name)}
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold small">${user.name}</div>
                        <div class="text-muted" style="font-size: 0.7em;">${user.department || 'Aucun département'}</div>
                    </div>
                    <span class="badge bg-${user.status === 'online' ? 'success' : 'warning'}" style="font-size: 0.6em;">
                        ${user.status === 'online' ? 'En ligne' : 'Occupé'}
                    </span>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Erreur chargement utilisateurs:', error);
        });
}

// Conversation privée
function startPrivateChat(userId, userName) {
    const privateChannelId = `private_${Math.min(currentUser.id, userId)}_${Math.max(currentUser.id, userId)}`;
    
    // Mettre à jour l'affichage du canal actuel
    const currentChannelSpan = document.getElementById('current-channel');
    if (currentChannelSpan) {
        currentChannelSpan.innerHTML = `
            <i class="fa-solid fa-user me-1"></i>
            ${userId === currentUser.id ? 'Notes personnelles' : userName}
        `;
    }
    
    // Changer de canal
    switchChannel(privateChannelId);
    
    console.log(`🔒 Conversation privée avec ${userName} (ID: ${userId})`);
}

// Fonctions utilitaires
function getChannelDisplayName(channel) {
    if (channel === 'global') return 'Global';
    if (channel === 'general') return 'Général';
    if (channel === 'technician') return 'Techniciens';
    if (channel.startsWith('dept_')) {
        const deptId = parseInt(channel.replace('dept_', ''));
        const dept = chatDepartments.find(d => d.id === deptId);
        return dept ? dept.name : 'Département';
    }
    if (channel.startsWith('private_')) return 'Privé';
    return channel;
}

function getInitials(name) {
    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatAudioDuration(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function updateCharCount() {
    const input = document.getElementById('chat-input');
    const charCount = document.getElementById('char-count');
    
    if (input && charCount) {
        charCount.textContent = `${input.value.length}/500`;
        
        if (input.value.length > 450) {
            charCount.className = 'float-end text-warning';
        } else {
            charCount.className = 'float-end text-muted';
        }
    }
}

function showTypingIndicator(username) {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator && !isRecording) {
        typingIndicator.innerHTML = `<i class="fa-solid fa-keyboard me-1"></i>${username} est en train d'écrire...`;
        
        // Effacer après 3 secondes
        setTimeout(() => {
            if (typingIndicator.innerHTML.includes(username)) {
                typingIndicator.innerHTML = '';
            }
        }, 3000);
    }
}

// Actualiser les canaux de chat
function refreshChatChannels() {
    console.log('🔄 Actualisation des canaux de chat...');
    loadRealDepartments();
    updateOnlineUsers();
    
    // Animation du bouton
    const refreshBtn = event?.target?.closest('button') || document.querySelector('[onclick="refreshChatChannels()"]');
    if (refreshBtn) {
        const icon = refreshBtn.querySelector('i');
        const originalClass = icon.className;
        icon.className = 'fa-solid fa-spinner fa-spin';
        
        setTimeout(() => {
            icon.className = originalClass;
        }, 1000);
    }
}

// Initialisation du chat
document.addEventListener('DOMContentLoaded', function() {
    const teamChatModal = document.getElementById('teamChatModal');
    const chatInput = document.getElementById('chat-input');
    const voiceBtn = document.getElementById('voice-record-btn');
    
    if (teamChatModal) {
        // Événement d'ouverture de la modal
        teamChatModal.addEventListener('show.bs.modal', function() {
            console.log('🚀 Ouverture du chat ChronoTech');
            
            // Charger les départements
            loadRealDepartments();
            
            // Initialiser la connexion WebSocket
            initWebSocketConnection();
            
            // Canal par défaut
            setTimeout(() => {
                switchChannel('global');
            }, 1000);
            
            // Focus sur le champ de saisie
            setTimeout(() => {
                if (chatInput) chatInput.focus();
            }, 1500);
            
            // Mettre à jour les utilisateurs en ligne
            setTimeout(() => {
                updateOnlineUsers();
            }, 2000);
        });
        
        // Événement de fermeture
        teamChatModal.addEventListener('hidden.bs.modal', function() {
            console.log('🔚 Fermeture du chat ChronoTech');
            
            // Déconnecter le WebSocket pour économiser les ressources
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            // Arrêter l'enregistrement si en cours
            if (isRecording) {
                stopRecording();
            }
        });
    }
    
    // Événements du champ de saisie
    if (chatInput) {
        chatInput.addEventListener('input', function() {
            updateCharCount();
            
            // Envoyer l'événement "typing"
            if (socket && socket.connected) {
                socket.emit('typing', {
                    user_id: currentUser.id,
                    username: currentUser.name,
                    channel: currentChatChannel
                });
            }
        });
    }
    
    // Événement du bouton vocal
    if (voiceBtn) {
        voiceBtn.addEventListener('click', toggleVoiceRecording);
    }
});

// Écouter les mises à jour des départements depuis la modal départements
document.addEventListener('departmentsUpdated', function() {
    if (document.getElementById('teamChatModal')?.classList.contains('show')) {
        loadRealDepartments();
    }
});
</script>
