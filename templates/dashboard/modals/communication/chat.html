<!-- Modal Chat d'√©quipe avec toutes les fonctionnalit√©s -->
<div class="modal fade" id="teamChatModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fa-solid fa-comments me-2"></i>ChronoChat - Chat d'√©quipe
                </h5>
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button"
                            data-bs-toggle="dropdown" id="channelDropdownBtn">
                            <i class="fa-solid fa-hashtag me-1"></i><span id="current-channel">Global</span>
                        </button>
                        <ul class="dropdown-menu" id="channelDropdownMenu">
                            <li><h6 class="dropdown-header">Canaux g√©n√©raux</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="switchChannel('global')">
                                    <i class="fa-solid fa-globe me-2"></i>Global
                                </a></li>
                            <li><a class="dropdown-item" href="#" onclick="switchChannel('general')">
                                    <i class="fa-solid fa-comments me-2"></i>G√©n√©ral
                                </a></li>
                            <li><a class="dropdown-item" href="#" onclick="switchChannel('technician')">
                                    <i class="fa-solid fa-wrench me-2"></i>Techniciens
                                </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">D√©partements</h6></li>
                            <div id="department-channels">
                                <!-- Canaux d√©partements dynamiques -->
                            </div>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-info" href="#" data-bs-toggle="modal" data-bs-target="#departmentsModal">
                                    <i class="fa-solid fa-cog me-2"></i>G√©rer les d√©partements
                                </a></li>
                        </ul>
                    </div>
                    <button class="btn btn-sm btn-outline-light" onclick="refreshChatChannels()" title="Actualiser les canaux">
                        <i class="fa-solid fa-sync"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="toggleConnectionStatus()" title="√âtat de connexion">
                        <i class="fa-solid fa-circle" id="connection-status" style="color: #dc3545;"></i>
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0" style="height: 70vh;">
                    <!-- Zone des messages -->
                    <div class="col-12 col-md-8 d-flex flex-column">
                        <div class="chat-messages flex-grow-1 p-3" id="chat-messages"
                            style="overflow-y: auto; max-height: 100%;">
                            <div class="text-center text-muted py-4" id="welcome-message">
                                <i class="fa-solid fa-comments fa-2x mb-2"></i>
                                <p>Bienvenue dans ChronoChat! Commencez la conversation...</p>
                                <small>Connectez-vous au WebSocket pour discuter en temps r√©el</small>
                            </div>
                        </div>
                        <div class="border-top p-3">
                            <div class="input-group">
                                <!-- Bouton d'enregistrement vocal -->
                                <button class="btn btn-outline-secondary" type="button" id="voice-record-btn" 
                                        onclick="toggleVoiceRecording()" title="Enregistrement vocal">
                                    <i class="fa-solid fa-microphone"></i>
                                </button>
                                <!-- Bouton d'attachement de fichier -->
                                <button class="btn btn-outline-secondary" type="button" onclick="attachFile()" title="Joindre un fichier">
                                    <i class="fa-solid fa-paperclip"></i>
                                </button>
                                <input type="text" class="form-control" id="chat-input"
                                    placeholder="Tapez votre message..." maxlength="500"
                                    onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                                    oninput="handleTyping()">
                                <button class="btn btn-primary" type="button" onclick="sendMessage()" id="send-btn">
                                    <i class="fa-solid fa-paper-plane"></i>
                                </button>
                            </div>
                            <small class="text-muted mt-1">
                                <span id="typing-indicator"></span>
                                <span class="float-end" id="char-count">0/500</span>
                            </small>
                        </div>
                    </div>
                    <!-- Sidebar utilisateurs en ligne -->
                    <div class="col-12 col-md-4 border-start bg-light">
                        <div class="p-3 border-bottom">
                            <h6 class="mb-0">
                                <i class="fa-solid fa-users me-2"></i>Membres en ligne
                                <span class="badge bg-success ms-2" id="chat-online-count">0</span>
                            </h6>
                        </div>
                        <div class="p-2" style="max-height: calc(70vh - 60px); overflow-y: auto;">
                            <div id="chat-online-users">
                                <!-- Liste des utilisateurs en ligne -->
                                <div class="text-center text-muted py-3">
                                    <i class="fa-solid fa-wifi fa-pulse mb-2"></i>
                                    <p class="small">Connexion en cours...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS pour le chat -->
<style>
.chat-messages {
    background: #f8f9fa;
}

.chat-message {
    margin-bottom: 1rem;
    max-width: 85%;
}

.chat-message.own {
    margin-left: auto;
    margin-right: 0;
}

.chat-message.other {
    margin-left: 0;
    margin-right: auto;
}

.message-bubble {
    padding: 0.75rem 1rem;
    border-radius: 18px;
    word-wrap: break-word;
    position: relative;
}

.chat-message.own .message-bubble {
    background: #007bff;
    color: white;
    border-bottom-right-radius: 6px;
}

.chat-message.other .message-bubble {
    background: white;
    color: #333;
    border: 1px solid #e9ecef;
    border-bottom-left-radius: 6px;
}

.file-attachment {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 0.75rem;
    margin: 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.file-attachment:hover {
    background: #e9ecef;
}

.voice-message audio {
    max-width: 250px;
    height: 40px;
}

.user-item {
    cursor: pointer;
    border-radius: 8px;
    transition: background-color 0.2s;
}

.user-item:hover {
    background-color: rgba(0,123,255,0.1) !important;
}

.avatar-circle {
    flex-shrink: 0;
    font-size: 0.75rem;
    font-weight: bold;
}

.typing-animation {
    display: inline-block;
}

.typing-animation::after {
    content: '...';
    animation: typing 1.5s infinite;
}

@keyframes typing {
    0%, 60% { content: '...'; }
    30% { content: '..'; }
    60% { content: '.'; }
}

.connection-status.connected {
    color: #28a745 !important;
}

.connection-status.disconnected {
    color: #dc3545 !important;
}

.loading-message {
    opacity: 0.7;
    font-style: italic;
}

.message-timestamp {
    font-size: 0.7rem;
    opacity: 0.7;
    margin-top: 0.25rem;
}

.department-color-badge {
    display: inline-block;
    border-radius: 50%;
}

.image-preview {
    max-width: 300px;
    max-height: 200px;
    border-radius: 8px;
    cursor: pointer;
}

.system-message {
    text-align: center;
    font-style: italic;
    color: #6c757d;
    font-size: 0.9rem;
    margin: 1rem 0;
}

#voice-record-btn.recording {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    color: white !important;
    animation: pulse-red 1s infinite;
}

@keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}
</style>

<!-- JavaScript int√©gr√© pour le chat complet -->
<script>
// Variables globales pour le chat avec d√©partements
let currentChatChannel = 'global';
let chatDepartments = [];
let socket = null;
let isConnected = false;
let currentUser = {
    id: Math.floor(Math.random() * 1000) + 1, // Simul√© - devrait venir de la session
    name: 'Utilisateur Test',
    department: 'Technique'
};

// Variables pour l'enregistrement vocal
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let recordingTimer;
let recordingDuration = 0;

// ==============================================
// CHARGEMENT DES D√âPARTEMENTS
// ==============================================

// Charger les d√©partements depuis l'API
function loadRealDepartments() {
    fetch('/api/chat/departments')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                chatDepartments = data.departments.filter(d => d.chat_enabled && d.active);
                updateDepartmentChannels();
                console.log('‚úÖ D√©partements synchronis√©s:', chatDepartments.length);
            } else {
                console.error('‚ùå Erreur API d√©partements:', data.error);
                loadFallbackDepartments();
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur chargement d√©partements:', error);
            loadFallbackDepartments();
        });
}

// D√©partements de fallback
function loadFallbackDepartments() {
    chatDepartments = [
        { id: 1, name: 'Technique', code: 'TECH', color: '#007bff', member_count: 8 },
        { id: 2, name: 'Commercial', code: 'COMM', color: '#28a745', member_count: 5 },
        { id: 3, name: 'Support Client', code: 'SUPP', color: '#17a2b8', member_count: 4 }
    ];
    updateDepartmentChannels();
}

// Mettre √† jour les canaux de d√©partements dans le dropdown
function updateDepartmentChannels() {
    const container = document.getElementById('department-channels');
    if (!container) return;

    container.innerHTML = '';

    if (chatDepartments.length === 0) {
        container.innerHTML = '<li><span class="dropdown-item-text text-muted small">Aucun d√©partement configur√©</span></li>';
        return;
    }

    chatDepartments.forEach(dept => {
        const channelItem = document.createElement('li');
        channelItem.innerHTML = `
            <a class="dropdown-item" href="#" onclick="switchChannel('dept_${dept.id}')">
                <span class="department-color-badge me-2" style="background-color: ${dept.color}; width: 8px; height: 8px; border-radius: 50%; display: inline-block;"></span>
                <i class="fa-solid fa-hashtag me-1"></i>${dept.name.toLowerCase()}
                <small class="text-muted ms-auto">(${dept.member_count})</small>
            </a>
        `;
        container.appendChild(channelItem);
    });
}

// ==============================================
// WEBSOCKET ET CONNEXION
// ==============================================

// Initialiser la connexion WebSocket
function initWebSocketConnection() {
    // Fermer la connexion existante si n√©cessaire
    if (socket) {
        socket.disconnect();
    }
    
    try {
        // Connexion WebSocket
        socket = io('http://localhost:5001', {
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            timeout: 5000
        });
        
        // √âv√©nements de base
        socket.on('connect', () => {
            console.log('‚úÖ WebSocket connect√©!');
            isConnected = true;
            updateConnectionStatus(true);
            
            // Rejoindre le canal actuel
            joinChannel(currentChatChannel);
            
            // Charger les utilisateurs en ligne
            updateOnlineUsers();
        });
        
        socket.on('connect_error', (error) => {
            console.error('‚ùå Erreur de connexion WebSocket:', error);
            isConnected = false;
            updateConnectionStatus(false);
            displaySystemMessage('Impossible de se connecter au chat en temps r√©el. Mode hors ligne.', 'warning');
        });
        
        socket.on('disconnect', () => {
            console.log('‚ö†Ô∏è WebSocket d√©connect√©');
            isConnected = false;
            updateConnectionStatus(false);
        });
        
        // √âcouter les nouveaux messages
        socket.on('new_message', (data) => {
            displayMessage(data);
        });
        
        // √âcouter les utilisateurs qui rejoignent/quittent
        socket.on('user_joined', (data) => {
            displaySystemMessage(`${data.username} a rejoint le canal`);
            updateOnlineUsers();
        });
        
        socket.on('user_left', (data) => {
            displaySystemMessage(`${data.username} a quitt√© le canal`);
            updateOnlineUsers();
        });
        
        // Indicateur de frappe
        socket.on('user_typing', (data) => {
            showTypingIndicator(data.username);
        });
        
    } catch (error) {
        console.error('‚ùå Erreur initialisation WebSocket:', error);
        isConnected = false;
        updateConnectionStatus(false);
    }
}

// Mettre √† jour l'indicateur de connexion
function updateConnectionStatus(connected) {
    const statusIcon = document.getElementById('connection-status');
    if (statusIcon) {
        if (connected) {
            statusIcon.className = 'fa-solid fa-circle connection-status connected';
            statusIcon.title = 'Connect√© au chat en temps r√©el';
        } else {
            statusIcon.className = 'fa-solid fa-circle connection-status disconnected';
            statusIcon.title = 'D√©connect√© - Mode hors ligne';
        }
    }
}

function toggleConnectionStatus() {
    if (isConnected) {
        socket.disconnect();
    } else {
        initWebSocketConnection();
    }
}

// Rejoindre un canal
function joinChannel(channel) {
    if (!socket || !socket.connected) {
        console.error('‚ùå WebSocket non connect√©');
        return;
    }
    
    // Quitter l'ancien canal si n√©cessaire
    if (currentChatChannel && currentChatChannel !== channel) {
        socket.emit('leave', {
            user_id: currentUser.id,
            username: currentUser.name,
            channel: currentChatChannel
        });
    }
    
    // Rejoindre le nouveau canal
    socket.emit('join', {
        user_id: currentUser.id,
        username: currentUser.name,
        channel: channel
    });
    
    currentChatChannel = channel;
}

// ==============================================
// GESTION DES CANAUX
// ==============================================

// Fonction de changement de canal mise √† jour
function switchChannel(channel) {
    currentChatChannel = channel;
    
    // Mettre √† jour l'affichage du canal actuel
    const currentChannelSpan = document.getElementById('current-channel');
    if (currentChannelSpan) {
        if (channel === 'global') {
            currentChannelSpan.textContent = 'Global';
        } else if (channel === 'general') {
            currentChannelSpan.textContent = 'G√©n√©ral';
        } else if (channel === 'technician') {
            currentChannelSpan.textContent = 'Techniciens';
        } else if (channel.startsWith('dept_')) {
            const deptId = parseInt(channel.replace('dept_', ''));
            const dept = chatDepartments.find(d => d.id === deptId);
            if (dept) {
                currentChannelSpan.innerHTML = `<span class="department-color-badge me-1" style="background-color: ${dept.color}; width: 8px; height: 8px; border-radius: 50%; display: inline-block;"></span>${dept.name}`;
            }
        } else if (channel.startsWith('private_')) {
            currentChannelSpan.innerHTML = '<i class="fa-solid fa-user me-1"></i>Message priv√©';
        }
    }

    // Charger les messages du canal
    loadChannelMessages(channel);
    
    // Rejoindre le canal via WebSocket
    if (socket && socket.connected) {
        joinChannel(channel);
    }
    
    // Mettre √† jour les utilisateurs en ligne pour ce canal
    updateChannelUsers(channel);

    console.log('üì¢ Canal chang√© vers:', channel);
}

// Charger les messages d'un canal
function loadChannelMessages(channel) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;

    // Afficher un loader
    messagesContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2 text-muted">Chargement des messages...</p>
        </div>
    `;
    
    // R√©cup√©rer l'historique depuis l'API
    fetch(`/api/chat/messages/${encodeURIComponent(channel)}`)
        .then(response => response.json())
        .then(data => {
            messagesContainer.innerHTML = '';
            
            if (!data.success || data.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fa-solid fa-comments fa-2x mb-2"></i>
                        <p>Pas encore de messages dans ce canal.</p>
                        <p class="small">Soyez le premier √† √©crire!</p>
                    </div>
                `;
                return;
            }
            
            // Afficher les messages existants
            data.messages.forEach(message => {
                displayMessage(message, false); // false = ne pas faire d√©filer automatiquement
            });
            
            // Faire d√©filer vers le bas
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        })
        .catch(error => {
            console.error('Erreur chargement messages:', error);
            messagesContainer.innerHTML = `
                <div class="alert alert-warning m-3">
                    <i class="fa-solid fa-exclamation-triangle me-2"></i>
                    Erreur de chargement des messages. Mode hors ligne activ√©.
                </div>
            `;
        });
}

// ==============================================
// AFFICHAGE DES MESSAGES
// ==============================================

// Afficher un message
function displayMessage(data, autoScroll = true) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    // Supprimer le message de bienvenue s'il existe
    const welcomeMsg = messagesContainer.querySelector('#welcome-message');
    if (welcomeMsg) {
        welcomeMsg.remove();
    }
    
    const messageDiv = document.createElement('div');
    const isCurrentUser = data.user_id === currentUser.id;
    
    messageDiv.className = `chat-message ${isCurrentUser ? 'own' : 'other'}`;
    
    // Contenu selon le type de message
    let messageContent = '';
    
    switch(data.type || data.message_type) {
        case 'file':
        case 'pdf':
            messageContent = `
                <div class="file-attachment">
                    <i class="fa-solid ${data.type === 'pdf' ? 'fa-file-pdf text-danger' : 'fa-file text-primary'} me-2"></i>
                    <span class="file-name">${data.message?.filename || data.file_info?.filename || 'Fichier'}</span>
                    <span class="file-size text-muted ms-2">(${formatFileSize(data.message?.size || data.file_info?.file_size || 0)})</span>
                    <a href="${data.file_url || data.message?.url}" class="btn btn-sm btn-outline-primary ms-2" target="_blank" download>
                        <i class="fa-solid fa-download"></i>
                    </a>
                </div>`;
            break;
            
        case 'image':
            messageContent = `
                <div class="mb-2">
                    <a href="${data.file_url || data.message?.url}" target="_blank">
                        <img src="${data.file_url || data.message?.url}" class="image-preview" alt="Image partag√©e">
                    </a>
                </div>`;
            break;
            
        case 'voice':
            messageContent = `
                <div class="voice-message mb-2">
                    <audio controls class="w-100">
                        <source src="${data.file_url || data.message?.url}" type="audio/webm">
                        Votre navigateur ne supporte pas l'√©l√©ment audio.
                    </audio>
                </div>
                <small class="text-muted">${formatAudioDuration(data.message?.duration || 0)}</small>`;
            break;
            
        case 'text':
        default:
            messageContent = `<p class="mb-1">${escapeHtml(data.message)}</p>`;
    }
    
    // Structure compl√®te du message
    messageDiv.innerHTML = `
        <div class="message-bubble">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <strong class="${isCurrentUser ? 'text-white' : 'text-dark'}">${isCurrentUser ? 'Vous' : (data.username || 'Utilisateur')}</strong>
                <small class="${isCurrentUser ? 'text-white-50' : 'text-muted'}">${data.timestamp || new Date().toLocaleTimeString()}</small>
            </div>
            ${messageContent}
            <small class="${isCurrentUser ? 'text-white-50' : 'text-muted'} d-block mt-1">Canal: #${getChannelDisplayName(data.channel || currentChatChannel)}</small>
        </div>
    `;
    
    // Ajouter au conteneur
    messagesContainer.appendChild(messageDiv);
    
    if (autoScroll) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

// Afficher un message syst√®me
function displaySystemMessage(message, type = 'info') {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    const systemMsgDiv = document.createElement('div');
    systemMsgDiv.className = `system-message text-${type === 'error' ? 'danger' : (type === 'warning' ? 'warning' : 'info')}`;
    systemMsgDiv.innerHTML = `
        <i class="fa-solid fa-${type === 'error' ? 'exclamation-circle' : (type === 'warning' ? 'exclamation-triangle' : 'info-circle')} me-1"></i>
        ${message}
    `;
    
    messagesContainer.appendChild(systemMsgDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// ==============================================
// ENVOI DE MESSAGES
// ==============================================

// Envoyer un message
function sendMessage() {
    const input = document.getElementById('chat-input');
    if (!input || !input.value.trim()) return;

    const message = input.value.trim();
    
    // Si WebSocket connect√©, envoyer via WebSocket
    if (socket && socket.connected) {
        socket.emit('message', {
            user_id: currentUser.id,
            username: currentUser.name,
            channel: currentChatChannel,
            message: message,
            type: 'text'
        });
    } else {
        // Mode hors ligne - affichage local uniquement
        displayMessage({
            user_id: currentUser.id,
            username: currentUser.name,
            channel: currentChatChannel,
            message: message,
            type: 'text',
            timestamp: new Date().toLocaleTimeString()
        });
        
        displaySystemMessage('Message envoy√© en mode hors ligne (WebSocket d√©connect√©)', 'warning');
    }

    input.value = '';
    updateCharacterCount();
    
    console.log(`üì§ Message envoy√© sur #${currentChatChannel}:`, message);
}

// Gestion de la frappe
function handleTyping() {
    updateCharacterCount();
    
    // Envoyer l'indicateur de frappe via WebSocket
    if (socket && socket.connected) {
        socket.emit('typing', {
            user_id: currentUser.id,
            username: currentUser.name,
            channel: currentChatChannel
        });
    }
}

// Mettre √† jour le compteur de caract√®res
function updateCharacterCount() {
    const input = document.getElementById('chat-input');
    const charCount = document.getElementById('char-count');
    
    if (input && charCount) {
        const length = input.value.length;
        charCount.textContent = `${length}/500`;
        
        if (length > 450) {
            charCount.className = 'float-end text-warning';
        } else {
            charCount.className = 'float-end text-muted';
        }
    }
}

// Afficher l'indicateur de frappe
function showTypingIndicator(username) {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.innerHTML = `
            <i class="fa-solid fa-keyboard me-1"></i>
            <span class="typing-animation">${username} √©crit</span>
        `;
        
        // Effacer apr√®s 3 secondes
        setTimeout(() => {
            typingIndicator.innerHTML = '';
        }, 3000);
    }
}

// ==============================================
// GESTION DES FICHIERS
// ==============================================

// Attachement de fichier
function attachFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // V√©rifier la taille (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
            displaySystemMessage('Fichier trop volumineux (max 10MB)', 'error');
            return;
        }
        
        // Afficher un message de chargement
        const messagesContainer = document.getElementById('chat-messages');
        const loadingMsgDiv = document.createElement('div');
        loadingMsgDiv.className = 'chat-message own loading-message';
        loadingMsgDiv.innerHTML = `
            <div class="message-bubble">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <strong class="text-white">Vous</strong>
                    <small class="text-white-50">${new Date().toLocaleTimeString()}</small>
                </div>
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-white me-2" role="status"></div>
                    <span>Envoi du fichier ${file.name}...</span>
                </div>
            </div>
        `;
        messagesContainer.appendChild(loadingMsgDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Pr√©parer les donn√©es
        const formData = new FormData();
        formData.append('file', file);
        formData.append('channel', currentChatChannel);
        formData.append('user_id', currentUser.id);
        
        // Envoyer le fichier
        fetch('/api/chat/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Supprimer le message de chargement
            loadingMsgDiv.remove();
            
            if (data.success) {
                // D√©terminer le type de fichier
                const fileType = file.type.startsWith('image/') ? 'image' : 
                                (file.name.endsWith('.pdf') ? 'pdf' : 'file');
                
                // Envoyer via WebSocket si connect√©
                if (socket && socket.connected) {
                    socket.emit('message', {
                        user_id: currentUser.id,
                        username: currentUser.name,
                        channel: currentChatChannel,
                        type: fileType,
                        message: {
                            filename: file.name,
                            size: file.size,
                            url: data.url,
                            mimetype: file.type
                        },
                        file_id: data.file_id
                    });
                } else {
                    // Mode hors ligne
                    displayMessage({
                        user_id: currentUser.id,
                        username: currentUser.name,
                        channel: currentChatChannel,
                        type: fileType,
                        message: {
                            filename: file.name,
                            size: file.size,
                            url: data.url
                        },
                        timestamp: new Date().toLocaleTimeString()
                    });
                }
            } else {
                displaySystemMessage('Erreur lors de l\'envoi du fichier: ' + (data.error || 'Erreur inconnue'), 'error');
            }
        })
        .catch(error => {
            console.error('Erreur upload fichier:', error);
            loadingMsgDiv.remove();
            displaySystemMessage('Erreur lors de l\'envoi du fichier. Veuillez r√©essayer.', 'error');
        });
    };
    
    input.click();
}

// ==============================================
// ENREGISTREMENT VOCAL
// ==============================================

// Basculer l'enregistrement vocal
function toggleVoiceRecording() {
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
}

// D√©marrer l'enregistrement
function startRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            const recordBtn = document.getElementById('voice-record-btn');
            
            // Mettre √† jour l'apparence du bouton
            recordBtn.classList.add('recording');
            recordBtn.innerHTML = '<i class="fa-solid fa-stop"></i>';
            recordBtn.title = 'Arr√™ter l\'enregistrement';
            
            // Initialiser l'enregistreur
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            isRecording = true;
            
            // D√©marrer le compteur
            recordingDuration = 0;
            recordingTimer = setInterval(() => {
                recordingDuration += 1;
                const minutes = Math.floor(recordingDuration / 60);
                const seconds = recordingDuration % 60;
                
                // Afficher la dur√©e dans l'indicateur de frappe
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.innerHTML = `
                        <i class="fa-solid fa-microphone text-danger me-1"></i>
                        Enregistrement: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}
                    `;
                }
                
                // Limiter √† 2 minutes
                if (recordingDuration >= 120) {
                    stopRecording();
                }
            }, 1000);
            
            // Collecter les donn√©es
            mediaRecorder.addEventListener('dataavailable', event => {
                audioChunks.push(event.data);
            });
            
            // Quand l'enregistrement est termin√©
            mediaRecorder.addEventListener('stop', () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                uploadVoiceMessage(audioBlob);
            });
            
            // Commencer l'enregistrement
            mediaRecorder.start();
            
        })
        .catch(error => {
            console.error('Erreur d\'acc√®s au microphone:', error);
            displaySystemMessage('Impossible d\'acc√©der au microphone. V√©rifiez les permissions.', 'error');
        });
}

// Arr√™ter l'enregistrement
function stopRecording() {
    if (!mediaRecorder || mediaRecorder.state === 'inactive') return;
    
    // Arr√™ter l'enregistrement
    mediaRecorder.stop();
    isRecording = false;
    
    // Arr√™ter le timer
    clearInterval(recordingTimer);
    
    // Remettre le bouton √† l'√©tat initial
    const recordBtn = document.getElementById('voice-record-btn');
    recordBtn.classList.remove('recording');
    recordBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
    recordBtn.title = 'Enregistrement vocal';
    
    // Effacer l'indicateur
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.innerHTML = '';
    }
    
    // Arr√™ter tous les tracks du stream
    mediaRecorder.stream.getTracks().forEach(track => track.stop());
}

// Upload du message vocal
function uploadVoiceMessage(audioBlob) {
    // Cr√©er FormData
    const formData = new FormData();
    formData.append('file', audioBlob, 'voice-message.webm');
    formData.append('channel', currentChatChannel);
    formData.append('user_id', currentUser.id);
    
    // Afficher un message de chargement
    const messagesContainer = document.getElementById('chat-messages');
    const loadingMsgDiv = document.createElement('div');
    loadingMsgDiv.className = 'chat-message own loading-message';
    loadingMsgDiv.innerHTML = `
        <div class="message-bubble">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <strong class="text-white">Vous</strong>
                <small class="text-white-50">${new Date().toLocaleTimeString()}</small>
            </div>
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm text-white me-2" role="status"></div>
                <span>Envoi du message vocal...</span>
            </div>
        </div>
    `;
    messagesContainer.appendChild(loadingMsgDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Envoyer l'audio
    fetch('/api/chat/upload-voice', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Supprimer le message de chargement
        loadingMsgDiv.remove();
        
        if (data.success) {
            // Envoyer via WebSocket si connect√©
            if (socket && socket.connected) {
                socket.emit('message', {
                    user_id: currentUser.id,
                    username: currentUser.name,
                    channel: currentChatChannel,
                    type: 'voice',
                    message: {
                        url: data.url,
                        duration: recordingDuration
                    },
                    file_id: data.file_id
                });
            } else {
                // Mode hors ligne
                displayMessage({
                    user_id: currentUser.id,
                    username: currentUser.name,
                    channel: currentChatChannel,
                    type: 'voice',
                    message: {
                        url: data.url,
                        duration: recordingDuration
                    },
                    timestamp: new Date().toLocaleTimeString()
                });
            }
        } else {
            displaySystemMessage('Erreur lors de l\'envoi du message vocal: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('Erreur upload message vocal:', error);
        loadingMsgDiv.remove();
        displaySystemMessage('Erreur lors de l\'envoi du message vocal. Veuillez r√©essayer.', 'error');
    });
}

// ==============================================
// GESTION DES UTILISATEURS
// ==============================================

// Mettre √† jour la liste des utilisateurs en ligne
function updateOnlineUsers() {
    fetch('/api/chat/online-users')
        .then(response => response.json())
        .then(data => {
            const usersContainer = document.getElementById('chat-online-users');
            const countBadge = document.getElementById('chat-online-count');
            
            if (!usersContainer || !countBadge) return;
            
            if (data.success && data.users.length > 0) {
                // Nombre d'utilisateurs en ligne
                countBadge.textContent = data.users.length;
                
                // Afficher les utilisateurs
                usersContainer.innerHTML = data.users.map(user => `
                    <div class="d-flex align-items-center mb-2 p-2 rounded hover-bg user-item" 
                         data-user-id="${user.id}" onclick="startPrivateChat(${user.id}, '${user.name}')">
                        <div class="avatar-circle me-2 ${user.status === 'online' ? 'bg-success' : 'bg-warning'}" 
                             style="width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; color: white; font-size: 0.75em; font-weight: bold;">
                            ${getInitials(user.name)}
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold small">${user.name}</div>
                            <div class="text-muted" style="font-size: 0.7em;">${user.department || 'Sans d√©partement'}</div>
                        </div>
                        <span class="badge bg-${user.status === 'online' ? 'success' : 'warning'}" style="font-size: 0.6em;">
                            ${user.status === 'online' ? 'En ligne' : 'Occup√©'}
                        </span>
                    </div>
                `).join('');
            } else {
                countBadge.textContent = '0';
                usersContainer.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fa-solid fa-user-slash mb-2"></i>
                        <p class="small">Aucun utilisateur en ligne</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Erreur chargement utilisateurs:', error);
            // Afficher des utilisateurs de test
            updateChannelUsers(currentChatChannel);
        });
}

// Mettre √† jour les utilisateurs d'un canal (fallback)
function updateChannelUsers(channel) {
    const usersContainer = document.getElementById('chat-online-users');
    const countBadge = document.getElementById('chat-online-count');
    
    if (!usersContainer || !countBadge) return;

    // Simuler des utilisateurs selon le canal
    let users = [];
    
    if (channel === 'global' || channel === 'general') {
        users = [
            { id: 1, name: 'Jean Dupont', status: 'online', department: 'Technique' },
            { id: 2, name: 'Sophie Martin', status: 'online', department: 'Commercial' },
            { id: 3, name: 'Pierre Durand', status: 'busy', department: 'Administration' },
            { id: 4, name: 'Marie Dubois', status: 'online', department: 'Support' }
        ];
    } else if (channel === 'technician') {
        users = [
            { id: 1, name: 'Jean Dupont', status: 'online', department: 'Technique' },
            { id: 5, name: 'Luc Moreau', status: 'online', department: 'Technique' },
            { id: 6, name: 'Anne Lefevre', status: 'busy', department: 'Technique' }
        ];
    }

    // Afficher les utilisateurs
    usersContainer.innerHTML = users.map(user => `
        <div class="d-flex align-items-center mb-2 p-2 rounded hover-bg user-item" 
             data-user-id="${user.id}" onclick="startPrivateChat(${user.id}, '${user.name}')">
            <div class="avatar-circle me-2 ${user.status === 'online' ? 'bg-success' : 'bg-warning'}" 
                 style="width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; 
                        justify-content: center; color: white; font-size: 0.75em; font-weight: bold;">
                ${getInitials(user.name)}
            </div>
            <div class="flex-grow-1">
                <div class="fw-bold small">${user.name}</div>
                <div class="text-muted" style="font-size: 0.7em;">${user.department}</div>
            </div>
            <span class="badge bg-${user.status === 'online' ? 'success' : 'warning'}" style="font-size: 0.6em;">
                ${user.status === 'online' ? 'En ligne' : 'Occup√©'}
            </span>
        </div>
    `).join('');

    countBadge.textContent = users.length;
}

// D√©marrer une conversation priv√©e
function startPrivateChat(userId, userName) {
    const privateChannelId = `private_${Math.min(currentUser.id, userId)}_${Math.max(currentUser.id, userId)}`;
    
    // Mettre √† jour l'affichage du canal actuel
    const currentChannelSpan = document.getElementById('current-channel');
    if (currentChannelSpan) {
        currentChannelSpan.innerHTML = `
            <i class="fa-solid fa-user me-1"></i>
            ${userId === currentUser.id ? 'Notes personnelles' : userName}
        `;
    }
    
    // Changer de canal
    switchChannel(privateChannelId);
    
    // Fermer le dropdown de canal si ouvert
    const dropdown = document.getElementById('channelDropdownBtn');
    if (dropdown && dropdown.getAttribute('aria-expanded') === 'true') {
        const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
        if (bsDropdown) bsDropdown.hide();
    }
    
    console.log(`üîí Conversation priv√©e avec ${userName} (ID: ${userId})`);
}

// ==============================================
// FONCTIONS UTILITAIRES
// ==============================================

// Obtenir les initiales d'un nom
function getInitials(name) {
    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
}

// Obtenir le nom d'affichage d'un canal
function getChannelDisplayName(channel) {
    if (channel === 'global') return 'Global';
    if (channel === 'general') return 'G√©n√©ral';
    if (channel === 'technician') return 'Techniciens';
    if (channel.startsWith('dept_')) {
        const deptId = parseInt(channel.replace('dept_', ''));
        const dept = chatDepartments.find(d => d.id === deptId);
        return dept ? dept.name : 'D√©partement';
    }
    if (channel.startsWith('private_')) return 'Priv√©';
    return channel;
}

// Formater la taille d'un fichier
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Formater la dur√©e d'un audio
function formatAudioDuration(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// √âchapper le HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Actualiser les canaux de chat
function refreshChatChannels() {
    console.log('üîÑ Actualisation des canaux de chat...');
    loadRealDepartments();
    updateOnlineUsers();
    
    // Animation du bouton
    const refreshBtn = event?.target?.closest('button') || document.querySelector('[onclick="refreshChatChannels()"]');
    if (refreshBtn) {
        const icon = refreshBtn.querySelector('i');
        if (icon) {
            const originalClass = icon.className;
            icon.className = 'fa-solid fa-spinner fa-spin';
            
            setTimeout(() => {
                icon.className = originalClass;
            }, 1000);
        }
    }
}

// ==============================================
// INITIALISATION
// ==============================================

// Initialisation du chat
document.addEventListener('DOMContentLoaded', function() {
    const teamChatModal = document.getElementById('teamChatModal');
    const chatInput = document.getElementById('chat-input');
    
    if (teamChatModal) {
        // √âv√©nement d'ouverture de la modal
        teamChatModal.addEventListener('show.bs.modal', function() {
            console.log('üöÄ Ouverture du chat ChronoTech');
            
            // Charger les d√©partements
            loadRealDepartments();
            
            // Initialiser la connexion WebSocket
            setTimeout(() => {
                initWebSocketConnection();
            }, 500);
            
            // Canal par d√©faut
            switchChannel('global');
            
            // Focus sur le champ de saisie
            setTimeout(() => {
                chatInput?.focus();
            }, 1000);
        });
        
        // √âv√©nement de fermeture
        teamChatModal.addEventListener('hidden.bs.modal', function() {
            console.log('üîå Fermeture du chat - D√©connexion WebSocket');
            
            // D√©connecter le WebSocket pour √©conomiser les ressources
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            // Arr√™ter l'enregistrement s'il est en cours
            if (isRecording) {
                stopRecording();
            }
        });
    }
    
    // Compteur de caract√®res et events du champ de saisie
    if (chatInput) {
        chatInput.addEventListener('input', handleTyping);
        updateCharacterCount();
    }
});

// √âcouter les mises √† jour des d√©partements depuis la modal d√©partements
document.addEventListener('departmentsUpdated', function() {
    console.log('üîÑ D√©partements mis √† jour - Rechargement du chat');
    if (document.getElementById('teamChatModal')?.classList.contains('show')) {
        loadRealDepartments();
    }
});

console.log('‚úÖ Chat ChronoTech initialis√©');
</script>
