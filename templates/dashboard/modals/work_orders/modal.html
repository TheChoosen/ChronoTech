<!-- Modal Détail Bon de Travail -->
<div class="modal fade" id="workOrderModal" tabindex="-1" aria-labelledby="workOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="workOrderModalLabel">
                    <i class="fa-solid fa-clipboard-list me-2"></i>Bon de Travail #<span id="wo-number">-</span>
                </h5>
                <div class="d-flex gap-2">
                    <!-- Actions rapides dans le header -->
                    <button class="btn btn-sm btn-outline-light" onclick="printWorkOrder()" title="Imprimer">
                        <i class="fa-solid fa-print"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="exportWorkOrderPDF()" title="Export PDF">
                        <i class="fa-solid fa-file-pdf"></i>
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <!-- Informations principales (côté gauche) -->
                    <div class="col-12 col-lg-8">
                        <!-- En-tête du bon de travail -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fa-solid fa-info-circle me-2"></i>Informations Générales
                                </h6>
                                <div class="d-flex gap-2">
                                    <span class="badge fs-6" id="wo-priority-badge">Medium</span>
                                    <span class="badge fs-6" id="wo-status-badge">En attente</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Client</label>
                                        <p class="mb-1" id="wo-customer">-</p>
                                        <small class="text-muted" id="wo-customer-contact">-</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Technicien Assigné</label>
                                        <p class="mb-1" id="wo-technician">Non assigné</p>
                                        <small class="text-muted" id="wo-technician-contact">-</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Date de Création</label>
                                        <p class="mb-0" id="wo-created-date">-</p>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Date Prévue</label>
                                        <p class="mb-0" id="wo-scheduled-date">-</p>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Date de Fin</label>
                                        <p class="mb-0" id="wo-completed-date">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Description et détails -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fa-solid fa-file-text me-2"></i>Description des Travaux
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Titre</label>
                                    <p class="mb-2" id="wo-title">-</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Description Détaillée</label>
                                    <div class="border rounded p-3 bg-light" id="wo-description">
                                        Aucune description disponible
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Catégorie</label>
                                        <p class="mb-0" id="wo-category">-</p>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Type d'Intervention</label>
                                        <p class="mb-0" id="wo-type">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes et commentaires -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fa-solid fa-comments me-2"></i>Notes et Commentaires
                                </h6>
                                <button class="btn btn-sm btn-outline-primary" onclick="addWorkOrderNote()">
                                    <i class="fa-solid fa-plus me-1"></i>Ajouter Note
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="wo-notes">
                                    <div class="text-center text-muted py-3">
                                        <i class="fa-solid fa-sticky-note fa-2x mb-2"></i>
                                        <p>Aucune note disponible</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pièces jointes -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fa-solid fa-paperclip me-2"></i>Pièces Jointes
                                </h6>
                                <button class="btn btn-sm btn-outline-primary" onclick="uploadWorkOrderFile()">
                                    <i class="fa-solid fa-upload me-1"></i>Ajouter Fichier
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="wo-attachments">
                                    <div class="text-center text-muted py-3">
                                        <i class="fa-solid fa-file fa-2x mb-2"></i>
                                        <p>Aucune pièce jointe</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar Actions (côté droit) -->
                    <div class="col-12 col-lg-4">
                        <!-- Changement de statut -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fa-solid fa-exchange-alt me-2"></i>Actions Rapides
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Changer le Statut</label>
                                    <select class="form-select" id="wo-status-select" onchange="changeWorkOrderStatus()">
                                        <option value="draft">Brouillon</option>
                                        <option value="pending">En attente</option>
                                        <option value="assigned">Assigné</option>
                                        <option value="in_progress">En cours</option>
                                        <option value="completed">Terminé</option>
                                        <option value="cancelled">Annulé</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Assigner Technicien</label>
                                    <select class="form-select" id="wo-technician-select" onchange="assignTechnician()">
                                        <option value="">Non assigné</option>
                                        <!-- Options dynamiques -->
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Priorité</label>
                                    <select class="form-select" id="wo-priority-select" onchange="changePriority()">
                                        <option value="low">Basse</option>
                                        <option value="medium">Moyenne</option>
                                        <option value="high">Haute</option>
                                        <option value="urgent">Urgente</option>
                                    </select>
                                </div>

                                <hr>

                                <div class="d-grid gap-2">
                                    <button class="btn btn-success btn-sm" onclick="startWork()">
                                        <i class="fa-solid fa-play me-1"></i>Démarrer Travail
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="pauseWork()">
                                        <i class="fa-solid fa-pause me-1"></i>Mettre en Pause
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="completeWork()">
                                        <i class="fa-solid fa-check me-1"></i>Marquer Terminé
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="duplicateWorkOrder()">
                                        <i class="fa-solid fa-copy me-1"></i>Dupliquer
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Temps de travail -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fa-solid fa-clock me-2"></i>Temps de Travail
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Temps Estimé:</span>
                                        <strong id="wo-estimated-time">-</strong>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Temps Réel:</span>
                                        <strong id="wo-actual-time">-</strong>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Temps Restant:</span>
                                        <strong id="wo-remaining-time" class="text-warning">-</strong>
                                    </div>
                                </div>
                                
                                <div class="progress mb-2" style="height: 10px;">
                                    <div class="progress-bar" id="wo-progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted">Progression: <span id="wo-progress-text">0%</span></small>
                            </div>
                        </div>

                        <!-- Historique des actions -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fa-solid fa-history me-2"></i>Historique
                                </h6>
                            </div>
                            <div class="card-body p-2" style="max-height: 300px; overflow-y: auto;">
                                <div id="wo-history">
                                    <!-- Historique dynamique -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" onclick="saveWorkOrderChanges()">
                    <i class="fa-solid fa-save me-1"></i>Sauvegarder
                </button>
                <button type="button" class="btn btn-info" onclick="editWorkOrder()">
                    <i class="fa-solid fa-edit me-1"></i>Éditer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CSS pour la modal bon de travail -->
<style>
.work-order-modal .badge {
    font-size: 0.75em;
}

.work-order-note {
    border-left: 4px solid #007bff;
    background: #f8f9fa;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 4px;
}

.work-order-note .note-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 8px;
}

.work-order-note .note-author {
    font-weight: bold;
    color: #007bff;
}

.work-order-note .note-date {
    font-size: 0.875em;
    color: #6c757d;
}

.attachment-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-bottom: 8px;
    background: #f8f9fa;
}

.attachment-icon {
    margin-right: 8px;
    color: #6c757d;
}

.history-item {
    display: flex;
    padding: 8px 12px;
    border-bottom: 1px solid #dee2e6;
}

.history-item:last-child {
    border-bottom: none;
}

.history-icon {
    margin-right: 8px;
    margin-top: 2px;
}

.history-content {
    flex-grow: 1;
}

.history-time {
    font-size: 0.75em;
    color: #6c757d;
}

.priority-low { background-color: #17a2b8 !important; }
.priority-medium { background-color: #ffc107 !important; color: #000 !important; }
.priority-high { background-color: #fd7e14 !important; }
.priority-urgent { background-color: #dc3545 !important; }

.status-draft { background-color: #6c757d !important; }
.status-pending { background-color: #ffc107 !important; color: #000 !important; }
.status-assigned { background-color: #17a2b8 !important; }
.status-in_progress { background-color: #007bff !important; }
.status-completed { background-color: #28a745 !important; }
.status-cancelled { background-color: #dc3545 !important; }
</style>

<!-- JavaScript pour la modal bon de travail -->
<script>
// Variables globales pour le bon de travail
let currentWorkOrder = null;
let workOrderHistory = [];

// Données mockées pour les techniciens
const technicians = [
    { id: 1, name: 'Jean Dupont', email: 'jean.dupont@chronotech.com' },
    { id: 2, name: 'Sophie Martin', email: 'sophie.martin@chronotech.com' },
    { id: 3, name: 'Pierre Durand', email: 'pierre.durand@chronotech.com' },
    { id: 4, name: 'Marie Dubois', email: 'marie.dubois@chronotech.com' },
    { id: 5, name: 'Luc Moreau', email: 'luc.moreau@chronotech.com' },
    { id: 6, name: 'Anne Lefevre', email: 'anne.lefevre@chronotech.com' }
];

// Afficher les détails d'un bon de travail
function showWorkOrderDetails(workOrderId) {
    // Trouver le bon de travail dans les données Kanban
    let workOrder = null;
    
    // Rechercher dans toutes les colonnes
    ['draft', 'pending', 'assigned', 'in_progress', 'completed', 'cancelled'].forEach(status => {
        const column = document.getElementById(`column-${status}`);
        if (column) {
            const cards = column.querySelectorAll('.kanban-card');
            cards.forEach(card => {
                if (card.dataset.cardId == workOrderId) {
                    // Extraire les données de la carte
                    workOrder = {
                        id: workOrderId,
                        claim_number: card.querySelector('.card-title').textContent.replace('#', ''),
                        customer_name: card.querySelector('.text-muted.small').textContent,
                        description: card.querySelector('p:not(.text-muted)').textContent,
                        status: status,
                        priority: card.querySelector('.badge').textContent,
                        technician_name: card.querySelector('.d-flex .text-muted:first-child')?.textContent || 'Non assigné',
                        created_at: card.querySelector('.d-flex .text-muted:last-child')?.textContent || new Date().toLocaleDateString()
                    };
                }
            });
        }
    });

    if (!workOrder) {
        console.error('Bon de travail non trouvé:', workOrderId);
        return;
    }

    currentWorkOrder = workOrder;
    populateWorkOrderModal(workOrder);
    
    // Afficher la modal
    const modal = new bootstrap.Modal(document.getElementById('workOrderModal'));
    modal.show();
}

// Remplir la modal avec les données du bon de travail
function populateWorkOrderModal(workOrder) {
    // En-tête
    document.getElementById('wo-number').textContent = workOrder.claim_number;
    
    // Badges de statut et priorité
    const statusBadge = document.getElementById('wo-status-badge');
    const priorityBadge = document.getElementById('wo-priority-badge');
    
    statusBadge.textContent = getStatusDisplayName(workOrder.status);
    statusBadge.className = `badge fs-6 status-${workOrder.status}`;
    
    priorityBadge.textContent = getPriorityDisplayName(workOrder.priority);
    priorityBadge.className = `badge fs-6 priority-${workOrder.priority}`;

    // Informations générales
    document.getElementById('wo-customer').textContent = workOrder.customer_name;
    document.getElementById('wo-customer-contact').textContent = 'contact@' + workOrder.customer_name.toLowerCase().replace(/\s+/g, '') + '.com';
    document.getElementById('wo-technician').textContent = workOrder.technician_name;
    document.getElementById('wo-technician-contact').textContent = workOrder.technician_name !== 'Non assigné' ? 
        workOrder.technician_name.toLowerCase().replace(/\s+/g, '.') + '@chronotech.com' : '-';
    
    document.getElementById('wo-created-date').textContent = workOrder.created_at;
    document.getElementById('wo-scheduled-date').textContent = 'À définir';
    document.getElementById('wo-completed-date').textContent = workOrder.status === 'completed' ? new Date().toLocaleDateString() : '-';

    // Description
    document.getElementById('wo-title').textContent = `Intervention ${workOrder.claim_number}`;
    document.getElementById('wo-description').textContent = workOrder.description;
    document.getElementById('wo-category').textContent = 'Maintenance';
    document.getElementById('wo-type').textContent = 'Intervention Standard';

    // Sélecteurs
    document.getElementById('wo-status-select').value = workOrder.status;
    document.getElementById('wo-priority-select').value = workOrder.priority;
    
    // Charger la liste des techniciens
    loadTechniciansSelect();
    
    // Temps de travail (simulé)
    document.getElementById('wo-estimated-time').textContent = '4h';
    document.getElementById('wo-actual-time').textContent = workOrder.status === 'completed' ? '3h 45min' : '2h 15min';
    document.getElementById('wo-remaining-time').textContent = workOrder.status === 'completed' ? '0h' : '1h 45min';
    
    const progress = workOrder.status === 'completed' ? 100 : 
                    workOrder.status === 'in_progress' ? 60 : 
                    workOrder.status === 'assigned' ? 25 : 0;
    
    document.getElementById('wo-progress-bar').style.width = progress + '%';
    document.getElementById('wo-progress-text').textContent = progress + '%';

    // Charger les notes et l'historique
    loadWorkOrderNotes(workOrder);
    loadWorkOrderHistory(workOrder);
    loadWorkOrderAttachments(workOrder);
}

// Charger la liste des techniciens
function loadTechniciansSelect() {
    const select = document.getElementById('wo-technician-select');
    select.innerHTML = '<option value="">Non assigné</option>';
    
    technicians.forEach(tech => {
        const option = document.createElement('option');
        option.value = tech.id;
        option.textContent = tech.name;
        select.appendChild(option);
    });
    
    // Sélectionner le technicien actuel si assigné
    if (currentWorkOrder.technician_name !== 'Non assigné') {
        const currentTech = technicians.find(t => t.name === currentWorkOrder.technician_name);
        if (currentTech) {
            select.value = currentTech.id;
        }
    }
}

// Charger les notes
function loadWorkOrderNotes(workOrder) {
    const notesContainer = document.getElementById('wo-notes');
    
    // Simuler quelques notes
    const mockNotes = [
        {
            id: 1,
            author: 'Jean Dupont',
            content: 'Début de l\'intervention. Matériel vérifié.',
            created_at: '2025-01-20 09:30'
        },
        {
            id: 2,
            author: 'Sophie Martin',
            content: 'Client informé du délai. Pièces à commander.',
            created_at: '2025-01-20 11:15'
        }
    ];

    if (workOrder.status === 'draft') {
        notesContainer.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fa-solid fa-sticky-note fa-2x mb-2"></i>
                <p>Aucune note disponible</p>
            </div>
        `;
        return;
    }

    notesContainer.innerHTML = mockNotes.map(note => `
        <div class="work-order-note">
            <div class="note-header">
                <span class="note-author">${note.author}</span>
                <span class="note-date">${note.created_at}</span>
            </div>
            <div class="note-content">${note.content}</div>
        </div>
    `).join('');
}

// Charger l'historique
function loadWorkOrderHistory(workOrder) {
    const historyContainer = document.getElementById('wo-history');
    
    // Simuler l'historique
    const mockHistory = [
        {
            action: 'Création du bon de travail',
            user: 'Système',
            timestamp: workOrder.created_at,
            icon: 'fa-plus',
            color: 'text-success'
        },
        {
            action: 'Assigné à ' + (workOrder.technician_name || 'Non assigné'),
            user: 'Sophie Martin',
            timestamp: '2025-01-20 09:15',
            icon: 'fa-user-check',
            color: 'text-info'
        }
    ];

    if (workOrder.status !== 'draft') {
        mockHistory.push({
            action: 'Statut changé vers: ' + getStatusDisplayName(workOrder.status),
            user: workOrder.technician_name || 'Système',
            timestamp: '2025-01-20 10:30',
            icon: 'fa-exchange-alt',
            color: 'text-warning'
        });
    }

    historyContainer.innerHTML = mockHistory.map(item => `
        <div class="history-item">
            <i class="fa-solid ${item.icon} history-icon ${item.color}"></i>
            <div class="history-content">
                <div>${item.action}</div>
                <div class="history-time">Par ${item.user} - ${item.timestamp}</div>
            </div>
        </div>
    `).join('');
}

// Charger les pièces jointes
function loadWorkOrderAttachments(workOrder) {
    const attachmentsContainer = document.getElementById('wo-attachments');
    
    // Simuler quelques pièces jointes
    if (workOrder.status === 'draft') {
        attachmentsContainer.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fa-solid fa-file fa-2x mb-2"></i>
                <p>Aucune pièce jointe</p>
            </div>
        `;
        return;
    }

    const mockAttachments = [
        { name: 'Devis_client.pdf', size: '245 KB', type: 'pdf' },
        { name: 'Photo_avant.jpg', size: '1.2 MB', type: 'image' }
    ];

    attachmentsContainer.innerHTML = mockAttachments.map(file => `
        <div class="attachment-item">
            <i class="fa-solid fa-${file.type === 'pdf' ? 'file-pdf' : 'file-image'} attachment-icon"></i>
            <div class="flex-grow-1">
                <div class="fw-bold">${file.name}</div>
                <small class="text-muted">${file.size}</small>
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="downloadAttachment('${file.name}')">
                <i class="fa-solid fa-download"></i>
            </button>
        </div>
    `).join('');
}

// Fonctions d'actions
function changeWorkOrderStatus() {
    const newStatus = document.getElementById('wo-status-select').value;
    const oldStatus = currentWorkOrder.status;
    
    if (newStatus !== oldStatus) {
        // Mettre à jour le bon de travail dans le Kanban
        moveWorkOrderToColumn(currentWorkOrder.id, oldStatus, newStatus);
        currentWorkOrder.status = newStatus;
        
        // Mettre à jour l'affichage de la modal
        const statusBadge = document.getElementById('wo-status-badge');
        statusBadge.textContent = getStatusDisplayName(newStatus);
        statusBadge.className = `badge fs-6 status-${newStatus}`;
        
        // Ajouter à l'historique
        addHistoryEntry(`Statut changé de ${getStatusDisplayName(oldStatus)} vers ${getStatusDisplayName(newStatus)}`);
        
        showWorkOrderNotification('Statut mis à jour avec succès', 'success');
    }
}

function assignTechnician() {
    const technicianId = document.getElementById('wo-technician-select').value;
    const technician = technicians.find(t => t.id == technicianId);
    
    const oldTechnician = currentWorkOrder.technician_name;
    const newTechnician = technician ? technician.name : 'Non assigné';
    
    if (newTechnician !== oldTechnician) {
        currentWorkOrder.technician_name = newTechnician;
        
        // Mettre à jour l'affichage
        document.getElementById('wo-technician').textContent = newTechnician;
        document.getElementById('wo-technician-contact').textContent = 
            technician ? technician.email : '-';
        
        // Mettre à jour la carte Kanban
        updateWorkOrderCard(currentWorkOrder.id, currentWorkOrder);
        
        addHistoryEntry(`Assigné à ${newTechnician}`);
        showWorkOrderNotification('Technicien assigné avec succès', 'success');
    }
}

function changePriority() {
    const newPriority = document.getElementById('wo-priority-select').value;
    const oldPriority = currentWorkOrder.priority;
    
    if (newPriority !== oldPriority) {
        currentWorkOrder.priority = newPriority;
        
        // Mettre à jour l'affichage
        const priorityBadge = document.getElementById('wo-priority-badge');
        priorityBadge.textContent = getPriorityDisplayName(newPriority);
        priorityBadge.className = `badge fs-6 priority-${newPriority}`;
        
        // Mettre à jour la carte Kanban
        updateWorkOrderCard(currentWorkOrder.id, currentWorkOrder);
        
        addHistoryEntry(`Priorité changée de ${getPriorityDisplayName(oldPriority)} vers ${getPriorityDisplayName(newPriority)}`);
        showWorkOrderNotification('Priorité mise à jour', 'success');
    }
}

// Actions rapides
function startWork() {
    if (currentWorkOrder.status !== 'in_progress') {
        document.getElementById('wo-status-select').value = 'in_progress';
        changeWorkOrderStatus();
    }
    addHistoryEntry('Travail démarré');
    showWorkOrderNotification('Travail démarré', 'success');
}

function pauseWork() {
    addHistoryEntry('Travail mis en pause');
    showWorkOrderNotification('Travail mis en pause', 'warning');
}

function completeWork() {
    document.getElementById('wo-status-select').value = 'completed';
    changeWorkOrderStatus();
    addHistoryEntry('Travail marqué comme terminé');
    showWorkOrderNotification('Travail terminé', 'success');
}

function duplicateWorkOrder() {
    console.log('Duplication du bon de travail', currentWorkOrder.id);
    showWorkOrderNotification('Fonctionnalité de duplication en développement', 'info');
}

// Fonctions utilitaires
function getStatusDisplayName(status) {
    const statusNames = {
        'draft': 'Brouillon',
        'pending': 'En attente',
        'assigned': 'Assigné',
        'in_progress': 'En cours',
        'completed': 'Terminé',
        'cancelled': 'Annulé'
    };
    return statusNames[status] || status;
}

function getPriorityDisplayName(priority) {
    const priorityNames = {
        'low': 'Basse',
        'medium': 'Moyenne',
        'high': 'Haute',
        'urgent': 'Urgente'
    };
    return priorityNames[priority] || priority;
}

function addHistoryEntry(action) {
    const historyContainer = document.getElementById('wo-history');
    const newEntry = document.createElement('div');
    newEntry.className = 'history-item';
    newEntry.innerHTML = `
        <i class="fa-solid fa-clock history-icon text-primary"></i>
        <div class="history-content">
            <div>${action}</div>
            <div class="history-time">Par Utilisateur - ${new Date().toLocaleString()}</div>
        </div>
    `;
    historyContainer.insertBefore(newEntry, historyContainer.firstChild);
}

function showWorkOrderNotification(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}

// Fonctions d'export et impression
function printWorkOrder() {
    window.print();
}

function exportWorkOrderPDF() {
    console.log('Export PDF du bon de travail', currentWorkOrder.id);
    showWorkOrderNotification('Export PDF en cours...', 'info');
}

function addWorkOrderNote() {
    const note = prompt('Ajouter une note:');
    if (note && note.trim()) {
        // Ici on ajouterait la note via API
        console.log('Note ajoutée:', note);
        showWorkOrderNotification('Note ajoutée avec succès', 'success');
        // Recharger les notes
        loadWorkOrderNotes(currentWorkOrder);
    }
}

function uploadWorkOrderFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pdf,.jpg,.jpeg,.png,.doc,.docx';
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
            console.log('Fichier sélectionné:', file.name);
            showWorkOrderNotification('Fichier uploadé avec succès', 'success');
            // Recharger les pièces jointes
            loadWorkOrderAttachments(currentWorkOrder);
        }
    };
    input.click();
}

function downloadAttachment(filename) {
    console.log('Téléchargement de:', filename);
    showWorkOrderNotification('Téléchargement démarré', 'info');
}

function saveWorkOrderChanges() {
    console.log('Sauvegarde des modifications');
    showWorkOrderNotification('Modifications sauvegardées', 'success');
}

function editWorkOrder() {
    console.log('Édition du bon de travail');
    showWorkOrderNotification('Fonctionnalité d\'édition en développement', 'info');
}
</script>
