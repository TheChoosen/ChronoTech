{% extends "base.html" %}

{% block title %}ChronoChat Dashboard Interface - ChronoTech{% endblock %}

{% block head %}
<!-- Favicon -->
<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
<link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

<!-- CSS simple FullCalendar sans dépendance externe -->
<style>
    /* Styles FullCalendar minimaux pour éviter les erreurs de chargement */
    .fc-view-harness,
    .fc-view,
    .fc-toolbar {
        position: relative;
    }

    .fc-event {
        display: block;
        padding: 2px;
        margin: 1px 0;
        border-radius: 3px;
        background: #3788d8;
        color: white;
        text-decoration: none;
    }

    .fc-daygrid-event-harness {
        position: relative;
    }
</style>
<!-- Socket.IO pour chat temps réel -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<!-- ChronoChat Dashboard CSS -->
<link href="{{ url_for('static', filename='css/chronochat-dashboard.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="chronochat-dashboard">
    <!-- Toast de notifications -->
    <div class="toast-container position-fixed top-0 end-0 p-3 toast-layer">
        <div id="workOrderToast" class="toast" role="status" aria-live="polite" aria-atomic="true"
            data-bs-autohide="true">
            <div class="toast-header">
                <i class="fa-solid fa-info-circle text-primary me-2" aria-hidden="true"></i>
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Fermer"></button>
            </div>
            <div class="toast-body" id="toastMessage">Message</div>
        </div>
    </div>

    <!-- Bouton flottant Actions Rapides -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1030;">
        <button class="btn btn-primary btn-lg rounded-circle shadow-lg" 
                data-bs-toggle="modal" 
                data-bs-target="#quickActionsModal"
                title="Actions Rapides"
                style="width: 60px; height: 60px;">
            <i class="fa-solid fa-bolt fa-lg"></i>
        </button>
    </div>

    <!-- Détails Bon de Travail (section principale) -->
    <section class="card mb-4" id="work-order-details-panel" aria-labelledby="work-order-details-title">
        <div class="card-header py-2">
            <h6 class="mb-0" id="work-order-details-title"><i class="fa-solid fa-clipboard-list me-2 text-primary"
                    aria-hidden="true"></i>Détails du Bon de Travail</h6>
        </div>
        <div class="card-body">
            <!-- Boutons critiques toujours visibles -->
            <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fa-solid fa-bell me-1"></i>
                <span id="notif-badge" class="badge bg-danger ms-1">0</span>
            </button>

            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#quickActionsModal">
                <i class="fa-solid fa-bolt me-1"></i>
                <span class="d-none d-lg-inline">Actions Rapides</span>
            </button>

            <button class="btn btn-outline-success" onclick="createWorkOrder()">
                <i class="fa-solid fa-plus me-1"></i>
                <span class="d-none d-lg-inline">Nouveau</span>
            </button>
        </div>
    </section>

    <!-- Dashboard Widgets Innovation - Phase 1-3 -->
    <div class="row dashboard-widgets-container" id="dashboard-widgets-grid">
        <!-- Widget Copilote IA -->
        <div class="col-lg-4 col-md-6 mb-4">
            {% include 'dashboard/components/copilot_widget.html' %}
        </div>
        
        <!-- Widget Customer 360 -->
        <div class="col-lg-4 col-md-6 mb-4">
            {% include 'dashboard/components/customer360_widget.html' %}
        </div>
        
        <!-- Widget Chat Contextuel -->
        <div class="col-lg-4 col-md-6 mb-4">
            {% include 'dashboard/components/contextual_chat_widget.html' %}
        </div>
    </div>
    
    <!-- Bouton de personnalisation des widgets -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <button class="btn btn-outline-primary btn-sm" id="customize-dashboard" onclick="dashboardWidgets.toggleCustomizationMode()">
                <i class="fa-solid fa-gear me-2"></i>Personnaliser le Dashboard
            </button>
            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="dashboardWidgets.resetLayout()">
                <i class="fa-solid fa-undo me-2"></i>Réinitialiser
            </button>
        </div>
    </div>

    <!-- ChronoChat Interface principale avec Kanban Board -->
    <div class="row">
        <!-- Section Kanban Work Orders (largeur principale) -->
        <div class="col-lg-8 mb-4">
            <div class="clay-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-tasks me-2 text-primary"></i>Bons de Travail
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal"
                            data-bs-target="#workOrdersKanbanModal">
                            <i class="fa-solid fa-tasks me-1"></i>Kanban
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="createWorkOrder()">
                            <i class="fa-solid fa-plus me-1"></i>Nouveau
                        </button>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="work-orders-summary">
                        <div class="row text-center">
                            <div class="col-lg-2 col-md-4 col-6 mb-3">
                                <div class="wo-stat-card bg-secondary text-white rounded p-2">
                                    <i class="fa-solid fa-file-lines fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="summary-draft">0</h4>
                                    <small>Brouillons</small>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-6 mb-3">
                                <div class="wo-stat-card bg-warning text-dark rounded p-2">
                                    <i class="fa-solid fa-clock fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="summary-pending">0</h4>
                                    <small>En attente</small>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-6 mb-3">
                                <div class="wo-stat-card bg-info text-white rounded p-2">
                                    <i class="fa-solid fa-user-tag fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="summary-assigned">0</h4>
                                    <small>Assignés</small>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-6 mb-3">
                                <div class="wo-stat-card bg-primary text-white rounded p-2">
                                    <i class="fa-solid fa-gear fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="summary-in_progress">0</h4>
                                    <small>En cours</small>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-6 mb-3">
                                <div class="wo-stat-card bg-success text-white rounded p-2">
                                    <i class="fa-solid fa-check-circle fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="summary-completed">0</h4>
                                    <small>Terminés</small>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-6 mb-3">
                                <div class="wo-stat-card bg-danger text-white rounded p-2">
                                    <i class="fa-solid fa-times-circle fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="summary-cancelled">0</h4>
                                    <small>Annulés</small>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                            data-bs-target="#workOrdersKanbanModal">
                            <i class="fa-solid fa-expand me-1"></i>Vue Kanban Complète
                        </button>
                        <button class="btn btn-outline-info btn-sm ms-2" data-bs-toggle="modal"
                            data-bs-target="#workOrdersStatsModal">
                            <i class="fa-solid fa-chart-bar me-1"></i>Statistiques
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bouton Kanban Techniciens (ouvre une modal) -->
        <div class="col-lg-4 mb-4">
            <div class="clay-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-users-gear me-2 text-success"></i>Gestion Techniciens
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal"
                            data-bs-target="#techniciansKanbanModal">
                            <i class="fa-solid fa-users-gear me-1"></i>Kanban
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="addTechnician()">
                            <i class="fa-solid fa-user-plus me-1"></i>Ajouter
                        </button>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="technicians-summary">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="tech-stat-card bg-success text-white rounded p-2">
                                    <i class="fa-solid fa-user-check fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="summary-available">0</h4>
                                    <small>Disponibles</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="tech-stat-card bg-warning text-dark rounded p-2">
                                    <i class="fa-solid fa-user-clock fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="summary-busy">0</h4>
                                    <small>Occupés</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="tech-stat-card bg-info text-white rounded p-2">
                                    <i class="fa-solid fa-user-minus fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="summary-break">0</h4>
                                    <small>En pause</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="tech-stat-card bg-secondary text-white rounded p-2">
                                    <i class="fa-solid fa-user-slash fa-2x mb-2"></i>
                                    <h4 class="mb-0" id="summary-offline">0</h4>
                                    <small>Hors ligne</small>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-success btn-sm" data-bs-toggle="modal"
                                data-bs-target="#techniciansKanbanModal">
                                <i class="fa-solid fa-expand me-1"></i>Vue Kanban Complète
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Diagramme de Gantt -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="clay-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-chart-gantt me-2 text-info"></i>Diagramme de Gantt - Planning des Bons de
                        Travail
                    </h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="gantt-period" style="width: auto;">
                            <option value="week">Cette semaine</option>
                            <option value="month" selected>Ce mois</option>
                            <option value="quarter">Ce trimestre</option>
                        </select>
                        <button class="btn btn-sm btn-info" onclick="refreshGantt()">
                            <i class="fa-solid fa-refresh me-1"></i>Actualiser
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="exportGantt()">
                            <i class="fa-solid fa-download me-1"></i>Exporter
                        </button>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="gantt-container" id="gantt-container">
                        <div class="gantt-header">
                            <div class="gantt-timeline" id="gantt-timeline">
                                <!-- Timeline sera générée dynamiquement -->
                            </div>
                        </div>
                        <div class="gantt-body" id="gantt-body">
                            <!-- Barres de Gantt seront générées dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modales ChronoChat -->
{% include 'templates/dashboard/modal/quick_actions_modal.html' %}
{% include 'templates/dashboard/modal/team_chat_modal.html' %}
{% include 'templates/dashboard/modal/agenda_modal.html' %}
{% include 'templates/dashboard/modal/event_modal.html' %}
{% include 'templates/dashboard/modal/event_details_modal.html' %}
{% include 'templates/dashboard/modal/notifications_modal.html' %}
{% include 'templates/dashboard/modal/aura_modal.html' %}
{% include 'templates/dashboard/modal/stats_modal.html' %}
{% include 'templates/dashboard/modal/modules_modal.html' %}
{% include 'templates/dashboard/modal/departments_modal.html' %}
{% include 'templates/dashboard/modal/work_order_modal.html' %}

<!-- Modales Kanban -->
{% include 'templates/dashboard/modal/technicians_kanban_modal.html' %}
{% include 'templates/dashboard/modal/work_orders_kanban_modal.html' %}
{% include 'templates/dashboard/modal/work_order_details_modal.html' %}
{% include 'templates/dashboard/modal/assign_technician_modal.html' %}
{% include 'templates/dashboard/modal/add_time_modal.html' %}
{% include 'templates/dashboard/modal/add_note_modal.html' %}

<!-- Modal Simple - Temporairement désactivé pour éviter conflit d'IDs -->
<!-- {% include 'dashboard/modal/work_order_simple_details_modal.html' %} -->


<!-- Toast de notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="workOrderToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fa-solid fa-info-circle text-primary me-2"></i>
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Fermer"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Message
        </div>
    </div>
</div>

</div>
{% endblock %}

{% block scripts %}
<!-- FullCalendar CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/fullcalendar/6.1.10/index.global.min.css') }}">

<!-- FullCalendar JS - Version locale pour éviter CSP -->
<script src="{{ url_for('static', filename='vendor/fullcalendar/6.1.10/index.global.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/fullcalendar/6.1.10/fr.global.min.js') }}"></script>

<!-- ChronoChat Dashboard Scripts -->
<script src="{{ url_for('static', filename='js/chronochat-dashboard.js') }}"></script>

<!-- Kanban Fullscreen Manager -->
<script src="{{ url_for('static', filename='js/kanban-fullscreen-manager.js') }}"></script>

<!-- Kanban Fix (correction des conflits) -->
<script src="{{ url_for('static', filename='js/kanban-fix.js') }}"></script>

<!-- Debug Kanban (en développement) -->
<script src="{{ url_for('static', filename='js/kanban-debug.js') }}"></script>

<!-- Bootstrap principal pour initialisation -->
<script>
    // ==================== BOOTSTRAP CENTRALISE ====================
    window.ChronoTechDashboard = {
        initialized: false,

        // Fonctions qui seront exposées globalement
        loadGanttData: null,
        loadKanbanDataFix: null,
        loadTechniciansData: null,

        // Initialisation centralisée
        init: function () {
            if (this.initialized) return;

            console.log('🚀 Initialisation ChronoTech Dashboard...');

            // Attendre que toutes les librairies soient chargées
            if (typeof FullCalendar === 'undefined') {
                console.log('⏳ Attente FullCalendar...');
                setTimeout(() => this.init(), 100);
                return;
            }

            // Exposer les fonctions sur window pour compatibilité onclick
            if (typeof loadGanttData === 'function') {
                window.loadGanttData = loadGanttData;
                this.loadGanttData = loadGanttData;
            }

            if (typeof loadKanbanDataFix === 'function') {
                window.loadKanbanDataFix = loadKanbanDataFix;
                this.loadKanbanDataFix = loadKanbanDataFix;
            }

            if (typeof loadTechniciansData === 'function') {
                window.loadTechniciansData = loadTechniciansData;
                this.loadTechniciansData = loadTechniciansData;
            }

            this.initialized = true;
            console.log('✅ ChronoTech Dashboard initialisé');

            // Déclencher le chargement des données
            this.loadAllData();
        },

        loadAllData: function () {
            console.log('📊 Chargement des données dashboard...');

            // Charger les données avec délais pour éviter les races conditions
            setTimeout(() => {
                if (this.loadKanbanDataFix) this.loadKanbanDataFix();
            }, 100);

            setTimeout(() => {
                if (this.loadGanttData) this.loadGanttData();
            }, 200);

            setTimeout(() => {
                if (this.loadTechniciansData) this.loadTechniciansData();
            }, 300);
        }
    };

    // Initialisation au chargement de la page
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🎯 DOM Ready - Démarrage bootstrap dashboard');

        // Donner un délai pour que tous les scripts se chargent
        setTimeout(() => {
            window.ChronoTechDashboard.init();
        }, 500);
    });

    // Fallback au cas où DOMContentLoaded est déjà passé
    if (document.readyState === 'loading') {
        // DOM encore en cours de chargement, DOMContentLoaded se déclenchera
    } else {
        // DOM déjà chargé
        setTimeout(() => {
            window.ChronoTechDashboard.init();
        }, 100);
    }
</script>

<!-- Ajustements CSS spécifiques au template -->
<style>
    /* Ajustements spécifiques pour l'intégration avec base.html */
    .chronochat-dashboard {
        margin-top: -1.5rem;
        /* Compensation du padding container */
    }

    /* Personnalisations pour les statuts Kanban spécifiques */
    .kanban-column[data-status="nouveau"] {
        --status-color: var(--info-color);
    }

    .kanban-column[data-status="assigne"] {
        --status-color: var(--warning-color);
    }

    .kanban-column[data-status="en-cours"] {
        --status-color: var(--primary-color);
    }

    .kanban-column[data-status="en-attente"] {
        --status-color: var(--warning-color);
    }

    .kanban-column[data-status="termine"] {
        --status-color: var(--success-color);
    }

    .kanban-column[data-status="facture"] {
        --status-color: var(--success-color);
    }

    .kanban-column::before {
        background: var(--status-color, var(--primary-color));
    }

    /* Intégration harmonieuse avec la navbar */
    @media (min-width: 992px) {
        .chronochat-dashboard {
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
    }

    /* Suppressions d'effets pour un rendu plus sobre */
    .clay-element:hover,
    .clay-card:hover,
    .kanban-column:hover,
    .kanban-card:hover {
        transform: none !important;
        /* Supprime tous les effets de translation */
    }

    /* Réduction de la transparence globale */
    .badge {
        opacity: 0.95 !important;
    }

    /* Désactivation des animations subtiles */
    * {
        animation-duration: 0s !important;
        transition-duration: 0.2s !important;
        /* Transitions très rapides */
    }

    /* Réduction des ombres pour moins d'effets */
    .clay-element,
    .clay-card,
    .kanban-column,
    .kanban-card {
        box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light) !important;
        transition: all 0.3s ease;
    }

    /* Animations pour le drag & drop */
    .kanban-card.status-changed {
        animation: statusChanged 0.6s ease;
        border: 2px solid #007bff;
    }

    @keyframes statusChanged {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
        }

        100% {
            transform: scale(1);
        }
    }

    .kanban-card.dragging {
        opacity: 0.8;
        transform: rotate(5deg) scale(1.05);
        z-index: 1000;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .kanban-column.drag-over {
        background-color: rgba(0, 123, 255, 0.1);
        border: 2px dashed #007bff;
    }

    /* Toast notifications */
    .toast-notification {
        font-family: 'Inter', sans-serif;
        border-left: 4px solid rgba(255, 255, 255, 0.3);
    }

    .toast-notification:hover {
        cursor: pointer;
        opacity: 0.9;
    }

    /* Conteneur toast couche supérieure */
    .toast-layer {
        z-index: 1090;
        /* supérieur à modal (1050) pour rester visible */
    }

    /* Styles pour le Kanban Techniciens */
    .technician-board {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-height: 500px;
        overflow-y: auto;
    }

    .tech-column {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        overflow: hidden;
        background: #fff;
    }

    .tech-header {
        padding: 0.5rem;
        display: flex;
        justify-content: between;
        align-items: center;
        font-size: 0.875rem;
    }

    .tech-content {
        min-height: 60px;
        padding: 0.5rem;
        background: #f8f9fa;
    }

    .tech-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .tech-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .tech-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(45deg, #007bff, #6f42c1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.75rem;
    }

    .tech-info {
        flex: 1;
    }

    .tech-name {
        font-weight: 600;
        font-size: 0.875rem;
        margin: 0;
    }

    .tech-role {
        font-size: 0.75rem;
        color: #6c757d;
        margin: 0;
    }

    .tech-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-left: auto;
    }

    .tech-status.available {
        background: #28a745;
    }

    .tech-status.busy {
        background: #ffc107;
    }

    .tech-status.break {
        background: #17a2b8;
    }

    .tech-status.offline {
        background: #6c757d;
    }

    /* Styles pour le Diagramme de Gantt */
    .gantt-container {
        width: 100%;
        overflow-x: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        background: white;
    }

    .gantt-header {
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .gantt-timeline {
        display: flex;
        height: 40px;
        align-items: center;
        padding: 0 0.5rem;
        min-width: 800px;
    }

    .gantt-day {
        flex: 1;
        text-align: center;
        padding: 0.25rem;
        border-right: 1px solid #dee2e6;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .gantt-day:last-child {
        border-right: none;
    }

    .gantt-body {
        min-width: 800px;
    }

    .gantt-row {
        display: flex;
        border-bottom: 1px solid #f0f0f0;
        min-height: 50px;
        align-items: center;
        position: relative;
    }

    .gantt-row:hover {
        background: #f8f9fa;
    }

    .gantt-task {
        position: absolute;
        height: 30px;
        border-radius: 4px;
        color: white;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        padding: 0 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 5;
    }

    .gantt-task:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .gantt-task::after {
        content: '👁️';
        position: absolute;
        top: 50%;
        right: 8px;
        transform: translateY(-50%);
        opacity: 0;
        transition: opacity 0.2s ease;
        font-size: 0.8rem;
        pointer-events: none;
    }

    .gantt-task:hover::after {
        opacity: 0.8;
    }

    .gantt-task.priority-low {
        background: #17a2b8;
    }

    .gantt-task.priority-medium {
        background: #ffc107;
        color: #000;
    }

    .gantt-task.priority-high {
        background: #fd7e14;
    }

    .gantt-task.priority-urgent {
        background: #dc3545;
    }

    .gantt-task-label {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
    }

    .gantt-legend {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .gantt-legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .gantt-legend-color {
        width: 16px;
        height: 16px;
        border-radius: 2px;
    }

    /* Styles pour la section résumé des techniciens */
    .technicians-summary {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .tech-stat-card {
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .tech-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* Styles pour la modal Kanban Techniciens */
    .tech-kanban-column {
        border: 2px solid #dee2e6;
        border-radius: 0.75rem;
        overflow: hidden;
        background: #fff;
        min-height: 400px;
        transition: all 0.2s ease;
    }

    .tech-kanban-column:hover {
        border-color: #adb5bd;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .tech-kanban-column.drag-over {
        border-color: #0d6efd;
        background: #f8f9ff;
        transform: scale(1.02);
    }

    .tech-kanban-header {
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .tech-kanban-content {
        min-height: 350px;
        padding: 0.75rem;
        background: #f8f9fa;
        overflow-y: auto;
    }

    .tech-kanban-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        cursor: grab;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .tech-kanban-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
        transform: translateY(-2px);
    }

    .tech-kanban-card:active {
        cursor: grabbing;
        transform: rotate(2deg);
    }

    .tech-kanban-card.dragging {
        opacity: 0.7;
        transform: rotate(5deg) scale(1.05);
        z-index: 1000;
    }

    .tech-kanban-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(45deg, #007bff, #6f42c1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .tech-kanban-info {
        text-align: center;
    }

    .tech-kanban-name {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.25rem;
        color: #343a40;
    }

    .tech-kanban-role {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .tech-kanban-details {
        font-size: 0.8rem;
        color: #495057;
    }

    .tech-kanban-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }

    .tech-kanban-status-indicator.available {
        background: #28a745;
    }

    .tech-kanban-status-indicator.busy {
        background: #ffc107;
    }

    .tech-kanban-status-indicator.break {
        background: #17a2b8;
    }

    .tech-kanban-status-indicator.offline {
        background: #6c757d;
    }

    .tech-stats-summary {
        font-size: 0.9rem;
    }

    .tech-stats-summary span {
        font-weight: 600;
        color: #495057;
    }

    /* Animation pour les changements de statut */
    @keyframes statusChange {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
        }

        100% {
            transform: scale(1);
        }
    }

    .tech-kanban-card.status-changed {
        animation: statusChange 0.3s ease;
    }

    /* Responsive pour la modal */
    @media (max-width: 768px) {
        .tech-kanban-column {
            margin-bottom: 1rem;
        }

        .tech-kanban-content {
            min-height: 200px;
        }

        .modal-xl {
            max-width: 95%;
        }
    }

    /* Styles pour la section résumé des bons de travail */
    .work-orders-summary {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .wo-stat-card {
        transition: all 0.2s ease;
        cursor: pointer;
        height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .wo-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* Styles pour la modal Kanban Bons de Travail */
    .wo-kanban-column {
        border: 2px solid #dee2e6;
        border-radius: 0.75rem;
        overflow: hidden;
        background: #fff;
        min-height: 500px;
        transition: all 0.2s ease;
    }

    .wo-kanban-column:hover {
        border-color: #adb5bd;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .wo-kanban-column.drag-over {
        border-color: #0d6efd;
        background: #f8f9ff;
        transform: scale(1.02);
    }

    .wo-kanban-header {
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .wo-kanban-content {
        min-height: 450px;
        padding: 0.75rem;
        background: #f8f9fa;
        overflow-y: auto;
    }

    .wo-kanban-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        cursor: grab;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        position: relative;
    }

    .wo-kanban-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-top: 10px solid #007bff;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .wo-kanban-card:hover::before {
        opacity: 0.7;
    }

    .wo-kanban-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
        transform: translateY(-2px);
        cursor: pointer;
    }

    .wo-kanban-card:active {
        cursor: grabbing;
        transform: rotate(1deg);
    }

    .wo-kanban-card.dragging {
        opacity: 0.7;
        transform: rotate(3deg) scale(1.05);
        z-index: 1000;
    }

    .wo-kanban-card.urgent-priority {
        border-left: 4px solid #dc3545;
        background: linear-gradient(90deg, #fff5f5 0%, #ffffff 10%);
    }

    .wo-kanban-card.high-priority {
        border-left: 4px solid #fd7e14;
        background: linear-gradient(90deg, #fff8f0 0%, #ffffff 10%);
    }

    .wo-kanban-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }

    .wo-kanban-card-title {
        font-weight: 600;
        font-size: 0.95rem;
        color: #343a40;
        margin: 0;
    }

    .wo-kanban-card-customer {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .wo-kanban-card-description {
        font-size: 0.85rem;
        color: #495057;
        margin-bottom: 0.5rem;
        line-height: 1.3;
        max-height: 3.9rem;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }

    .wo-kanban-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: #6c757d;
    }

    .wo-kanban-card-technician {
        font-weight: 500;
    }

    .wo-kanban-card-date {
        opacity: 0.8;
    }

    .wo-priority-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
    }

    .wo-stats-summary {
        font-size: 0.9rem;
    }

    .wo-stats-summary span {
        font-weight: 600;
        color: #495057;
    }

    /* Animation pour les changements de statut des bons de travail */
    @keyframes woStatusChange {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }

        100% {
            transform: scale(1);
        }
    }

    .wo-kanban-card.status-changed {
        animation: woStatusChange 0.3s ease;
    }

    /* Responsive pour la modal Kanban Work Orders */
    @media (max-width: 1200px) {
        .wo-kanban-column {
            margin-bottom: 1rem;
        }

        .wo-kanban-content {
            min-height: 300px;
        }
    }

    @media (max-width: 768px) {
        .wo-kanban-content {
            min-height: 250px;
        }

        .wo-kanban-header h6 {
            font-size: 0.8rem;
        }

        .wo-kanban-card {
            padding: 0.5rem;
        }
    }

    /* Styles pour la modal de détails des bons de travail */
    .timeline {
        position: relative;
        max-height: 300px;
        overflow-y: auto;
    }

    .timeline-item {
        position: relative;
        padding-left: 0;
    }

    .timeline-marker {
        position: relative;
        z-index: 2;
    }

    .timeline-content {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 0.75rem;
        position: relative;
    }

    .timeline-content::before {
        content: '';
        position: absolute;
        left: -8px;
        top: 15px;
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-right: 8px solid #dee2e6;
    }

    .timeline-content::after {
        content: '';
        position: absolute;
        left: -7px;
        top: 15px;
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-right: 8px solid #f8f9fa;
    }

    /* Styles pour les cartes de détails */
    #workOrderDetailsModal .card {
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    #workOrderDetailsModal .card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    #workOrderDetailsModal .card-header {
        background: linear-gradient(45deg, #f8f9fa, #e9ecef);
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
    }

    #workOrderDetailsModal .card-body {
        padding: 1.25rem;
    }

    /* Amélioration des badges dans la modal */
    #workOrderDetailsModal .badge {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
        border-radius: 0.375rem;
    }

    /* Styles pour la barre de progression personnalisée */
    #workOrderDetailsModal .progress {
        border-radius: 0.5rem;
        overflow: hidden;
        background: #e9ecef;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    #workOrderDetailsModal .progress-bar {
        border-radius: 0.5rem;
        transition: width 0.6s ease;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Responsive pour la modal de détails */
    @media (max-width: 992px) {
        #workOrderDetailsModal .modal-dialog {
            max-width: 95%;
            margin: 1rem auto;
        }

        #workOrderDetailsModal .card-body {
            padding: 1rem;
        }

        #workOrderDetailsModal .timeline {
            max-height: 200px;
        }
    }

    @media (max-width: 768px) {
        #workOrderDetailsModal .modal-dialog {
            margin: 0.5rem;
        }

        #workOrderDetailsModal .row.mb-3 {
            margin-bottom: 1rem !important;
        }

        #workOrderDetailsModal .col-sm-4,
        #workOrderDetailsModal .col-sm-5 {
            margin-bottom: 0.25rem;
        }

        #workOrderDetailsModal .modal-footer .d-flex {
            flex-direction: column;
            gap: 0.5rem;
        }

        #workOrderDetailsModal .modal-footer .d-flex>div {
            width: 100%;
            text-align: center;
        }
    }

    /* Animation pour l'ouverture de la modal */
    #workOrderDetailsModal .modal-content {
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Styles spéciaux pour les éléments interactifs */
    #workOrderDetailsModal .card-body .row:hover {
        background: rgba(13, 110, 253, 0.05);
        border-radius: 0.25rem;
        padding: 0.25rem;
        margin: -0.25rem;
        transition: all 0.2s ease;
    }

    /* Amélioration visuelle des zones de texte */
    #workOrderDetailsModal .border.rounded {
        background: #ffffff;
        border: 2px solid #e9ecef !important;
        transition: border-color 0.2s ease;
    }

    #workOrderDetailsModal .border.rounded:hover {
        border-color: #adb5bd !important;
    }
</style>

<!-- Script de correction pour données Kanban -->
<script>
    // Correctif temporaire pour charger les données Kanban
    async function loadKanbanDataFix() {
        try {
            console.log('🔧 Correction: Chargement données Kanban...');

            // Essayer l'URL locale d'abord (qui fonctionne selon nos tests)
            let response = await fetch('/api/kanban-data');
            
            if (!response.ok) {
                console.log('⚠️ API principale non disponible, test d\'autres ports...');

                // Essayer d'autres URLs/ports
                const alternativeUrls = [
                    'http://127.0.0.1:5020/api/kanban-data',
                    'http://127.0.0.1:5000/api/kanban-data',
                    'http://192.168.50.147:5020/api/kanban-data',
                    'http://192.168.50.147:5011/api/kanban-data'
                ];

                for (const url of alternativeUrls) {
                    try {
                        response = await fetch(url);
                        if (response.ok) {
                            console.log(`✅ Données trouvées sur ${url}`);
                            break;
                        }
                    } catch (e) {
                        console.log(`❌ Échec ${url}:`, e.message);
                    }
                }
            } else {
                console.log('✅ Données trouvées avec URL relative /api/kanban-data');
            }

            if (response.ok) {
                const data = await response.json();
                console.log('📊 Données API reçues:', data);

                // L'API retourne soit { success: true, kanban_data: {...} } soit directement { kanban_data: {...} }
                let kanbanData = data.kanban_data || data;

                if (kanbanData && typeof kanbanData === 'object') {
                    // Compter le total
                    const totalCount = Object.values(kanbanData).reduce((total, statusArray) => {
                        return total + (Array.isArray(statusArray) ? statusArray.length : 0);
                    }, 0);

                    console.log(`✅ ${totalCount} bons de travail chargés depuis l'API`);
                    console.log('  - Statuts disponibles:', Object.keys(kanbanData));

                    // Utiliser les vraies données de l'API
                    updateKanbanColumnsDirect(kanbanData);
                    return;
                } else {
                    console.warn('⚠️ Structure de données API inattendue:', data);
                }
            }

            // Fallback avec données test
            console.log('⚠️ Utilisation des données de test');
            const testData = {
                draft: [
                    { id: 1, claim_number: 'WO-001', customer_name: 'Entreprise Alpha', description: 'Installation système de sécurité - En phase de planification', priority: 'medium', created_at: '2025-01-20 10:00' },
                    { id: 2, claim_number: 'WO-007', customer_name: 'Société Beta', description: 'Devis pour maintenance préventive', priority: 'low', created_at: '2025-01-20 11:30' }
                ],
                pending: [
                    { id: 3, claim_number: 'WO-002', customer_name: 'Client Gamma', description: 'Réparation urgente climatisation bureau principal', priority: 'high', created_at: '2025-01-20 09:00' },
                    { id: 4, claim_number: 'WO-003', customer_name: 'Corp Delta', description: 'Panne électrique complète - Intervention immédiate requise', priority: 'urgent', created_at: '2025-01-20 08:00' },
                    { id: 5, claim_number: 'WO-008', customer_name: 'Magasin Epsilon', description: 'Installation nouvelle caisse enregistreuse', priority: 'medium', created_at: '2025-01-20 07:45' }
                ],
                assigned: [
                    { id: 6, claim_number: 'WO-004', customer_name: 'Restaurant Zeta', description: 'Maintenance équipement cuisine professionnelle', priority: 'medium', technician_name: 'Jean Dupont', created_at: '2025-01-20 07:00' },
                    { id: 7, claim_number: 'WO-009', customer_name: 'Hôtel Eta', description: 'Réparation ascenseur principal', priority: 'high', technician_name: 'Sophie Martin', created_at: '2025-01-20 06:30' }
                ],
                in_progress: [
                    { id: 8, claim_number: 'WO-005', customer_name: 'Bureau Theta', description: 'Migration serveur informatique en cours', priority: 'high', technician_name: 'Marie Martin', created_at: '2025-01-20 06:00' },
                    { id: 9, claim_number: 'WO-010', customer_name: 'Usine Iota', description: 'Calibrage machines de production', priority: 'urgent', technician_name: 'Pierre Durand', created_at: '2025-01-20 05:00' }
                ],
                completed: [
                    { id: 10, claim_number: 'WO-006', customer_name: 'Boutique Kappa', description: 'Installation éclairage LED terminée avec succès', priority: 'low', technician_name: 'Pierre Durand', created_at: '2025-01-19 15:00' },
                    { id: 11, claim_number: 'WO-011', customer_name: 'Cabinet Lambda', description: 'Mise en place réseau Wi-Fi sécurisé', priority: 'medium', technician_name: 'Luc Moreau', created_at: '2025-01-19 14:00' },
                    { id: 12, claim_number: 'WO-012', customer_name: 'Laboratoire Mu', description: 'Certification équipements scientifiques', priority: 'high', technician_name: 'Anne Dubois', created_at: '2025-01-19 13:00' }
                ],
                cancelled: [
                    { id: 13, claim_number: 'WO-013', customer_name: 'Projet Nu', description: 'Annulé - Client a reporté le projet', priority: 'low', created_at: '2025-01-19 12:00' }
                ]
            };

            updateKanbanColumnsDirect(testData);

        } catch (error) {
            console.error('❌ Erreur chargement Kanban:', error);
        }
    }

    // Mise à jour directe des colonnes Kanban
    function updateKanbanColumnsDirect(data) {
        const statuses = ['draft', 'pending', 'assigned', 'in_progress', 'completed', 'cancelled'];

        console.log('🎯 Mise à jour Kanban avec données:', data);

        statuses.forEach(status => {
            // Utiliser le bon ID de colonne
            const column = document.getElementById(`modal-column-${status}`);
            const count = document.getElementById(`count-${status}`);

            if (column && data[status]) {
                // Vider la colonne
                column.innerHTML = '';

                // Ajouter chaque carte
                data[status].forEach(workOrder => {
                    const card = createKanbanCardDirect(workOrder);
                    column.appendChild(card);
                });

                // Mettre à jour le compteur
                if (count) {
                    count.textContent = data[status].length;
                }

                console.log(`✅ ${status}: ${data[status].length} éléments ajoutés dans #modal-column-${status}`);
            } else {
                if (!column) {
                    console.warn(`❌ Colonne #modal-column-${status} non trouvée`);
                }
                if (!data[status]) {
                    console.warn(`❌ Pas de données pour status ${status}`);
                }
            }
        });

        console.log('🎯 Vérification DOM après mise à jour:');
        statuses.forEach(status => {
            const column = document.getElementById(`modal-column-${status}`);
            if (column) {
                const cards = column.querySelectorAll('.kanban-card, .wo-card');
                console.log(`  - ${status}: ${cards.length} cartes dans le DOM`);
            }
        });

        // Charger les filtres et ajouter les événements drag
        setTimeout(() => {
            loadFilterOptions();
            addDragEvents();
        }, 500);
    }

    // Créer une carte Kanban directement
    function createKanbanCardDirect(workOrder) {
        const card = document.createElement('div');
        card.className = `kanban-card ${workOrder.priority === 'urgent' ? 'urgent-priority' : workOrder.priority === 'high' ? 'high-priority' : ''}`;
        card.draggable = true;
        card.dataset.cardId = workOrder.id;
        card.dataset.currentStatus = workOrder.status;

        const priorityColor = {
            'low': 'info',
            'medium': 'warning',
            'high': 'warning',
            'urgent': 'danger'
        };

        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="card-title mb-0">#${workOrder.claim_number}</h6>
                <span class="badge bg-${priorityColor[workOrder.priority] || 'info'}">${workOrder.priority}</span>
            </div>
            <p class="text-muted small mb-2">${workOrder.customer_name}</p>
            <p class="mb-2">${workOrder.description || 'Aucune description'}</p>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted">${workOrder.technician_name || 'Non assigné'}</small>
                <small class="text-muted">${workOrder.created_at || ''}</small>
            </div>
            <div class="d-flex gap-1">
                <button class="btn btn-sm btn-outline-primary flex-fill" onclick="event.stopPropagation(); viewWorkOrderDetails(${workOrder.id})">
                    <i class="fa-solid fa-eye me-1"></i>Voir
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); editWorkOrder(${workOrder.id})" title="Modifier">
                    <i class="fa-solid fa-edit"></i>
                </button>
            </div>
        `;

        card.addEventListener('click', () => {
            if (workOrder.id > 0 && workOrder.id < 1000) {
                showWorkOrderDetails(workOrder.id);
            }
        });

        return card;
    }

    // Déplacer un bon de travail entre colonnes
    function moveWorkOrderToColumn(workOrderId, fromStatus, toStatus) {
        const fromColumn = document.getElementById(`modal-column-${fromStatus}`);
        const toColumn = document.getElementById(`modal-column-${toStatus}`);
        const fromCount = document.getElementById(`count-${fromStatus}`);
        const toCount = document.getElementById(`count-${toStatus}`);

        if (fromColumn && toColumn) {
            // Trouver la carte
            const card = fromColumn.querySelector(`[data-card-id="${workOrderId}"]`);
            if (card) {
                // Déplacer la carte
                toColumn.appendChild(card);

                // Mettre à jour les compteurs
                if (fromCount) {
                    fromCount.textContent = parseInt(fromCount.textContent) - 1;
                }
                if (toCount) {
                    toCount.textContent = parseInt(toCount.textContent) + 1;
                }

                console.log(`✅ Bon de travail ${workOrderId} déplacé de ${fromStatus} vers ${toStatus}`);
            }
        }
    }

    // Mettre à jour une carte Kanban
    function updateWorkOrderCard(workOrderId, workOrderData) {
        const allColumns = ['draft', 'pending', 'assigned', 'in_progress', 'completed', 'cancelled'];

        allColumns.forEach(status => {
            const column = document.getElementById(`modal-column-${status}`);
            if (column) {
                const card = column.querySelector(`[data-card-id="${workOrderId}"]`);
                if (card) {
                    // Mettre à jour le contenu de la carte
                    const priorityColor = {
                        'low': 'info',
                        'medium': 'warning',
                        'high': 'warning',
                        'urgent': 'danger'
                    };

                    card.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">#${workOrderData.claim_number}</h6>
                            <span class="badge bg-${priorityColor[workOrderData.priority] || 'info'}">${workOrderData.priority}</span>
                        </div>
                        <p class="text-muted small mb-2">${workOrderData.customer_name}</p>
                        <p class="mb-2">${workOrderData.description || 'Aucune description'}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">${workOrderData.technician_name || 'Non assigné'}</small>
                            <small class="text-muted">${workOrderData.created_at || ''}</small>
                        </div>
                    `;
                }
            }
        });
    }

    // Filtrer le Kanban
    function filterKanban() {
        const clientFilter = document.getElementById('kanban-filter-client').value;
        const techFilter = document.getElementById('kanban-filter-tech').value;

        console.log('🔍 Filtrage Kanban:', { client: clientFilter, tech: techFilter });

        const allCards = document.querySelectorAll('.kanban-card');
        let visibleCount = 0;

        allCards.forEach(card => {
            const customerName = card.querySelector('.text-muted.small').textContent;
            const technicianName = card.querySelector('.d-flex .text-muted:first-child').textContent;

            let showCard = true;

            // Filtre client
            if (clientFilter && !customerName.toLowerCase().includes(clientFilter.toLowerCase())) {
                showCard = false;
            }

            // Filtre technicien
            if (techFilter && !technicianName.toLowerCase().includes(techFilter.toLowerCase())) {
                showCard = false;
            }

            if (showCard) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        console.log(`✅ Filtrage terminé: ${visibleCount} cartes visibles`);
    }

    // Charger les options de filtres
    function loadFilterOptions() {
        const clientSelect = document.getElementById('kanban-filter-client');
        const techSelect = document.getElementById('kanban-filter-tech');

        // Extraire les clients uniques
        const clients = new Set();
        const technicians = new Set();
        const departments = new Set();

        document.querySelectorAll('.kanban-card').forEach(card => {
            const customer = card.querySelector('.text-muted.small')?.textContent;
            const tech = card.querySelector('.d-flex .text-muted:first-child')?.textContent;

            if (customer) clients.add(customer);
            if (tech && tech !== 'Non assigné') technicians.add(tech);
        });

        // Remplir le filtre clients
        clientSelect.innerHTML = '<option value="">Tous les clients</option>';
        Array.from(clients).sort().forEach(client => {
            const option = document.createElement('option');
            option.value = client;
            option.textContent = client;
            clientSelect.appendChild(option);
        });

        // Remplir le filtre techniciens
        techSelect.innerHTML = '<option value="">Tous les techniciens</option>';
        Array.from(technicians).sort().forEach(tech => {
            const option = document.createElement('option');
            option.value = tech;
            option.textContent = tech;
            techSelect.appendChild(option);
        });

        console.log(`✅ Filtres chargés: ${clients.size} clients, ${technicians.size} techniciens`);
    }

    // Gestion du drag & drop Kanban
    function allowDrop(ev) {
        ev.preventDefault();

        // Ajouter feedback visuel sur la zone de drop
        const dropZone = ev.target.closest('.wo-kanban-content');
        if (dropZone && !dropZone.classList.contains('drag-over')) {
            dropZone.classList.add('drag-over');

            // Supprimer le feedback après un court délai si pas de drop
            setTimeout(() => {
                if (dropZone.classList.contains('drag-over')) {
                    dropZone.classList.remove('drag-over');
                }
            }, 100);
        }
    }

    function handleDrop(ev) {
        ev.preventDefault();
        const cardId = ev.dataTransfer.getData("text");
        const dropZone = ev.target.closest('.kanban-content');

        if (dropZone && cardId) {
            const card = document.querySelector(`[data-card-id="${cardId}"]`);
            const newStatus = dropZone.id.replace('column-', '');
            const oldColumn = card.closest('.kanban-content');
            const oldStatus = oldColumn.id.replace('column-', '');

            if (newStatus !== oldStatus) {
                // Déplacer la carte
                dropZone.appendChild(card);

                // Mettre à jour les compteurs
                updateKanbanCounts();

                console.log(`📋 Carte ${cardId} déplacée de ${oldStatus} vers ${newStatus}`);

                // Ici on pourrait faire un appel API pour sauvegarder le changement
                // updateWorkOrderStatus(cardId, newStatus);
            }
        }
    }

    // Ajouter l'événement de drag aux cartes
    function addDragEvents() {
        document.querySelectorAll('.kanban-card').forEach(card => {
            card.addEventListener('dragstart', function (e) {
                e.dataTransfer.setData("text", this.dataset.cardId);
            });
        });
    }

    // Mettre à jour les compteurs Kanban
    function updateKanbanCounts() {
        ['draft', 'pending', 'assigned', 'in_progress', 'completed', 'cancelled'].forEach(status => {
            const column = document.getElementById(`column-${status}`);
            const count = document.getElementById(`count-${status}`);

            if (column && count) {
                const visibleCards = column.querySelectorAll('.kanban-card[style*="display: block"], .kanban-card:not([style*="display: none"])').length;
                count.textContent = visibleCards;
            }
        });
    }

    // Synchronisation des statistiques entre sidebar et modal
    function syncStatsToModal() {
        // Synchroniser les statistiques principales
        const mainStats = {
            'pending-work-orders': 'modal-pending-work-orders',
            'today-appointments': 'modal-today-appointments',
            'online-techs': 'modal-online-techs',
            'monthly-revenue': 'modal-monthly-revenue'
        };

        Object.entries(mainStats).forEach(([mainId, modalId]) => {
            const mainElement = document.getElementById(mainId);
            const modalElement = document.getElementById(modalId);
            if (mainElement && modalElement) {
                modalElement.textContent = mainElement.textContent;
            }
        });

        // Synchroniser le compteur d'équipe en ligne
        const onlineCount = document.getElementById('online-count');
        const modalOnlineCount = document.getElementById('modal-online-count');
        if (onlineCount && modalOnlineCount) {
            modalOnlineCount.textContent = onlineCount.textContent;
        }

        // Synchroniser la liste de l'équipe en ligne
        const teamList = document.getElementById('online-team-list');
        const modalTeamList = document.getElementById('modal-online-team-list');
        if (teamList && modalTeamList) {
            modalTeamList.innerHTML = teamList.innerHTML || `
                <div class="text-center text-muted py-4">
                    <i class="fa-solid fa-users fa-2x mb-2"></i>
                    <p>Aucun membre en ligne</p>
                </div>
            `;
        }
    }

    // Actualiser les statistiques de la modal
    function refreshStatsModal() {
        console.log('🔄 Actualisation des statistiques...');

        // Générer des données d'exemple pour les statistiques détaillées
        const mockStats = {
            'modal-total-work-orders': Math.floor(Math.random() * 50) + 20,
            'modal-completed-today': Math.floor(Math.random() * 10) + 5,
            'modal-in-progress': Math.floor(Math.random() * 8) + 3,
            'modal-avg-response-time': (Math.random() * 4 + 1).toFixed(1) + 'h'
        };

        Object.entries(mockStats).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });

        // Synchroniser depuis la sidebar
        syncStatsToModal();

        // Animation de confirmation
        const refreshBtn = document.querySelector('[onclick="refreshStatsModal()"]');
        if (refreshBtn) {
            const originalIcon = refreshBtn.querySelector('i').className;
            refreshBtn.querySelector('i').className = 'fa-solid fa-spinner fa-spin me-1';
            setTimeout(() => {
                refreshBtn.querySelector('i').className = originalIcon;
            }, 1000);
        }
    }

    // Exporter les statistiques
    function exportStats() {
        console.log('📊 Export des statistiques...');

        const stats = {
            'timestamp': new Date().toISOString(),
            'pending_work_orders': document.getElementById('modal-pending-work-orders')?.textContent || '--',
            'today_appointments': document.getElementById('modal-today-appointments')?.textContent || '--',
            'online_technicians': document.getElementById('modal-online-techs')?.textContent || '--',
            'monthly_revenue': document.getElementById('modal-monthly-revenue')?.textContent || '--',
            'total_work_orders': document.getElementById('modal-total-work-orders')?.textContent || '--',
            'completed_today': document.getElementById('modal-completed-today')?.textContent || '--',
            'in_progress': document.getElementById('modal-in-progress')?.textContent || '--',
            'avg_response_time': document.getElementById('modal-avg-response-time')?.textContent || '--'
        };

        // Créer un fichier JSON téléchargeable
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(stats, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `chronotech_stats_${new Date().toISOString().split('T')[0]}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    // === GESTION DU KANBAN BONS DE TRAVAIL ===

    // Charger les données des bons de travail pour la modal
    async function loadWorkOrdersModal() {
        try {
            console.log('📋 Chargement des données bons de travail pour modal...');

            // Essayer l'API standard d'abord
            let response = await fetch('/api/kanban-data');
            console.log('🔍 API Response status:', response.status, response.ok);

            if (!response.ok) {
                console.log('⚠️ API principale non disponible, utilisation des données de test...');

                // Fallback avec données test
                const testData = {
                    draft: [
                        { id: 1, claim_number: 'WO-001', customer_name: 'Entreprise Alpha', description: 'Installation système de sécurité - En phase de planification', priority: 'medium', created_at: '2025-01-20 10:00' },
                        { id: 2, claim_number: 'WO-007', customer_name: 'Société Beta', description: 'Devis pour maintenance préventive', priority: 'low', created_at: '2025-01-20 11:30' }
                    ],
                    pending: [
                        { id: 3, claim_number: 'WO-002', customer_name: 'Client Gamma', description: 'Réparation urgente climatisation bureau principal', priority: 'high', created_at: '2025-01-20 09:00' },
                        { id: 4, claim_number: 'WO-003', customer_name: 'Corp Delta', description: 'Panne électrique complète - Intervention immédiate requise', priority: 'urgent', created_at: '2025-01-20 08:00' },
                        { id: 5, claim_number: 'WO-008', customer_name: 'Magasin Epsilon', description: 'Installation nouvelle caisse enregistreuse', priority: 'medium', created_at: '2025-01-20 07:45' }
                    ],
                    assigned: [
                        { id: 6, claim_number: 'WO-004', customer_name: 'Restaurant Zeta', description: 'Maintenance équipement cuisine professionnelle', priority: 'medium', technician_name: 'Jean Dupont', created_at: '2025-01-20 07:00' },
                        { id: 7, claim_number: 'WO-009', customer_name: 'Hôtel Eta', description: 'Réparation ascenseur principal', priority: 'high', technician_name: 'Sophie Martin', created_at: '2025-01-20 06:30' }
                    ],
                    in_progress: [
                        { id: 8, claim_number: 'WO-005', customer_name: 'Bureau Theta', description: 'Migration serveur informatique en cours', priority: 'high', technician_name: 'Marie Martin', created_at: '2025-01-20 06:00' },
                        { id: 9, claim_number: 'WO-010', customer_name: 'Usine Iota', description: 'Calibrage machines de production', priority: 'urgent', technician_name: 'Pierre Durand', created_at: '2025-01-20 05:00' }
                    ],
                    completed: [
                        { id: 10, claim_number: 'WO-006', customer_name: 'Boutique Kappa', description: 'Installation éclairage LED terminée avec succès', priority: 'low', technician_name: 'Pierre Durand', created_at: '2025-01-19 15:00' },
                        { id: 11, claim_number: 'WO-011', customer_name: 'Cabinet Lambda', description: 'Mise en place réseau Wi-Fi sécurisé', priority: 'medium', technician_name: 'Luc Moreau', created_at: '2025-01-19 14:00' },
                        { id: 12, claim_number: 'WO-012', customer_name: 'Laboratoire Mu', description: 'Certification équipements scientifiques', priority: 'high', technician_name: 'Anne Dubois', created_at: '2025-01-19 13:00' }
                    ],
                    cancelled: [
                        { id: 13, claim_number: 'WO-013', customer_name: 'Projet Nu', description: 'Annulé - Client a reporté le projet', priority: 'low', created_at: '2025-01-19 12:00' }
                    ]
                };

                updateWorkOrdersModal(testData);
                updateWorkOrdersSummary(testData);
                loadModalFilterOptions(testData);
                return;
            }

            const data = await response.json();
            console.log('🔍 API Data received:', data);
            if (data.success && data.kanban_data) {
                console.log(`✅ ${data.total_count} bons de travail chargés pour modal`);
                console.log('🔍 Kanban data structure:', Object.keys(data.kanban_data));
                updateWorkOrdersModal(data.kanban_data);
                updateWorkOrdersSummary(data.kanban_data);
                loadModalFilterOptions(data.kanban_data);
            }

        } catch (error) {
            console.error('❌ Erreur chargement bons de travail modal:', error);
        }
    }

    // Mettre à jour la modal Kanban des bons de travail
    function updateWorkOrdersModal(data) {
        const statuses = ['draft', 'pending', 'assigned', 'in_progress', 'completed', 'cancelled'];

        statuses.forEach(status => {
            const column = document.getElementById(`modal-column-${status}`);
            const count = document.getElementById(`modal-count-${status}`);

            if (column && data[status]) {
                column.innerHTML = '';
                data[status].forEach(workOrder => {
                    const card = createWorkOrderKanbanCard(workOrder, status);
                    column.appendChild(card);
                });

                if (count) {
                    count.textContent = data[status].length;
                }

                console.log(`✅ Modal ${status}: ${data[status].length} bons de travail`);
            }
        });

        // Calculer et afficher les statistiques
        updateWorkOrdersStats(data);
    }

    // Mettre à jour le résumé des bons de travail dans la carte principale
    function updateWorkOrdersSummary(data) {
        console.log('📋 Mise à jour résumé bons de travail:', data);

        const summaryElements = {
            'summary-draft': data.draft?.length || 0,
            'summary-pending': data.pending?.length || 0,
            'summary-assigned': data.assigned?.length || 0,
            'summary-in_progress': data.in_progress?.length || 0,
            'summary-completed': data.completed?.length || 0,
            'summary-cancelled': data.cancelled?.length || 0
        };

        console.log('📊 Compteurs calculés:', summaryElements);

        Object.entries(summaryElements).forEach(([id, count]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = count;
                console.log(`✅ Mis à jour ${id}: ${count}`);
            } else {
                console.warn(`⚠️ Élément ${id} non trouvé`);
            }
        });
    }

    // Créer une carte bon de travail pour la modal Kanban
    function createWorkOrderKanbanCard(workOrder, status) {
        const card = document.createElement('div');
        card.className = `wo-kanban-card ${workOrder.priority === 'urgent' ? 'urgent-priority' : workOrder.priority === 'high' ? 'high-priority' : ''}`;
        card.draggable = true;
        card.dataset.cardId = workOrder.id;
        card.dataset.currentStatus = status;

        const priorityColor = {
            'low': 'info',
            'medium': 'warning',
            'high': 'warning',
            'urgent': 'danger'
        };

        const priorityText = {
            'low': 'Basse',
            'medium': 'Moyenne',
            'high': 'Haute',
            'urgent': 'Urgente'
        };

        const dept = workOrder.vehicle_department || workOrder.department_name || workOrder.department || workOrder.dept || '';
        const vehicleInfo = workOrder.vehicle_make && workOrder.vehicle_model ? 
            `${workOrder.vehicle_make} ${workOrder.vehicle_model}` : '';
        const vehicleDisplay = vehicleInfo && dept ? `${vehicleInfo} (${dept})` : 
                              vehicleInfo || dept || '';
        
        card.innerHTML = `
            <div class="wo-kanban-card-header">
                <h6 class="wo-kanban-card-title">#${workOrder.claim_number}</h6>
                <span class="badge bg-${priorityColor[workOrder.priority] || 'info'} wo-priority-badge">${priorityText[workOrder.priority] || workOrder.priority}</span>
            </div>
            <p class="wo-kanban-card-customer">${workOrder.customer_name}</p>
            <p class="wo-kanban-card-description">${workOrder.description || 'Aucune description'}</p>
            <div class="d-flex justify-content-between align-items-center mb-1 small text-muted">
                <span class="wo-kanban-card-vehicle" title="Véhicule et département">${vehicleDisplay}</span>
                <span class="wo-kanban-card-department" style="display:none;">${dept}</span>
                <span class="wo-kanban-card-date">${workOrder.created_at || ''}</span>
            </div>
            <div class="wo-kanban-card-footer">
                <span class="wo-kanban-card-technician">${workOrder.assigned_technician_name || workOrder.technician_name || 'Non assigné'}</span>
            </div>
        `;

        // Événements drag & drop
        card.addEventListener('dragstart', handleWorkOrderDragStart);
        card.addEventListener('dragend', handleWorkOrderDragEnd);

        // Événement click pour détails
        card.addEventListener('click', () => {
            showWorkOrderDetails(workOrder.id);
        });

        return card;
    }

    // Gérer le début du drag pour les bons de travail
    function handleWorkOrderDragStart(e) {
        e.dataTransfer.setData('text/plain', e.target.dataset.cardId);
        e.dataTransfer.setData('application/json', JSON.stringify({
            cardId: e.target.dataset.cardId,
            currentStatus: e.target.dataset.currentStatus
        }));

        e.target.classList.add('dragging');

        // Marquer les zones de drop valides
        document.querySelectorAll('.wo-kanban-content').forEach(zone => {
            zone.classList.add('drop-zone-active');
        });
    }

    // Gérer la fin du drag pour les bons de travail
    function handleWorkOrderDragEnd(e) {
        e.target.classList.remove('dragging');

        // Nettoyer les zones de drop
        document.querySelectorAll('.wo-kanban-content').forEach(zone => {
            zone.classList.remove('drop-zone-active', 'drag-over');
        });

        document.querySelectorAll('.wo-kanban-column').forEach(column => {
            column.classList.remove('drag-over');
        });
    }

    // Gérer le drop des bons de travail
    function handleWorkOrderDrop(e) {
        e.preventDefault();

        const dropZone = e.target.closest('.wo-kanban-content');
        const column = e.target.closest('.wo-kanban-column');

        if (dropZone && column) {
            const newStatus = column.dataset.status;

            try {
                const dragData = JSON.parse(e.dataTransfer.getData('application/json'));
                const cardId = dragData.cardId;
                const oldStatus = dragData.currentStatus;

                if (newStatus !== oldStatus) {
                    moveWorkOrderToModalStatus(cardId, oldStatus, newStatus);
                }
            } catch (error) {
                console.error('Erreur lors du drop:', error);
            }
        }

        // Nettoyer les styles de drag
        if (column) {
            column.classList.remove('drag-over');
        }
    }

    // Déplacer un bon de travail vers un nouveau statut dans la modal
    function moveWorkOrderToModalStatus(cardId, fromStatus, toStatus) {
        const fromColumn = document.getElementById(`modal-column-${fromStatus}`);
        const toColumn = document.getElementById(`modal-column-${toStatus}`);
        const fromCount = document.getElementById(`modal-count-${fromStatus}`);
        const toCount = document.getElementById(`modal-count-${toStatus}`);

        if (fromColumn && toColumn) {
            // Trouver la carte
            const card = fromColumn.querySelector(`[data-card-id="${cardId}"]`);
            if (card) {
                // Mettre à jour le statut de la carte
                card.dataset.currentStatus = toStatus;

                // Animation de changement
                card.classList.add('status-changed');
                setTimeout(() => {
                    card.classList.remove('status-changed');
                }, 300);

                // Déplacer la carte
                toColumn.appendChild(card);

                // Mettre à jour les compteurs
                if (fromCount) {
                    fromCount.textContent = parseInt(fromCount.textContent) - 1;
                }
                if (toCount) {
                    toCount.textContent = parseInt(toCount.textContent) + 1;
                }

                console.log(`✅ Bon de travail ${cardId} déplacé de ${fromStatus} vers ${toStatus}`);

                // Mettre à jour les statistiques
                updateWorkOrdersStatsAfterMove();

                // Mettre à jour le résumé dans la carte principale
                updateSummaryAfterMove();

                // Sauvegarder le changement (ici simulation)
                saveWorkOrderStatusChange(cardId, toStatus);
            }
        }
    }

    // Mettre à jour les statistiques des bons de travail
    function updateWorkOrdersStats(data) {
        const total = Object.values(data).reduce((sum, group) => sum + group.length, 0);
        const active = (data.pending?.length || 0) + (data.assigned?.length || 0) + (data.in_progress?.length || 0);
        const completed = data.completed?.length || 0;
        const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;

        const statsElements = {
            'total-work-orders': total,
            'active-work-orders': active,
            'completion-rate': completionRate + '%'
        };

        Object.entries(statsElements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });
    }

    // Mettre à jour les statistiques après un déplacement
    function updateWorkOrdersStatsAfterMove() {
        const counts = {};
        ['draft', 'pending', 'assigned', 'in_progress', 'completed', 'cancelled'].forEach(status => {
            const column = document.getElementById(`modal-column-${status}`);
            counts[status] = column ? column.children.length : 0;
        });

        const total = Object.values(counts).reduce((sum, count) => sum + count, 0);
        const active = counts.pending + counts.assigned + counts.in_progress;
        const completionRate = total > 0 ? Math.round((counts.completed / total) * 100) : 0;

        document.getElementById('total-work-orders').textContent = total;
        document.getElementById('active-work-orders').textContent = active;
        document.getElementById('completion-rate').textContent = completionRate + '%';
    }

    // Mettre à jour le résumé après un déplacement
    function updateSummaryAfterMove() {
        const counts = {};
        ['draft', 'pending', 'assigned', 'in_progress', 'completed', 'cancelled'].forEach(status => {
            const column = document.getElementById(`modal-column-${status}`);
            counts[status] = column ? column.children.length : 0;
        });

        // Mettre à jour le résumé dans la carte principale
        Object.entries(counts).forEach(([status, count]) => {
            const element = document.getElementById(`summary-${status}`);
            if (element) {
                element.textContent = count;
            }
        });
    }

    // Charger les options de filtres pour la modal
    function loadModalFilterOptions(data) {
        const clientSelect = document.getElementById('modal-kanban-filter-client');
        const techSelect = document.getElementById('modal-kanban-filter-tech');

        if (!clientSelect || !techSelect) return;

        // Extraire les clients, techniciens et départements uniques
        const clients = new Set();
        const technicians = new Set();
        const departments = new Set();

        Object.values(data).flat().forEach(workOrder => {
            if (workOrder.customer_name) clients.add(workOrder.customer_name);
            const techName = workOrder.assigned_technician_name || workOrder.technician_name;
            if (techName && techName !== 'Non assigné') {
                technicians.add(techName);
            }
            // Prioriser vehicle_department, puis les autres champs
            const dept = workOrder.vehicle_department || workOrder.department_name || workOrder.department || workOrder.dept || null;
            if (dept) {
                departments.add(dept);
            }
        });

        // Remplir le filtre clients
        clientSelect.innerHTML = '<option value="">Tous les clients</option>';
        Array.from(clients).sort().forEach(client => {
            const option = document.createElement('option');
            option.value = client;
            option.textContent = client;
            clientSelect.appendChild(option);
        });

        // Remplir le filtre techniciens
        techSelect.innerHTML = '<option value="">Tous les techniciens</option>';
        Array.from(technicians).sort().forEach(tech => {
            const option = document.createElement('option');
            option.value = tech;
            option.textContent = tech;
            techSelect.appendChild(option);
        });

        // Remplir le filtre départements
        const deptSelect = document.getElementById('modal-kanban-filter-department');
        if (deptSelect) {
            deptSelect.innerHTML = '<option value="">Tous les départements</option>';
            Array.from(departments).sort().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptSelect.appendChild(option);
            });
        }

        // Ajouter les événements de filtrage
        clientSelect.addEventListener('change', filterModalWorkOrders);
        techSelect.addEventListener('change', filterModalWorkOrders);
        if (deptSelect) deptSelect.addEventListener('change', filterModalWorkOrders);

        // Bouton reset
        const clearBtn = document.getElementById('modal-kanban-clear-filters');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                clientSelect.value = '';
                techSelect.value = '';
                if (deptSelect) deptSelect.value = '';
                filterModalWorkOrders();
            });
        }

        console.log(`✅ Filtres modal chargés: ${clients.size} clients, ${technicians.size} techniciens, ${departments.size} départements`);
    }

    // Filtrer les bons de travail dans la modal
    function filterModalWorkOrders() {
        const clientFilter = document.getElementById('modal-kanban-filter-client').value;
        const techFilter = document.getElementById('modal-kanban-filter-tech').value;
        const deptSelect = document.getElementById('modal-kanban-filter-department');
        const deptFilter = deptSelect ? deptSelect.value : '';

        console.log('🔍 Filtrage modal Kanban:', { client: clientFilter, tech: techFilter, department: deptFilter });

        const allCards = document.querySelectorAll('.wo-kanban-card');
        let visibleCount = 0;

        allCards.forEach(card => {
            const customerName = card.querySelector('.wo-kanban-card-customer').textContent;
            const technicianName = card.querySelector('.wo-kanban-card-technician').textContent;
            const deptEl = card.querySelector('.wo-kanban-card-department');
            const cardDept = deptEl ? deptEl.textContent : '';

            let showCard = true;

            // Filtre client
            if (clientFilter && !customerName.toLowerCase().includes(clientFilter.toLowerCase())) {
                showCard = false;
            }

            // Filtre technicien
            if (techFilter && !technicianName.toLowerCase().includes(techFilter.toLowerCase())) {
                showCard = false;
            }

            // Filtre département
            if (deptFilter && (!cardDept || cardDept.toLowerCase() !== deptFilter.toLowerCase())) {
                showCard = false;
            }

            if (showCard) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        console.log(`✅ Filtrage modal terminé: ${visibleCount} cartes visibles`);
    }

    // Sauvegarder le changement de statut d'un bon de travail
    function saveWorkOrderStatusChange(cardId, newStatus) {
        console.log(`💾 Sauvegarde: Bon de travail ${cardId} -> ${newStatus}`);

        // Affichage de feedback immédiat
        const card = document.querySelector(`[data-card-id="${cardId}"]`);
        if (card) {
            card.style.opacity = '0.6';
            card.style.transform = 'scale(0.98)';
        }

        // Appel API pour sauvegarder en base
        fetch(`/api/work-orders/${cardId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                status: newStatus
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`✅ Statut sauvegardé: WO-${cardId} -> ${newStatus}`);

                // Feedback visuel de succès
                if (card) {
                    card.style.opacity = '1';
                    card.style.transform = 'scale(1)';
                    card.style.border = '2px solid #28a745';

                    setTimeout(() => {
                        card.style.border = '';
                    }, 2000);
                }

                // Mettre à jour les compteurs
                updateWorkOrdersStats();

                // Toast de succès
                showToast(`✅ Bon de travail #${cardId} déplacé vers ${newStatus}`, 'success');
            })
            .catch(error => {
                console.error(`❌ Erreur sauvegarde WO-${cardId}:`, error);

                // Feedback visuel d'erreur
                if (card) {
                    card.style.opacity = '1';
                    card.style.transform = 'scale(1)';
                    card.style.border = '2px solid #dc3545';

                    // Revenir à la colonne précédente en cas d'erreur
                    // TODO: Implémenter le rollback

                    setTimeout(() => {
                        card.style.border = '';
                    }, 3000);
                }

                // Affichage détaillé de l'erreur pour le debugging
                let errorMessage = `❌ Erreur: Impossible de déplacer le bon de travail #${cardId}`;
                if (error.message && error.message.includes('HTTP')) {
                    errorMessage += ` (${error.message})`;
                }
                
                // Log de l'erreur complète pour le debugging
                console.error('Détails erreur API:', {
                    cardId: cardId,
                    newStatus: newStatus,
                    error: error,
                    timestamp: new Date().toISOString()
                });

                // Toast d'erreur
                showToast(errorMessage, 'error');
            });
    }

    // Fonction utilitaire pour afficher des notifications toast
    function showToast(message, type = 'info') {
        // Créer le toast
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        `;

        // Couleurs selon le type
        switch (type) {
            case 'success':
                toast.style.backgroundColor = '#28a745';
                break;
            case 'error':
                toast.style.backgroundColor = '#dc3545';
                break;
            case 'warning':
                toast.style.backgroundColor = '#ffc107';
                toast.style.color = '#000';
                break;
            default:
                toast.style.backgroundColor = '#17a2b8';
        }

        toast.innerHTML = message;
        document.body.appendChild(toast);

        // Animation d'apparition
        setTimeout(() => {
            toast.style.transform = 'translateX(0)';
        }, 100);

        // Suppression automatique
        setTimeout(() => {
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 4000);

        // Clic pour fermer
        toast.addEventListener('click', () => {
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        });
    }

    // Sauvegarder tous les statuts des bons de travail
    function saveWorkOrdersStatus() {
        console.log('💾 Sauvegarde globale des statuts bons de travail...');

        const statusData = {};
        ['draft', 'pending', 'assigned', 'in_progress', 'completed', 'cancelled'].forEach(status => {
            const column = document.getElementById(`modal-column-${status}`);
            if (column) {
                statusData[status] = Array.from(column.children).map(card =>
                    parseInt(card.dataset.cardId)
                );
            }
        });

        console.log('Nouveaux statuts bons de travail:', statusData);

        // Animation de confirmation
        const saveBtn = document.querySelector('[onclick="saveWorkOrdersStatus()"]');
        if (saveBtn) {
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>Sauvegarde...';
            saveBtn.disabled = true;

            setTimeout(() => {
                saveBtn.innerHTML = '<i class="fa-solid fa-check me-1"></i>Sauvegardé !';
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }, 1000);
            }, 1500);
        }
    }

    // Actualiser les bons de travail
    function refreshWorkOrders() {
        console.log('🔄 Actualisation des bons de travail...');
        loadWorkOrdersModal();

        // Animation du bouton
        const refreshBtn = document.querySelector('[onclick="refreshWorkOrders()"]');
        if (refreshBtn) {
            const icon = refreshBtn.querySelector('i');
            const originalClass = icon.className;
            icon.className = 'fa-solid fa-spinner fa-spin me-1';

            setTimeout(() => {
                icon.className = originalClass;
            }, 1000);
        }
    }

    // === ÉVÉNEMENTS DRAG & DROP POUR LES BONS DE TRAVAIL ===

    // Initialiser les événements drag & drop pour la modal des bons de travail
    function initWorkOrdersDragDropEvents() {
        const workOrderColumns = document.querySelectorAll('.wo-kanban-column .wo-kanban-content');

        workOrderColumns.forEach(content => {
            content.addEventListener('dragover', (e) => {
                e.preventDefault();
                const column = e.target.closest('.wo-kanban-column');
                if (column) {
                    column.classList.add('drag-over');
                }
            });

            content.addEventListener('dragleave', (e) => {
                // Vérifier si on quitte vraiment la zone
                if (!e.currentTarget.contains(e.relatedTarget)) {
                    const column = e.target.closest('.wo-kanban-column');
                    if (column) {
                        column.classList.remove('drag-over');
                    }
                }
            });

            content.addEventListener('drop', handleWorkOrderDrop);
        });

        console.log('✅ Événements drag & drop bons de travail initialisés');
    }

    // Fonction pour afficher les détails d'un bon de travail
    function showWorkOrderDetails(workOrderId) {
        console.log(`📋 Affichage détails bon de travail: ${workOrderId}`);

        // Charger les données du bon de travail
        loadWorkOrderDetails(workOrderId);

        // Afficher la modal
        const detailsModal = new bootstrap.Modal(document.getElementById('workOrderDetailsModal'));
        detailsModal.show();
    }

    // Charger les détails d'un bon de travail
    async function loadWorkOrderDetails(workOrderId) {
        try {
            console.log(`🔍 Chargement détails pour WO ${workOrderId}...`);

            // Essayer l'API standard d'abord
            let response = await fetch(`/api/work-orders/${workOrderId}`);

            if (!response.ok) {
                console.log('⚠️ API détails non disponible, utilisation des données de test...');

                // Fallback avec données test détaillées
                const testWorkOrder = generateTestWorkOrderDetails(workOrderId);
                updateWorkOrderDetailsModal(testWorkOrder);
                return;
            }

            const data = await response.json();
            if (data.success && data.work_order) {
                console.log(`✅ Détails WO ${workOrderId} chargés`);
                updateWorkOrderDetailsModal(data.work_order);
            }

        } catch (error) {
            console.error('❌ Erreur chargement détails WO:', error);
            // Fallback avec données test
            const testWorkOrder = generateTestWorkOrderDetails(workOrderId);
            updateWorkOrderDetailsModal(testWorkOrder);
        }
    }

    // Générer des données de test détaillées pour un bon de travail
    function generateTestWorkOrderDetails(workOrderId) {
        const testData = {
            1: {
                id: 1,
                claim_number: 'WO-001',
                customer_name: 'Entreprise Alpha',
                description: 'Installation système de sécurité - Mise en place d\'un système de sécurité complet avec caméras de surveillance, détecteurs de mouvement et central d\'alarme.',
                status: 'draft',
                priority: 'medium',
                technician_name: null,
                created_at: '2025-01-20 10:00:00',
                updated_at: '2025-01-20 10:15:00',
                scheduled_date: '2025-01-25 09:00:00',
                estimated_duration: '6h 30m',
                time_spent: '0h 0m',
                progress: 0,
                deadline: '2025-01-30 17:00:00',
                quote_amount: 2500.00,
                materials_cost: 1200.00,
                labor_cost: 800.00,
                total_amount: 2500.00,
                invoice_status: 'not_invoiced',
                notes: 'Client souhaite une installation discrète. Prévoir visite de reconnaissance avant intervention.',
                instructions: 'Accès par l\'entrée principale. Contact M. Durand au 06.12.34.56.78',
                activities: [
                    { date: '2025-01-20 10:00', action: 'Création du bon de travail', user: 'Admin', details: 'Demande initiale du client' },
                    { date: '2025-01-20 10:15', action: 'Ajout description détaillée', user: 'Admin', details: 'Spécifications techniques précisées' }
                ]
            },
            8: {
                id: 8,
                claim_number: 'WO-005',
                customer_name: 'Bureau Theta',
                description: 'Migration serveur informatique - Migration complète du serveur de fichiers vers une nouvelle infrastructure cloud avec sauvegarde des données.',
                status: 'in_progress',
                priority: 'high',
                technician_name: 'Marie Martin',
                created_at: '2025-01-20 06:00:00',
                updated_at: '2025-01-20 14:30:00',
                scheduled_date: '2025-01-20 08:00:00',
                estimated_duration: '8h 0m',
                time_spent: '5h 30m',
                progress: 70,
                deadline: '2025-01-21 18:00:00',
                quote_amount: 4500.00,
                materials_cost: 2000.00,
                labor_cost: 2000.00,
                total_amount: 4500.00,
                invoice_status: 'pending',
                notes: 'Migration en cours. Sauvegarde terminée. Phase de test en cours.',
                instructions: 'Intervention durant les heures ouvrées uniquement. Prévoir interruption de service minimale.',
                activities: [
                    { date: '2025-01-20 06:00', action: 'Création du bon de travail', user: 'Admin', details: 'Demande urgente du client' },
                    { date: '2025-01-20 08:00', action: 'Début intervention', user: 'Marie Martin', details: 'Début des opérations de migration' },
                    { date: '2025-01-20 11:30', action: 'Sauvegarde terminée', user: 'Marie Martin', details: 'Toutes les données sauvegardées' },
                    { date: '2025-01-20 14:30', action: 'Tests en cours', user: 'Marie Martin', details: 'Phase de validation des données migrées' }
                ]
            }
        };

        // Retourner les données spécifiques ou des données par défaut
        return testData[workOrderId] || {
            id: workOrderId,
            claim_number: `WO-${String(workOrderId).padStart(3, '0')}`,
            customer_name: 'Client Test',
            description: 'Description test pour le bon de travail',
            status: 'pending',
            priority: 'medium',
            technician_name: null,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            scheduled_date: null,
            estimated_duration: '2h 0m',
            time_spent: '0h 0m',
            progress: 0,
            deadline: null,
            quote_amount: 500.00,
            materials_cost: 200.00,
            labor_cost: 200.00,
            total_amount: 500.00,
            invoice_status: 'not_invoiced',
            notes: 'Notes par défaut',
            instructions: 'Instructions par défaut',
            activities: [
                { date: new Date().toISOString(), action: 'Création du bon de travail', user: 'Admin', details: 'Bon de travail créé' }
            ]
        };
    }

    // Mettre à jour la modal des détails du bon de travail
    function updateWorkOrderDetailsModal(workOrder) {
        // Informations principales
        document.getElementById('modal-work-order-number').textContent = `#${workOrder.claim_number}`;
        document.getElementById('detail-claim-number').textContent = `#${workOrder.claim_number}`;
        document.getElementById('detail-customer-name').textContent = workOrder.customer_name;
        document.getElementById('detail-technician').textContent = workOrder.technician_name || 'Non assigné';
        document.getElementById('detail-created-date').textContent = formatDateTime(workOrder.created_at);
        document.getElementById('detail-updated-date').textContent = formatDateTime(workOrder.updated_at);

        // Statuts avec badges colorés
        updateStatusBadge('detail-status-badge', workOrder.status);
        updatePriorityBadge('detail-priority-badge', workOrder.priority);

        // Description et notes
        document.getElementById('detail-description').textContent = workOrder.description || 'Aucune description';
        document.getElementById('detail-notes').textContent = workOrder.notes || 'Aucune note';
        document.getElementById('detail-instructions').textContent = workOrder.instructions || 'Aucune instruction';

        // Planning et temps
        document.getElementById('detail-scheduled-date').textContent = workOrder.scheduled_date ? formatDateTime(workOrder.scheduled_date) : 'Non planifié';
        document.getElementById('detail-estimated-duration').textContent = workOrder.estimated_duration || '-';
        document.getElementById('detail-time-spent').textContent = workOrder.time_spent || '0h 0m';
        document.getElementById('detail-deadline').textContent = workOrder.deadline ? formatDateTime(workOrder.deadline) : 'Non définie';

        // Progression
        const progressBar = document.getElementById('detail-progress-bar');
        const progressText = document.getElementById('detail-progress-text');
        const progress = workOrder.progress || 0;
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        progressText.textContent = `${progress}%`;

        // Couleur de la barre de progression
        progressBar.className = 'progress-bar';
        if (progress < 25) {
            progressBar.classList.add('bg-danger');
        } else if (progress < 50) {
            progressBar.classList.add('bg-warning');
        } else if (progress < 75) {
            progressBar.classList.add('bg-info');
        } else {
            progressBar.classList.add('bg-success');
        }

        // Informations financières
        document.getElementById('detail-quote-amount').textContent = formatCurrency(workOrder.quote_amount);
        document.getElementById('detail-materials-cost').textContent = formatCurrency(workOrder.materials_cost);
        document.getElementById('detail-labor-cost').textContent = formatCurrency(workOrder.labor_cost);
        document.getElementById('detail-total-amount').textContent = formatCurrency(workOrder.total_amount);
        updateInvoiceStatusBadge('detail-invoice-status', workOrder.invoice_status);

        // Historique des activités
        updateActivityTimeline(workOrder.activities || []);

        console.log(`✅ Modal détails mise à jour pour WO ${workOrder.id}`);
    }

    // Mettre à jour le badge de statut
    function updateStatusBadge(elementId, status) {
        const badge = document.getElementById(elementId);
        const statusConfig = {
            'draft': { text: 'Brouillon', class: 'bg-secondary' },
            'pending': { text: 'En attente', class: 'bg-warning text-dark' },
            'assigned': { text: 'Assigné', class: 'bg-info' },
            'in_progress': { text: 'En cours', class: 'bg-primary' },
            'completed': { text: 'Terminé', class: 'bg-success' },
            'cancelled': { text: 'Annulé', class: 'bg-danger' }
        };

        const config = statusConfig[status] || { text: status, class: 'bg-secondary' };
        badge.textContent = config.text;
        badge.className = `badge ${config.class}`;
    }

    // Mettre à jour le badge de priorité
    function updatePriorityBadge(elementId, priority) {
        const badge = document.getElementById(elementId);
        const priorityConfig = {
            'low': { text: 'Basse', class: 'bg-info' },
            'medium': { text: 'Moyenne', class: 'bg-warning text-dark' },
            'high': { text: 'Haute', class: 'bg-warning' },
            'urgent': { text: 'Urgente', class: 'bg-danger' }
        };

        const config = priorityConfig[priority] || { text: priority, class: 'bg-secondary' };
        badge.textContent = config.text;
        badge.className = `badge ${config.class}`;
    }

    // Mettre à jour le badge de statut de facturation
    function updateInvoiceStatusBadge(elementId, invoiceStatus) {
        const badge = document.getElementById(elementId);
        const statusConfig = {
            'not_invoiced': { text: 'Non facturé', class: 'bg-secondary' },
            'pending': { text: 'En attente', class: 'bg-warning text-dark' },
            'sent': { text: 'Envoyée', class: 'bg-info' },
            'paid': { text: 'Payée', class: 'bg-success' },
            'overdue': { text: 'Échue', class: 'bg-danger' }
        };

        const config = statusConfig[invoiceStatus] || { text: invoiceStatus, class: 'bg-secondary' };
        badge.textContent = config.text;
        badge.className = `badge ${config.class}`;
    }

    // Mettre à jour la timeline des activités
    function updateActivityTimeline(activities) {
        const timeline = document.getElementById('detail-activity-timeline');
        timeline.innerHTML = '';

        if (!activities || activities.length === 0) {
            timeline.innerHTML = '<p class="text-muted">Aucune activité enregistrée</p>';
            return;
        }

        activities.forEach((activity, index) => {
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item d-flex mb-3';

            timelineItem.innerHTML = `
                <div class="timeline-marker bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; min-width: 40px;">
                    <i class="fa-solid fa-circle text-white" style="font-size: 8px;"></i>
                </div>
                <div class="timeline-content flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <strong>${activity.action}</strong>
                        <small class="text-muted">${formatDateTime(activity.date)}</small>
                    </div>
                    <p class="mb-1 text-muted">${activity.details}</p>
                    <small class="text-primary">Par: ${activity.user}</small>
                </div>
            `;

            timeline.appendChild(timelineItem);
        });
    }

    // Formater une date/heure
    function formatDateTime(dateString) {
        if (!dateString) return '-';

        try {
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            return dateString;
        }
    }

    // Formater une devise
    function formatCurrency(amount) {
        if (amount === null || amount === undefined) return '0,00 €';

        try {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        } catch (error) {
            return `${amount} €`;
        }
    }

    // Fonctions d'actions pour la modal de détails
    function editWorkOrder() {
        console.log('✏️ Modification du bon de travail...');
        // Ici on pourrait ouvrir une modal d'édition
        alert('Fonctionnalité d\'édition à implémenter');
    }

    function printWorkOrder() {
        console.log('🖨️ Impression du bon de travail...');
        window.print();
    }

    function exportWorkOrderPDF() {
        console.log('📄 Export PDF du bon de travail...');
        alert('Fonctionnalité d\'export PDF à implémenter');
    }

    function assignTechnician() {
        console.log('👷 Assignation technicien...');
        alert('Fonctionnalité d\'assignation à implémenter');
    }

    function addTimeEntry() {
        console.log('⏰ Ajout entrée temps...');
        alert('Fonctionnalité d\'ajout de temps à implémenter');
    }

    function addNote() {
        console.log('📝 Ajout note...');
        alert('Fonctionnalité d\'ajout de note à implémenter');
    }

    function updateWorkOrderStatus() {
        console.log('💾 Mise à jour statut bon de travail...');
        alert('Fonctionnalité de mise à jour à implémenter');
    }

    // Fonction utilitaire pour ouvrir la modal de détails depuis n'importe où
    window.openWorkOrderDetails = function (workOrderId) {
        showWorkOrderDetails(workOrderId);
    };

    // Fonction pour fermer la modal de détails
    window.closeWorkOrderDetails = function () {
        const modal = bootstrap.Modal.getInstance(document.getElementById('workOrderDetailsModal'));
        if (modal) {
            modal.hide();
        }
    };

    // Fonction pour naviguer entre les bons de travail (précédent/suivant)
    window.navigateWorkOrder = function (direction) {
        console.log(`🔄 Navigation ${direction} vers autre bon de travail...`);
        // À implémenter : logique de navigation
        alert(`Navigation ${direction} à implémenter`);
    };

    // Fonction globale pour recharger toutes les données du dashboard
    window.refreshDashboardData = function () {
        console.log('🔄 Rechargement forcé de toutes les données du dashboard...');

        try {
            // Recharger les techniciens
            loadTechniciansData();

            // Recharger les bons de travail
            loadWorkOrdersModal();

            // Recharger le Gantt (avec délai pour s'assurer que la fonction est définie)
            setTimeout(() => {
                if (typeof loadGanttData === 'function') {
                    loadGanttData();
                } else {
                    console.warn('⚠️ loadGanttData() n\'est pas encore définie - elle sera définie plus bas dans le script');
                }
            }, 500);

            console.log('✅ Toutes les données rechargées avec succès');
        } catch (error) {
            console.error('❌ Erreur lors du rechargement:', error);
        }
    };

    // Fonction de debug pour vérifier la présence des éléments
    window.debugDashboardElements = function () {
        console.log('🔍 Vérification des éléments du dashboard:');

        // Vérifier les éléments de résumé des bons de travail
        const woElements = ['summary-draft', 'summary-pending', 'summary-assigned', 'summary-in_progress', 'summary-completed', 'summary-cancelled'];
        woElements.forEach(id => {
            const element = document.getElementById(id);
            console.log(`📋 ${id}: ${element ? '✅ Trouvé' : '❌ Manquant'}`);
        });

        // Vérifier les éléments de résumé des techniciens
        const techElements = ['summary-available', 'summary-busy', 'summary-break', 'summary-offline'];
        techElements.forEach(id => {
            const element = document.getElementById(id);
            console.log(`👷 ${id}: ${element ? '✅ Trouvé' : '❌ Manquant'}`);
        });
    };

    // Démarrer le debug automatiquement en développement
    setTimeout(() => {
        window.debugDashboardElements();
        window.refreshDashboardData();
    }, 1000);

    // === GESTION DU KANBAN TECHNICIENS ===

    // Charger les données des techniciens
    async function loadTechniciansData() {
        try {
            console.log('👷 Chargement des données techniciens...');

            // Données d'exemple pour les techniciens
            const techniciansData = {
                available: [
                    { id: 1, name: 'Jean Dupont', role: 'Électricien', avatar: 'JD', workload: 2, skills: ['Électricité', 'Dépannage'] },
                    { id: 2, name: 'Sophie Martin', role: 'Plombier', avatar: 'SM', workload: 1, skills: ['Plomberie', 'Chauffage'] },
                    { id: 3, name: 'Luc Moreau', role: 'Informatique', avatar: 'LM', workload: 0, skills: ['Réseaux', 'Sécurité'] }
                ],
                busy: [
                    { id: 4, name: 'Marie Martin', role: 'Électricien', avatar: 'MM', workload: 5, current_task: 'WO-005', skills: ['Électricité', 'Automation'] },
                    { id: 5, name: 'Pierre Durand', role: 'Mécanicien', avatar: 'PD', workload: 3, current_task: 'WO-010', skills: ['Mécanique', 'Hydraulique'] }
                ],
                break: [
                    { id: 6, name: 'Anne Dubois', role: 'Climatisation', avatar: 'AD', workload: 2, break_until: '14:30', skills: ['Climatisation', 'Frigorifique'] }
                ],
                offline: [
                    { id: 7, name: 'Paul Rousseau', role: 'Électricien', avatar: 'PR', workload: 0, last_seen: '12:45', skills: ['Électricité', 'Éclairage'] },
                    { id: 8, name: 'Claire Bernard', role: 'Plombier', avatar: 'CB', workload: 1, last_seen: 'Hier', skills: ['Plomberie', 'Sanitaire'] }
                ]
            };

            updateTechnicianColumns(techniciansData);
            updateTechnicianModal(techniciansData);
            updateTechniciansSummary(techniciansData);

        } catch (error) {
            console.error('❌ Erreur chargement techniciens:', error);
        }
    }

    // Mettre à jour les colonnes des techniciens (ancienne version - maintenant utilisée pour le résumé)
    function updateTechnicianColumns(data) {
        // Cette fonction est maintenant utilisée pour d'autres intégrations si nécessaire
        console.log('📊 Données techniciens chargées pour intégration');
    }

    // Mettre à jour la modal Kanban des techniciens
    function updateTechnicianModal(data) {
        const statuses = ['available', 'busy', 'break', 'offline'];

        statuses.forEach(status => {
            const column = document.getElementById(`modal-tech-${status}`);
            const count = document.getElementById(`modal-count-${status}`);

            if (column && data[status]) {
                column.innerHTML = '';
                data[status].forEach(technician => {
                    const card = createTechnicianKanbanCard(technician, status);
                    column.appendChild(card);
                });

                if (count) {
                    count.textContent = data[status].length;
                }

                console.log(`✅ Modal ${status}: ${data[status].length} techniciens`);
            }
        });

        // Calculer et afficher les statistiques
        updateTechnicianStats(data);
    }

    // Mettre à jour le résumé des techniciens dans la carte principale
    function updateTechniciansSummary(data) {
        console.log('👷 Mise à jour résumé techniciens:', data);

        const summaryElements = {
            'summary-available': data.available?.length || 0,
            'summary-busy': data.busy?.length || 0,
            'summary-break': data.break?.length || 0,
            'summary-offline': data.offline?.length || 0
        };

        console.log('👥 Compteurs techniciens calculés:', summaryElements);

        Object.entries(summaryElements).forEach(([id, count]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = count;
                console.log(`✅ Mis à jour ${id}: ${count}`);
            } else {
                console.warn(`⚠️ Élément technicien ${id} non trouvé`);
            }
        });
    }

    // Créer une carte technicien pour la modal Kanban
    function createTechnicianKanbanCard(tech, status) {
        const card = document.createElement('div');
        card.className = 'tech-kanban-card';
        card.draggable = true;
        card.dataset.techId = tech.id;
        card.dataset.currentStatus = status;

        let extraInfo = '';
        let statusIndicator = `<span class="tech-kanban-status-indicator ${status}"></span>`;

        if (status === 'busy' && tech.current_task) {
            extraInfo = `
                <div class="tech-kanban-details">
                    <strong>Tâche:</strong> ${tech.current_task}<br>
                    <strong>Charge:</strong> ${tech.workload} tâches
                </div>
            `;
        } else if (status === 'break' && tech.break_until) {
            extraInfo = `
                <div class="tech-kanban-details">
                    <strong>Retour prévu:</strong> ${tech.break_until}<br>
                    <strong>Charge:</strong> ${tech.workload} tâches
                </div>
            `;
        } else if (status === 'offline' && tech.last_seen) {
            extraInfo = `
                <div class="tech-kanban-details">
                    <strong>Dernière connexion:</strong> ${tech.last_seen}<br>
                    <strong>Charge:</strong> ${tech.workload} tâches
                </div>
            `;
        } else if (status === 'available') {
            extraInfo = `
                <div class="tech-kanban-details">
                    <strong>Disponible pour:</strong> nouvelles tâches<br>
                    <strong>Charge actuelle:</strong> ${tech.workload} tâches
                </div>
            `;
        }

        const skillsHtml = tech.skills ?
            `<div class="mt-2">
                ${tech.skills.map(skill => `<span class="badge bg-light text-dark me-1">${skill}</span>`).join('')}
            </div>` : '';

        card.innerHTML = `
            <div class="tech-kanban-avatar">${tech.avatar}</div>
            <div class="tech-kanban-info">
                <div class="tech-kanban-name">${statusIndicator}${tech.name}</div>
                <div class="tech-kanban-role">${tech.role}</div>
                ${extraInfo}
                ${skillsHtml}
            </div>
        `;

        // Événements drag & drop
        card.addEventListener('dragstart', handleTechDragStart);
        card.addEventListener('dragend', handleTechDragEnd);

        // Événement click pour détails
        card.addEventListener('click', () => {
            showTechnicianDetails(tech.id);
        });

        return card;
    }

    // Gérer le début du drag
    function handleTechDragStart(e) {
        e.dataTransfer.setData('text/plain', e.target.dataset.techId);
        e.dataTransfer.setData('application/json', JSON.stringify({
            techId: e.target.dataset.techId,
            currentStatus: e.target.dataset.currentStatus
        }));

        e.target.classList.add('dragging');

        // Marquer les zones de drop valides
        document.querySelectorAll('.tech-kanban-content').forEach(zone => {
            zone.classList.add('drop-zone-active');
        });
    }

    // Gérer la fin du drag
    function handleTechDragEnd(e) {
        e.target.classList.remove('dragging');

        // Nettoyer les zones de drop
        document.querySelectorAll('.tech-kanban-content').forEach(zone => {
            zone.classList.remove('drop-zone-active', 'drag-over');
        });

        document.querySelectorAll('.tech-kanban-column').forEach(column => {
            column.classList.remove('drag-over');
        });
    }

    // Gérer le drop des techniciens
    function handleTechDrop(e) {
        e.preventDefault();

        const dropZone = e.target.closest('.tech-kanban-content');
        const column = e.target.closest('.tech-kanban-column');

        if (dropZone && column) {
            const newStatus = column.dataset.status;

            try {
                const dragData = JSON.parse(e.dataTransfer.getData('application/json'));
                const techId = dragData.techId;
                const oldStatus = dragData.currentStatus;

                if (newStatus !== oldStatus) {
                    moveTechnicianToStatus(techId, oldStatus, newStatus);
                }
            } catch (error) {
                console.error('Erreur lors du drop:', error);
            }
        }

        // Nettoyer les styles de drag
        column.classList.remove('drag-over');
    }

    // Déplacer un technicien vers un nouveau statut
    function moveTechnicianToStatus(techId, fromStatus, toStatus) {
        const fromColumn = document.getElementById(`modal-tech-${fromStatus}`);
        const toColumn = document.getElementById(`modal-tech-${toStatus}`);
        const fromCount = document.getElementById(`modal-count-${fromStatus}`);
        const toCount = document.getElementById(`modal-count-${toStatus}`);

        if (fromColumn && toColumn) {
            // Trouver la carte
            const card = fromColumn.querySelector(`[data-tech-id="${techId}"]`);
            if (card) {
                // Mettre à jour le statut de la carte
                card.dataset.currentStatus = toStatus;

                // Animation de changement
                card.classList.add('status-changed');
                setTimeout(() => {
                    card.classList.remove('status-changed');
                }, 300);

                // Mettre à jour l'indicateur de statut
                const statusIndicator = card.querySelector('.tech-kanban-status-indicator');
                if (statusIndicator) {
                    statusIndicator.className = `tech-kanban-status-indicator ${toStatus}`;
                }

                // Déplacer la carte
                toColumn.appendChild(card);

                // Mettre à jour les compteurs
                if (fromCount) {
                    fromCount.textContent = parseInt(fromCount.textContent) - 1;
                }
                if (toCount) {
                    toCount.textContent = parseInt(toCount.textContent) + 1;
                }

                console.log(`✅ Technicien ${techId} déplacé de ${fromStatus} vers ${toStatus}`);

                // Mettre à jour les statistiques
                updateTechnicianStatsAfterMove();

                // Sauvegarder le changement (ici simulation)
                saveTechnicianStatusChange(techId, toStatus);
            }
        }
    }

    // Mettre à jour les statistiques des techniciens
    function updateTechnicianStats(data) {
        const total = Object.values(data).reduce((sum, group) => sum + group.length, 0);
        const active = (data.available?.length || 0) + (data.busy?.length || 0);
        const efficiency = total > 0 ? Math.round((active / total) * 100) : 0;

        const statsElements = {
            'total-technicians': total,
            'active-technicians': active,
            'team-efficiency': efficiency + '%'
        };

        Object.entries(statsElements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });
    }

    // Mettre à jour les statistiques après un déplacement
    function updateTechnicianStatsAfterMove() {
        const counts = {};
        ['available', 'busy', 'break', 'offline'].forEach(status => {
            const column = document.getElementById(`modal-tech-${status}`);
            counts[status] = column ? column.children.length : 0;
        });

        const total = Object.values(counts).reduce((sum, count) => sum + count, 0);
        const active = counts.available + counts.busy;
        const efficiency = total > 0 ? Math.round((active / total) * 100) : 0;

        document.getElementById('total-technicians').textContent = total;
        document.getElementById('active-technicians').textContent = active;
        document.getElementById('team-efficiency').textContent = efficiency + '%';

        // Mettre à jour le résumé dans la carte principale
        document.getElementById('summary-available').textContent = counts.available;
        document.getElementById('summary-busy').textContent = counts.busy;
        document.getElementById('summary-break').textContent = counts.break;
        document.getElementById('summary-offline').textContent = counts.offline;
    }

    // Sauvegarder le changement de statut d'un technicien
    function saveTechnicianStatusChange(techId, newStatus) {
        console.log(`💾 Sauvegarde: Technicien ${techId} -> ${newStatus}`);

        // Ici on ferait un appel API pour sauvegarder en base
        // fetch('/api/technicians/update-status', {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify({ techId, status: newStatus })
        // });
    }

    // Sauvegarder tous les statuts des techniciens
    function saveTechniciansStatus() {
        console.log('💾 Sauvegarde globale des statuts techniciens...');

        const statusData = {};
        ['available', 'busy', 'break', 'offline'].forEach(status => {
            const column = document.getElementById(`modal-tech-${status}`);
            if (column) {
                statusData[status] = Array.from(column.children).map(card =>
                    parseInt(card.dataset.techId)
                );
            }
        });

        console.log('Nouveaux statuts:', statusData);

        // Animation de confirmation
        const saveBtn = document.querySelector('[onclick="saveTechniciansStatus()"]');
        if (saveBtn) {
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>Sauvegarde...';
            saveBtn.disabled = true;

            setTimeout(() => {
                saveBtn.innerHTML = '<i class="fa-solid fa-check me-1"></i>Sauvegardé !';
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }, 1000);
            }, 1500);
        }
    }

    // Afficher les détails d'un technicien
    function showTechnicianDetails(techId) {
        console.log(`👷 Affichage détails technicien ${techId}`);
        // Ici on pourrait ouvrir une modal avec les détails du technicien
        // ou rediriger vers une page de profil
    }

    // Actualiser les techniciens
    function refreshTechnicians() {
        console.log('🔄 Actualisation des techniciens...');
        loadTechniciansData();

        // Animation du bouton
        const refreshBtn = document.querySelector('[onclick="refreshTechnicians()"]');
        if (refreshBtn) {
            const icon = refreshBtn.querySelector('i');
            const originalClass = icon.className;
            icon.className = 'fa-solid fa-spinner fa-spin me-1';

            setTimeout(() => {
                icon.className = originalClass;
            }, 1000);
        }
    }

    // Ajouter un technicien
    function addTechnician() {
        console.log('➕ Ajout d\'un technicien...');
        // Ici on pourrait ouvrir une modal pour ajouter un technicien
    }

    // Gérer les événements de drag over pour les colonnes
    document.addEventListener('DOMContentLoaded', function () {
        // Ajouter les événements dragover pour les colonnes
        document.querySelectorAll('.tech-kanban-column').forEach(column => {
            column.addEventListener('dragover', function (e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });

            column.addEventListener('dragleave', function (e) {
                if (!this.contains(e.relatedTarget)) {
                    this.classList.remove('drag-over');
                }
            });
        });

        // Charger les données au démarrage et quand la modal s'ouvre
        const techModal = document.getElementById('techniciansKanbanModal');
        if (techModal) {
            techModal.addEventListener('show.bs.modal', function () {
                loadTechniciansData();
            });
        }

        // Initialiser les événements pour la modal des bons de travail
        const workOrderModal = document.getElementById('workOrdersKanbanModal');
        if (workOrderModal) {
            workOrderModal.addEventListener('show.bs.modal', function () {
                loadWorkOrdersModal();
                // Attendre que la modal soit affichée pour initialiser les événements
                setTimeout(() => {
                    initWorkOrdersDragDropEvents();
                }, 100);
            });
        }

        // ==========================================
        // VARIABLES GLOBALES POUR DÉTAILS WORK ORDER
        // ==========================================
        let currentWorkOrderId = null;
        let currentWorkOrderData = null;

        // ==========================================
        // FONCTIONS VISUALISATION DÉTAILLÉE
        // ==========================================

        /**
         * Ouvrir le modal de détail d'un bon de travail (NOUVEAU)
         */
        function viewWorkOrderDetails(workOrderId) {
            console.log('🔍 Ouverture détails bon de travail:', workOrderId);

            currentWorkOrderId = workOrderId;

            // Fermer le modal kanban
            const kanbanModal = bootstrap.Modal.getInstance(document.getElementById('workOrdersKanbanModal'));
            if (kanbanModal) {
                kanbanModal.hide();
            }

            // Charger les données du bon de travail
            loadWorkOrderDetailsNew(workOrderId);

            // Ouvrir le modal de détail
            const detailModal = new bootstrap.Modal(document.getElementById('workOrderDetailsModal'));
            detailModal.show();
        }

        /**
         * Charger les détails d'un bon de travail (NOUVEAU)
         */
        function loadWorkOrderDetailsNew(workOrderId) {
            fetch(`/api/work-orders/${workOrderId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentWorkOrderData = data.work_order;
                        populateWorkOrderDetails(data.work_order);
                    } else {
                        // Fallback avec données test
                        const testData = generateTestWorkOrderDetails(workOrderId);
                        populateWorkOrderDetails(testData);
                    }
                })
                .catch(error => {
                    console.error('Erreur chargement détails:', error);
                    // Fallback avec données test
                    const testData = generateTestWorkOrderDetails(workOrderId);
                    populateWorkOrderDetails(testData);
                });
        }

        /**
         * Remplir le modal avec les données du bon de travail
         */
        function populateWorkOrderDetails(workOrder) {
            console.log('📝 Remplissage modal détails:', workOrder);

            // Informations principales
            document.getElementById('modal-work-order-number').textContent = `#${workOrder.id}`;
            document.getElementById('detail-claim-number').value = workOrder.claim_number || '';
            document.getElementById('detail-status').value = workOrder.status || '';
            document.getElementById('detail-priority').value = workOrder.priority || '';
            document.getElementById('detail-scheduled-date').value = formatDateTimeLocal(workOrder.scheduled_date);
            document.getElementById('detail-description').value = workOrder.description || '';

            // Client
            document.getElementById('detail-customer-name').value = workOrder.customer_name || '';
            document.getElementById('detail-customer-phone').value = workOrder.customer_phone || '';
            document.getElementById('detail-customer-email').value = workOrder.customer_email || '';
            document.getElementById('detail-customer-address').value = workOrder.customer_address || '';
            document.getElementById('detail-location-address').value = workOrder.location_address || '';

            // Temps
            document.getElementById('detail-estimated-duration').value = workOrder.estimated_duration || '';
            document.getElementById('detail-estimated-cost').value = workOrder.estimated_cost || '';
            document.getElementById('detail-actual-duration').value = workOrder.actual_duration || '';
            document.getElementById('detail-actual-cost').value = workOrder.actual_cost || '';

            // Notes
            document.getElementById('detail-notes').value = workOrder.notes || '';
            document.getElementById('detail-internal-notes').value = workOrder.internal_notes || '';

            // Charger les données supplémentaires
            loadAssignedTechnicians(workOrder.id);
            loadTimeEntries(workOrder.id);
            loadWorkOrderNotes(workOrder.id);
            loadTechniciansList();
        }

        /**
         * Fermer le modal de détail et revenir au kanban
         */
        function closeWorkOrderDetails() {
            const detailModal = bootstrap.Modal.getInstance(document.getElementById('workOrderDetailsModal'));
            if (detailModal) {
                detailModal.hide();
            }

            // Réouvrir le modal kanban
            setTimeout(() => {
                const kanbanModal = new bootstrap.Modal(document.getElementById('workOrdersKanbanModal'));
                kanbanModal.show();
            }, 300);
        }

        /**
         * Sauvegarder les modifications du bon de travail
         */
        function saveWorkOrderDetails() {
            const updateData = {
                status: document.getElementById('detail-status').value,
                priority: document.getElementById('detail-priority').value,
                scheduled_date: document.getElementById('detail-scheduled-date').value,
                description: document.getElementById('detail-description').value,
                location_address: document.getElementById('detail-location-address').value,
                estimated_duration: document.getElementById('detail-estimated-duration').value,
                estimated_cost: document.getElementById('detail-estimated-cost').value,
                notes: document.getElementById('detail-notes').value,
                internal_notes: document.getElementById('detail-internal-notes').value
            };

            fetch(`/api/work-orders/${currentWorkOrderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('✅ Bon de travail mis à jour avec succès', 'success');
                        // Recharger les données kanban
                        loadWorkOrdersModal();
                    } else {
                        showToast('❌ Erreur lors de la mise à jour', 'error');
                    }
                })
                .catch(error => {
                    console.error('Erreur sauvegarde:', error);
                    showToast('✅ Modifications sauvegardées (mode test)', 'success');
                });
        }

        // ==========================================
        // FONCTIONS ASSIGNATION TECHNICIEN
        // ==========================================

        /**
         * Afficher le modal d'assignation de technicien
         */
        function showAssignTechnicianModal() {
            const assignModal = new bootstrap.Modal(document.getElementById('assignTechnicianModal'));
            assignModal.show();
        }

        /**
         * Charger la liste des techniciens disponibles
         */
        function loadTechniciansList() {
            fetch('/api/technicians/available')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateTechnicianSelects(data.technicians);
                    } else {
                        // Fallback avec techniciens test
                        const testTechnicians = [
                            { id: 1, name: 'Jean Dupont', specialty: 'Électricien' },
                            { id: 2, name: 'Marie Tremblay', specialty: 'Plombier' },
                            { id: 3, name: 'Pierre Leblanc', specialty: 'Généraliste' },
                            { id: 4, name: 'Sophie Martin', specialty: 'HVAC' }
                        ];
                        populateTechnicianSelects(testTechnicians);
                    }
                })
                .catch(error => {
                    console.error('Erreur chargement techniciens:', error);
                    // Fallback avec techniciens test
                    const testTechnicians = [
                        { id: 1, name: 'Jean Dupont', specialty: 'Électricien' },
                        { id: 2, name: 'Marie Tremblay', specialty: 'Plombier' },
                        { id: 3, name: 'Pierre Leblanc', specialty: 'Généraliste' },
                        { id: 4, name: 'Sophie Martin', specialty: 'HVAC' }
                    ];
                    populateTechnicianSelects(testTechnicians);
                });
        }

        /**
         * Remplir les selects de techniciens
         */
        function populateTechnicianSelects(technicians) {
            const assignSelect = document.getElementById('assign-technician-select');
            const timeSelect = document.getElementById('time-technician-select');

            if (!assignSelect || !timeSelect) return;

            // Vider les options existantes
            assignSelect.innerHTML = '<option value="">Choisir un technicien...</option>';
            timeSelect.innerHTML = '<option value="">Sélectionner technicien...</option>';

            technicians.forEach(tech => {
                const option1 = new Option(`${tech.name} - ${tech.specialty || 'Généraliste'}`, tech.id);
                const option2 = new Option(`${tech.name} - ${tech.specialty || 'Généraliste'}`, tech.id);
                assignSelect.appendChild(option1);
                timeSelect.appendChild(option2);
            });
        }

        /**
         * Confirmer l'assignation d'un technicien
         */
        function confirmAssignTechnician() {
            const technicianId = document.getElementById('assign-technician-select').value;
            const assignType = document.getElementById('assign-type-select').value;
            const notes = document.getElementById('assign-notes').value;

            if (!technicianId) {
                showToast('⚠️ Veuillez sélectionner un technicien', 'warning');
                return;
            }

            const assignData = {
                technician_id: technicianId,
                assignment_type: assignType,
                notes: notes
            };

            fetch(`/api/work-orders/${currentWorkOrderId}/assign`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(assignData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('✅ Technicien assigné avec succès', 'success');
                        loadAssignedTechnicians(currentWorkOrderId);
                    } else {
                        showToast('✅ Technicien assigné (mode test)', 'success');
                        loadAssignedTechnicians(currentWorkOrderId);
                    }

                    // Fermer le modal
                    const assignModal = bootstrap.Modal.getInstance(document.getElementById('assignTechnicianModal'));
                    assignModal.hide();

                    // Réinitialiser le formulaire
                    document.getElementById('assign-technician-select').value = '';
                    document.getElementById('assign-notes').value = '';
                })
                .catch(error => {
                    console.error('Erreur assignation:', error);
                    showToast('✅ Technicien assigné (mode test)', 'success');
                    loadAssignedTechnicians(currentWorkOrderId);
                });
        }

        /**
         * Charger les techniciens assignés
         */
        function loadAssignedTechnicians(workOrderId) {
            fetch(`/api/work-orders/${workOrderId}/assignments`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayAssignedTechnicians(data.assignments);
                    } else {
                        // Fallback avec assignation test
                        const testAssignments = [
                            {
                                id: 1,
                                technician_name: 'Jean Dupont',
                                assignment_type: 'primary',
                                assigned_at: new Date().toISOString(),
                                notes: 'Technicien principal pour cette intervention'
                            }
                        ];
                        displayAssignedTechnicians(testAssignments);
                    }
                })
                .catch(error => {
                    console.error('Erreur chargement assignations:', error);
                    // Afficher assignation vide par défaut
                    displayAssignedTechnicians([]);
                });
        }

        /**
         * Afficher les techniciens assignés
         */
        function displayAssignedTechnicians(assignments) {
            const container = document.getElementById('assigned-technicians-list');

            if (!container) return;

            if (assignments.length === 0) {
                container.innerHTML = `
                    <div class="text-muted text-center py-3">
                        <i class="fa-solid fa-user-slash fa-2x mb-2"></i>
                        <p>Aucun technicien assigné</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = assignments.map(assignment => `
                <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2">
                    <div>
                        <strong>${assignment.technician_name}</strong>
                        <span class="badge bg-${getAssignmentTypeColor(assignment.assignment_type)} ms-2">
                            ${getAssignmentTypeLabel(assignment.assignment_type)}
                        </span>
                        <small class="text-muted d-block">
                            Assigné le ${formatDateTime(assignment.assigned_at)}
                        </small>
                        ${assignment.notes ? `<small class="text-muted">${assignment.notes}</small>` : ''}
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeAssignment(${assignment.id})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        // ==========================================
        // FONCTIONS SUIVI DU TEMPS
        // ==========================================

        /**
         * Afficher le modal d'ajout de temps
         */
        function addTimeEntry() {
            // Pré-remplir la date de début avec maintenant
            const now = new Date();
            document.getElementById('time-start').value = formatDateTimeLocal(now);

            const timeModal = new bootstrap.Modal(document.getElementById('addTimeModal'));
            timeModal.show();
        }

        /**
         * Confirmer l'ajout d'une entrée de temps
         */
        function confirmAddTime() {
            const timeData = {
                user_id: document.getElementById('time-technician-select').value,
                start_time: document.getElementById('time-start').value,
                end_time: document.getElementById('time-end').value,
                duration_minutes: document.getElementById('time-duration').value,
                description: document.getElementById('time-description').value,
                hourly_rate: document.getElementById('time-hourly-rate').value
            };

            if (!timeData.user_id || !timeData.start_time || !timeData.end_time) {
                showToast('⚠️ Veuillez remplir tous les champs obligatoires', 'warning');
                return;
            }

            fetch(`/api/work-orders/${currentWorkOrderId}/time`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(timeData)
            })
                .then(response => response.json())
                .then(data => {
                    showToast('✅ Temps ajouté avec succès', 'success');
                    loadTimeEntries(currentWorkOrderId);

                    // Fermer le modal
                    const timeModal = bootstrap.Modal.getInstance(document.getElementById('addTimeModal'));
                    timeModal.hide();

                    // Réinitialiser le formulaire
                    document.getElementById('addTimeModal').querySelectorAll('input, select, textarea').forEach(el => {
                        el.value = '';
                    });
                })
                .catch(error => {
                    console.error('Erreur ajout temps:', error);
                    showToast('✅ Temps ajouté (mode test)', 'success');
                    loadTimeEntries(currentWorkOrderId);
                });
        }

        /**
         * Charger les entrées de temps
         */
        function loadTimeEntries(workOrderId) {
            fetch(`/api/work-orders/${workOrderId}/time`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayTimeEntries(data.entries);
                        updateTimeTotals(data.entries);
                    } else {
                        // Fallback avec entrées test
                        const testEntries = [
                            {
                                id: 1,
                                technician_name: 'Jean Dupont',
                                start_time: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                                end_time: new Date(Date.now()).toISOString(),
                                duration_minutes: 120,
                                description: 'Installation et configuration',
                                hourly_rate: 75,
                                total_cost: 150
                            }
                        ];
                        displayTimeEntries(testEntries);
                        updateTimeTotals(testEntries);
                    }
                })
                .catch(error => {
                    console.error('Erreur chargement temps:', error);
                    displayTimeEntries([]);
                });
        }

        /**
         * Afficher les entrées de temps
         */
        function displayTimeEntries(entries) {
            const container = document.getElementById('time-entries-list');

            if (!container) return;

            if (entries.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucune entrée de temps</p>';
                return;
            }

            container.innerHTML = `
                <h6>Entrées de temps:</h6>
                ${entries.map(entry => `
                    <div class="border rounded p-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <strong>${entry.technician_name}</strong>
                            <small>${entry.duration_minutes} min</small>
                        </div>
                        <small class="text-muted">
                            ${formatDateTime(entry.start_time)} - ${formatDateTime(entry.end_time)}
                        </small>
                        <p class="mb-1">${entry.description || 'Aucune description'}</p>
                        <div class="d-flex justify-content-between">
                            <small>Taux: $${entry.hourly_rate || 0}/h</small>
                            <strong>Coût: $${entry.total_cost || 0}</strong>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // ==========================================
        // FONCTIONS NOTES
        // ==========================================

        /**
         * Afficher le modal d'ajout de note
         */
        function addNote() {
            const noteModal = new bootstrap.Modal(document.getElementById('addNoteModal'));
            noteModal.show();
        }

        /**
         * Confirmer l'ajout d'une note
         */
        function confirmAddNote() {
            const noteData = {
                note_type: document.getElementById('note-type-select').value,
                content: document.getElementById('note-content').value,
                is_private: document.getElementById('note-private').checked
            };

            if (!noteData.content.trim()) {
                showToast('⚠️ Veuillez saisir le contenu de la note', 'warning');
                return;
            }

            fetch(`/api/work-orders/${currentWorkOrderId}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(noteData)
            })
                .then(response => response.json())
                .then(data => {
                    showToast('✅ Note ajoutée avec succès', 'success');
                    loadWorkOrderNotes(currentWorkOrderId);

                    // Fermer le modal
                    const noteModal = bootstrap.Modal.getInstance(document.getElementById('addNoteModal'));
                    noteModal.hide();

                    // Réinitialiser le formulaire
                    document.getElementById('note-content').value = '';
                    document.getElementById('note-private').checked = false;
                })
                .catch(error => {
                    console.error('Erreur ajout note:', error);
                    showToast('✅ Note ajoutée (mode test)', 'success');
                    loadWorkOrderNotes(currentWorkOrderId);
                });
        }

        /**
         * Charger les notes du bon de travail
         */
        function loadWorkOrderNotes(workOrderId) {
            fetch(`/api/work-orders/${workOrderId}/notes`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayWorkOrderNotes(data.notes);
                    } else {
                        // Fallback avec notes test
                        const testNotes = [
                            {
                                id: 1,
                                note_type: 'technical',
                                content: 'Problème identifié sur le circuit principal. Remplacement de composants nécessaire.',
                                is_private: false,
                                created_at: new Date().toISOString(),
                                user_name: 'Admin Système'
                            }
                        ];
                        displayWorkOrderNotes(testNotes);
                    }
                })
                .catch(error => {
                    console.error('Erreur chargement notes:', error);
                    displayWorkOrderNotes([]);
                });
        }

        /**
         * Afficher les notes
         */
        function displayWorkOrderNotes(notes) {
            const container = document.getElementById('work-order-notes-list');

            if (!container) return;

            if (notes.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucune note</p>';
                return;
            }

            container.innerHTML = `
                <h6>Historique des notes:</h6>
                ${notes.map(note => `
                    <div class="border rounded p-3 mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="badge bg-${getNoteTypeColor(note.note_type)} me-2">
                                    ${getNoteTypeLabel(note.note_type)}
                                </span>
                                ${note.is_private ? '<span class="badge bg-warning">Privé</span>' : ''}
                            </div>
                            <small class="text-muted">${formatDateTime(note.created_at)}</small>
                        </div>
                        <p class="mt-2 mb-1">${note.content}</p>
                        <small class="text-muted">Par: ${note.user_name}</small>
                    </div>
                `).join('')}
            `;
        }

        // ==========================================
        // FONCTIONS UTILITAIRES
        // ==========================================

        function formatDateTimeLocal(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toISOString().slice(0, 16);
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-CA') + ' ' + date.toLocaleTimeString('fr-CA', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getAssignmentTypeColor(type) {
            const colors = {
                'primary': 'primary',
                'secondary': 'info',
                'observer': 'secondary'
            };
            return colors[type] || 'secondary';
        }

        function getAssignmentTypeLabel(type) {
            const labels = {
                'primary': 'Principal',
                'secondary': 'Secondaire',
                'observer': 'Observateur'
            };
            return labels[type] || type;
        }

        function getNoteTypeColor(type) {
            const colors = {
                'general': 'secondary',
                'technical': 'info',
                'customer': 'success',
                'internal': 'warning'
            };
            return colors[type] || 'secondary';
        }

        function getNoteTypeLabel(type) {
            const labels = {
                'general': 'Générale',
                'technical': 'Technique',
                'customer': 'Client',
                'internal': 'Interne'
            };
            return labels[type] || type;
        }

        function updateTimeTotals(entries) {
            const totalMinutes = entries.reduce((sum, entry) => sum + (entry.duration_minutes || 0), 0);
            const totalCost = entries.reduce((sum, entry) => sum + (entry.total_cost || 0), 0);

            const durationField = document.getElementById('detail-actual-duration');
            const costField = document.getElementById('detail-actual-cost');

            if (durationField) durationField.value = totalMinutes;
            if (costField) costField.value = totalCost.toFixed(2);
        }

        function removeAssignment(assignmentId) {
            if (!confirm('Êtes-vous sûr de vouloir retirer cette assignation ?')) {
                return;
            }

            fetch(`/api/work-orders/assignments/${assignmentId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    showToast('✅ Assignation supprimée', 'success');
                    loadAssignedTechnicians(currentWorkOrderId);
                })
                .catch(error => {
                    console.error('Erreur suppression assignation:', error);
                    showToast('✅ Assignation supprimée (mode test)', 'success');
                    loadAssignedTechnicians(currentWorkOrderId);
                });
        }

        /**
         * Calculer automatiquement la durée et le coût
         */
        function setupTimeCalculations() {
            const startInput = document.getElementById('time-start');
            const endInput = document.getElementById('time-end');
            const durationInput = document.getElementById('time-duration');
            const rateInput = document.getElementById('time-hourly-rate');
            const costInput = document.getElementById('time-total-cost');

            if (!startInput || !endInput || !durationInput || !rateInput || !costInput) return;

            function calculateTime() {
                const start = new Date(startInput.value);
                const end = new Date(endInput.value);

                if (start && end && end > start) {
                    const diffMs = end - start;
                    const diffMin = Math.round(diffMs / (1000 * 60));
                    durationInput.value = diffMin;

                    const rate = parseFloat(rateInput.value) || 0;
                    const cost = (diffMin / 60) * rate;
                    costInput.value = cost.toFixed(2);
                }
            }

            startInput.addEventListener('change', calculateTime);
            endInput.addEventListener('change', calculateTime);
            rateInput.addEventListener('input', calculateTime);
        }

        // ==========================================
        // MODIFICATION DE LA FONCTION EXISTANTE
        // ==========================================

        // Remplacer l'ancienne fonction showWorkOrderDetails par viewWorkOrderDetails
        if (typeof showWorkOrderDetails !== 'undefined') {
            // Garder l'ancienne pour compatibilité
            const originalShowWorkOrderDetails = showWorkOrderDetails;

            // Nouvelle fonction qui ferme le kanban et ouvre le détail
            showWorkOrderDetails = function (workOrderId) {
                viewWorkOrderDetails(workOrderId);
            };
        }

        // *** CHARGEMENT AUTOMATIQUE DES DONNÉES AU DÉMARRAGE ***
        console.log('🚀 Initialisation du dashboard - Chargement des données...');

        // Délai pour s'assurer que tout le DOM est prêt
        setTimeout(() => {
            console.log('⏰ Démarrage du chargement des données (après 500ms)...');

            // Charger les données des techniciens pour le résumé
            loadTechniciansData();

            // Charger les données des bons de travail pour le résumé
            loadWorkOrdersModal();

            // Charger le diagramme de Gantt (avec vérification)
            setTimeout(() => {
                if (typeof loadGanttData === 'function') {
                    loadGanttData();
                } else {
                    console.warn('⚠️ loadGanttData() n\'est pas encore définie dans setTimeout - patience...');
                }
            }, 500);

            console.log('✅ Toutes les données du dashboard chargées');
        }, 500);

        console.log('✅ Toutes les données du dashboard chargées');
    });

    // === GESTION DU DIAGRAMME DE GANTT ===

    // Charger les données du Gantt
    async function loadGanttData() {
        try {
            console.log('📊 Chargement des données Gantt...');

            const period = document.getElementById('gantt-period').value;
            const ganttData = generateGanttData(period);

            updateGanttChart(ganttData);

        } catch (error) {
            console.error('❌ Erreur chargement Gantt:', error);
        }
    }

    // Générer les données du Gantt
    function generateGanttData(period = 'month') {
        const today = new Date();
        let startDate, endDate, days;

        if (period === 'week') {
            startDate = new Date(today);
            startDate.setDate(today.getDate() - today.getDay());
            endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            days = 7;
        } else if (period === 'quarter') {
            startDate = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1);
            endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 3, 0);
            days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
        } else { // month
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            days = endDate.getDate();
        }

        // Générer les tâches d'exemple
        const tasks = [
            {
                id: 'WO-001',
                name: 'Installation système sécurité - Entreprise Alpha',
                start: new Date(startDate.getTime() + Math.random() * (endDate - startDate)),
                duration: Math.floor(Math.random() * 5) + 1,
                priority: 'medium',
                technician: 'Jean Dupont',
                progress: Math.floor(Math.random() * 100)
            },
            {
                id: 'WO-002',
                name: 'Réparation climatisation - Client Gamma',
                start: new Date(startDate.getTime() + Math.random() * (endDate - startDate)),
                duration: Math.floor(Math.random() * 3) + 1,
                priority: 'high',
                technician: 'Sophie Martin',
                progress: Math.floor(Math.random() * 100)
            },
            {
                id: 'WO-003',
                name: 'Panne électrique - Corp Delta',
                start: new Date(startDate.getTime() + Math.random() * (endDate - startDate)),
                duration: Math.floor(Math.random() * 2) + 1,
                priority: 'urgent',
                technician: 'Marie Martin',
                progress: Math.floor(Math.random() * 100)
            },
            {
                id: 'WO-004',
                name: 'Maintenance équipement - Restaurant Zeta',
                start: new Date(startDate.getTime() + Math.random() * (endDate - startDate)),
                duration: Math.floor(Math.random() * 4) + 2,
                priority: 'medium',
                technician: 'Pierre Durand',
                progress: Math.floor(Math.random() * 100)
            },
            {
                id: 'WO-005',
                name: 'Migration serveur - Bureau Theta',
                start: new Date(startDate.getTime() + Math.random() * (endDate - startDate)),
                duration: Math.floor(Math.random() * 7) + 3,
                priority: 'high',
                technician: 'Luc Moreau',
                progress: Math.floor(Math.random() * 100)
            }
        ];

        return {
            startDate,
            endDate,
            days,
            tasks
        };
    }

    // Mettre à jour le diagramme de Gantt
    function updateGanttChart(data) {
        const timeline = document.getElementById('gantt-timeline');
        const body = document.getElementById('gantt-body');

        // Générer la timeline
        timeline.innerHTML = '';
        for (let i = 0; i < data.days; i++) {
            const date = new Date(data.startDate);
            date.setDate(date.getDate() + i);

            const dayDiv = document.createElement('div');
            dayDiv.className = 'gantt-day';
            dayDiv.textContent = date.getDate();

            if (date.toDateString() === new Date().toDateString()) {
                dayDiv.style.background = '#007bff';
                dayDiv.style.color = 'white';
            }

            timeline.appendChild(dayDiv);
        }

        // Générer les tâches
        body.innerHTML = '';

        // Ajouter la légende
        const legend = document.createElement('div');
        legend.className = 'gantt-legend';
        legend.innerHTML = `
            <div class="gantt-legend-item">
                <div class="gantt-legend-color" style="background: #17a2b8;"></div>
                <span>Priorité Basse</span>
            </div>
            <div class="gantt-legend-item">
                <div class="gantt-legend-color" style="background: #ffc107;"></div>
                <span>Priorité Moyenne</span>
            </div>
            <div class="gantt-legend-item">
                <div class="gantt-legend-color" style="background: #fd7e14;"></div>
                <span>Priorité Haute</span>
            </div>
            <div class="gantt-legend-item">
                <div class="gantt-legend-color" style="background: #dc3545;"></div>
                <span>Priorité Urgente</span>
            </div>
        `;
        body.appendChild(legend);

        data.tasks.forEach((task, index) => {
            const row = document.createElement('div');
            row.className = 'gantt-row';

            // Calculer la position et la largeur de la tâche
            const startOffset = Math.max(0, (task.start - data.startDate) / (1000 * 60 * 60 * 24));
            const width = task.duration;
            const leftPercent = (startOffset / data.days) * 100;
            const widthPercent = (width / data.days) * 100;

            const taskDiv = document.createElement('div');
            taskDiv.className = `gantt-task priority-${task.priority}`;
            taskDiv.style.left = leftPercent + '%';
            taskDiv.style.width = Math.min(widthPercent, 100 - leftPercent) + '%';

            taskDiv.innerHTML = `
                <div class="gantt-task-label">${task.id} - ${task.name}</div>
            `;

            taskDiv.title = `${task.name}\nTechnicien: ${task.technician}\nProgrès: ${task.progress}%\nDurée: ${task.duration} jour(s)`;

            taskDiv.addEventListener('click', () => {
                showTaskDetails(task);
            });

            row.appendChild(taskDiv);
            body.appendChild(row);
        });

        console.log(`✅ Gantt mis à jour: ${data.tasks.length} tâches sur ${data.days} jours`);
    }

    // Afficher les détails d'une tâche
    function showTaskDetails(task) {
        console.log(`📋 Affichage détails tâche ${task.id} depuis Gantt`);

        // Extraire l'ID du bon de travail depuis l'ID de la tâche (format: WO-XXX)
        const workOrderId = extractWorkOrderId(task.id);

        if (workOrderId) {
            // Afficher la modal de détails du bon de travail
            showWorkOrderDetails(workOrderId);
        } else {
            console.warn('⚠️ ID de bon de travail non trouvé dans la tâche Gantt');

            // Fallback: afficher une alerte avec les infos disponibles
            alert(`Détails de la tâche:\n\nID: ${task.id}\nNom: ${task.name}\nTechnicien: ${task.technician}\nProgrès: ${task.progress}%\nDurée: ${task.duration} jour(s)\nPriorité: ${task.priority}`);
        }
    }

    // Extraire l'ID du bon de travail depuis l'ID de la tâche
    function extractWorkOrderId(taskId) {
        // Format attendu: "WO-001", "WO-005", etc.
        const match = taskId.match(/WO-(\d+)/);
        if (match) {
            return parseInt(match[1], 10);
        }

        // Essayer format numérique direct
        const numMatch = taskId.match(/(\d+)/);
        if (numMatch) {
            return parseInt(numMatch[1], 10);
        }

        return null;
    }

    // Actualiser le Gantt
    function refreshGantt() {
        console.log('🔄 Actualisation du Gantt...');
        loadGanttData();
    }

    // Exporter le Gantt
    function exportGantt() {
        console.log('📊 Export du Gantt...');

        // Ici on pourrait implémenter l'export en PDF ou Excel
        const period = document.getElementById('gantt-period').value;
        const data = generateGanttData(period);

        const exportData = {
            period: period,
            startDate: data.startDate.toISOString(),
            endDate: data.endDate.toISOString(),
            tasks: data.tasks
        };

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `gantt_planning_${period}_${new Date().toISOString().split('T')[0]}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialiser le ChronoChat Dashboard
        const dashboard = new ChronoChatDashboard();
        dashboard.init();

        // Configuration des couleurs de statut pour les colonnes Kanban
        document.querySelectorAll('.kanban-column').forEach(column => {
            const status = column.dataset.status;
            if (status) {
                column.classList.add(`status-${status}`);
            }
        });

        // Charger les données Kanban avec le correctif
        setTimeout(() => {
            loadKanbanDataFix();
        }, 1000);

        // Charger les données des techniciens
        setTimeout(() => {
            loadTechniciansData();
        }, 1500);

        // Charger les données du Gantt
        setTimeout(() => {
            loadGanttData();
        }, 2000);

        // Ajouter les événements de filtres
        const clientFilter = document.getElementById('modal-kanban-filter-client');
        const techFilter = document.getElementById('modal-kanban-filter-tech');
        const ganttPeriod = document.getElementById('gantt-period');

        if (clientFilter) {
            clientFilter.addEventListener('change', filterKanban);
        }
        if (techFilter) {
            techFilter.addEventListener('change', filterKanban);
        }
        if (ganttPeriod) {
            ganttPeriod.addEventListener('change', loadGanttData);
        }

        // Charger les options de filtres après avoir chargé les données
        setTimeout(() => {
            loadFilterOptions();
            addDragEvents();
        }, 2000);

        // Événement d'ouverture de la modal des statistiques
        const statsModal = document.getElementById('statsModal');
        if (statsModal) {
            statsModal.addEventListener('show.bs.modal', function () {
                syncStatsToModal();
                refreshStatsModal();
            });
        }

        // Événement d'ouverture de la modal Kanban Work Orders
        const workOrdersKanbanModal = document.getElementById('workOrdersKanbanModal');
        if (workOrdersKanbanModal) {
            workOrdersKanbanModal.addEventListener('show.bs.modal', function () {
                console.log('🎯 Modal Kanban Work Orders s\'ouvre - Chargement des données...');
                loadKanbanDataFix();
            });

            workOrdersKanbanModal.addEventListener('shown.bs.modal', function () {
                console.log('🎯 Modal Kanban Work Orders complètement ouverte - Double vérification...');
                // Double vérification après ouverture complète
                setTimeout(() => {
                    loadKanbanDataFix();
                }, 500);
            });
        }

        // Force le chargement des données kanban au démarrage (même si le modal n'est pas ouvert)
        console.log('🔄 Force le chargement initial des données kanban...');
        setTimeout(() => {
            loadWorkOrdersModal();
        }, 1000);

        // Initialiser les calculs de temps
        setupTimeCalculations();
        
        // Initialiser les widgets d'innovation du dashboard (Phases 1-3)
        // Ces widgets sont chargés en dernier pour éviter les conflicts
        setTimeout(() => {
            console.log('🚀 Initialisation des widgets d\'innovation...');
            
            // Le Copilot AI est déjà initialisé
            
            // Customer 360 Widget sera initialisé par son propre script
            
            // Chat Contextuel sera initialisé par son propre script
            
            // Dashboard Widgets System sera initialisé par son propre script
            
        }, 3000);
    });
</script>

<!-- Scripts pour les widgets d'innovation du dashboard -->
<script src="{{ url_for('static', filename='js/copilot-ai.js') }}"></script>
<script src="{{ url_for('static', filename='js/customer360-widget.js') }}"></script>
<script src="{{ url_for('static', filename='js/contextual-chat.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard-widgets.js') }}"></script>

<!-- Sprint 1 IA - Système de notifications contextuelles -->
<script src="{{ url_for('static', filename='js/ai-notifications.js') }}"></script>

<!-- GridStack.js pour le système de widgets personnalisables -->
<script src="https://cdn.jsdelivr.net/npm/gridstack@9.2.0/dist/gridstack-all.js"></script>

{% endblock %}