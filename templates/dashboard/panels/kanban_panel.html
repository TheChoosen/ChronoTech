<!-- Panel Kanban pour Dashboard -->
<div class="dashboard-panel kanban-panel" id="kanbanPanel">
    <div class="panel-header">
        <h4><i class="fas fa-tasks me-2"></i>Tableau Kanban</h4>
        <div class="panel-controls">
            <button class="btn btn-sm btn-outline-primary" onclick="refreshKanban()">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn btn-sm btn-primary" onclick="addWorkOrder()">
                <i class="fas fa-plus"></i> Nouveau
            </button>
        </div>
    </div>
    
    <div class="panel-content">
        <div class="kanban-board" id="kanbanBoard">
            <!-- Colonne En Attente -->
            <div class="kanban-column" data-status="pending">
                <div class="column-header">
                    <h5><i class="fas fa-clock text-warning"></i> En Attente</h5>
                    <span class="badge bg-warning" id="pending-count">0</span>
                </div>
                <div class="column-content" id="pending-tasks" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <!-- Les cartes seront ajoutées dynamiquement -->
                </div>
            </div>
            
            <!-- Colonne En Cours -->
            <div class="kanban-column" data-status="in_progress">
                <div class="column-header">
                    <h5><i class="fas fa-play text-info"></i> En Cours</h5>
                    <span class="badge bg-info" id="in_progress-count">0</span>
                </div>
                <div class="column-content" id="in_progress-tasks" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <!-- Les cartes seront ajoutées dynamiquement -->
                </div>
            </div>
            
            <!-- Colonne En Révision -->
            <div class="kanban-column" data-status="review">
                <div class="column-header">
                    <h5><i class="fas fa-search text-primary"></i> En Révision</h5>
                    <span class="badge bg-primary" id="review-count">0</span>
                </div>
                <div class="column-content" id="review-tasks" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <!-- Les cartes seront ajoutées dynamiquement -->
                </div>
            </div>
            
            <!-- Colonne Terminé -->
            <div class="kanban-column" data-status="completed">
                <div class="column-header">
                    <h5><i class="fas fa-check text-success"></i> Terminé</h5>
                    <span class="badge bg-success" id="completed-count">0</span>
                </div>
                <div class="column-content" id="completed-tasks" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <!-- Les cartes seront ajoutées dynamiquement -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.kanban-panel {
    background: var(--bg-color);
    border-radius: 15px;
    box-shadow: var(--shadow);
    overflow: hidden;
}

.kanban-board {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    padding: 1rem;
    min-height: 500px;
}

.kanban-column {
    background: var(--bg-secondary);
    border-radius: 10px;
    padding: 1rem;
    min-height: 450px;
}

.column-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-color);
}

.column-header h5 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
}

.column-content {
    min-height: 350px;
    border: 2px dashed transparent;
    border-radius: 8px;
    transition: border-color 0.3s ease;
}

.column-content.drag-over {
    border-color: var(--primary-color);
    background: var(--primary-light);
}

.kanban-card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    cursor: grab;
    transition: all 0.3s ease;
    border-left: 4px solid var(--primary-color);
}

.kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.kanban-card.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.card-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-color);
    font-size: 0.9rem;
}

.card-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.8rem;
}

.card-priority {
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
}

.priority-high {
    background: #ffeaa7;
    color: #d63031;
}

.priority-medium {
    background: #81ecec;
    color: #00b894;
}

.priority-low {
    background: #a29bfe;
    color: #6c5ce7;
}

.card-assignee {
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.assignee-avatar {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
}

.card-description {
    color: var(--text-muted);
    font-size: 0.8rem;
    margin-bottom: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.7rem;
    color: var(--text-muted);
}

.card-tags {
    display: flex;
    gap: 0.3rem;
}

.card-tag {
    background: var(--bg-color);
    padding: 0.1rem 0.4rem;
    border-radius: 8px;
    font-size: 0.6rem;
}

@media (max-width: 768px) {
    .kanban-board {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }
    
    .kanban-column {
        min-height: 200px;
    }
    
    .column-content {
        min-height: 150px;
    }
}
</style>

<script>
// Système Kanban
window.KanbanSystem = {
    workOrders: [],
    
    // Initialiser le Kanban
    async init() {
        await this.loadWorkOrders();
        this.renderBoard();
        this.updateCounts();
    },
    
    // Charger les ordres de travail
    async loadWorkOrders() {
        try {
            const response = await fetch('/api/work_orders/kanban');
            this.workOrders = await response.json();
        } catch (error) {
            console.error('Erreur lors du chargement du Kanban:', error);
            NotificationSystem.showToast('Erreur lors du chargement du tableau', 'error');
        }
    },
    
    // Rendre le tableau
    renderBoard() {
        const statuses = ['pending', 'in_progress', 'review', 'completed'];
        
        statuses.forEach(status => {
            const container = document.getElementById(`${status}-tasks`);
            const orders = this.workOrders.filter(order => order.status === status);
            
            container.innerHTML = orders.map(order => this.createCard(order)).join('');
        });
    },
    
    // Créer une carte
    createCard(order) {
        const priorityClass = `priority-${order.priority || 'medium'}`;
        const assigneeInitials = order.assigned_to ? 
            order.assigned_to.split(' ').map(n => n[0]).join('') : '?';
        
        return `
            <div class="kanban-card" draggable="true" data-id="${order.id}" 
                 ondragstart="dragStart(event)" ondragend="dragEnd(event)"
                 onclick="openWorkOrderModal(${order.id})">
                <div class="card-title">${order.title}</div>
                <div class="card-meta">
                    <span class="card-priority ${priorityClass}">${order.priority || 'Medium'}</span>
                    <div class="card-assignee">
                        <div class="assignee-avatar">${assigneeInitials}</div>
                        <span>${order.assigned_to || 'Non assigné'}</span>
                    </div>
                </div>
                <div class="card-description">${order.description || ''}</div>
                <div class="card-footer">
                    <div class="card-tags">
                        ${order.category ? `<span class="card-tag">${order.category}</span>` : ''}
                    </div>
                    <span>${this.formatDate(order.created_at)}</span>
                </div>
            </div>
        `;
    },
    
    // Mettre à jour les compteurs
    updateCounts() {
        const statuses = ['pending', 'in_progress', 'review', 'completed'];
        
        statuses.forEach(status => {
            const count = this.workOrders.filter(order => order.status === status).length;
            const badge = document.getElementById(`${status}-count`);
            if (badge) badge.textContent = count;
        });
    },
    
    // Déplacer une carte
    async moveCard(cardId, newStatus) {
        try {
            const response = await fetch(`/api/work_orders/${cardId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrf_token]').value
                },
                body: JSON.stringify({ status: newStatus })
            });
            
            if (response.ok) {
                // Mettre à jour localement
                const order = this.workOrders.find(o => o.id == cardId);
                if (order) order.status = newStatus;
                
                this.renderBoard();
                this.updateCounts();
                NotificationSystem.showToast('Ordre de travail déplacé', 'success');
            }
        } catch (error) {
            console.error('Erreur lors du déplacement:', error);
            NotificationSystem.showToast('Erreur lors du déplacement', 'error');
        }
    },
    
    // Formater la date
    formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
    }
};

// Fonctions de drag & drop
function allowDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function dragStart(event) {
    event.dataTransfer.setData('text/plain', event.target.dataset.id);
    event.target.classList.add('dragging');
}

function dragEnd(event) {
    event.target.classList.remove('dragging');
    document.querySelectorAll('.column-content').forEach(col => {
        col.classList.remove('drag-over');
    });
}

function drop(event) {
    event.preventDefault();
    const cardId = event.dataTransfer.getData('text/plain');
    const newStatus = event.currentTarget.closest('.kanban-column').dataset.status;
    
    KanbanSystem.moveCard(cardId, newStatus);
    event.currentTarget.classList.remove('drag-over');
}

// Fonctions globales
function refreshKanban() {
    KanbanSystem.init();
}

function addWorkOrder() {
    // Ouvrir le modal de création d'ordre de travail
    if (typeof openCreateWorkOrderModal === 'function') {
        openCreateWorkOrderModal();
    } else {
        window.location.href = '/work_orders/create';
    }
}

function openWorkOrderModal(id) {
    // Ouvrir le modal de détails de l'ordre de travail
    if (typeof openWorkOrderDetailsModal === 'function') {
        openWorkOrderDetailsModal(id);
    } else {
        window.location.href = `/work_orders/${id}`;
    }
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('kanbanPanel')) {
        KanbanSystem.init();
    }
});
</script>
