{% extends 'layout.html' %}

{% block content %}
<div class="clay-container">
    <!-- Header avec animation d'entrée -->
    <header class="text-center clay-fade-in" style="animation-delay: 0.1s;">
        <h1 class="clay-title-primary mb-4">
            <i class="fas fa-tools clay-icon-accent mr-3"></i>
            Intervention Détaillée
        </h1>
        <p class="clay-subtitle">Suivi étape par étape, chronométrage et gestion complète</p>
    </header>

    <!-- Carte des détails de l'intervention -->
    <div class="clay-card clay-card-elevated clay-fade-in" style="animation-delay: 0.2s;">
        <div class="clay-card-header mb-6">
            <h2 class="clay-title-secondary">
                <i class="fas fa-info-circle clay-icon-primary mr-3"></i>
                Détails de l'intervention
            </h2>
        </div>
        
        <div class="clay-grid clay-grid-2 mb-6">
            <div class="clay-info-item">
                <label class="clay-label">Client</label>
                <p class="clay-text-primary">{{ intervention.customer_name }}</p>
            </div>
            <div class="clay-info-item">
                <label class="clay-label">Adresse</label>
                <p class="clay-text-primary">{{ intervention.customer_address }}</p>
            </div>
            <div class="clay-info-item">
                <label class="clay-label">Statut</label>
                <span class="clay-badge clay-badge-{{ 'success' if intervention.status == 'completed' else 'warning' if intervention.status == 'in_progress' else 'info' }}">
                    {{ intervention.status }}
                </span>
            </div>
            <div class="clay-info-item">
                <label class="clay-label">Technicien</label>
                <p class="clay-text-primary">{{ intervention.technician_name }}</p>
            </div>
            <div class="clay-info-item">
                <label class="clay-label">Début</label>
                <p class="clay-text-secondary">{{ intervention.start_time or 'Non démarrée' }}</p>
            </div>
            <div class="clay-info-item">
                <label class="clay-label">Fin</label>
                <p class="clay-text-secondary">{{ intervention.end_time or 'Non terminée' }}</p>
            </div>
        </div>

        {% if session.user_role != 'technician' %}
        <div class="clay-button-group">
            <button class="clay-btn clay-btn-warning clay-ripple" onclick="editIntervention('{{ intervention.id }}', '{{ intervention.customer_name }}', '{{ intervention.customer_address }}', '{{ intervention.technician_id }}')">
                <i class="fas fa-edit mr-2"></i>
                Modifier
            </button>
            <form action="{{ url_for('delete_intervention', id=intervention.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Supprimer cette intervention ?');">
                <button type="submit" class="clay-btn clay-btn-danger clay-ripple">
                    <i class="fas fa-trash mr-2"></i>
                    Supprimer
                </button>
            </form>
        </div>
        {% endif %}
    </div>

    <!-- Formulaire d'ajout d'étape -->
    <div class="clay-card clay-fade-in" style="animation-delay: 0.3s;">
        <div class="clay-card-header mb-6">
            <h2 class="clay-title-secondary">
                <i class="fas fa-plus-circle clay-icon-success mr-3"></i>
                Ajouter une étape
            </h2>
        </div>
        
        <form action="{{ url_for('add_step', id=intervention.id) }}" method="post" class="clay-form">
            <div class="clay-form-group">
                <label for="description" class="clay-label">Description de l'étape</label>
                <textarea name="description" id="description" rows="3" class="clay-textarea" required placeholder="Décrire l'étape en détail..."></textarea>
            </div>

            <!-- Sélecteur de produit avec style claymorphism -->
            <div class="clay-form-group">
                <label for="product_search" class="clay-label">Produit associé</label>
                <div class="clay-search-wrapper">
                    <input type="text" id="product_search" class="clay-input" placeholder="Rechercher un produit par nom ou code..." autocomplete="off">
                    <i class="fas fa-search clay-search-icon"></i>
                </div>
                
                <div class="clay-filter-group mt-3">
                    <select id="product_filter_type" class="clay-select">
                        <option value="DESCR">Recherche par nom</option>
                        <option value="CODEAP">Recherche par code</option>
                    </select>
                </div>
                
                <div id="product_results" class="clay-dropdown clay-dropdown-hidden"></div>
                <input type="hidden" name="product_id" id="product_id">
            </div>
            
            <div id="product_pager" class="clay-pagination"></div>
            
            <button type="submit" class="clay-btn clay-btn-primary clay-btn-lg clay-ripple">
                <i class="fas fa-plus mr-2"></i>
                Ajouter l'Étape
            </button>
        </form>
    </div>

    <!-- Liste des étapes -->
    <div id="steps-container" class="clay-fade-in" style="animation-delay: 0.4s;">
        {% for step in steps %}
        <div class="clay-card clay-card-compact mb-4 clay-hover-lift">
            <div class="clay-card-header mb-4">
                <h3 class="clay-title-tertiary">
                    <i class="fas fa-check-circle clay-icon-success mr-3"></i>
                    Étape {{ loop.index }}
                </h3>
                <div class="clay-timestamp">{{ step.timestamp }}</div>
            </div>
            
            <div class="clay-grid clay-grid-2">
                <div class="clay-content-area">
                    <div class="clay-info-item mb-4">
                        <label class="clay-label">Description</label>
                        <p class="clay-text-primary">{{ step.description }}</p>
                    </div>
                    
                    <div class="clay-info-item mb-4">
                        <label class="clay-label">Produit associé</label>
                        <span class="clay-badge clay-badge-info">
                            {{ step.product_name or 'Aucun produit' }}
                        </span>
                    </div>
                    
                    <div class="clay-button-group">
                        <button class="clay-btn clay-btn-sm clay-btn-warning clay-ripple" onclick="editStep('{{ step.id }}', '{{ step.description }}')">
                            <i class="fas fa-edit mr-1"></i>
                            Modifier
                        </button>
                        <form action="{{ url_for('delete_step', id=intervention.id, step_id=step.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Supprimer cette étape ?');">
                            <button type="submit" class="clay-btn clay-btn-sm clay-btn-danger clay-ripple">
                                <i class="fas fa-trash mr-1"></i>
                                Supprimer
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="clay-tools-area">
                    <!-- Chronomètre et outils -->
                    <div class="clay-tool-card">
                        <h4 class="clay-label mb-3">Outils d'intervention</h4>
                        <div class="clay-tools-grid">
                            <button class="clay-tool-btn" onclick="startTimer('{{ step.id }}')">
                                <i class="fas fa-play"></i>
                                <span>Timer</span>
                            </button>
                            <button class="clay-tool-btn" onclick="addVoiceNote('{{ step.id }}')">
                                <i class="fas fa-microphone"></i>
                                <span>Note vocale</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="clay-card clay-empty-state">
            <div class="text-center">
                <i class="fas fa-clipboard-list clay-icon-muted" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <h3 class="clay-title-tertiary mb-2">Aucune étape</h3>
                <p class="clay-text-secondary">Commencez par ajouter une première étape à cette intervention.</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Template pour une nouvelle étape (caché) -->
    <template id="step-template">
        <div class="clay-card clay-card-compact step-card">
            <div class="clay-card-header mb-4">
                <h3 class="clay-title-tertiary">
                    <i class="fas fa-check-circle clay-icon-success mr-3"></i>
                    Étape <span class="step-number"></span>
                </h3>
            </div>
            
            <div class="clay-grid clay-grid-2">
                <div class="clay-content-area">
                    <div class="clay-form-group">
                        <label class="clay-label">Description de l'étape</label>
                        <input type="text" placeholder="Ex: Diagnostic initial" class="clay-input">
                    </div>
                    <div class="clay-form-group">
                        <label class="clay-label">Notes</label>
                        <textarea placeholder="Notes pour cette étape" rows="2" class="clay-textarea"></textarea>
                    </div>
                </div>
                
                <div class="clay-tools-area">
                    <div class="clay-tool-card">
                        <h4 class="clay-label mb-3">Chronomètre</h4>
                        <div class="clay-timer-display">
                            <div class="clay-timer-info">
                                <span class="clay-timer-label">Début: <span class="start-time">--:--:--</span></span>
                                <span class="clay-timer-label">Fin: <span class="end-time">--:--:--</span></span>
                            </div>
                            <div class="clay-timer-main">
                                Durée: <span class="duration">00:00</span>
                            </div>
                        </div>
                        <div class="clay-button-group mt-3">
                            <button class="clay-btn clay-btn-sm clay-btn-success start-step-btn">Démarrer</button>
                            <button class="clay-btn clay-btn-sm clay-btn-danger end-step-btn" disabled>Terminer</button>
                        </div>
                    </div>
                    
                    <div class="clay-tool-card mt-4">
                        <h4 class="clay-label mb-3">Note Vocale</h4>
                        <div class="clay-voice-controls">
                            <button class="clay-tool-btn voice-note-btn">
                                <i class="fas fa-microphone"></i>
                                <span>Enregistrer</span>
                            </button>
                            <p class="voice-status clay-text-muted"></p>
                        </div>
                        <div class="voice-transcript clay-content-box mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </template>
</div>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script>
            // --- JS pour recherche dynamique, pagination, filtres ---
            const products = {{ products|tojson }};
            let currentPage = 1;
            const pageSize = 8;
            let filteredProducts = products;
            const productSearch = document.getElementById('product_search');
            const productResults = document.getElementById('product_results');
            const productIdInput = document.getElementById('product_id');
            const productPager = document.getElementById('product_pager');
            const filterType = document.getElementById('product_filter_type');

            function safeLower(val) {
                return (val || '').toString().toLowerCase();
            }

            function filterProducts() {
                const query = safeLower(productSearch.value.trim());
                const type = filterType.value;
                filteredProducts = products.filter(p => safeLower(p[type]).includes(query));
                currentPage = 1;
                renderResults();
            }

            function renderResults() {
                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                const pageProducts = filteredProducts.slice(start, end);
                productResults.innerHTML = pageProducts.map(p => `
                    <div class='cursor-pointer px-3 py-2 hover:bg-indigo-100 dark:hover:bg-indigo-900' data-codeap='${p.CODEAP}' data-descr='${p.DESCR}'>
                        <span class='font-bold text-indigo-700 dark:text-indigo-300'>${p.CODEAP}</span> - <span>${p.DESCR}</span>
                    </div>
                `).join('');
                productResults.style.display = pageProducts.length ? 'block' : 'none';
                renderPager();
            }
            
            function renderPager() {
                const totalPages = Math.ceil(filteredProducts.length / pageSize);
                if (totalPages <= 1) {
                    productPager.innerHTML = '';
                    return;
                }
                const prev = currentPage > 1 ? `<button onclick="changePage(${currentPage - 1})" class="btn btn-sm btn-outline-secondary">Précédent</button>` : '';
                const next = currentPage < totalPages ? `<button onclick="changePage(${currentPage + 1})" class="btn btn-sm btn-outline-secondary">Suivant</button>` : '';
                productPager.innerHTML = `${prev} <span>Page ${currentPage} / ${totalPages}</span> ${next}`;
            }

            function changePage(page) {
                currentPage = page;
                renderResults();
            }

            productSearch.addEventListener('input', filterProducts);
            filterType.addEventListener('change', filterProducts);
            productResults.addEventListener('click', (e) => {
                const item = e.target.closest('[data-codeap]');
                if (item) {
                    productSearch.value = `${item.dataset.codeap} - ${item.dataset.descr}`;
                    productIdInput.value = item.dataset.codeap;
                    productResults.style.display = 'none';
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#product_search') && !e.target.closest('#product_results')) {
                    productResults.style.display = 'none';
                }
            });

<!-- Modal Modifier Intervention -->
<div class="clay-modal clay-modal-hidden" id="editInterventionModal">
    <div class="clay-modal-backdrop"></div>
    <div class="clay-modal-content">
        <form id="editInterventionForm" method="post" class="clay-form">
            <div class="clay-modal-header">
                <h3 class="clay-title-secondary">
                    <i class="fas fa-edit clay-icon-warning mr-3"></i>
                    Modifier l'intervention
                </h3>
                <button type="button" class="clay-btn-close" data-dismiss="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="clay-modal-body">
                <div class="clay-form-group">
                    <label for="edit_customer_name" class="clay-label">Nom du client</label>
                    <input type="text" class="clay-input" id="edit_customer_name" name="customer_name" required>
                </div>
                <div class="clay-form-group">
                    <label for="edit_customer_address" class="clay-label">Adresse du client</label>
                    <textarea class="clay-textarea" id="edit_customer_address" name="customer_address" rows="3" required></textarea>
                </div>
                <div class="clay-form-group">
                    <label for="edit_technician_id" class="clay-label">Technicien assigné</label>
                    <select class="clay-select" id="edit_technician_id" name="technician_id" required>
                        {% for tech in technicians %}
                            <option value="{{ tech.id }}">{{ tech.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="clay-modal-footer">
                <button type="button" class="clay-btn clay-btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="submit" class="clay-btn clay-btn-primary clay-ripple">
                    <i class="fas fa-save mr-2"></i>
                    Enregistrer
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Modifier Étape -->
<div class="clay-modal clay-modal-hidden" id="editStepModal">
    <div class="clay-modal-backdrop"></div>
    <div class="clay-modal-content">
        <form id="editStepForm" method="post" class="clay-form">
            <div class="clay-modal-header">
                <h3 class="clay-title-secondary">
                    <i class="fas fa-edit clay-icon-warning mr-3"></i>
                    Modifier l'étape
                </h3>
                <button type="button" class="clay-btn-close" data-dismiss="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="clay-modal-body">
                <div class="clay-form-group">
                    <label for="edit_step_description" class="clay-label">Description</label>
                    <textarea class="clay-textarea" id="edit_step_description" name="description" rows="3" required></textarea>
                </div>
            </div>
            
            <div class="clay-modal-footer">
                <button type="button" class="clay-btn clay-btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="submit" class="clay-btn clay-btn-primary clay-ripple">
                    <i class="fas fa-save mr-2"></i>
                    Enregistrer
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// JS pour recherche dynamique, pagination, filtres avec style claymorphism
const products = {{ products|tojson }};
let currentPage = 1;
const pageSize = 8;
let filteredProducts = products;
const productSearch = document.getElementById('product_search');
const productResults = document.getElementById('product_results');
const productIdInput = document.getElementById('product_id');
const productPager = document.getElementById('product_pager');
const filterType = document.getElementById('product_filter_type');

function safeLower(val) {
    return (val || '').toString().toLowerCase();
}

function filterProducts() {
    const query = safeLower(productSearch.value.trim());
    const type = filterType.value;
    filteredProducts = products.filter(p => safeLower(p[type]).includes(query));
    currentPage = 1;
    renderResults();
}

function renderResults() {
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageProducts = filteredProducts.slice(start, end);
    
    productResults.innerHTML = pageProducts.map(p => `
        <div class='clay-dropdown-item' data-codeap='${p.CODEAP}' data-descr='${p.DESCR}'>
            <span class='clay-product-code'>${p.CODEAP}</span> - 
            <span class='clay-product-name'>${p.DESCR}</span>
        </div>
    `).join('');
    
    if (pageProducts.length > 0) {
        productResults.classList.remove('clay-dropdown-hidden');
    } else {
        productResults.classList.add('clay-dropdown-hidden');
    }
    
    renderPager();
}

function renderPager() {
    const totalPages = Math.ceil(filteredProducts.length / pageSize);
    if (totalPages <= 1) {
        productPager.innerHTML = '';
        return;
    }
    
    const prev = currentPage > 1 ? 
        `<button onclick="changePage(${currentPage - 1})" class="clay-btn clay-btn-sm clay-btn-secondary">Précédent</button>` : '';
    const next = currentPage < totalPages ? 
        `<button onclick="changePage(${currentPage + 1})" class="clay-btn clay-btn-sm clay-btn-secondary">Suivant</button>` : '';
    
    productPager.innerHTML = `
        <div class="clay-pagination-controls">
            ${prev} 
            <span class="clay-pagination-info">Page ${currentPage} / ${totalPages}</span> 
            ${next}
        </div>
    `;
}

function changePage(page) {
    currentPage = page;
    renderResults();
}

// Event listeners
productSearch.addEventListener('input', filterProducts);
filterType.addEventListener('change', filterProducts);

productResults.addEventListener('click', (e) => {
    const item = e.target.closest('[data-codeap]');
    if (item) {
        productSearch.value = `${item.dataset.codeap} - ${item.dataset.descr}`;
        productIdInput.value = item.dataset.codeap;
        productResults.classList.add('clay-dropdown-hidden');
    }
});

document.addEventListener('click', (e) => {
    if (!e.target.closest('#product_search') && !e.target.closest('#product_results')) {
        productResults.classList.add('clay-dropdown-hidden');
    }
});

// Fonctions pour les modals et édition
function editIntervention(id, customerName, customerAddress, technicianId) {
    document.getElementById('edit_customer_name').value = customerName;
    document.getElementById('edit_customer_address').value = customerAddress;
    document.getElementById('edit_technician_id').value = technicianId;
    document.getElementById('editInterventionForm').action = `/edit_intervention/${id}`;
    showModal('editInterventionModal');
}

function editStep(stepId, description) {
    document.getElementById('edit_step_description').value = description;
    document.getElementById('editStepForm').action = `/edit_step/${stepId}`;
    showModal('editStepModal');
}

// Fonctions utilitaires pour chronomètre et notes vocales
function startTimer(stepId) {
    // Implémentation du chronomètre
    console.log('Timer démarré pour l\'étape:', stepId);
}

function addVoiceNote(stepId) {
    // Implémentation des notes vocales
    console.log('Note vocale pour l\'étape:', stepId);
}

// Gestion des modals claymorphism
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('clay-modal-hidden');
    document.body.classList.add('clay-modal-open');
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('clay-modal-hidden');
    document.body.classList.remove('clay-modal-open');
}

// Event listeners pour fermer les modals
document.addEventListener('click', (e) => {
    if (e.target.matches('[data-dismiss="modal"]') || e.target.closest('[data-dismiss="modal"]')) {
        const modal = e.target.closest('.clay-modal');
        if (modal) {
            modal.classList.add('clay-modal-hidden');
            document.body.classList.remove('clay-modal-open');
        }
    }
    
    if (e.target.classList.contains('clay-modal-backdrop')) {
        const modal = e.target.closest('.clay-modal');
        if (modal) {
            modal.classList.add('clay-modal-hidden');
            document.body.classList.remove('clay-modal-open');
        }
    }
});
</script>

{% endblock %}
